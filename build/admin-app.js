(()=>{"use strict";var e,s={435:()=>{const e=window.wp.element,s=window.wp.components,t=window.ReactJSXRuntime,n=async(e,{signal:s}={})=>{const t=await window.fetch(`${DBVC_ADMIN_APP.root}${e}`,{headers:{"X-WP-Nonce":DBVC_ADMIN_APP.nonce},signal:s});if(!t.ok)throw new Error(`Request failed (${t.status})`);return t.json()},i=async(e,s)=>{const t=await window.fetch(`${DBVC_ADMIN_APP.root}${e}`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":DBVC_ADMIN_APP.nonce},body:JSON.stringify(s)});if(!t.ok){const e=await t.text();let s=e;try{s=JSON.parse(e)}catch(e){}const n=new Error(s&&s.message||e||`Request failed (${t.status})`);throw n.status=t.status,n.body=s,n}return t.json()},l=async e=>{const s=await window.fetch(`${DBVC_ADMIN_APP.root}${e}`,{method:"DELETE",headers:{"X-WP-Nonce":DBVC_ADMIN_APP.nonce}});if(!s.ok){const e=await s.text();throw new Error(e||`Request failed (${s.status})`)}return s.json()},a=e=>{if(!e)return"—";const s=new Date(e);return Number.isNaN(s.getTime())?e:s.toLocaleString()},o=e=>null==e?"—":"boolean"==typeof e?e?"true":"false":"number"==typeof e?e.toString():""===e?"(empty)":e,r=e=>{if(null==e)return"";if("string"==typeof e)return e;if("number"==typeof e||"boolean"==typeof e)return String(e);try{return JSON.stringify(e,null,2)}catch(s){return String(e)}},c=e=>e&&(e.diff||e.before||e.after)?(0,t.jsxs)(t.Fragment,{children:[e.before&&(0,t.jsx)("span",{children:e.before}),e.diff&&(0,t.jsx)("mark",{children:e.diff||"(empty)"}),e.after&&(0,t.jsx)("span",{children:e.after})]}):null,d=new Set(["post_title","post_name","post_status","post_type","post_excerpt","post_parent","post_author","post_date","post_date_gmt","post_modified","post_modified_gmt","post_password","post_mime_type","post_content_filtered","menu_order","comment_status","ping_status","guid","comment_count"]),u={meta:"Meta",tax:"Taxonomies",media:"Media References",content:"Content",post_fields:"Post Fields",title:"Title",status:"Status",post_type:"Post Type",post_excerpt:"Excerpt",other:"Other"},p="__dbvc_new_entity__",h={all:"All entities",needs_review:"Needs Review",needs_review_media:"Needs Review (Media)",resolved:"Resolved",reused:"Resolved",conflict:"Conflict",needs_download:"Needs Download",missing:"Missing",unknown:"Unknown",new_entities:"New posts",with_decisions:"With selections"},v=e=>{const s=h[e]||e;return(0,t.jsx)("span",{className:`dbvc-badge dbvc-badge--${e}`,children:s})},m=e=>Boolean(void 0!==e?.is_new_entity?e.is_new_entity:"missing_local_post"===e?.diff_state?.reason),b=[{id:"title",label:"Title",defaultVisible:!0,lockVisible:!0,renderCell:e=>e.post_title||e.vf_object_uid},{id:"post_name",label:"Slug",defaultVisible:!0,renderCell:e=>(0,t.jsx)("span",{className:"dbvc-text-break",children:e.post_name||"—"})},{id:"post_type",label:"Type",defaultVisible:!0,renderCell:e=>e.post_type||"—"},{id:"post_status",label:"Status",defaultVisible:!0,renderCell:e=>e.post_status||"—"},{id:"post_modified",label:"Last modified",defaultVisible:!0,renderCell:e=>e.post_modified?a(e.post_modified):"—"},{id:"content_hash",label:"Content hash",defaultVisible:!1,renderCell:e=>{var s;return(0,t.jsx)("span",{className:"dbvc-text-break",children:null!==(s=e.content_hash)&&void 0!==s?s:"—"})}},{id:"diff",label:"Diff",defaultVisible:!0,renderCell:(e,s)=>(0,t.jsxs)(t.Fragment,{children:[v(s.diffState.needs_review?"needs_review":"resolved"),s.hashMissing&&(0,t.jsx)("span",{className:"dbvc-badge dbvc-badge--missing",style:{marginLeft:"0.25rem"},children:"Hash missing"})]})},{id:"media_refs",label:"Media refs",defaultVisible:!0,renderCell:e=>{var s,t;return(null!==(s=e.media_refs?.meta?.length)&&void 0!==s?s:0)+(null!==(t=e.media_refs?.content?.length)&&void 0!==t?t:0)}},{id:"resolver",label:"Resolver",defaultVisible:!0,renderCell:(e,s)=>{const n=s.isNewEntity,i=s.newDecision||"";let l="New post";return"accept_new"===i?l="New post accepted":"decline_new"===i&&(l="New post declined"),(0,t.jsxs)("div",{className:"dbvc-resolver-cell",children:[v(s.mediaStatus),n&&(0,t.jsx)("span",{className:"dbvc-badge dbvc-badge--new"+("decline_new"===i?" is-declined":""),style:{marginLeft:"0.25rem"},children:l})]})}},{id:"unresolved_media",label:"Unresolved media",defaultVisible:!0,renderCell:(e,s)=>{var t;return null!==(t=s.summary.unresolved)&&void 0!==t?t:0}},{id:"meta_diff_count",label:"Unresolved meta",defaultVisible:!0,renderCell:e=>{var s;return null!==(s=e.meta_diff_count)&&void 0!==s?s:0}},{id:"conflicts",label:"Conflicts",defaultVisible:!0,renderCell:(e,s)=>{var t;return null!==(t=s.summary.conflicts)&&void 0!==t?t:0}},{id:"decisions",label:"Decisions",defaultVisible:!0,renderCell:(e,s)=>s.entityHasSelections?(0,t.jsxs)("div",{className:"dbvc-decisions",children:[s.entityAccepted>0&&(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--accept",children:[s.entityAccepted," accept"]}),s.entityNewAccepted>0&&(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--new",children:[s.entityNewAccepted," new"]}),s.entityKept>0&&(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--keep",children:[s.entityKept," keep"]})]}):"—"}],f=({proposals:e,selectedId:s,onSelect:n})=>e.length?(0,t.jsxs)("table",{className:"widefat fixed striped dbvc-proposal-table",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:"Proposal"}),(0,t.jsx)("th",{children:"Generated"}),(0,t.jsx)("th",{children:"Files"}),(0,t.jsx)("th",{children:"Media"}),(0,t.jsx)("th",{children:"Status"}),(0,t.jsx)("th",{children:"Decisions"}),(0,t.jsx)("th",{children:"Resolver reused"}),(0,t.jsx)("th",{children:"Resolver unresolved"})]})}),(0,t.jsx)("tbody",{children:e.map(e=>{var i,l,o,r,c,d,u,p,h,v,m;const b=null!==(i=e.resolver?.metrics)&&void 0!==i?i:{},f=e.id===s,g=null!==(l=e.decisions)&&void 0!==l?l:{},j=null!==(o=g.accepted)&&void 0!==o?o:0,x=null!==(r=g.kept)&&void 0!==r?r:0,_=null!==(c=g.entities_reviewed)&&void 0!==c?c:0,y=(null!==(d=g.total)&&void 0!==d?d:0)>0,w="closed"===e.status?"Closed":"Open";return(0,t.jsxs)("tr",{className:`${f?"is-active":""} ${"closed"===e.status?"is-archived":""}`,onClick:()=>n(e.id),style:{cursor:"pointer"},children:[(0,t.jsx)("td",{children:e.title}),(0,t.jsx)("td",{children:a(e.generated_at)}),(0,t.jsx)("td",{children:null!==(u=e.files)&&void 0!==u?u:"—"}),(0,t.jsx)("td",{children:null!==(p=e.media_items)&&void 0!==p?p:"—"}),(0,t.jsx)("td",{children:(0,t.jsx)("span",{className:`dbvc-status-badge dbvc-status-badge--${null!==(h=e.status)&&void 0!==h?h:"draft"}`,children:w})}),(0,t.jsx)("td",{children:y?(0,t.jsxs)("div",{className:"dbvc-decisions",children:[(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--accept",children:[j," accept"]}),(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--keep",children:[x," keep"]}),_>0&&(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--reviewed",children:[_," reviewed"]})]}):"—"}),(0,t.jsx)("td",{children:null!==(v=b.reused)&&void 0!==v?v:"—"}),(0,t.jsx)("td",{children:null!==(m=b.unresolved)&&void 0!==m?m:"—"})]},e.id)})})]}):(0,t.jsx)("p",{children:"No proposals found. Generate an export to get started."}),g=({onUploaded:n,onError:i})=>{const[l,a]=(0,e.useState)(!1),[o,r]=(0,e.useState)(!1),[c,d]=(0,e.useState)(""),[u,p]=(0,e.useState)(""),[h,v]=(0,e.useState)(!1),m=(0,e.useRef)(null),b=(0,e.useCallback)(async e=>{const s=e&&e[0];if(!s)return;const t=new window.FormData;t.append("file",s),t.append("overwrite",h?"1":"0"),r(!0),d(""),p("");try{const e=await(async(e,s)=>{const t=await window.fetch(`${DBVC_ADMIN_APP.root}proposals/upload`,{method:"POST",headers:{"X-WP-Nonce":DBVC_ADMIN_APP.nonce},body:s});if(!t.ok){const e=await t.text();throw new Error(e||`Request failed (${t.status})`)}return t.json()})(0,t);d(`Uploaded ${s.name}`),"function"==typeof n&&n(e.proposal_id,e)}catch(e){const s=e?.message||"Upload failed.";p(s),"function"==typeof i&&i(s)}finally{r(!1),m.current&&(m.current.value="")}},[h,n,i]);return(0,t.jsxs)("div",{className:"dbvc-proposal-uploader",children:[(0,t.jsx)("div",{className:`dbvc-proposal-uploader__dropzone${l?" is-dragging":""}${o?" is-uploading":""}`,onDragOver:e=>{e.preventDefault(),a(!0)},onDragLeave:e=>{e.currentTarget.contains(e.relatedTarget)||a(!1)},onDrop:e=>{e.preventDefault(),a(!1),b(e.dataTransfer?.files)},children:(0,t.jsxs)("div",{children:[(0,t.jsx)("strong",{children:"Upload proposal bundle"}),(0,t.jsx)("p",{children:"Drop a DBVC ZIP export here or select a file to register it."}),(0,t.jsx)(s.Button,{variant:"secondary",onClick:()=>m.current?.click(),disabled:o,children:o?"Uploading…":"Select ZIP"}),(0,t.jsx)("input",{ref:m,type:"file",accept:".zip",style:{display:"none"},onChange:e=>b(e.target.files)}),(0,t.jsx)(s.CheckboxControl,{label:"Replace existing proposal when IDs match",help:"Enable if this upload should refresh an existing proposal folder instead of creating a new one.",checked:h,onChange:e=>v(e),disabled:o})]})}),c&&(0,t.jsx)("p",{className:"dbvc-proposal-uploader__status",children:c}),u&&(0,t.jsx)("p",{className:"dbvc-proposal-uploader__error",role:"alert",children:u})]})},j=({resolver:e})=>{var s,n,i,l;if(!e)return(0,t.jsx)("p",{children:"Resolver metrics unavailable."});const{metrics:a={},conflicts:o=[]}=e;return(0,t.jsxs)("div",{className:"dbvc-admin-app__resolver",children:[(0,t.jsx)("h3",{children:"Resolver Summary"}),(0,t.jsxs)("ul",{children:[(0,t.jsxs)("li",{children:["Detected: ",null!==(s=a.detected)&&void 0!==s?s:0]}),(0,t.jsxs)("li",{children:["Reused: ",null!==(n=a.reused)&&void 0!==n?n:0]}),(0,t.jsxs)("li",{children:["Downloaded: ",null!==(i=a.downloaded)&&void 0!==i?i:0]}),(0,t.jsxs)("li",{children:["Unresolved: ",null!==(l=a.unresolved)&&void 0!==l?l:0]}),(0,t.jsxs)("li",{children:["Conflicts: ",o.length]})]}),o.length>0&&(0,t.jsx)("div",{className:"notice notice-warning",children:(0,t.jsxs)("p",{children:["The resolver reported ",o.length," conflict(s). Review before applying."]})})]})},x=({entities:s,loading:n,selectedEntityId:i,onSelect:l,columns:a,selectedIds:o=new Set,onToggleSelection:r,onToggleSelectionAll:c})=>{if(n)return(0,t.jsx)("p",{children:"Loading entities…"});if(!s.length)return(0,t.jsx)("p",{children:"No entities found for this proposal."});const d=a&&a.length?a:b,u=s.length>200,p=(0,e.useRef)(null),[h,v]=(0,e.useState)(0),[f,g]=(0,e.useState)(0);(0,e.useEffect)(()=>{if(!u)return v(0),void g(0);const e=p.current;if(!e)return;const s=()=>{v(e.clientHeight||0)};s();let t=null;return"undefined"!=typeof ResizeObserver?(t=new ResizeObserver(s),t.observe(e)):window.addEventListener("resize",s),()=>{t?t.disconnect():window.removeEventListener("resize",s)}},[u]);const j=s.length,x=52*j,_=u&&h?Math.ceil(h/52)+5:j,y=u?Math.max(0,Math.floor(f/52)-5):0,w=u?Math.min(j,y+_):j,C=u?s.slice(y,w):s,k=u?52*y:0,N=u?Math.max(0,x-k-52*C.length):0,S=u?e=>{g(e.currentTarget.scrollTop)}:void 0,R="function"==typeof r,D=o instanceof Set?o:new Set(o),$=C.map(e=>e.vf_object_uid),I=R&&C.length>0&&C.every(e=>D.has(e.vf_object_uid)),A=R&&!I&&C.some(e=>D.has(e.vf_object_uid)),E=(0,e.useRef)(null);return(0,e.useEffect)(()=>{R&&E.current&&(E.current.indeterminate=A)},[R,A]),(0,t.jsx)("div",{className:"dbvc-entity-table"+(u?" is-virtualized":""),ref:p,onScroll:S,children:(0,t.jsxs)("table",{className:"widefat striped",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[R&&(0,t.jsx)("th",{className:"dbvc-entity-select",children:(0,t.jsx)("input",{type:"checkbox",ref:E,checked:I,onChange:e=>c?.($,e.target.checked)})}),d.map(e=>(0,t.jsx)("th",{children:e.label},e.id))]})}),(0,t.jsxs)("tbody",{children:[u&&k>0&&(0,t.jsx)("tr",{className:"dbvc-entity-spacer","aria-hidden":"true",style:{height:`${k}px`},children:(0,t.jsx)("td",{colSpan:d.length+(R?1:0)})}),C.map(e=>{var s,n,a,o,c,u,p,h;const v=e.vf_object_uid===i,b=R&&D.has(e.vf_object_uid),f=null!==(s=e.resolver?.summary)&&void 0!==s?s:{},g=null!==(n=e.diff_state)&&void 0!==n?n:{},j=e.media_needs_review?"needs_review":null!==(a=e.resolver?.status)&&void 0!==a?a:"resolved",x=e.overall_status||(g.needs_review?"needs_review":"resolved"),_="missing_local_hash"===g.reason,y=null!==(o=e.decision_summary)&&void 0!==o?o:{},w=null!==(c=y.accepted)&&void 0!==c?c:0,C=null!==(u=y.kept)&&void 0!==u?u:0,k=null!==(p=y.accepted_new)&&void 0!==p?p:0,N=(null!==(h=y.total)&&void 0!==h?h:0)>0,S=m(e),$=e.new_entity_decision||"",I=e.identity_match||"",A=[`resolver-${x}`,v?"is-active":"",b?"is-selected":""].filter(Boolean).join(" "),E=s=>{s.preventDefault(),s.stopPropagation(),l(e.vf_object_uid)},M={summary:f,diffState:g,mediaStatus:j,hashMissing:_,decisionSummary:y,entityHasSelections:N,entityAccepted:w,entityNewAccepted:k,entityKept:C,isNewEntity:S,newDecision:$,identityMatch:I};return(0,t.jsxs)("tr",{className:A,onClick:E,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||E(e)},style:{cursor:"pointer"},role:"button",tabIndex:0,children:[R&&(0,t.jsx)("td",{className:"dbvc-entity-select",children:(0,t.jsx)("input",{type:"checkbox",checked:b,onChange:s=>{s.stopPropagation(),r?.(e.vf_object_uid)},onClick:e=>e.stopPropagation()})}),d.map(s=>{var n;return(0,t.jsx)("td",{children:s.renderCell?s.renderCell(e,M):null!==(n=e[s.id])&&void 0!==n?n:"—"},s.id)})]},e.vf_object_uid)}),u&&N>0&&(0,t.jsx)("tr",{className:"dbvc-entity-spacer","aria-hidden":"true",style:{height:`${N}px`},children:(0,t.jsx)("td",{colSpan:d.length+(R?1:0)})})]})]})})},_=({entityDetail:n,resolverInfo:i,resolverDecisionSummary:l=null,decisions:a={},onDecisionChange:o,onBulkDecision:r,onResetDecisions:c,onCaptureSnapshot:h,onResolverDecision:v,onResolverDecisionReset:b,onApplyResolverDecisionToSimilar:f,savingPaths:g={},bulkSaving:j=!1,resolverSaving:x={},resolverError:_=null,decisionError:y,loading:w,error:C,onClose:N,filterMode:R,onFilterModeChange:D,isOpen:$=!0,resettingDecisions:I=!1,snapshotCapturing:A=!1,onHashSync:E,hashSyncing:M=!1,hashSyncTarget:U=""})=>{var B,O,P,T,F,V,L,z,H,K,J,q,G,W,X;const Z=(0,e.useMemo)(()=>n?.item?.vf_object_uid?`dbvc-entity-detail-${n.item.vf_object_uid}`:n?.vf_object_uid?`dbvc-entity-detail-${n.vf_object_uid}`:"dbvc-entity-detail",[n]),Q=(0,e.useRef)(null),Y=(0,e.useRef)(null);(0,e.useEffect)(()=>{if(!N||!$)return;Y.current=document.activeElement instanceof HTMLElement?document.activeElement:null;const e=Q.current;e&&e.focus();const s=e=>{"Escape"===e.key&&(e.preventDefault(),N())};return document.addEventListener("keydown",s),()=>{document.removeEventListener("keydown",s),Y.current&&"function"==typeof Y.current.focus&&Y.current.focus()}},[$,N,Z]);const{item:ee,current:se,proposed:te={},diff:ne}=null!=n?n:{},ie=null!==(B=n?.decision_summary)&&void 0!==B?B:{},le=null!==(O=null!==(P=n?.diff_state)&&void 0!==P?P:ee?.diff_state)&&void 0!==O?O:null,ae=null!==(T=le?.local_post_id)&&void 0!==T?T:null,oe=ae?`post.php?post=${ae}&action=edit`:"",re="missing_local_hash"===le?.reason,ce=m(null!=n?n:{diff_state:le}),de=null!==(F=null!==(V=a?.[p])&&void 0!==V?V:n?.new_entity_decision)&&void 0!==F?F:"",ue=Boolean(g?.[p]),pe=null!==(L=ie.total)&&void 0!==L?L:0,he=pe>0?`${null!==(z=ie.accepted)&&void 0!==z?z:0} accepted · ${null!==(H=ie.kept)&&void 0!==H?H:0} kept`:"No selections captured yet.",ve=null!==(K=ne?.changes)&&void 0!==K?K:[],me=(0,e.useMemo)(()=>ve,[ve,R]),be=(0,e.useMemo)(()=>(e=>{const s={};return e.forEach(e=>{const[t]=e.path.split("."),n=(d.has(t)?"post_fields":t)||"other";s[n]||(s[n]=[]),s[n].push(e)}),Object.entries(s).map(([e,s])=>({key:e,label:u[e]||e,items:s}))})(me),[me]),fe=null!==(J=i?.attachments)&&void 0!==J?J:[],[ge,je]=(0,e.useState)(""),xe=(0,e.useMemo)(()=>{if(!ge)return fe;const e=ge.toLowerCase();return fe.filter(s=>{const t=s.descriptor||{};return[s.original_id,s.reason,s.status,s.decision?.note,t.asset_uid,t.bundle_path,t.path].filter(Boolean).join(" ").toLowerCase().includes(e)})},[fe,ge]),_e="conflicts"===R,ye=ve.length,we=(0,e.useMemo)(()=>ve.filter(e=>{var s;return"accept"!==(null!==(s=a?.[e.path])&&void 0!==s?s:"")}).length,[ve,a]),Ce=me.length,[ke,Ne]=(0,e.useState)(!1),[Se,Re]=(0,e.useState)(""),[De,$e]=(0,e.useState)("reason"),[Ie,Ae]=(0,e.useState)(""),[Ee,Me]=(0,e.useState)(""),[Ue,Be]=(0,e.useState)(""),[Oe,Pe]=(0,e.useState)(""),[Te,Fe]=(0,e.useState)(!1),[Ve,Le]=(0,e.useState)(!1),[ze,He]=(0,e.useState)("");(0,e.useEffect)(()=>{ke||Re(be[0]?.key||"")},[be,ke]);const Ke=(0,e.useMemo)(()=>ke||!Se?be:be.filter(e=>e.key===Se),[be,ke,Se]),Je=(0,e.useMemo)(()=>{if(ke)return me;const e=be.find(e=>e.key===Se);return e?e.items:[]},[ke,me,be,Se]),qe=(0,e.useMemo)(()=>Je.map(e=>e.path).filter(Boolean),[Je]),Ge=(0,e.useMemo)(()=>{const e=new Set,s=new Set,t=new Set;return fe.forEach(n=>{n.reason&&e.add(n.reason);const i=n.descriptor||{};i.asset_uid&&s.add(i.asset_uid);const l=i.bundle_path||i.path||"";l&&t.add(l)}),{reason:Array.from(e),asset_uid:Array.from(s),bundle_path:Array.from(t)}},[fe]);(0,e.useEffect)(()=>{const e=Ge[De]||[];e.length?e.includes(Ie)||Ae(e[0]||""):Ae("")},[De,Ie,Ge]);const We=(0,e.useMemo)(()=>!Ie&&(Ge[De]||[]).length?[]:fe.filter(e=>{const s=e.descriptor||{};switch(De){case"asset_uid":return(s.asset_uid||"")===Ie;case"bundle_path":return(s.bundle_path||s.path||"")===Ie;default:return(e.reason||"")===Ie}}),[fe,De,Ie,Ge]),Xe=We.length,Ze="reuse"===Ee||"map"===Ee;return N&&!$?null:(e=>{const s=(0,t.jsx)("div",{className:"dbvc-admin-app__entity-detail",children:e});return N?(0,t.jsxs)("div",{className:"dbvc-entity-detail-modal",role:"presentation",children:[(0,t.jsx)("div",{className:"dbvc-entity-detail-modal__overlay",onClick:N,"aria-hidden":"true"}),(0,t.jsx)("div",{className:"dbvc-entity-detail-modal__panel",role:"dialog","aria-modal":"true","aria-labelledby":Z,children:s})]}):s})(w?(0,t.jsx)("p",{children:"Loading entity detail…"}):C?(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsxs)("p",{children:["Failed to load entity detail: ",C]})}):n?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"dbvc-entity-toolbar",children:[(0,t.jsxs)("div",{className:"dbvc-entity-toolbar__meta",children:[(0,t.jsx)("div",{className:"dbvc-entity-toolbar__title",id:Z,children:oe?(0,t.jsx)("a",{href:oe,target:"_blank",rel:"noreferrer",children:ee?.post_title||"Entity detail"}):ee?.post_title||"Entity detail"}),(0,t.jsxs)("div",{className:"dbvc-entity-toolbar__sub",children:[(0,t.jsxs)("span",{children:["Slug:"," ",oe&&ee?.post_name?(0,t.jsx)("a",{href:oe,target:"_blank",rel:"noreferrer",children:ee.post_name}):ee?.post_name||"—"]}),(0,t.jsxs)("span",{children:["File: ",ee?.path||"—"]})]})]}),N&&(0,t.jsx)("button",{type:"button",className:"dbvc-entity-detail__close",onClick:N,"aria-label":"Close entity detail",ref:N?Q:void 0,children:"Close"}),(0,t.jsxs)("div",{className:"dbvc-diff-filter",children:[(0,t.jsx)("span",{children:"View:"}),(0,t.jsx)("button",{type:"button",className:_e?"is-active":"",onClick:()=>D&&D("conflicts"),children:"Conflicts & Resolver"}),(0,t.jsx)("button",{type:"button",className:_e?"":"is-active",onClick:()=>D&&D("full"),children:"Full Overview"})]}),(0,t.jsx)("p",{className:"dbvc-entity-toolbar__count",children:_e?`${we} field(s) awaiting review · ${ye} total`:`${Ce} field(s) shown.`}),re&&E&&(0,t.jsxs)("div",{className:"notice notice-warning",children:[(0,t.jsx)("p",{children:"This entity is missing its stored import hash. Sync it to prevent repeated reviews."}),(0,t.jsx)("button",{type:"button",className:"button button-secondary",onClick:()=>E(n?.vf_object_uid),disabled:M&&U===n?.vf_object_uid,children:M&&U===n?.vf_object_uid?"Storing hash…":"Store import hash"})]}),(()=>{const e=[];return qe.length>0&&(e.push({key:"accept_all",content:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{type:"button",className:"button button-secondary",onClick:()=>{r&&window.confirm(`Accept ${qe.length} field(s)?`)&&r("accept",qe)},disabled:j,children:j?"Accepting…":"Accept All Visible"}),(0,t.jsx)("p",{className:"description",children:"Applies the bundle values to every field currently listed."})]})}),e.push({key:"keep_all",content:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{type:"button",className:"button",onClick:()=>{r&&window.confirm(`Keep current values for ${qe.length} field(s)?`)&&r("keep",qe)},disabled:j,children:j?"Keeping…":"Keep All Visible"}),(0,t.jsx)("p",{className:"description",children:"Locks in the live values for each visible field without importing."})]})})),"function"==typeof h&&e.push({key:"snapshot",content:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{type:"button",className:"button dbvc-button-inverted",onClick:h,disabled:A||!h,children:A?"Capturing snapshot…":"Capture current snapshot"}),(0,t.jsx)("p",{className:"description",children:"Refreshes the “current” baseline from the live post before you compare."})]})}),"function"==typeof c&&pe>0&&e.push({key:"clear_decisions",content:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{type:"button",className:"button",onClick:c,disabled:I,children:I?"Clearing…":"Clear all decisions"}),(0,t.jsx)("p",{className:"description",children:"Removes every Accept/Keep choice so you can re-evaluate this entity."})]})}),e.length?(0,t.jsx)("div",{className:"dbvc-entity-action-grid",children:e.map(e=>(0,t.jsx)("div",{className:"dbvc-entity-action",children:e.content},e.key))}):null})(),(0,t.jsxs)("p",{className:"dbvc-decision-summary",children:["Selections: ",he]})]}),ce&&(0,t.jsxs)("div",{className:"dbvc-new-entity-card",children:[(0,t.jsxs)("div",{className:"dbvc-new-entity-card__header",children:[(0,t.jsx)("span",{className:"dbvc-badge dbvc-badge--new",children:"New post"}),(0,t.jsx)("span",{className:"dbvc-new-entity-card__status",children:"accept_new"===de?"Accepted for import":"decline_new"===de?"Declined — will be skipped":"Pending reviewer decision"})]}),(0,t.jsxs)("p",{children:["This proposal would create a new ",ee?.post_type||"post"," on this site. No UID, original ID, or slug match was detected locally, so choose whether to import it."]}),(0,t.jsxs)("div",{className:"dbvc-new-entity-actions",children:[(0,t.jsx)(s.Button,{variant:"accept_new"===de?"primary":"secondary",onClick:()=>o&&o(p,"accept_new"),disabled:ue,isBusy:ue&&"accept_new"===de,children:"Accept & import"}),(0,t.jsx)(s.Button,{variant:"decline_new"===de?"primary":"secondary",onClick:()=>o&&o(p,"decline_new"),disabled:ue,isBusy:ue&&"decline_new"===de,children:"Decline new post"}),(0,t.jsx)(s.Button,{variant:"tertiary",onClick:()=>o&&o(p,"clear"),disabled:ue||!de,children:"Clear choice"})]})]}),y&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsx)("p",{children:y})}),be.length>0&&(0,t.jsxs)("div",{className:"dbvc-section-nav",children:[(0,t.jsx)("span",{children:ke?"Sections:":"Jump to:"}),be.map(e=>(0,t.jsx)("button",{type:"button",className:ke||Se!==e.key?"":"is-active",onClick:()=>{if(ke){const s=document.getElementById(`dbvc-diff-${e.key}`);s&&s.scrollIntoView({behavior:"smooth",block:"start"})}else Re(e.key)},children:e.label},e.key)),(0,t.jsx)("button",{type:"button",className:ke?"is-active":"",onClick:()=>Ne(e=>!e),children:ke?"Focus Section":"Show All"})]}),Ke.length>0?Ke.map(e=>(0,t.jsx)(k,{section:e,decisions:a,onDecisionChange:o,savingPaths:g},e.key)):(0,t.jsx)("p",{children:_e&&ye>0?"No resolver or media conflicts detected for this entity. Switch to Full Overview to inspect all differences.":"No differences detected."}),fe.length>0&&(0,t.jsxs)("div",{className:"dbvc-admin-app__resolver-attachments",children:[(0,t.jsx)("h4",{children:"Media Resolver"}),(0,t.jsx)("div",{className:"dbvc-panel-search",children:(0,t.jsxs)("label",{children:["Search:  ",(0,t.jsx)("input",{type:"search",value:ge,onChange:e=>je(e.target.value),placeholder:"Reason, asset UID, note…"})]})}),l&&(0,t.jsxs)("p",{className:"dbvc-resolver-summary",children:["Saved decisions — reuse: ",null!==(q=l.reuse)&&void 0!==q?q:0,", map: ",null!==(G=l.map)&&void 0!==G?G:0,", download:"," ",null!==(W=l.download)&&void 0!==W?W:0,", skip: ",null!==(X=l.skip)&&void 0!==X?X:0]}),_&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsx)("p",{children:_})}),xe.length>0?(0,t.jsxs)("table",{className:"widefat",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:"Status"}),(0,t.jsx)("th",{children:"Original ID"}),(0,t.jsx)("th",{children:"Target"}),(0,t.jsx)("th",{children:"Reason"}),(0,t.jsx)("th",{children:"Decision"}),(0,t.jsx)("th",{style:{width:"160px"},children:"Actions"})]})}),(0,t.jsx)("tbody",{children:xe.map(e=>(0,t.jsx)(S,{attachment:e,saving:!!x[e.original_id],onSave:v,onClear:b,onApplyToSimilar:f},e.original_id))})]}):(0,t.jsx)("p",{children:"No resolver conflicts match your search."}),(0,t.jsxs)("div",{className:"dbvc-resolver-bulk",children:[(0,t.jsx)("h5",{children:"Bulk Apply Resolver Decision"}),(0,t.jsx)("p",{className:"description",children:"Match a subset of conflicts and apply a single decision without editing rows individually."}),(0,t.jsxs)("div",{className:"dbvc-resolver-bulk__filters",children:[(0,t.jsxs)("label",{children:["Match by",(0,t.jsxs)("select",{value:De,onChange:e=>$e(e.target.value),children:[(0,t.jsx)("option",{value:"reason",children:"Reason"}),(0,t.jsx)("option",{value:"asset_uid",children:"Asset UID"}),(0,t.jsx)("option",{value:"bundle_path",children:"Manifest Path"})]})]}),(0,t.jsxs)("label",{children:["Value",(0,t.jsxs)("select",{value:Ie,onChange:e=>Ae(e.target.value),disabled:0===(Ge[De]||[]).length,children:[0===(Ge[De]||[]).length&&(0,t.jsx)("option",{value:"",children:"No values detected"}),(Ge[De]||[]).map(e=>(0,t.jsx)("option",{value:e,children:e||"— Not provided —"},e||"blank"))]})]}),(0,t.jsxs)("span",{className:"dbvc-resolver-bulk__count",children:["Matches: ",Xe]})]}),(0,t.jsxs)("div",{className:"dbvc-resolver-controls dbvc-resolver-bulk__controls",children:[(0,t.jsxs)("select",{value:Ee,onChange:e=>Me(e.target.value),children:[(0,t.jsx)("option",{value:"",children:"Select action…"}),(0,t.jsx)("option",{value:"reuse",children:"Reuse existing"}),(0,t.jsx)("option",{value:"download",children:"Download new"}),(0,t.jsx)("option",{value:"map",children:"Map to attachment ID"}),(0,t.jsx)("option",{value:"skip",children:"Skip"})]}),Ze&&(0,t.jsx)("input",{type:"number",min:"1",placeholder:"Attachment ID",value:Ue,onChange:e=>Be(e.target.value)}),(0,t.jsx)("textarea",{value:Oe,onChange:e=>Pe(e.target.value),placeholder:"Optional note",rows:2}),(0,t.jsxs)("label",{children:[(0,t.jsx)("input",{type:"checkbox",checked:Te,onChange:e=>Fe(e.target.checked)})," ","Remember as global rule"]})]}),ze&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsx)("p",{children:ze})}),(0,t.jsx)("button",{type:"button",className:"button button-secondary",onClick:async()=>{if(!Ee)return void He("Select an action to apply.");if(Ze&&!Ue)return void He("Enter a target attachment ID for this action.");if(!Xe)return void He("No matching conflicts were found for the selected filter.");if(!v)return;if(!window.confirm(`Apply this decision to ${Xe} conflict(s) matched by ${"reason"===De?"reason":"asset_uid"===De?"asset UID":"manifest path"}?`))return;Le(!0),He("");const e={action:Ee,target_id:Ze?Number(Ue):null,note:Oe,persist_global:Te};try{for(const s of We)s.original_id&&await v(s.original_id,e);Pe(""),Be("")}catch(e){He(e?.message||"Bulk apply failed.")}finally{Le(!1)}},disabled:Ve,children:Ve?"Applying…":"Apply to Matches"})]})]}),(0,t.jsxs)("div",{className:"dbvc-admin-app__entity-columns",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h4",{children:"Raw Current"}),(0,t.jsx)("pre",{children:JSON.stringify(se,null,2)})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h4",{children:"Raw Proposed (Bundle)"}),(0,t.jsx)("pre",{children:JSON.stringify(te,null,2)})]})]})]}):(0,t.jsx)("p",{children:"Select an entity to view details."}))};function y({open:e,onClose:n,report:i,onMarkCanonical:l,actionKey:o}){var r,c;return e?(0,t.jsxs)(s.Modal,{title:`Duplicate entities (${null!==(r=i.count)&&void 0!==r?r:0})`,onRequestClose:n,className:"dbvc-duplicates-modal",children:[0===(null!==(c=i.items)&&void 0!==c?c:[]).length?(0,t.jsx)("p",{children:"No duplicate manifest entries were detected for this proposal."}):i.items.map(e=>{var n,i;const r=null!==(n=e.entries)&&void 0!==n?n:[],c=r.reduce((e,s)=>{const t=s.post_modified?Date.parse(s.post_modified.replace(" ","T")):0;return Number.isFinite(t)&&t>e?t:e},0);return(0,t.jsxs)("div",{className:"dbvc-duplicate-group",children:[(0,t.jsxs)("div",{className:"dbvc-duplicate-group__header",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("strong",{children:e.post_title||e.vf_object_uid}),(0,t.jsxs)("div",{className:"dbvc-duplicate-group__meta",children:[(0,t.jsxs)("span",{children:["UID: ",e.vf_object_uid]}),(0,t.jsxs)("span",{children:["Slug: ",e.post_name||"—"]}),(0,t.jsxs)("span",{children:["Type: ",e.post_type||"—"]})]})]}),(0,t.jsx)("div",{className:"dbvc-duplicate-group__badges",children:(0,t.jsxs)("span",{className:"dbvc-badge",children:[null!==(i=e.entries?.length)&&void 0!==i?i:0," files"]})})]}),(0,t.jsxs)("table",{className:"widefat",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:"Path"}),(0,t.jsx)("th",{children:"Hash"}),(0,t.jsx)("th",{children:"Content hash"}),(0,t.jsx)("th",{children:"Modified"}),(0,t.jsx)("th",{children:"Status"}),(0,t.jsx)("th",{children:"Size"}),(0,t.jsx)("th",{children:"Actions"})]})}),(0,t.jsx)("tbody",{children:r.map((n,i)=>{const r=`${e.vf_object_uid}::${n.path||i}`,d=n.post_modified?Date.parse(n.post_modified.replace(" ","T")):0,u=c&&Number.isFinite(d)&&d===c;return(0,t.jsxs)("tr",{className:u?"is-latest":"",children:[(0,t.jsx)("td",{className:"dbvc-text-break",children:n.path||"—"}),(0,t.jsx)("td",{className:"dbvc-text-break",children:n.hash||"—"}),(0,t.jsx)("td",{className:"dbvc-text-break",children:n.content_hash||"—"}),(0,t.jsx)("td",{children:n.post_modified?a(n.post_modified):"—"}),(0,t.jsx)("td",{children:n.post_status||"—"}),(0,t.jsx)("td",{children:"number"==typeof n.size?`${n.size} B`:"—"}),(0,t.jsx)("td",{children:(0,t.jsx)(s.Button,{variant:"secondary",onClick:()=>l&&l(e.vf_object_uid,n.path),disabled:o===r,children:o===r?"Marking…":"Keep this file"})})]},r)})})]})]},e.vf_object_uid)}),(0,t.jsx)("p",{className:"description",children:"Tip: Clean up duplicate JSON files in the sync folder before exporting new proposals to keep reviewers focused on a single entity per post."})]}):null}const w=()=>{var o,r,c,d,u,v,w,C,k,N,S,D,$,I,A,E,M,U,B,O,P,T,F,V,L,z,H;const[K,J]=(0,e.useState)([]),[q,G]=(0,e.useState)(null),[W,X]=(0,e.useState)(null),[Z,Q]=(0,e.useState)([]),[Y,ee]=(0,e.useState)("needs_review"),[se,te]=(0,e.useState)(""),[ne,ie]=(0,e.useState)(null),[le,ae]=(0,e.useState)(null),[oe,re]=(0,e.useState)(!1),[ce,de]=(0,e.useState)({}),[ue,pe]=(0,e.useState)({}),[he,ve]=(0,e.useState)(null),[me,be]=(0,e.useState)(!0),[fe,ge]=(0,e.useState)(!1),[je,xe]=(0,e.useState)(!1),[_e,ye]=(0,e.useState)(!1),[we,Ce]=(0,e.useState)(!1),[ke,Ne]=(0,e.useState)(null),[Se,Re]=(0,e.useState)(null),[De,$e]=(0,e.useState)(null),[Ie,Ae]=(0,e.useState)(null),[Ee,Me]=(0,e.useState)(!1),[Ue,Be]=(0,e.useState)(!1),[Oe,Pe]=(0,e.useState)(!1),[Te,Fe]=(0,e.useState)(""),[Ve,Le]=(0,e.useState)(null),[ze,He]=(0,e.useState)(null),[Ke,Je]=(0,e.useState)(!1),[qe,Ge]=(0,e.useState)("full"),[We,Xe]=(0,e.useState)(!1),[Ze,Qe]=(0,e.useState)("conflicts"),[Ye,es]=(0,e.useState)([]),[ss,ts]=(0,e.useState)([]),[ns,is]=(0,e.useState)({}),[ls,as]=(0,e.useState)(null),[os,rs]=(0,e.useState)(!1),[cs,ds]=(0,e.useState)(!1),[us,ps]=(0,e.useState)(!1),[hs,vs]=(0,e.useState)(!1),[ms,bs]=(0,e.useState)(()=>{const e={};return b.forEach(s=>{e[s.id]=!1!==s.defaultVisible}),e}),[fs,gs]=(0,e.useState)({count:0,items:[]}),[js,xs]=(0,e.useState)(!1),[_s,ys]=(0,e.useState)(null),[ws,Cs]=(0,e.useState)(!1),[ks,Ns]=(0,e.useState)(""),[Ss,Rs]=(0,e.useState)(!1),[Ds,$s]=(0,e.useState)(!1),[Is,As]=(0,e.useState)(!1),[Es,Ms]=(0,e.useState)(()=>new Set),Us=(0,e.useMemo)(()=>b.filter(e=>ms[e.id]),[ms]),Bs=(0,e.useCallback)(e=>{bs(s=>{const t=b.find(s=>s.id===e);return t&&t.lockVisible?s:{...s,[e]:!s[e]}})},[]),Os=(0,e.useCallback)(async(e,s={})=>{if(!e)return gs({count:0,items:[]}),void ys(null);const{signal:t}=s;xs(!0),ys(null);try{var i,l;const s=await n(`proposals/${encodeURIComponent(e)}/duplicates`,t?{signal:t}:void 0);gs({count:null!==(i=s.count)&&void 0!==i?i:s.items?s.items.length:0,items:null!==(l=s.items)&&void 0!==l?l:[]})}catch(e){if("AbortError"===e.name)return;ys(e?.message||"Failed to load duplicates."),gs({count:0,items:[]})}finally{xs(!1)}},[]),Ps=(0,e.useRef)(null);(0,e.useEffect)(()=>{Ps.current=ne},[ne]);const Ts=(0,e.useCallback)(async(e={})=>{const{signal:s,focusProposalId:t}=e;be(!0),Ne(null);try{var i;const e=null!==(i=(await n("proposals",s?{signal:s}:void 0)).items)&&void 0!==i?i:[];J(e),G(s=>{var n;return t&&e.some(e=>e.id===t)?t:s&&e.some(e=>e.id===s)?s:null!==(n=e[0]?.id)&&void 0!==n?n:null})}catch(e){if("AbortError"===e.name)return;Ne(e.message)}finally{be(!1),ge(!0)}},[]),Fs=(0,e.useCallback)(async(e,s,t)=>{if(!e)return Q([]),[];xe(!0),Re(null);try{var i;const l=s&&!["needs_review","needs_review_media","resolved","new_entities"].includes(s)||!s||"all"===s?"":`?status=${encodeURIComponent(s)}`,a=await n(`proposals/${encodeURIComponent(e)}/entities${l}`,{signal:t}),o=null!==(i=a.items)&&void 0!==i?i:[];return Q(o),a.decision_summary&&J(s=>s.map(s=>s.id===e?{...s,decisions:a.decision_summary}:s)),a.resolver_decisions&&J(s=>s.map(s=>s.id===e?{...s,resolver_decisions:a.resolver_decisions}:s)),o}catch(e){return"AbortError"!==e.name&&Re(e.message),[]}finally{xe(!1)}},[]),Vs=(0,e.useCallback)(e=>{e.stopPropagation()},[]),Ls=(0,e.useCallback)(e=>{e.preventDefault(),e.stopPropagation()},[]),zs=(0,e.useMemo)(()=>le?.resolver?.attachments?.length?le.resolver.attachments:W?.attachments||[],[W,le]),Hs=(0,e.useCallback)(()=>{q&&Os(q)},[q,Os]),Ks=(0,e.useCallback)(async(e,s)=>{if(q&&e&&s){Ns(`${e}::${s}`),ys(null);try{await i(`proposals/${encodeURIComponent(q)}/duplicates/cleanup`,{vf_object_uid:e,keep_path:s}),await Os(q),await Fs(q,Y)}catch(e){ys(e?.message||"Failed to mark canonical entry.")}finally{Ns("")}}},[q,Os,Fs,Y]),[Js,qs]=(0,e.useState)(!1),Gs=(0,e.useCallback)(e=>{Ms(s=>{const t=new Set(s);return t.has(e)?t.delete(e):t.add(e),t})},[]),Ws=(0,e.useCallback)((e,s)=>{Ms(t=>{const n=new Set(t);return e.forEach(e=>{s?n.add(e):n.delete(e)}),n})},[]),Xs=(0,e.useCallback)(()=>{Ms(new Set)},[]),Zs=(0,e.useCallback)(()=>{Ms(new Set(Z.map(e=>e.vf_object_uid)))},[Z]),Qs=(0,e.useCallback)(async()=>{if(q){Rs(!0),ys(null);try{await i(`proposals/${encodeURIComponent(q)}/entities/accept`,{scope:"new_only"}),await Fs(q,Y),await Os(q)}catch(e){ys(e?.message||"Failed to accept new entities.")}finally{Rs(!1)}}},[q,Fs,Y,Os]),Ys=(0,e.useCallback)(async()=>{if(q&&0!==Es.size){$s(!0),ve(null);try{await i(`proposals/${encodeURIComponent(q)}/entities/accept`,{scope:"selected",vf_object_uids:Array.from(Es)}),await Fs(q,Y),Xs()}catch(e){ve(e?.message||"Failed to accept selected entities.")}finally{$s(!1)}}},[q,Es,Fs,Y,Xs]),et=(0,e.useCallback)(async()=>{if(q&&0!==Es.size){As(!0),ve(null);try{await i(`proposals/${encodeURIComponent(q)}/entities/unaccept`,{scope:"selected",vf_object_uids:Array.from(Es)}),await Fs(q,Y),Xs()}catch(e){ve(e?.message||"Failed to unaccept selected entities.")}finally{As(!1)}}},[q,Es,Fs,Y,Xs]);(0,e.useEffect)(()=>{Le(null),He(null),Me(!1),Je(!1),Ge("full"),Xe(!1),es([])},[q]),(0,e.useEffect)(()=>{"partial"!==qe&&Xe(!1)},[qe]),(0,e.useEffect)(()=>{if(0===Ye.length)return;const e=setTimeout(()=>{es(e=>e.slice(1))},6e3);return()=>clearTimeout(e)},[Ye]),(0,e.useEffect)(()=>{const e=new AbortController;return Ts({signal:e.signal}),()=>e.abort()},[Ts]);const st=(0,e.useCallback)(async(e,s)=>{if(e){ye(!0),$e(null);try{const t=await n(`proposals/${encodeURIComponent(e)}/resolver`,{signal:s});X(t)}catch(e){"AbortError"!==e.name&&$e(e.message)}finally{ye(!1)}}else X(null)},[]);(0,e.useEffect)(()=>{if(!q)return ie(null),ae(null),void re(!1);const e=new AbortController;return Fs(q,Y,e.signal).then(e=>{if(!e.length)return ie(null),void re(!1);const s=Ps.current;s&&e.some(e=>e.vf_object_uid===s)||(ie(null),re(!1))}),()=>e.abort()},[q,Y,Fs]),(0,e.useEffect)(()=>{if(!q)return;const e=new AbortController;return st(q,e.signal),()=>e.abort()},[q,st]),(0,e.useEffect)(()=>{if(!q)return gs({count:0,items:[]}),void ys(null);const e=new AbortController;return Os(q,{signal:e.signal}),()=>e.abort()},[q,Os]),(0,e.useEffect)(()=>{if(!q||!ne)return ae(null),de({}),void pe({});const e=new AbortController;return(async()=>{Ce(!0),Ae(null),ve(null),pe({});try{var s;const t=await n(`proposals/${encodeURIComponent(q)}/entities/${encodeURIComponent(ne)}`,{signal:e.signal});ae(t),de(null!==(s=t.decisions)&&void 0!==s?s:{})}catch(e){"AbortError"!==e.name&&Ae(e.message)}finally{Ce(!1)}})(),()=>e.abort()},[q,ne]);const tt=(0,e.useCallback)((e,s)=>{const t=Number(e),n=(e=[])=>e.map(e=>{if((void 0!==e.original_id?e.original_id:e.descriptor?.original_id)===t){if(s)return{...e,decision:s};const{decision:t,...n}=e;return n}return e});X(e=>e?{...e,attachments:n(e.attachments||[])}:e),ae(e=>e?{...e,resolver:{...e.resolver||{},attachments:n(e.resolver?.attachments||[])}}:e),Q(e=>e.map(e=>e.vf_object_uid===ne?{...e,resolver:{...e.resolver||{},attachments:n(e.resolver?.attachments||[])}}:e))},[ne]),nt=(0,e.useMemo)(()=>{let e=Z;if("with_decisions"===Y&&(e=e.filter(e=>{var s;return(null!==(s=e.decision_summary?.total)&&void 0!==s?s:0)>0})),!se)return e;const s=se.toLowerCase();return e.filter(e=>[e.post_title,e.post_type,e.post_status,e.path].filter(Boolean).join(" ").toLowerCase().includes(s))},[Z,se,Y]),it=(0,e.useMemo)(()=>Z.find(e=>e.vf_object_uid===ne),[Z,ne]);(0,e.useEffect)(()=>{Ms(e=>{const s=new Set,t=new Set(Z.map(e=>e.vf_object_uid));return e.forEach(e=>{t.has(e)&&s.add(e)}),s})},[Z]);const lt=(0,e.useMemo)(()=>Z.filter(e=>"missing_local_hash"===e.diff_state?.reason),[Z]),at=(0,e.useMemo)(()=>Z.filter(e=>m(e)),[Z]),ot=at.length>0,rt=(0,e.useMemo)(()=>K.find(e=>e.id===q),[K,q]),ct=(0,e.useRef)(!1);(0,e.useEffect)(()=>{ot?ct.current||"new_entities"===Y||(ee("new_entities"),ct.current=!0):ct.current=!1},[ot,Y]),(0,e.useEffect)(()=>{if(!nt.length)return ie(null),void re(!1);ne&&!nt.some(e=>e.vf_object_uid===ne)&&(ie(null),re(!1))},[nt,ne]),(0,e.useEffect)(()=>{Qe("conflicts")},[ne]);const dt=(0,e.useCallback)(e=>{if(!e)return ie(null),void re(!1);ie(s=>s===e?s:e),re(!0)},[]),ut=(0,e.useCallback)(async e=>{if(q){Be(!0);try{const s=await i(`proposals/${encodeURIComponent(q)}/status`,{status:e});J(e=>e.map(e=>e.id===q?{...e,status:s.status}:e))}catch(e){He(e?.message||"Failed to update proposal status.")}finally{Be(!1)}}},[q]),pt=(0,e.useCallback)(async()=>{if(q&&0!==lt.length&&window.confirm(`Store import hashes for ${lt.length} entit${1===lt.length?"y":"ies"}?`)){Fe("bulk"),Pe(!0),ve(null);try{await i(`proposals/${encodeURIComponent(q)}/entities/hash-sync`,{vf_object_uids:lt.map(e=>e.vf_object_uid)}),await Fs(q,Y)}catch(e){ve(e?.message||"Failed to store import hashes.")}finally{Pe(!1),Fe("")}}},[q,lt,Fs,Y]),ht=(0,e.useCallback)(async e=>{if(q&&e){Fe(e),Pe(!0),ve(null);try{var s;await i(`proposals/${encodeURIComponent(q)}/entities/${encodeURIComponent(e)}/hash-sync`,{}),await Fs(q,Y);const t=await n(`proposals/${encodeURIComponent(q)}/entities/${encodeURIComponent(e)}`);ae(t),de(null!==(s=t.decisions)&&void 0!==s?s:{})}catch(e){ve(e?.message||"Failed to store import hash.")}finally{Pe(!1),Fe("")}}},[q,Y,Fs]),vt=(0,e.useCallback)(()=>{re(!1)},[]),mt=(0,e.useCallback)(()=>{q&&(He(null),Le(null),Ge("full"),Xe(!1),Je(!0))},[q]),bt=(0,e.useCallback)(()=>{Ee||Je(!1)},[Ee]),ft=(0,e.useCallback)(e=>{es(s=>s.filter(s=>s.id!==e))},[]),gt=(0,e.useCallback)(async()=>{if(q){Je(!1),He(null),Le(null),Me(!0);try{var e,s;const o=await i(`proposals/${encodeURIComponent(q)}/apply`,{mode:qe,ignore_missing_hash:We});Le(o),o.decisions&&J(e=>e.map(e=>e.id===q?{...e,decisions:o.decisions}:e)),o.resolver_decisions&&J(e=>e.map(e=>e.id===q?{...e,resolver_decisions:o.resolver_decisions}:e)),o.status&&J(e=>e.map(e=>e.id===q?{...e,status:o.status}:e));const r=null!==(e=o?.result?.imported)&&void 0!==e?e:0,c=null!==(s=o?.result?.skipped)&&void 0!==s?s:0,d=Array.isArray(o?.result?.errors)?o.result.errors:[],u=(new Date).toISOString(),p=Date.now(),h=[];var t,n,l,a;d.length>0&&h.push(d[0]),o.decisions_cleared&&o.auto_clear_enabled&&h.push("Reviewer decisions cleared."),o.ignore_missing_hash&&h.push("Hash check override enabled."),o.resolver_decisions&&h.push(`Resolver decisions — reuse: ${null!==(t=o.resolver_decisions.reuse)&&void 0!==t?t:0}, map: ${null!==(n=o.resolver_decisions.map)&&void 0!==n?n:0}, download: ${null!==(l=o.resolver_decisions.download)&&void 0!==l?l:0}, skip: ${null!==(a=o.resolver_decisions.skip)&&void 0!==a?a:0}`),"closed"===o.status&&h.push("Proposal marked closed."),es(e=>[...e,{id:p,severity:d.length?"warning":"success",title:`Applied ${rt?.title||q}`,message:`Imported ${r} · Skipped ${c}`,detail:h.join(" "),timestamp:u}]),ts(e=>{var s,t;return[{id:p,timestamp:u,proposalId:q,proposalTitle:rt?.title||q,mode:null!==(s=o.mode)&&void 0!==s?s:qe,imported:r,skipped:c,errors:d,decisionsCleared:Boolean(o.decisions_cleared&&o.auto_clear_enabled),ignoreMissingHash:Boolean(o.ignore_missing_hash),resolverDecisions:null!==(t=o.resolver_decisions)&&void 0!==t?t:null},...e].slice(0,10)}),ie(null),re(!1),ae(null),de({}),pe({});const v=await Fs(q,Y);v.length&&(ie(v[0].vf_object_uid),re(!0)),await st(q)}catch(e){const s=e?.message||"Apply request failed.";He(s);const t=(new Date).toISOString(),n=Date.now(),i=[s];We&&i.push("Hash check override requested."),es(e=>[...e,{id:n,severity:"warning",title:`Apply failed (${rt?.title||q})`,message:s,detail:i.join(" "),timestamp:t}]),ts(e=>[{id:n,timestamp:t,proposalId:q,proposalTitle:rt?.title||q,mode:qe,imported:0,skipped:0,errors:[s],decisionsCleared:!1,ignoreMissingHash:We},...e].slice(0,10))}finally{Me(!1)}}},[q,qe,Fs,Y,st,rt,We]),jt=(0,e.useCallback)(async(e,s)=>{if(q&&ne){ve(null),pe(s=>({...s,[e]:!0}));try{var t,n;const l=await i(`proposals/${encodeURIComponent(q)}/entities/${encodeURIComponent(ne)}/selections`,{path:e,action:s}),a=null!==(t=l.decisions)&&void 0!==t?t:{},o=null!==(n=l.summary)&&void 0!==n?n:null;de(a),ae(e=>{var s;return e?{...e,decisions:a,decision_summary:null!=o?o:e.decision_summary,new_entity_decision:null!==(s=a[p])&&void 0!==s?s:e.new_entity_decision}:e}),Q(e=>e.map(e=>{var s;return e.vf_object_uid===ne?{...e,decision_summary:null!=o?o:e.decision_summary,new_entity_decision:null!==(s=a[p])&&void 0!==s?s:e.new_entity_decision}:e})),l.proposal_summary&&J(e=>e.map(e=>e.id===q?{...e,decisions:l.proposal_summary}:e))}catch(e){ve(e.message)}finally{pe(s=>{const t={...s};return delete t[e],t})}}},[q,ne]),xt=(0,e.useCallback)(async(e,s)=>{if(q){as(null),is(s=>({...s,[e]:!0}));try{var t;const n=await i(`proposals/${encodeURIComponent(q)}/resolver/${encodeURIComponent(e)}`,s);return tt(e,null!==(t=n.decision)&&void 0!==t?t:null),n}catch(e){throw as(e.message),e}finally{is(s=>{const t={...s};return delete t[e],t})}}},[q,tt]),_t=(0,e.useCallback)(async(e,s)=>{await xt(e,s)},[xt]),yt=(0,e.useCallback)(async(e,s="proposal")=>{if(q){as(null),is(s=>({...s,[e]:!0}));try{var t;const n=await l(`proposals/${encodeURIComponent(q)}/resolver/${encodeURIComponent(e)}?scope=${encodeURIComponent(s)}`);tt(e,null!==(t=n.decision)&&void 0!==t?t:null)}catch(e){as(e.message)}finally{is(s=>{const t={...s};return delete t[e],t})}}},[q,tt]),wt=(0,e.useCallback)(async(e,s)=>{const t=e.reason||"";if(!t||!zs.length)return;const n=zs.filter(s=>s.original_id!==e.original_id&&(s.reason||"")===t);if(n.length){if(window.confirm(`Apply this ${s.action} decision to ${n.length} other conflict(s) with reason "${t}"?`))try{await Promise.all(n.map(e=>xt(e.original_id,s)))}catch(e){}}else window.alert("No similar conflicts found to apply this decision to.")},[zs,xt]),Ct=(0,e.useCallback)(async()=>{if(q&&ne&&window.confirm("Clear all Accept/Keep choices for this entity?")){ve(null),rs(!0),pe({});try{var e,s;const t=await i(`proposals/${encodeURIComponent(q)}/entities/${encodeURIComponent(ne)}/selections`,{action:"clear_all"}),n=null!==(e=t.decisions)&&void 0!==e?e:{},l=null!==(s=t.summary)&&void 0!==s?s:null;de(n),ae(e=>e?{...e,decisions:n,decision_summary:null!=l?l:e.decision_summary}:e),Q(e=>e.map(e=>e.vf_object_uid===ne?{...e,decision_summary:null!=l?l:e.decision_summary}:e)),t.proposal_summary&&J(e=>e.map(e=>e.id===q?{...e,decisions:t.proposal_summary}:e))}catch(e){ve(e.message)}finally{rs(!1)}}},[q,ne]),kt=(0,e.useCallback)(async()=>{if(q&&ne){ds(!0),ve(null);try{var e,s;const t=null!==(e=(await i(`proposals/${encodeURIComponent(q)}/entities/${encodeURIComponent(ne)}/snapshot`,{})).snapshot)&&void 0!==e?e:null;t&&ae(e=>e?{...e,current:t,current_source:"snapshot"}:e);const l=await n(`proposals/${encodeURIComponent(q)}/entities/${encodeURIComponent(ne)}`);ae(l),de(null!==(s=l.decisions)&&void 0!==s?s:{}),Q(e=>e.map(e=>{var s;return e.vf_object_uid===ne?{...e,decision_summary:null!==(s=l.decision_summary)&&void 0!==s?s:e.decision_summary}:e}))}catch(e){ve(e.message)}finally{ds(!1)}}},[q,ne]),Nt=(0,e.useCallback)(async()=>{if(q){ps(!0),ve(null);try{var e,s;const l=await n(`proposals/${encodeURIComponent(q)}/entities?status=needs_review`),a=Array.isArray(l.items)?l.items:[],o=a.map(e=>e.vf_object_uid).filter(e=>"string"==typeof e&&e.length>0),r=o.length?{entity_ids:o}:{},c=await i(`proposals/${encodeURIComponent(q)}/snapshot`,r),d=null!==(e=c.captured)&&void 0!==e?e:0,u=null!==(s=c.targets)&&void 0!==s?s:o.length||a.length||0,p=(new Date).toISOString();if(es(e=>[...e,{id:Date.now(),severity:"info",title:"Snapshots captured",message:`Captured ${d}/${u||d} snapshot(s) for proposal ${q}.`,timestamp:p}]),await Fs(q,Y),await st(q),ne){var t;const e=await n(`proposals/${encodeURIComponent(q)}/entities/${encodeURIComponent(ne)}`);ae(e),de(null!==(t=e.decisions)&&void 0!==t?t:{})}}catch(e){ve(e.message)}finally{ps(!1)}}},[q,ne,Y,Fs,st]),St=(0,e.useCallback)(async()=>{if(window.confirm("This will delete all stored backups, snapshots, and reviewer decisions. Continue?")){vs(!0),ve(null);try{await l("maintenance/clear-proposals"),await Ts(),G(null),Q([]),ae(null),X(null),de({}),pe({}),es(e=>[...e,{id:Date.now(),severity:"info",title:"Backups cleared",message:"All proposal backups, snapshots, and decisions have been removed.",timestamp:(new Date).toISOString()}])}catch(e){ve(e.message)}finally{vs(!1)}}},[Ts]),Rt=(0,e.useCallback)(async(e,s)=>{if(!q||!ne||!Array.isArray(s)||0===s.length)return;const t=s.filter(e=>"string"==typeof e&&e.length>0);if(!t.length)return;const n=e=>{var s,t;const n=null!==(s=e.decisions)&&void 0!==s?s:{},i=null!==(t=e.summary)&&void 0!==t?t:null;de(n),ae(e=>e?{...e,decisions:n,decision_summary:null!=i?i:e.decision_summary}:e),Q(e=>e.map(e=>e.vf_object_uid===ne?{...e,decision_summary:null!=i?i:e.decision_summary}:e)),e.proposal_summary&&J(s=>s.map(s=>s.id===q?{...s,decisions:e.proposal_summary}:s))};ve(null),qs(!0),pe(e=>{const s={...e};return t.forEach(e=>{s[e]=!0}),s});try{try{const s=await i(`proposals/${encodeURIComponent(q)}/entities/${encodeURIComponent(ne)}/selections/bulk`,{action:e,paths:t});n(s),pe({})}catch(s){if(404!==s.status)throw s;await(async()=>{for(const s of t){const t=await i(`proposals/${encodeURIComponent(q)}/entities/${encodeURIComponent(ne)}/selections`,{path:s,action:e});n(t),pe(e=>{const t={...e};return delete t[s],t})}})()}}catch(e){ve(e.message)}finally{qs(!1),pe({})}},[q,ne]),Dt=null!==(o=rt?.decisions)&&void 0!==o?o:null,$t=null!==(r=Dt?.total)&&void 0!==r?r:0,It=null!==(c=Dt?.accepted)&&void 0!==c?c:0,At=null!==(d=Dt?.kept)&&void 0!==d?d:0,Et=null!==(u=Dt?.accepted_new)&&void 0!==u?u:0,Mt=null!==(v=Dt?.entities_reviewed)&&void 0!==v?v:0,Ut=null!==(w=rt?.resolver_decisions)&&void 0!==w?w:null,Bt=null!==(C=Ut?.reuse)&&void 0!==C?C:0,Ot=null!==(k=Ut?.map)&&void 0!==k?k:0,Pt=null!==(N=Ut?.download)&&void 0!==N?N:0,Tt=null!==(S=Ut?.skip)&&void 0!==S?S:0,Ft=null!==(D=null!==($=W?.metrics?.unresolved)&&void 0!==$?$:rt?.resolver?.metrics?.unresolved)&&void 0!==D?D:0,Vt=Array.isArray(Ve?.result?.errors)?Ve.result.errors:[],Lt=Vt.length?"notice notice-warning":"notice notice-success",zt=null!==(I=Ve?.result?.imported)&&void 0!==I?I:0,Ht=null!==(A=Ve?.result?.skipped)&&void 0!==A?A:0,Kt=null!==(E=Ve?.result?.media_resolver?.metrics)&&void 0!==E?E:{},Jt=null!==(M=Kt?.unresolved)&&void 0!==M?M:0,qt=null!==(U=Ve?.result?.media_reconcile)&&void 0!==U?U:null,Gt=(0,e.useCallback)(e=>{Ts({focusProposalId:e});const s=(new Date).toISOString(),t=Date.now();es(n=>[...n,{id:t,severity:"success",title:"Proposal uploaded",message:`Bundle registered as ${e}`,timestamp:s}])},[Ts]),Wt=(0,e.useCallback)(e=>{const s=(new Date).toISOString(),t=Date.now();es(n=>[...n,{id:t,severity:"error",title:"Upload failed",message:e,timestamp:s}])},[]);return!fe&&me?(0,t.jsx)("p",{children:"Loading proposals…"}):!fe&&ke?(0,t.jsxs)("p",{className:"dbvc-admin-app-error",children:["Error loading proposals: ",ke]}):(0,t.jsxs)("div",{className:"dbvc-admin-app",onClick:Vs,onMouseDown:Vs,onSubmit:Ls,children:[Ye.length>0&&(0,t.jsx)("div",{className:"dbvc-toasts",children:Ye.map(e=>(0,t.jsxs)("div",{className:`dbvc-toast dbvc-toast--${e.severity}`,children:[(0,t.jsxs)("div",{className:"dbvc-toast__content",children:[(0,t.jsx)("strong",{children:e.title}),(0,t.jsx)("span",{children:e.message}),e.detail&&(0,t.jsx)("small",{children:e.detail}),(0,t.jsx)("small",{className:"dbvc-toast__time",children:a(e.timestamp)})]}),(0,t.jsx)("button",{type:"button",className:"dbvc-toast__dismiss",onClick:()=>ft(e.id),"aria-label":"Dismiss notification",children:"×"})]},e.id))}),(0,t.jsxs)("div",{className:"dbvc-admin-app__header",children:[(0,t.jsx)("h1",{children:"DBVC Proposals"}),(0,t.jsx)(s.Button,{variant:"secondary",onClick:()=>Ts(),disabled:me&&fe,children:me&&fe?"Refreshing…":"Refresh list"}),(0,t.jsx)(s.Button,{variant:"tertiary",onClick:St,disabled:hs,isBusy:hs,children:hs?"Clearing…":"Clear all backups"})]}),(0,t.jsx)(g,{onUploaded:Gt,onError:Wt}),ke&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsxs)("p",{children:["Failed to load proposals: ",ke]})}),(0,t.jsx)(f,{proposals:K,selectedId:q,onSelect:G}),rt&&(0,t.jsxs)("section",{className:"dbvc-admin-app__detail",children:[(0,t.jsx)("h2",{children:rt.title}),(0,t.jsxs)("p",{className:"dbvc-admin-app__detail-meta",children:["Generated: ",a(rt.generated_at)," · Files:"," ",null!==(B=rt.files)&&void 0!==B?B:"—"," · Media: ",null!==(O=rt.media_items)&&void 0!==O?O:"—"," · Status:"," ",(0,t.jsx)("strong",{children:"closed"===rt.status?"Closed":"Open"})," ",(0,t.jsx)("span",{className:"dbvc-badge dbvc-badge--resolver",children:(0,t.jsx)("a",{href:"#dbvc-global-resolver",children:"Global rules enabled"})})]}),De&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsxs)("p",{children:["Resolver error: ",De]})}),_e?(0,t.jsx)("p",{children:"Loading resolver metrics…"}):(0,t.jsx)(j,{resolver:W}),(0,t.jsxs)("div",{className:"dbvc-admin-app__actions",children:[(0,t.jsx)("button",{type:"button",className:"button button-primary",onClick:mt,disabled:Ee||"closed"===rt.status,title:"closed"===rt.status?"Reopen this proposal before applying new changes.":void 0,children:Ee?"Applying…":"Close & Apply Proposal"}),"closed"===rt.status?(0,t.jsxs)("div",{className:"dbvc-admin-app__status-note",children:[(0,t.jsx)("p",{children:"This proposal has been closed. Reopen it to continue reviewing this snapshot."}),(0,t.jsx)("button",{type:"button",className:"button",onClick:()=>ut("draft"),disabled:Ue,children:Ue?"Reopening…":"Reopen proposal"})]}):(0,t.jsx)("p",{className:"description",children:"Applying will close this proposal snapshot. Re-export on the source site for additional changes."}),$t>0&&(0,t.jsxs)("div",{className:"dbvc-decisions",children:[(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--accept",children:[It," accept"]}),Et>0&&(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--new",children:[Et," new"]}),(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--keep",children:[At," keep"]}),(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--reviewed",children:[Mt," reviewed"]})]})]}),ze&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsxs)("p",{children:["Apply failed: ",ze]})}),Ve&&(0,t.jsxs)("div",{className:Lt,children:[(0,t.jsxs)("p",{children:['Applied proposal "',rt?.title||q,'". Mode: ',null!==(P=Ve.mode)&&void 0!==P?P:"full"," · Imported ",zt," · Skipped"," ",Ht,Ve.decisions_cleared&&Ve.auto_clear_enabled?" · Reviewer decisions were cleared.":"",Jt>0&&` · ${Jt} resolver conflict(s) remain.`]}),qt&&(0,t.jsxs)("p",{className:"dbvc-resolver-summary",children:["Media reconciliation — created: ",null!==(T=qt.created)&&void 0!==T?T:0,", unresolved: ",null!==(F=qt.unresolved)&&void 0!==F?F:0]}),Ve.resolver_decisions&&(0,t.jsxs)("p",{className:"dbvc-resolver-summary",children:["Resolver decisions applied — reuse: ",null!==(V=Ve.resolver_decisions.reuse)&&void 0!==V?V:0,", map:"," ",null!==(L=Ve.resolver_decisions.map)&&void 0!==L?L:0,", download: ",null!==(z=Ve.resolver_decisions.download)&&void 0!==z?z:0,", skip:"," ",null!==(H=Ve.resolver_decisions.skip)&&void 0!==H?H:0]}),Vt.length>0&&(0,t.jsx)("ul",{children:Vt.map((e,s)=>(0,t.jsx)("li",{children:e},s))})]}),Ut&&(0,t.jsx)("div",{className:"dbvc-resolver-summary",children:(0,t.jsxs)("span",{children:["Resolver decisions — reuse: ",Bt,", map: ",Ot,", download:"," ",Pt,", skip: ",Tt]})}),ss.length>0&&(0,t.jsxs)("div",{className:"dbvc-apply-history",children:[(0,t.jsx)("h3",{children:"Recent Apply Runs"}),(0,t.jsx)("ul",{children:ss.map(e=>{var s,n,i,l;return(0,t.jsxs)("li",{children:[(0,t.jsx)("strong",{children:a(e.timestamp)})," — Mode ",e.mode," · Imported ",e.imported," · Skipped ",e.skipped,e.errors.length?` · ${e.errors.length} error(s)`:"",e.decisionsCleared?" · Selections cleared":"",e.ignoreMissingHash?" · Hash override":"",e.resolverDecisions?` · Resolver decisions (reuse ${null!==(s=e.resolverDecisions.reuse)&&void 0!==s?s:0}, map ${null!==(n=e.resolverDecisions.map)&&void 0!==n?n:0}, download ${null!==(i=e.resolverDecisions.download)&&void 0!==i?i:0}, skip ${null!==(l=e.resolverDecisions.skip)&&void 0!==l?l:0})`:""]},e.id)})})]}),Ke&&(0,t.jsxs)(s.Modal,{title:`Apply proposal "${rt?.title||q}"`,onRequestClose:bt,isDismissible:!Ee,shouldCloseOnClickOutside:!Ee,children:[(0,t.jsxs)("div",{className:"dbvc-apply-modal__summary",children:[(0,t.jsx)("p",{children:"This will run the import pipeline for the selected proposal using the chosen mode."}),(0,t.jsx)("p",{className:"dbvc-apply-modal__warning",children:"Applying closes this proposal snapshot. To continue reviewing additional entities, export a new proposal after this step or reopen if necessary."}),$t>0?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("p",{children:"Reviewer selections captured:"}),(0,t.jsxs)("ul",{children:[(0,t.jsxs)("li",{children:[It," field(s) marked Accept"]}),Et>0&&(0,t.jsxs)("li",{children:[Et," new entity approval(s)"]}),(0,t.jsxs)("li",{children:[At," field(s) kept as-is"]}),(0,t.jsxs)("li",{children:[Mt," entity row(s) touched"]})]}),(0,t.jsx)("p",{className:"description",children:"Only fields marked Accept will overwrite live data. Other fields remain unchanged."})]}):(0,t.jsx)("p",{className:"dbvc-apply-modal__warning",children:"No reviewer selections have been recorded. Applying now only imports entities with Accept/Keep selections or new posts you marked “Accept & import.” All other entities are skipped."})]}),(0,t.jsx)(s.RadioControl,{label:"Import mode",selected:qe,options:[{label:"Full import (copy entire proposal)",value:"full"},{label:"Partial import (skip unchanged items when hashes match)",value:"partial"}],onChange:e=>Ge(e)}),(0,t.jsxs)("div",{className:"dbvc-apply-mode-help",children:[(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:"Full import (recommended):"})," Applies only the fields you accepted, records the close-out, and leaves untouched entities for the next export."]}),(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:"Partial import (legacy):"})," Only needed for old proposals missing import hashes. Behavior otherwise matches full import."]})]}),"partial"===qe&&(0,t.jsx)(s.CheckboxControl,{label:"Ignore missing import hash validation",checked:We,onChange:e=>Xe(e),help:"Use only for legacy backups that predate import hash support. Recommended to resolve hash mismatches when possible."}),(0,t.jsx)("p",{className:"description",children:"Selections will be cleared automatically after a successful apply if the auto-clear setting is enabled in Configure → Import."}),(0,t.jsxs)("div",{className:"dbvc-apply-modal__footer",children:[(0,t.jsx)(s.Button,{variant:"secondary",onClick:bt,disabled:Ee,children:"Cancel"}),(0,t.jsx)(s.Button,{variant:"primary",onClick:gt,isBusy:Ee,disabled:Ee,children:"Close & Apply Proposal"})]})]}),(0,t.jsxs)("div",{className:"dbvc-entities-header",children:[(0,t.jsx)("h3",{children:"Entities"}),js&&(0,t.jsx)("span",{className:"dbvc-duplicates-loading",children:"Checking duplicates…"})]}),_s&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsxs)("p",{children:["Failed to load duplicate summary: ",_s]})}),(0,t.jsxs)("div",{className:"dbvc-admin-app__filters",children:[(0,t.jsxs)("label",{children:["Show: ",(0,t.jsxs)("select",{value:Y,onChange:e=>{ee(e.target.value)},children:[(0,t.jsx)("option",{value:"all",children:h.all}),(0,t.jsx)("option",{value:"needs_review",children:h.needs_review}),(0,t.jsx)("option",{value:"needs_review_media",children:h.needs_review_media}),(0,t.jsx)("option",{value:"resolved",children:h.resolved}),(0,t.jsx)("option",{value:"new_entities",children:h.new_entities}),(0,t.jsx)("option",{value:"with_decisions",children:h.with_decisions})]})]}),(0,t.jsxs)("label",{children:[" Search: ",(0,t.jsx)("input",{type:"search",value:se,onChange:e=>{te(e.target.value)},placeholder:"Title, type, path…"})]})]}),rt&&(0,t.jsxs)("div",{className:"dbvc-entity-actions",children:[Es.size>0&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.Button,{className:"dbvc-new-entities-accept-button",variant:"primary",onClick:Ys,disabled:Ds,isBusy:Ds,children:Ds?"Accepting selected…":`Accept ${Es.size} selected`}),(0,t.jsx)(s.Button,{variant:"secondary",onClick:et,disabled:Is,isBusy:Is,children:Is?"Unaccepting…":"Unaccept selected"})]}),ot&&(0,t.jsx)(s.Button,{className:"dbvc-new-entities-accept-button",variant:"primary",onClick:Qs,disabled:Ss,isBusy:Ss,children:Ss?"Accepting…":`Accept all new posts (${at.length})`}),ot&&(0,t.jsxs)(s.Button,{className:"dbvc-new-entities-button",variant:"secondary",onClick:()=>{ee("new_entities"),te("")},children:["Review ",at.length," new post",1===at.length?"":"s"]}),Es.size>0&&(0,t.jsx)(s.Button,{variant:"tertiary",onClick:Xs,children:"Clear selection"}),0===Es.size&&Z.length>0&&(0,t.jsxs)(s.Button,{variant:"tertiary",onClick:Zs,children:["Select all (",Z.length,")"]}),fs.count>0&&(0,t.jsxs)(s.Button,{variant:"primary",className:"dbvc-duplicates-button",onClick:()=>Cs(!0),children:["Resolve ",fs.count," duplicate",1===fs.count?"":"s"]}),(0,t.jsx)(s.Button,{variant:"secondary",onClick:Nt,disabled:us,isBusy:us,children:us?"Capturing snapshots…":"Capture Full Snapshot"}),lt.length>0&&(0,t.jsx)(s.Button,{variant:"secondary",onClick:pt,disabled:Oe&&"bulk"===Te,isBusy:Oe&&"bulk"===Te,children:Oe&&"bulk"===Te?"Storing hashes…":`Store hashes for ${lt.length} entity hash${1===lt.length?"":"es"}`}),(0,t.jsxs)("p",{className:"description",children:["Captures current-state JSON for ",Ft>0?`${Ft} unresolved`:"all"," entity(ies) so the diff shows live vs. proposed."]}),lt.length>0&&(0,t.jsx)("p",{className:"description",children:"Some entities are missing their stored import hash. Sync them to prevent repeat reviews across environments."})]}),(0,t.jsxs)("div",{className:"dbvc-column-toggle",children:[(0,t.jsx)("span",{children:"Columns:"}),b.map(e=>(0,t.jsxs)("label",{children:[(0,t.jsx)("input",{type:"checkbox",checked:ms[e.id],onChange:()=>Bs(e.id),disabled:e.lockVisible}),e.label]},e.id))]}),Se&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsxs)("p",{children:["Failed to load entities: ",Se]})}),(0,t.jsxs)("div",{className:"dbvc-entity-table-wrapper",children:[fs.count>0&&(0,t.jsx)("button",{type:"button",className:"dbvc-duplicates-overlay",onClick:()=>Cs(!0),title:"Resolve duplicate manifest entries before continuing.",children:"Duplicate manifest entries detected — resolve these first"}),(0,t.jsx)(x,{entities:nt,loading:je,selectedEntityId:ne,onSelect:dt,columns:Us,selectedIds:Es,onToggleSelection:Gs,onToggleSelectionAll:Ws})]}),(0,t.jsx)(R,{}),(0,t.jsx)(_,{entityDetail:le,resolverInfo:it?.resolver,resolverDecisionSummary:rt?.resolver_decisions,decisions:ce,onDecisionChange:jt,onBulkDecision:Rt,onResetDecisions:Ct,onCaptureSnapshot:kt,onResolverDecision:_t,onResolverDecisionReset:yt,onApplyResolverDecisionToSimilar:wt,savingPaths:ue,bulkSaving:Js,resolverSaving:ns,resolverError:ls,decisionError:he,loading:we,error:Ie,filterMode:Ze,onFilterModeChange:Qe,isOpen:oe,onClose:vt,resettingDecisions:os,snapshotCapturing:cs,onHashSync:ht,hashSyncing:Oe,hashSyncTarget:Te}),(0,t.jsx)(y,{open:ws,onClose:()=>Cs(!1),onRefresh:Hs,onMarkCanonical:Ks,actionKey:ks,report:fs})]})]})},C=()=>{const s=document.getElementById("dbvc-admin-app-root");s&&(0,e.render)((0,t.jsx)(w,{}),s)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",C):C();const k=({section:s,decisions:n,onDecisionChange:i,savingPaths:l})=>{const[a,d]=(0,e.useState)(!0);return(0,t.jsxs)("div",{className:"dbvc-admin-app__diff-section",id:`dbvc-diff-${s.key}`,children:[(0,t.jsxs)("button",{type:"button",className:"dbvc-admin-app__diff-toggle",onClick:()=>d(e=>!e),"aria-expanded":a,children:[(0,t.jsx)("h4",{children:s.label}),(0,t.jsx)("span",{children:a?"Collapse":"Expand"})]}),a?(0,t.jsxs)("table",{className:"widefat dbvc-admin-app__diff-table",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{style:{width:"25%"},children:"Field"}),(0,t.jsx)("th",{children:"Current"}),(0,t.jsx)("th",{children:"Proposed"}),(0,t.jsx)("th",{style:{width:"20%"},children:"Decision"})]})}),(0,t.jsx)("tbody",{children:s.items.map(e=>{var s;const a=((e,s)=>{const t=r(e),n=r(s);if(t===n)return null;if(t.length>5e3||n.length>5e3)return null;const i=Math.min(t.length,n.length);let l=0;for(;l<i&&t[l]===n[l];)l++;let a=t.length-1,o=n.length-1;for(;a>=l&&o>=l&&t[a]===n[o];)a--,o--;return{old:{before:t.slice(0,l),diff:t.slice(l,a+1),after:t.slice(a+1)},new:{before:n.slice(0,l),diff:n.slice(l,o+1),after:n.slice(o+1)}}})(e.from,e.to),d=null!==(s=n?.[e.path])&&void 0!==s?s:"",u=!!l[e.path],p=["dbvc-diff-row"];return"accept"===d?p.push("is-accepted"):"keep"===d?p.push("is-kept"):p.push("is-unreviewed"),(0,t.jsxs)("tr",{className:p.join(" "),children:[(0,t.jsx)("td",{children:(0,t.jsxs)("div",{className:"dbvc-field-label",children:[e.label||e.path,e.path&&(0,t.jsx)("div",{className:"dbvc-field-label__key",children:e.path})]})}),(0,t.jsx)("td",{children:a&&a.old.diff?c(a.old):o(e.from)}),(0,t.jsx)("td",{children:a&&a.new.diff?c(a.new):o(e.to)}),(0,t.jsxs)("td",{children:[(0,t.jsxs)("div",{className:"dbvc-decision-controls",children:[(0,t.jsxs)("div",{className:"dbvc-decision-options",children:[(0,t.jsxs)("label",{children:[(0,t.jsx)("input",{type:"radio",name:`decision-${e.path}`,value:"keep",checked:"keep"===d,disabled:u,onChange:()=>i&&i(e.path,"keep")}),"Keep"]}),(0,t.jsxs)("label",{children:[(0,t.jsx)("input",{type:"radio",name:`decision-${e.path}`,value:"accept",checked:"accept"===d,disabled:u,onChange:()=>i&&i(e.path,"accept")}),"Accept"]})]}),(0,t.jsx)("button",{type:"button",className:"button-link dbvc-decision-clear",onClick:()=>i&&i(e.path,"clear"),disabled:u||!d,children:"Clear decision"})]}),(0,t.jsxs)("div",{className:"dbvc-decision-state",children:[(0,t.jsx)("span",{className:"dbvc-decision-status",children:"accept"===d?"Accepted":"keep"===d?"Kept":"Not reviewed"}),u&&(0,t.jsx)("span",{className:"saving",children:"Saving…"})]})]})]},e.path)})})]}):(0,t.jsxs)("div",{className:"dbvc-admin-app__no-diff",children:["Collapsed (",s.items.length," changes)."]})]})},N=({src:e,label:s})=>(0,t.jsxs)("div",{className:"dbvc-resolver-inline-preview",children:[e?(0,t.jsx)("img",{src:e,alt:"",className:"dbvc-resolver-inline-preview__image",loading:"lazy"}):(0,t.jsx)("span",{className:"dbvc-resolver-inline-preview__placeholder",children:"—"}),(0,t.jsx)("span",{className:"dbvc-resolver-inline-preview__label",children:null!=s?s:"—"})]}),S=({attachment:s,saving:n,onSave:i,onClear:l,onApplyToSimilar:a})=>{var o,r;const c=s.original_id,[d,u]=(0,e.useState)(s.decision?.action||""),[p,h]=(0,e.useState)(s.decision?.target_id?String(s.decision.target_id):""),[m,b]=(0,e.useState)(s.decision?.note||""),[f,g]=(0,e.useState)("global"===s.decision?.scope);(0,e.useEffect)(()=>{u(s.decision?.action||""),h(s.decision?.target_id?String(s.decision.target_id):""),b(s.decision?.note||""),g("global"===s.decision?.scope)},[s.decision]);const j="reuse"===d||"map"===d,x=parseInt(p,10),_=d&&(!j||x>0);return(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{children:v(s.status||"unknown")}),(0,t.jsx)("td",{children:(0,t.jsx)(N,{src:s.preview?.proposed,label:c})}),(0,t.jsx)("td",{children:(0,t.jsx)(N,{src:s.preview?.local,label:null!==(o=s.target_id)&&void 0!==o?o:"—"})}),(0,t.jsx)("td",{children:null!==(r=s.reason)&&void 0!==r?r:"—"}),(0,t.jsx)("td",{children:(0,t.jsxs)("div",{className:"dbvc-resolver-controls",children:[(0,t.jsxs)("select",{value:d,onChange:e=>u(e.target.value),children:[(0,t.jsx)("option",{value:"",children:"Select…"}),(0,t.jsx)("option",{value:"reuse",children:"Reuse existing"}),(0,t.jsx)("option",{value:"download",children:"Download new"}),(0,t.jsx)("option",{value:"map",children:"Map to attachment ID"}),(0,t.jsx)("option",{value:"skip",children:"Skip"})]}),j&&(0,t.jsx)("input",{type:"number",min:"1",placeholder:"Attachment ID",value:p,onChange:e=>h(e.target.value)}),(0,t.jsx)("textarea",{value:m,onChange:e=>b(e.target.value),placeholder:"Optional note",rows:2}),(0,t.jsxs)("label",{children:[(0,t.jsx)("input",{type:"checkbox",checked:f,onChange:e=>g(e.target.checked)})," ","Remember for future proposals"]})]})}),(0,t.jsxs)("td",{children:[(0,t.jsx)("button",{type:"button",className:"button button-primary",disabled:!_||n,onClick:()=>i&&i(c,{action:d,target_id:j?x:null,note:m,persist_global:f}),children:n?"Saving…":"Save"}),s.decision&&(0,t.jsx)("button",{type:"button",className:"button-link-delete",onClick:()=>l&&l(c,"global"===s.decision.scope?"global":"proposal"),disabled:n,children:"Clear"}),s.decision&&s.reason&&a&&(0,t.jsx)("button",{type:"button",className:"button-link",onClick:()=>{var e,t;return a(s,{action:s.decision?.action,target_id:null!==(e=s.decision?.target_id)&&void 0!==e?e:null,note:null!==(t=s.decision?.note)&&void 0!==t?t:"",persist_global:"global"===s.decision?.scope})},disabled:n,children:"Apply to similar"})]})]})},R=()=>{const[s,o]=(0,e.useState)([]),[r,c]=(0,e.useState)(!0),[d,u]=(0,e.useState)(null),[p,h]=(0,e.useState)(0),[v,m]=(0,e.useState)({}),[b,f]=(0,e.useState)(!1),[g,j]=(0,e.useState)(!1),[x,_]=(0,e.useState)(null),[y,w]=(0,e.useState)({original_id:"",action:"",target_id:"",note:""}),[C,k]=(0,e.useState)(""),[N,S]=(0,e.useState)(!1),[R,D]=(0,e.useState)(!0),[$,I]=(0,e.useState)(!1),[A,E]=(0,e.useState)({imported:0,errors:[]}),M=(0,e.useRef)(null),[U,B]=(0,e.useState)(""),O=(0,e.useRef)(""),P=(0,e.useMemo)(()=>{if(!U)return s;const e=U.toLowerCase();return s.filter(s=>[s.original_id,s.action,s.note,s.target_id,s.saved_at].filter(Boolean).map(e=>String(e).toLowerCase()).some(s=>s.includes(e)))},[U,s]),T=s.length>0,F=P.length>0,V=(Object.values(v).some(Boolean),!x&&y.original_id&&s.some(e=>String(e.original_id)===String(y.original_id))),L=("reuse"===y.action||"map"===y.action)&&y.target_id&&s.some(e=>String(e.original_id)!==String(y.original_id)&&e.target_id&&Number(e.target_id)===Number(y.target_id));(0,e.useEffect)(()=>{if(!O.current){const e=s.find(e=>e.target_id);e&&(O.current=String(e.target_id))}},[s]),(0,e.useEffect)(()=>{let e=!0;return(async()=>{c(!0),u(null);try{const t=await n("resolver-rules");var s;e&&o(null!==(s=t.rules)&&void 0!==s?s:[])}catch(s){e&&u(s.message)}finally{e&&c(!1)}})(),()=>{e=!1}},[p]);const z=(e=null)=>{var s,t,n;e?(_(e),w({original_id:String(null!==(s=e.original_id)&&void 0!==s?s:""),action:null!==(t=e.action)&&void 0!==t?t:"",target_id:e.target_id?String(e.target_id):"",note:null!==(n=e.note)&&void 0!==n?n:""})):(_(null),w({original_id:"",action:"",target_id:O.current||"",note:""})),k(""),j(!0)},H=()=>{j(!1),k(""),_(null)},K=(e,s)=>{w(t=>{const n={...t,[e]:s};return"action"===e&&("reuse"===s||"map"===s?!n.target_id&&O.current&&(n.target_id=O.current):n.target_id=""),n})};return(0,t.jsxs)("section",{className:"dbvc-resolver-rules",id:"dbvc-global-resolver",children:[(0,t.jsxs)("div",{className:"dbvc-resolver-rules__header",children:[(0,t.jsx)("h2",{children:"Global Resolver Rules"}),(0,t.jsx)("button",{type:"button",className:"button button-link",onClick:()=>D(e=>!e),children:R?"Show rules":"Hide rules"})]}),(0,t.jsx)("p",{className:"description",children:"Decisions saved with “remember for future proposals” appear here. They apply automatically whenever a matching original media ID is detected in any proposal."}),!R&&(0,t.jsxs)(t.Fragment,{children:[r&&(0,t.jsx)("p",{children:"Loading resolver rules…"}),d&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsx)("p",{children:d})}),!r&&!T&&(0,t.jsx)("p",{children:"No global rules saved yet."}),T&&(0,t.jsx)("div",{className:"dbvc-panel-search",children:(0,t.jsxs)("label",{children:["Search: ",(0,t.jsx)("input",{type:"search",value:U,onChange:e=>B(e.target.value),placeholder:"ID, action, note…"})]})}),!r&&T&&!F&&(0,t.jsxs)("p",{children:["No rules match “",U,"”."]}),!r&&F&&(0,t.jsxs)("table",{className:"widefat striped",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:(0,t.jsx)("input",{type:"checkbox",checked:b,onChange:()=>{const e=!b;if(f(e),e){const e={};s.forEach(s=>{e[s.original_id]=!0}),m(e)}else m({})}})}),(0,t.jsx)("th",{children:"Original ID"}),(0,t.jsx)("th",{children:"Action"}),(0,t.jsx)("th",{children:"Target"}),(0,t.jsx)("th",{children:"Note"}),(0,t.jsx)("th",{children:"Saved"}),(0,t.jsx)("th",{})]})}),(0,t.jsx)("tbody",{children:P.map(e=>{var s,n;return(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{children:(0,t.jsx)("input",{type:"checkbox",checked:!!v[e.original_id],onChange:()=>{return s=e.original_id,void m(e=>({...e,[s]:!e[s]}));var s}})}),(0,t.jsx)("td",{children:e.original_id}),(0,t.jsx)("td",{children:e.action}),(0,t.jsx)("td",{children:null!==(s=e.target_id)&&void 0!==s?s:"—"}),(0,t.jsx)("td",{children:null!==(n=e.note)&&void 0!==n?n:"—"}),(0,t.jsx)("td",{children:a(e.saved_at)}),(0,t.jsxs)("td",{className:"dbvc-resolver-rules__actions",children:[(0,t.jsx)("button",{type:"button",className:"button-link",onClick:()=>z(e),children:"Edit"}),(0,t.jsx)("button",{type:"button",className:"button-link-delete",onClick:()=>(async e=>{if(window.confirm(`Delete global rule for original ID ${e}?`))try{await l(`resolver-rules/${encodeURIComponent(e)}`),h(e=>e+1)}catch(e){window.alert(e.message)}})(e.original_id),children:"Delete"})]})]},e.original_id)})})]}),(0,t.jsxs)("div",{className:"dbvc-resolver-rules__bulk",children:[(0,t.jsx)("button",{type:"button",className:"button button-primary",onClick:()=>z(null),children:"Add Rule"}),(0,t.jsx)("button",{type:"button",className:"button",onClick:()=>{M.current&&M.current.click()},disabled:$,children:$?"Importing…":"Import CSV"}),(0,t.jsx)("button",{type:"button",className:"button button-secondary",onClick:async()=>{const e=Object.entries(v).filter(([,e])=>e).map(([e])=>e);if(e.length){if(window.confirm(`Delete ${e.length} selected rule(s)?`))try{await i("resolver-rules/bulk-delete",{original_ids:e}),m({}),f(!1),h(e=>e+1)}catch(e){window.alert(e.message)}}else window.alert("Select at least one rule to delete.")},disabled:!Object.values(v).some(Boolean),children:"Delete Selected"}),(0,t.jsx)("button",{type:"button",className:"button button-link",onClick:()=>{const e=["original_id,action,target_id,note,saved_at"].concat(s.map(e=>{var s;return[e.original_id,e.action,null!==(s=e.target_id)&&void 0!==s?s:"",(e.note||"").replace(/"/g,'""'),e.saved_at].join(",")})).join("\n"),t=new Blob([e],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download="dbvc-resolver-rules.csv",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n)},children:"Export CSV"}),(0,t.jsx)("input",{ref:M,type:"file",accept:".csv,text/csv",style:{display:"none"},onChange:async e=>{const s=e.target.files&&e.target.files[0];s&&(await(async e=>{I(!0),E({imported:0,errors:[]});try{var s;const t=(e=>{const s=e.replace(/\r\n/g,"\n").split("\n").map(e=>e.trim()).filter(e=>e.length>0).map(e=>(e=>{const s=[];let t="",n=!1;for(let i=0;i<e.length;i++){const l=e[i];'"'===l?n&&'"'===e[i+1]?(t+='"',i++):n=!n:","!==l||n?t+=l:(s.push(t),t="")}return s.push(t),s})(e));if(!s.length)return[];let t=s[0].map(e=>e.trim().toLowerCase()),n=s.slice(1);t.includes("original_id")||(t=["original_id","action","target_id","note"],n=s);const i=new Set(["original_id","action","target_id","note"]),l=t.map((e,s)=>i.has(e)?e:`col_${s}`);return n.map(e=>{const s={};return l.forEach((t,n)=>{var i;s[t]=null!==(i=e[n])&&void 0!==i?i:""}),s}).map(e=>{const s=parseInt(e.original_id,10),t=parseInt(e.target_id,10);return{original_id:Number.isFinite(s)?s:null,action:(e.action||"").toLowerCase(),target_id:Number.isFinite(t)?t:null,note:e.note||""}}).filter(e=>e.original_id&&e.action)})(await e.text());if(!t.length)return void E({imported:0,errors:["The CSV file does not contain any valid rows."]});const n=await i("resolver-rules/import",{rules:t}),l=n.imported?n.imported.length:0;E({imported:l,errors:null!==(s=n.errors)&&void 0!==s?s:[]}),h(e=>e+1)}catch(e){E({imported:0,errors:[e?.message||"Import failed."]})}finally{I(!1)}})(s),e.target.value="")}})]}),g&&(0,t.jsxs)("form",{className:"dbvc-resolver-rule-form",onSubmit:async e=>{e.preventDefault(),k("");const s=parseInt(y.original_id,10);if(!Number.isFinite(s)||s<=0)return void k("Enter a valid original media ID.");if(!x&&V)return void k("A rule already exists for that original media ID. Choose Edit instead.");if(!y.action)return void k("Select an action for this rule.");const t="reuse"===y.action||"map"===y.action,n=parseInt(y.target_id,10);if(t&&(!Number.isFinite(n)||n<=0))k("Enter a target attachment ID for reuse/map actions.");else if(t&&L)k("This attachment ID is already mapped to another rule.");else{S(!0);try{await i("resolver-rules",{original_id:s,action:y.action,target_id:t?n:null,note:y.note}),h(e=>e+1),t&&Number.isFinite(n)&&n>0&&(O.current=String(n)),H()}catch(e){k(e?.message||"Failed to save rule.")}finally{S(!1)}}},children:[(0,t.jsx)("h3",{children:x?"Edit global rule":"Add global rule"}),(0,t.jsxs)("div",{className:"dbvc-resolver-controls",children:[(0,t.jsx)("input",{type:"number",min:"1",placeholder:"Original ID",value:y.original_id,onChange:e=>K("original_id",e.target.value),readOnly:!!x}),V&&(0,t.jsx)("span",{className:"dbvc-field-hint is-warning",children:"Rule already exists for this media ID."}),(0,t.jsxs)("select",{value:y.action,onChange:e=>K("action",e.target.value),children:[(0,t.jsx)("option",{value:"",children:"Select action…"}),(0,t.jsx)("option",{value:"reuse",children:"Reuse existing"}),(0,t.jsx)("option",{value:"download",children:"Download new"}),(0,t.jsx)("option",{value:"map",children:"Map to attachment ID"}),(0,t.jsx)("option",{value:"skip",children:"Skip"})]}),("reuse"===y.action||"map"===y.action)&&(0,t.jsx)("input",{type:"number",min:"1",placeholder:"Target attachment ID",value:y.target_id,onChange:e=>K("target_id",e.target.value)}),L&&(0,t.jsx)("span",{className:"dbvc-field-hint is-warning",children:"This attachment ID is already used by another rule."}),(0,t.jsx)("textarea",{value:y.note,onChange:e=>K("note",e.target.value),placeholder:"Optional note",rows:2})]}),C&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsx)("p",{children:C})}),(0,t.jsxs)("div",{className:"dbvc-resolver-rule-form__actions",children:[(0,t.jsx)("button",{type:"button",className:"button button-link",onClick:H,children:"Cancel"}),(0,t.jsx)("button",{type:"submit",className:"button button-primary",disabled:N,children:N?"Saving…":x?"Update Rule":"Save Rule"})]})]}),(A.imported>0||A.errors.length>0)&&(0,t.jsxs)("div",{className:"dbvc-resolver-import",children:[A.imported>0&&(0,t.jsx)("div",{className:"notice notice-success",children:(0,t.jsxs)("p",{children:[A.imported," rule(s) imported successfully."]})}),A.errors.length>0&&(0,t.jsxs)("div",{className:"notice notice-warning",children:[(0,t.jsx)("p",{children:"Import completed with warnings:"}),(0,t.jsx)("ul",{children:A.errors.map((e,s)=>(0,t.jsx)("li",{children:e},s))})]})]})]})]})}}},t={};function n(e){var i=t[e];if(void 0!==i)return i.exports;var l=t[e]={exports:{}};return s[e](l,l.exports,n),l.exports}n.m=s,e=[],n.O=(s,t,i,l)=>{if(!t){var a=1/0;for(d=0;d<e.length;d++){for(var[t,i,l]=e[d],o=!0,r=0;r<t.length;r++)(!1&l||a>=l)&&Object.keys(n.O).every(e=>n.O[e](t[r]))?t.splice(r--,1):(o=!1,l<a&&(a=l));if(o){e.splice(d--,1);var c=i();void 0!==c&&(s=c)}}return s}l=l||0;for(var d=e.length;d>0&&e[d-1][2]>l;d--)e[d]=e[d-1];e[d]=[t,i,l]},n.o=(e,s)=>Object.prototype.hasOwnProperty.call(e,s),(()=>{var e={378:0,681:0};n.O.j=s=>0===e[s];var s=(s,t)=>{var i,l,[a,o,r]=t,c=0;if(a.some(s=>0!==e[s])){for(i in o)n.o(o,i)&&(n.m[i]=o[i]);if(r)var d=r(n)}for(s&&s(t);c<a.length;c++)l=a[c],n.o(e,l)&&e[l]&&e[l][0](),e[l]=0;return n.O(d)},t=globalThis.webpackChunkdb_version_control_admin_app=globalThis.webpackChunkdb_version_control_admin_app||[];t.forEach(s.bind(null,0)),t.push=s.bind(null,t.push.bind(t))})();var i=n.O(void 0,[681],()=>n(435));i=n.O(i)})();