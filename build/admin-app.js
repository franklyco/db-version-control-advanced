(()=>{var e,t={766:()=>{(()=>{var e={766:()=>{(()=>{"use strict";var e,t={435:()=>{const e=window.wp.element,t=window.wp.components,s=window.ReactJSXRuntime,n=({content:e,placement:n="top",children:i})=>{const a=t?.Tooltip;return a?(0,s.jsx)(a,{text:e,children:i}):(0,s.jsx)("span",{className:`dbvc-tooltip dbvc-tooltip--${n}`,"data-tooltip":e||"","aria-label":e||"",children:i})},i=async(e,{signal:t}={})=>{const s=await window.fetch(`${DBVC_ADMIN_APP.root}${e}`,{headers:{"X-WP-Nonce":DBVC_ADMIN_APP.nonce},signal:t});if(!s.ok)throw new Error(`Request failed (${s.status})`);return s.json()},a=async(e,t)=>{const s=await window.fetch(`${DBVC_ADMIN_APP.root}${e}`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":DBVC_ADMIN_APP.nonce},body:JSON.stringify(t)});if(!s.ok){const t=await s.text();let n=t;try{n=JSON.parse(t)}catch(e){}const i=new Error(n&&n.message||t||`Request failed (${s.status})`);throw i.status=s.status,i.body=n,i}return s.json()},l=async e=>{const t=await window.fetch(`${DBVC_ADMIN_APP.root}${e}`,{method:"DELETE",headers:{"X-WP-Nonce":DBVC_ADMIN_APP.nonce}});if(!t.ok){const e=await t.text();throw new Error(e||`Request failed (${t.status})`)}return t.json()},o=DBVC_ADMIN_APP?.docs?.masking||(window.location&&window.location.origin?`${window.location.origin.replace(/\/$/,"")}/wp-content/plugins/db-version-control-main/docs/meta-masking.md`:"https://example.com/docs/meta-masking.md"),r=e=>e?`${o}#${e}`:o,c=e=>!!e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof e.then,d=!1,u=new Set,p=e=>{if(!e)return"—";if(c(e))return"[async]";const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString()},h=e=>null==e?"—":c(e)?"[async]":"boolean"==typeof e?e?"true":"false":"number"==typeof e?e.toString():""===e?"(empty)":"string"==typeof e?e:m(e),m=e=>{if(null==e)return"";if(c(e))return d||(d=!0,console.warn("DBVC: Promise detected in entity drawer values. Inspect the data source returning a Promise.",e)),"[async]";if("string"==typeof e)return e;if("number"==typeof e||"boolean"==typeof e)return String(e);try{return JSON.stringify(e,null,2)}catch(t){return String(e)}},v=e=>e&&(e.diff||e.before||e.after)?(0,s.jsxs)(s.Fragment,{children:[e.before&&(0,s.jsx)("span",{children:e.before}),e.diff&&(0,s.jsx)("mark",{children:e.diff||"(empty)"}),e.after&&(0,s.jsx)("span",{children:e.after})]}):null,b=new Set(["post_title","post_name","post_status","post_type","post_excerpt","post_parent","post_author","post_date","post_date_gmt","post_modified","post_modified_gmt","post_password","post_mime_type","post_content_filtered","menu_order","comment_status","ping_status","guid","comment_count"]),f=new Set(["name","term_name","slug","term_slug","description","parent","parent_slug","taxonomy","term_taxonomy"]),g={meta:"Meta",tax:"Taxonomies",media:"Media References",content:"Content",post_fields:"Post Fields",term_fields:"Term Fields",title:"Title",status:"Status",post_type:"Post Type",post_excerpt:"Excerpt",other:"Other"},_="__dbvc_new_entity__",x={all:"All entities",needs_review:"Needs Review",needs_review_media:"Needs Review (Media)",resolved:"Resolved",reused:"Resolved",conflict:"Conflict",needs_download:"Needs Download",missing:"Missing",unknown:"Unknown",new_entities:"New entities",with_decisions:"With selections",uid_mismatch:"UID mismatch"},y={ignore:"Ignore masked field",auto_accept:"Auto-accept & suppress",override:"Override masked value"},j=e=>{const t=x[e]||e;return(0,s.jsx)("span",{className:`dbvc-badge dbvc-badge--${e}`,children:t})},w=e=>Boolean(void 0!==e?.is_new_entity?e.is_new_entity:"missing_local_post"===e?.diff_state?.reason),k=e=>e?.entity_type?e.entity_type:"string"==typeof e?.post_type&&e.post_type.startsWith("term:")?"term":"post",C=e=>{if("term"===k(e)){const t=(e?.term_taxonomy||e?.post_type||"").replace(/^term:/,"");return h(t?`Term (${t})`:"Term")}return h(e?.post_type||"Post")},N=e=>h("term"===k(e)?"Term":e?.post_status||"—"),S=e=>h("term"===k(e)?e?.term_slug||e?.slug||e?.post_name||"—":e?.post_name||"—"),$=e=>{if("term"===k(e)){const t=e?.name||e?.term_name||e?.post_title||"",s=e?.term_taxonomy||e?.taxonomy||"",n=e?.term_slug||e?.slug||e?.post_name||"";if(t)return h(t);if(s&&n)return h(`${s}/${n}`);if(n)return h(n)}return h(e?.post_title||e?.vf_object_uid||"Entity detail")},D=e=>(e||"").toString().trim().toLowerCase(),R=e=>{if("term"===k(e)){return e?.term_taxonomy||e?.taxonomy||("string"==typeof e?.post_type&&e.post_type.startsWith("term:")?e.post_type.replace(/^term:/,""):"term")}return e?.post_type||"post"},A=e=>{const t=$(e);if(t&&"Entity detail"!==t)return t;const s=S(e);return s&&"—"!==s?s:e?.vf_object_uid||""},I=(e,t)=>e.localeCompare(t,void 0,{numeric:!0,sensitivity:"base"}),E=e=>{if(!Array.isArray(e))return[];const t=[...e];return t.sort((e,t)=>{const s="term"===k(e)?1:0,n="term"===k(t)?1:0;if(s!==n)return s-n;const i=I(D(R(e)),D(R(t)));if(i)return i;const a=I(D(A(e)),D(A(t)));return a||(I(D(S(e)),D(S(t)))||I(D(e?.vf_object_uid||""),D(t?.vf_object_uid||"")))}),t},M=[{id:"title",label:"Title",defaultVisible:!0,lockVisible:!0,renderCell:e=>$(e)},{id:"post_name",label:"Slug",defaultVisible:!0,renderCell:e=>(0,s.jsx)("span",{className:"dbvc-text-break",children:S(e)})},{id:"post_type",label:"Type",defaultVisible:!0,renderCell:e=>C(e)},{id:"post_status",label:"Status",defaultVisible:!0,renderCell:e=>N(e)},{id:"post_modified",label:"Last modified",defaultVisible:!0,renderCell:e=>e.post_modified?p(e.post_modified):"—"},{id:"content_hash",label:"Content hash",defaultVisible:!1,renderCell:e=>{var t;return(0,s.jsx)("span",{className:"dbvc-text-break",children:null!==(t=e.content_hash)&&void 0!==t?t:"—"})}},{id:"diff",label:"Diff",defaultVisible:!0,renderCell:(e,t)=>(0,s.jsxs)(s.Fragment,{children:[j(t.diffState.needs_review?"needs_review":"resolved"),t.hashMissing&&(0,s.jsx)("span",{className:"dbvc-badge dbvc-badge--missing",style:{marginLeft:"0.25rem"},children:"Hash missing"}),t.entityHasSelections&&(0,s.jsx)("span",{className:"dbvc-badge dbvc-badge--pending",style:{marginLeft:"0.25rem"},children:"Pending"})]})},{id:"media_refs",label:"Media refs",defaultVisible:!0,renderCell:e=>{var t,s;return(null!==(t=e.media_refs?.meta?.length)&&void 0!==t?t:0)+(null!==(s=e.media_refs?.content?.length)&&void 0!==s?s:0)}},{id:"resolver",label:"Resolver",defaultVisible:!0,renderCell:(e,t)=>{const n=t.isNewEntity,i=t.newDecision||"",a=k(e);let l="term"===a?"New term":"New post";return"accept_new"===i?l="term"===a?"New term accepted":"New post accepted":"decline_new"===i&&(l="term"===a?"New term declined":"New post declined"),(0,s.jsxs)("div",{className:"dbvc-resolver-cell",children:[j(t.mediaStatus),n&&(0,s.jsx)("span",{className:"dbvc-badge dbvc-badge--new"+("decline_new"===i?" is-declined":""),style:{marginLeft:"0.25rem"},children:l})]})}},{id:"unresolved_media",label:"Unresolved media",defaultVisible:!0,renderCell:(e,t)=>{var s;return null!==(s=t.summary.unresolved)&&void 0!==s?s:0}},{id:"meta_diff_count",label:"Unresolved meta",defaultVisible:!0,renderCell:e=>{var t;return null!==(t=e.meta_diff_count)&&void 0!==t?t:0}},{id:"conflicts",label:"Conflicts",defaultVisible:!0,renderCell:(e,t)=>{var s;return null!==(s=t.summary.conflicts)&&void 0!==s?s:0}},{id:"decisions",label:"Decisions",defaultVisible:!0,renderCell:(e,t)=>t.entityHasSelections?(0,s.jsxs)("div",{className:"dbvc-decisions",children:[t.entityAccepted>0&&(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--accept",children:[t.entityAccepted," accept"]}),t.entityNewAccepted>0&&(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--new",children:[t.entityNewAccepted," new"]}),t.entityKept>0&&(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--keep",children:[t.entityKept," keep"]})]}):"—"}],B=({proposals:e,selectedId:n,onSelect:i,onDelete:a,deleteBusyId:l})=>e.length?(0,s.jsx)("div",{className:"dbvc-proposal-table-wrapper",children:(0,s.jsxs)("table",{className:"widefat fixed striped dbvc-proposal-table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Proposal"}),(0,s.jsx)("th",{children:"Generated"}),(0,s.jsx)("th",{children:"Files"}),(0,s.jsx)("th",{children:"Media"}),(0,s.jsx)("th",{children:"Status"}),(0,s.jsx)("th",{children:"Decisions"}),(0,s.jsx)("th",{children:"Resolver reused"}),(0,s.jsx)("th",{children:"Resolver unresolved"}),(0,s.jsx)("th",{children:"Actions"})]})}),(0,s.jsx)("tbody",{children:e.map(e=>{var l,o,r,c,d,u,h,m,v,b,f;const g=null!==(l=e.resolver?.metrics)&&void 0!==l?l:{},_=e.id===n,x=null!==(o=e.decisions)&&void 0!==o?o:{},y=null!==(r=x.accepted)&&void 0!==r?r:0,j=null!==(c=x.kept)&&void 0!==c?c:0,w=null!==(d=x.entities_reviewed)&&void 0!==d?d:0,k=(null!==(u=x.total)&&void 0!==u?u:0)>0,C="closed"===e.status?"Closed":"Open";return(0,s.jsxs)("tr",{className:`${_?"is-active":""} ${"closed"===e.status?"is-archived":""}`,onClick:()=>i(e.id),style:{cursor:"pointer"},children:[(0,s.jsx)("td",{children:e.title}),(0,s.jsx)("td",{children:p(e.generated_at)}),(0,s.jsx)("td",{children:null!==(h=e.files)&&void 0!==h?h:"—"}),(0,s.jsx)("td",{children:null!==(m=e.media_items)&&void 0!==m?m:"—"}),(0,s.jsx)("td",{children:(0,s.jsx)("span",{className:`dbvc-status-badge dbvc-status-badge--${null!==(v=e.status)&&void 0!==v?v:"draft"}`,children:C})}),(0,s.jsx)("td",{children:k?(0,s.jsxs)("div",{className:"dbvc-decisions",children:[(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--accept",children:[y," accept"]}),(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--keep",children:[j," keep"]}),w>0&&(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--reviewed",children:[w," reviewed"]})]}):"—"}),(0,s.jsx)("td",{children:null!==(b=g.reused)&&void 0!==b?b:"—"}),(0,s.jsx)("td",{children:null!==(f=g.unresolved)&&void 0!==f?f:"—"}),(0,s.jsx)("td",{className:"dbvc-proposal-table__actions",children:_?"—":(0,s.jsx)(t.Button,{variant:"tertiary",isDestructive:!0,onClick:t=>{t.stopPropagation(),"function"==typeof a&&a(e.id)},disabled:y===e.id||e.locked,title:e.locked?"Locked proposals cannot be deleted.":void 0,children:y===e.id?"Deleting…":"Delete"})})]},e.id)})})]})}):(0,s.jsx)("p",{children:"No proposals found. Generate an export to get started."}),P=({onUploaded:n,onError:i})=>{const[a,l]=(0,e.useState)(!1),[o,r]=(0,e.useState)(!1),[c,d]=(0,e.useState)(""),[u,p]=(0,e.useState)(""),[h,m]=(0,e.useState)(!1),[v,b]=(0,e.useState)(!1),f=(0,e.useRef)(null),g=(0,e.useCallback)(async e=>{const t=e&&e[0];if(!t)return;const s=new window.FormData;s.append("file",t),s.append("overwrite",h?"1":"0"),v&&s.append("fixture_name",t.name),r(!0),d(""),p("");try{const e=await(async(e,t)=>{const s=await window.fetch(`${DBVC_ADMIN_APP.root}${e}`,{method:"POST",headers:{"X-WP-Nonce":DBVC_ADMIN_APP.nonce},body:t});if(!s.ok){const e=await s.text();throw new Error(e||`Request failed (${s.status})`)}return s.json()})(v?"fixtures/upload":"proposals/upload",s);d(`${v?"Saved dev fixture":"Uploaded"} ${t.name}`),v||"function"!=typeof n||n(e.proposal_id,e)}catch(e){const t=e?.message||"Upload failed.";p(t),"function"==typeof i&&i(t)}finally{r(!1),f.current&&(f.current.value="")}},[h,v,n,i]);return(0,s.jsxs)("div",{className:"dbvc-proposal-uploader",children:[(0,s.jsx)("div",{className:`dbvc-proposal-uploader__dropzone${a?" is-dragging":""}${o?" is-uploading":""}`,onDragOver:e=>{e.preventDefault(),l(!0)},onDragLeave:e=>{e.currentTarget.contains(e.relatedTarget)||l(!1)},onDrop:e=>{e.preventDefault(),l(!1),g(e.dataTransfer?.files)},children:[(0,s.jsxs)("div",{className:"dbvc-proposal-uploader__body",children:[(0,s.jsxs)("div",{className:"dbvc-proposal-uploader__text",children:[(0,s.jsx)("strong",{children:"Upload proposal bundle"}),(0,s.jsx)("p",{children:"Drop a DBVC ZIP export here or select a file to register it."})]}),(0,s.jsxs)("div",{className:"dbvc-proposal-uploader__actions",children:[(0,s.jsx)(t.Button,{variant:"secondary",onClick:()=>f.current?.click(),disabled:o,children:o?"Uploading…":"Select ZIP"}),(0,s.jsx)("span",{className:"dbvc-proposal-uploader__actions-note",children:"ZIP files only"}),(0,s.jsx)("input",{ref:f,type:"file",accept:".zip",style:{display:"none"},onChange:e=>g(e.target.files)})]})]}),(0,s.jsxs)("div",{className:"dbvc-proposal-uploader__options",children:[(0,s.jsx)("div",{className:"dbvc-proposal-uploader__option",children:(0,s.jsx)(t.CheckboxControl,{label:"Replace existing proposal when IDs match",help:"Enable if this upload should refresh an existing proposal folder instead of creating a new one.",checked:h,onChange:e=>m(e),disabled:o})}),(0,s.jsx)("div",{className:"dbvc-proposal-uploader__option",children:(0,s.jsx)(t.CheckboxControl,{label:"Dev upload (store ZIP in docs/fixtures)",help:"Copies the selected ZIP into docs/fixtures for local QA. Disable to register the proposal normally.",checked:v,onChange:e=>b(e),disabled:o})})]})]}),c&&(0,s.jsx)("p",{className:"dbvc-proposal-uploader__status",children:c}),u&&(0,s.jsx)("p",{className:"dbvc-proposal-uploader__error",role:"alert",children:u})]})},O=({resolver:e})=>{var t,n,i,a;if(!e)return(0,s.jsx)("p",{children:"Resolver metrics unavailable."});const{metrics:l={},conflicts:o=[]}=e;return(0,s.jsxs)("div",{className:"dbvc-admin-app__resolver",children:[(0,s.jsx)("h3",{children:"Resolver Summary"}),(0,s.jsxs)("ul",{children:[(0,s.jsxs)("li",{children:["Detected: ",null!==(t=l.detected)&&void 0!==t?t:0]}),(0,s.jsxs)("li",{children:["Reused: ",null!==(n=l.reused)&&void 0!==n?n:0]}),(0,s.jsxs)("li",{children:["Downloaded: ",null!==(i=l.downloaded)&&void 0!==i?i:0]}),(0,s.jsxs)("li",{children:["Unresolved: ",null!==(a=l.unresolved)&&void 0!==a?a:0]}),(0,s.jsxs)("li",{children:["Conflicts: ",o.length]})]}),o.length>0&&(0,s.jsx)("div",{className:"notice notice-warning",children:(0,s.jsxs)("p",{children:["The resolver reported ",o.length," conflict(s). Review before applying."]})})]})},T=({entities:t,loading:n,selectedEntityId:i,onSelect:a,columns:l,selectedIds:o=new Set,onToggleSelection:r,onToggleSelectionAll:c})=>{if(n)return(0,s.jsx)("p",{children:"Loading entities…"});if(!t.length)return(0,s.jsx)("p",{children:"No entities found for this proposal."});const d=l&&l.length?l:M,u="function"==typeof r,p=o instanceof Set?o:new Set(o),h=t.map(e=>e.vf_object_uid),m=u&&t.length>0&&t.every(e=>p.has(e.vf_object_uid)),v=u&&!m&&t.some(e=>p.has(e.vf_object_uid)),b=o,f=(0,e.useRef)(null);return(0,e.useEffect)(()=>{u&&f.current&&(f.current.indeterminate=v)},[u,v]),(0,s.jsx)("div",{className:"dbvc-entity-table",children:(0,s.jsxs)("table",{className:"widefat striped",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[u&&(0,s.jsx)("th",{className:"dbvc-entity-select",children:(0,s.jsx)("input",{type:"checkbox",ref:f,checked:m,onChange:e=>c?.(h,e.target.checked)})}),d.map(e=>(0,s.jsx)("th",{children:e.label},e.id))]})}),(0,s.jsx)("tbody",{children:t.map(e=>{var t,n,l,o,c,h,m,v;const f=e.vf_object_uid===i,g=u&&p.has(e.vf_object_uid),_=null!==(t=e.resolver?.summary)&&void 0!==t?t:{},x=null!==(n=e.diff_state)&&void 0!==n?n:{},y=e.media_needs_review?"needs_review":null!==(l=e.resolver?.status)&&void 0!==l?l:"resolved",j=e.overall_status||(x.needs_review?"needs_review":"resolved"),k="missing_local_hash"===x.reason,C=null!==(o=e.decision_summary)&&void 0!==o?o:{},N=null!==(c=C.accepted)&&void 0!==c?c:0,S=null!==(h=C.kept)&&void 0!==h?h:0,$=null!==(m=C.accepted_new)&&void 0!==m?m:0,D=(null!==(v=C.total)&&void 0!==v?v:0)>0,R=w(e),A=e.new_entity_decision||"",I=e.identity_match||"",E=[`resolver-${j}`,f?"is-active":"",g?"is-selected":""].filter(Boolean).join(" "),M=t=>{t.preventDefault(),t.stopPropagation(),a(e.vf_object_uid)},B={summary:_,diffState:x,mediaStatus:y,hashMissing:k,decisionSummary:C,entityHasSelections:D,entityAccepted:N,entityNewAccepted:$,entityKept:S,isNewEntity:R,newDecision:A,identityMatch:I};return(0,s.jsxs)("tr",{className:E,onClick:M,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||M(e)},style:{cursor:"pointer"},role:"button",tabIndex:0,children:[u&&(0,s.jsx)("td",{className:"dbvc-entity-select",children:(0,s.jsx)("input",{type:"checkbox",checked:g,onChange:t=>{t.stopPropagation(),r?.(e.vf_object_uid)},onClick:e=>e.stopPropagation()})}),d.map(t=>{var n;return(0,s.jsx)("td",{children:t.renderCell?t.renderCell(e,B):null!==(n=e[t.id])&&void 0!==n?b(n):"—"},t.id)})]},e.vf_object_uid)})})]})})},U=({entityDetail:n,resolverInfo:i,resolverDecisionSummary:a=null,decisions:l={},onDecisionChange:o,onBulkDecision:r,onResetDecisions:c,onCaptureSnapshot:d,onResolverDecision:u,onResolverDecisionReset:p,onApplyResolverDecisionToSimilar:h,savingPaths:m={},bulkSaving:v=!1,resolverSaving:x={},resolverError:j=null,decisionError:N,loading:D,error:R,onClose:A,filterMode:I,onFilterModeChange:E,isOpen:M=!0,resettingDecisions:B=!1,snapshotCapturing:P=!1,onHashSync:O,hashSyncing:T=!1,hashSyncTarget:U="",maskFieldsByEntity:F={}})=>{var L,V,z,J,H,W,G,X,Z,Q,Y,ee,te,se,ne;const ie=(0,e.useMemo)(()=>n?.item?.vf_object_uid?`dbvc-entity-detail-${n.item.vf_object_uid}`:n?.vf_object_uid?`dbvc-entity-detail-${n.vf_object_uid}`:"dbvc-entity-detail",[n]),ae=(0,e.useRef)(null),le=(0,e.useRef)(null);(0,e.useEffect)(()=>{if(!A||!M)return;le.current=document.activeElement instanceof HTMLElement?document.activeElement:null;const e=ae.current;e&&e.focus();const t=e=>{"Escape"===e.key&&(e.preventDefault(),A())};return document.addEventListener("keydown",t),()=>{document.removeEventListener("keydown",t),le.current&&"function"==typeof le.current.focus&&le.current.focus()}},[M,A,ie]);const{item:oe,current:re,proposed:ce={},diff:de}=null!=n?n:{},ue=null!==(L=n?.decision_summary)&&void 0!==L?L:{},pe=null!==(V=null!==(z=n?.diff_state)&&void 0!==z?z:oe?.diff_state)&&void 0!==V?V:null,he=((e,t)=>{if(!t)return"";if("term"===k(e)){const s=e?.term_taxonomy||e?.taxonomy||"";return s?`term.php?taxonomy=${s}&tag_ID=${t}`:`term.php?tag_ID=${t}`}return`post.php?post=${t}&action=edit`})(oe,null!==(J=pe?.local_post_id)&&void 0!==J?J:null),me=$(oe),ve=S(oe),be=(e=>"term"===k(e)?"Term slug:":"Slug:")(oe),fe=k(oe),ge=oe?.term_taxonomy||oe?.taxonomy||"",_e=(C(oe),"missing_local_hash"===pe?.reason),xe=w(null!=n?n:{diff_state:pe}),ye=null!==(H=null!==(W=l?.[_])&&void 0!==W?W:n?.new_entity_decision)&&void 0!==H?H:"",je=Boolean(m?.[_]),we=null!==(G=ue.total)&&void 0!==G?G:0,ke=we>0?`${null!==(X=ue.accepted)&&void 0!==X?X:0} accepted · ${null!==(Z=ue.kept)&&void 0!==Z?Z:0} kept`:"No selections captured yet.",Ce=null!==(Q=de?.changes)&&void 0!==Q?Q:[],Ne=(0,e.useMemo)(()=>{const e=n?.vf_object_uid||oe?.vf_object_uid||"";return e&&F[e]?F[e]:[]},[F,n,oe]),Se=(0,e.useMemo)(()=>{if("all"!==I)return[];const e=(t,s="")=>{const n={};return t&&"object"==typeof t?(Object.keys(t).forEach(i=>{const a=t[i],l=s?`${s}.${i}`:String(i);a&&"object"==typeof a?Object.assign(n,e(a,l)):n[l]=void 0===a?null:a}),n):n},t=e(re?.meta||{},"meta"),s=e(ce?.meta||{},"meta"),n=new Set([...Object.keys(t),...Object.keys(s)]),i=Array.from(n);return i.sort(),i.map(e=>{const n=Object.prototype.hasOwnProperty.call(t,e)?t[e]:null,i=Object.prototype.hasOwnProperty.call(s,e)?s[e]:null;return{path:e,label:e,section:"meta",from:n,to:i,is_equal:r(n)===r(i)}})},[I,re,ce]),$e=(0,e.useMemo)(()=>"all"===I?Se:Ce,[Se,Ce,I]),De=(0,e.useMemo)(()=>(e=>{const t={};return e.forEach(e=>{const[s]=e.path.split("."),n=(b.has(s)?"post_fields":f.has(s)?"term_fields":s)||"other";t[n]||(t[n]=[]),t[n].push(e)}),Object.entries(t).map(([e,t])=>({key:e,label:g[e]||e,items:t}))})($e),[$e]),Re=null!==(Y=i?.attachments)&&void 0!==Y?Y:[],[Ae,Ie]=(0,e.useState)(""),Ee=(0,e.useMemo)(()=>{if(!Ae)return Re;const e=Ae.toLowerCase();return Re.filter(t=>{const s=t.descriptor||{};return[t.original_id,t.reason,t.status,t.decision?.note,s.asset_uid,s.bundle_path,s.path].filter(Boolean).join(" ").toLowerCase().includes(e)})},[Re,Ae]),Me="conflicts"===I,Be=Ce.length,Pe=(0,e.useMemo)(()=>Ce.filter(e=>{var t;return"accept"!==(null!==(t=l?.[e.path])&&void 0!==t?t:"")}).length,[Ce,l]),Oe=$e.length,[Te,Ue]=(0,e.useState)(!1),[Fe,Le]=(0,e.useState)(""),[Ve,ze]=(0,e.useState)("reason"),[Je,Ke]=(0,e.useState)(""),[He,qe]=(0,e.useState)(""),[We,Ge]=(0,e.useState)(""),[Xe,Ze]=(0,e.useState)(""),[Qe,Ye]=(0,e.useState)(!1),[et,tt]=(0,e.useState)(!1),[st,nt]=(0,e.useState)("");(0,e.useEffect)(()=>{Te||Le(De[0]?.key||"")},[De,Te]);const it=(0,e.useMemo)(()=>Te||!Fe?De:De.filter(e=>e.key===Fe),[De,Te,Fe]),at=(0,e.useMemo)(()=>{if(Te)return $e;const e=De.find(e=>e.key===Fe);return e?e.items:[]},[Te,$e,De,Fe]),lt=(0,e.useMemo)(()=>at.filter(e=>!e.is_equal).map(e=>e.path).filter(Boolean),[at]),ot=(0,e.useMemo)(()=>{const e=new Set,t=new Set,s=new Set;return Re.forEach(n=>{n.reason&&e.add(n.reason);const i=n.descriptor||{};i.asset_uid&&t.add(i.asset_uid);const a=i.bundle_path||i.path||"";a&&s.add(a)}),{reason:Array.from(e),asset_uid:Array.from(t),bundle_path:Array.from(s)}},[Re]);(0,e.useEffect)(()=>{const e=ot[Ve]||[];e.length?e.includes(Je)||Ke(e[0]||""):Ke("")},[Ve,Je,ot]);const rt="term"===fe&&ge?`${ge}/${ve}`:ve,ct=oe?.term_parent_slug||oe?.parent_slug||ce?.parent_slug||re?.term_parent_slug||re?.parent_slug||"",dt=oe?.term_parent||oe?.parent||ce?.parent||re?.term_parent||re?.parent||0,ut="term"!==fe?null:ct||(oe?.term_parent_uid||ce?.parent_uid||re?.term_parent_uid||"")||(dt?`ID ${dt}`:"—"),pt="term"===fe&&ge?`${me} · ${ge}`:me,ht=(0,e.useMemo)(()=>!Je&&(ot[Ve]||[]).length?[]:Re.filter(e=>{const t=e.descriptor||{};switch(Ve){case"asset_uid":return(t.asset_uid||"")===Je;case"bundle_path":return(t.bundle_path||t.path||"")===Je;default:return(e.reason||"")===Je}}),[Re,Ve,Je,ot]),mt=ht.length,vt="reuse"===He||"map"===He;return A&&!M?null:(e=>{const t=(0,s.jsx)("div",{className:"dbvc-admin-app__entity-detail",children:e});return A?(0,s.jsxs)("div",{className:"dbvc-entity-detail-modal",role:"presentation",children:[(0,s.jsx)("div",{className:"dbvc-entity-detail-modal__overlay",onClick:A,"aria-hidden":"true"}),(0,s.jsx)("div",{className:"dbvc-entity-detail-modal__panel",role:"dialog","aria-modal":"true","aria-labelledby":ie,children:t})]}):t})(D?(0,s.jsx)("p",{children:"Loading entity detail…"}):R?(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)("p",{children:["Failed to load entity detail: ",R]})}):n?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"dbvc-entity-toolbar",children:[(0,s.jsxs)("div",{className:"dbvc-entity-toolbar__meta",children:[(0,s.jsx)("div",{className:"dbvc-entity-toolbar__title",id:ie,children:he?(0,s.jsx)("a",{href:he,target:"_blank",rel:"noreferrer",children:pt}):pt}),(0,s.jsxs)("div",{className:"dbvc-entity-toolbar__sub",children:[(0,s.jsxs)("span",{children:[be," ",he&&"—"!==rt?(0,s.jsx)("a",{href:he,target:"_blank",rel:"noreferrer",children:rt}):rt]}),"term"===fe&&(0,s.jsxs)("span",{children:["Taxonomy: ",ge||"—"]}),"term"===fe&&(0,s.jsxs)("span",{children:["Parent: ",ut||"—"]}),(0,s.jsxs)("span",{children:["File: ",oe?.path||"—"]})]})]}),A&&(0,s.jsx)("button",{type:"button",className:"dbvc-entity-detail__close",onClick:A,"aria-label":"Close entity detail",ref:A?ae:void 0,children:"Close"}),(0,s.jsxs)("div",{className:"dbvc-diff-filter",children:[(0,s.jsx)("span",{children:"View:"}),(0,s.jsx)("button",{type:"button",className:Me?"is-active":"",onClick:()=>E&&E("conflicts"),children:"Conflicts & Resolver"}),(0,s.jsx)("button",{type:"button",className:"full"===I?"is-active":"",onClick:()=>E&&E("full"),children:"Full Overview"}),(0,s.jsx)("button",{type:"button",className:"all"===I?"is-active":"",onClick:()=>E&&E("all"),children:"View All"})]}),(0,s.jsx)("p",{className:"dbvc-entity-toolbar__count",children:Me?`${Pe} field(s) awaiting review · ${Be} total`:"all"===I?`${Oe} meta field(s) shown.`:`${Oe} field(s) shown.`}),_e&&O&&(0,s.jsxs)("div",{className:"notice notice-warning",children:[(0,s.jsx)("p",{children:"This entity is missing its stored import hash. Sync it to prevent repeated reviews."}),(0,s.jsx)("button",{type:"button",className:"button button-secondary",onClick:()=>O(n?.vf_object_uid),disabled:T&&U===n?.vf_object_uid,children:T&&U===n?.vf_object_uid?"Storing hash…":"Store import hash"})]}),(()=>{const e=[];return lt.length>0&&(e.push({key:"accept_all",content:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{type:"button",className:"button button-secondary",onClick:()=>{r&&window.confirm(`Accept ${lt.length} field(s)?`)&&r("accept",lt)},disabled:v,children:v?"Accepting…":"Accept All Visible"}),(0,s.jsx)("p",{className:"description",children:"Applies the bundle values to every field currently listed."})]})}),e.push({key:"keep_all",content:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{type:"button",className:"button",onClick:()=>{r&&window.confirm(`Keep current values for ${lt.length} field(s)?`)&&r("keep",lt)},disabled:v,children:v?"Keeping…":"Keep All Visible"}),(0,s.jsx)("p",{className:"description",children:"Locks in the live values for each visible field without importing."})]})})),"function"==typeof d&&e.push({key:"snapshot",content:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{type:"button",className:"button dbvc-button-inverted",onClick:d,disabled:P||!d,children:P?"Capturing snapshot…":"Capture current snapshot"}),(0,s.jsx)("p",{className:"description",children:`Refreshes the “current” baseline from the live ${"term"===fe?"term":"post"} before you compare.`})]})}),"function"==typeof c&&we>0&&e.push({key:"clear_decisions",content:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{type:"button",className:"button",onClick:c,disabled:B,children:B?"Clearing…":"Clear all decisions"}),(0,s.jsx)("p",{className:"description",children:"Removes every Accept/Keep choice so you can re-evaluate this entity."})]})}),e.length?(0,s.jsx)("div",{className:"dbvc-entity-action-grid",children:e.map(e=>(0,s.jsx)("div",{className:"dbvc-entity-action",children:e.content},e.key))}):null})(),Ne.length>0&&(0,s.jsxs)("section",{className:"dbvc-entity-detail__masking",children:[(0,s.jsx)("h4",{children:"Masked fields"}),(0,s.jsx)("div",{className:"dbvc-mask-field-list",children:Ne.map((e,t)=>{const n=g[e.section]||e.section||"Meta",i=y[e.default_action]||"Masked field",a="dbvc-mask-field__status"+("ignore"===e.default_action?" is-pending":""),l=e.vf_object_uid||"mask";return(0,s.jsxs)("div",{className:"dbvc-mask-field",children:[(0,s.jsxs)("div",{className:"dbvc-mask-field__meta",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:o(e.label||e.meta_path||n)}),(0,s.jsxs)("div",{className:"dbvc-mask-field__label",children:[n,e.meta_path?(0,s.jsx)("code",{children:e.meta_path}):null]})]}),(0,s.jsx)("span",{className:a,children:i})]}),(0,s.jsxs)("div",{className:"dbvc-mask-field__values",children:[(0,s.jsxs)("span",{children:["Proposed: ",o(e.proposed_value)]}),null!=e.current_value?(0,s.jsxs)("span",{children:["Current: ",o(e.current_value)]}):null]})]},`${l}::${e.meta_path||t}`)})})]}),(0,s.jsxs)("p",{className:"dbvc-decision-summary",children:["Selections: ",ke]})]}),xe&&(0,s.jsxs)("div",{className:"dbvc-new-entity-card",children:[(0,s.jsxs)("div",{className:"dbvc-new-entity-card__header",children:[(0,s.jsx)("span",{className:"dbvc-badge dbvc-badge--new",children:"term"===k(oe)?"New term":"New post"}),(0,s.jsx)("span",{className:"dbvc-new-entity-card__status",children:"accept_new"===ye?"Accepted for import":"decline_new"===ye?"Declined — will be skipped":"Pending reviewer decision"})]}),(0,s.jsxs)("p",{children:["This proposal would create a new ","term"===k(oe)?C(oe):oe?.post_type||"post"," on this site. No UID, original ID, or slug match was detected locally, so choose whether to import it."]}),(0,s.jsxs)("div",{className:"dbvc-new-entity-actions",children:[(0,s.jsx)(t.Button,{variant:"accept_new"===ye?"primary":"secondary",onClick:()=>o&&o(_,"accept_new"),disabled:je,isBusy:je&&"accept_new"===ye,children:"Accept & import"}),(0,s.jsx)(t.Button,{variant:"decline_new"===ye?"primary":"secondary",onClick:()=>o&&o(_,"decline_new"),disabled:je,isBusy:je&&"decline_new"===ye,children:"term"===k(oe)?"Decline new term":"Decline new post"}),(0,s.jsx)(t.Button,{variant:"tertiary",onClick:()=>o&&o(_,"clear"),disabled:je||!ye,children:"Clear choice"})]})]}),N&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsx)("p",{children:N})}),De.length>0&&(0,s.jsxs)("div",{className:"dbvc-section-nav",children:[(0,s.jsx)("span",{children:Te?"Sections:":"Jump to:"}),De.map(e=>(0,s.jsx)("button",{type:"button",className:Te||Fe!==e.key?"":"is-active",onClick:()=>{if(Te){const t=document.getElementById(`dbvc-diff-${e.key}`);t&&t.scrollIntoView({behavior:"smooth",block:"start"})}else Le(e.key)},children:e.label},e.key)),(0,s.jsx)("button",{type:"button",className:Te?"is-active":"",onClick:()=>Ue(e=>!e),children:Te?"Focus Section":"Show All"})]}),it.length>0?it.map(e=>(0,s.jsx)(K,{section:e,decisions:l,onDecisionChange:o,savingPaths:m},e.key)):(0,s.jsx)("p",{children:Me&&Be>0?"No resolver or media conflicts detected for this entity. Switch to Full Overview to inspect all differences.":"all"===I?"No meta fields found for this entity.":"No differences detected."}),Re.length>0&&(0,s.jsxs)("div",{className:"dbvc-admin-app__resolver-attachments",children:[(0,s.jsx)("h4",{children:"Media Resolver"}),(0,s.jsx)("div",{className:"dbvc-panel-search",children:(0,s.jsxs)("label",{children:["Search:  ",(0,s.jsx)("input",{type:"search",value:Ae,onChange:e=>Ie(e.target.value),placeholder:"Reason, asset UID, note…"})]})}),a&&(0,s.jsxs)("p",{className:"dbvc-resolver-summary",children:["Saved decisions — reuse: ",null!==(ee=a.reuse)&&void 0!==ee?ee:0,", map: ",null!==(te=a.map)&&void 0!==te?te:0,", download:"," ",null!==(se=a.download)&&void 0!==se?se:0,", skip: ",null!==(ne=a.skip)&&void 0!==ne?ne:0]}),j&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsx)("p",{children:j})}),Ee.length>0?(0,s.jsxs)("table",{className:"widefat",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Status"}),(0,s.jsx)("th",{children:"Original ID"}),(0,s.jsx)("th",{children:"Target"}),(0,s.jsx)("th",{children:"Reason"}),(0,s.jsx)("th",{children:"Decision"}),(0,s.jsx)("th",{style:{width:"160px"},children:"Actions"})]})}),(0,s.jsx)("tbody",{children:Ee.map(e=>(0,s.jsx)(q,{attachment:e,saving:!!x[e.original_id],onSave:u,onClear:p,onApplyToSimilar:h},e.original_id))})]}):(0,s.jsx)("p",{children:"No resolver conflicts match your search."}),(0,s.jsxs)("div",{className:"dbvc-resolver-bulk",children:[(0,s.jsx)("h5",{children:"Bulk Apply Resolver Decision"}),(0,s.jsx)("p",{className:"description",children:"Match a subset of conflicts and apply a single decision without editing rows individually."}),(0,s.jsxs)("div",{className:"dbvc-resolver-bulk__filters",children:[(0,s.jsxs)("label",{children:["Match by",(0,s.jsxs)("select",{value:Ve,onChange:e=>ze(e.target.value),children:[(0,s.jsx)("option",{value:"reason",children:"Reason"}),(0,s.jsx)("option",{value:"asset_uid",children:"Asset UID"}),(0,s.jsx)("option",{value:"bundle_path",children:"Manifest Path"})]})]}),(0,s.jsxs)("label",{children:["Value",(0,s.jsxs)("select",{value:Je,onChange:e=>Ke(e.target.value),disabled:0===(ot[Ve]||[]).length,children:[0===(ot[Ve]||[]).length&&(0,s.jsx)("option",{value:"",children:"No values detected"}),(ot[Ve]||[]).map(e=>(0,s.jsx)("option",{value:e,children:e||"— Not provided —"},e||"blank"))]})]}),(0,s.jsxs)("span",{className:"dbvc-resolver-bulk__count",children:["Matches: ",mt]})]}),(0,s.jsxs)("div",{className:"dbvc-resolver-controls dbvc-resolver-bulk__controls",children:[(0,s.jsxs)("select",{value:He,onChange:e=>qe(e.target.value),children:[(0,s.jsx)("option",{value:"",children:"Select action…"}),(0,s.jsx)("option",{value:"reuse",children:"Reuse existing"}),(0,s.jsx)("option",{value:"download",children:"Download new"}),(0,s.jsx)("option",{value:"map",children:"Map to attachment ID"}),(0,s.jsx)("option",{value:"skip",children:"Skip"})]}),vt&&(0,s.jsx)("input",{type:"number",min:"1",placeholder:"Attachment ID",value:We,onChange:e=>Ge(e.target.value)}),(0,s.jsx)("textarea",{value:Xe,onChange:e=>Ze(e.target.value),placeholder:"Optional note",rows:2}),(0,s.jsxs)("label",{children:[(0,s.jsx)("input",{type:"checkbox",checked:Qe,onChange:e=>Ye(e.target.checked)})," ","Remember as global rule"]})]}),st&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsx)("p",{children:st})}),(0,s.jsx)("button",{type:"button",className:"button button-secondary",onClick:async()=>{if(!He)return void nt("Select an action to apply.");if(vt&&!We)return void nt("Enter a target attachment ID for this action.");if(!mt)return void nt("No matching conflicts were found for the selected filter.");if(!u)return;if(!window.confirm(`Apply this decision to ${mt} conflict(s) matched by ${"reason"===Ve?"reason":"asset_uid"===Ve?"asset UID":"manifest path"}?`))return;tt(!0),nt("");const e={action:He,target_id:vt?Number(We):null,note:Xe,persist_global:Qe};try{for(const t of ht)t.original_id&&await u(t.original_id,e);Ze(""),Ge("")}catch(e){nt(e?.message||"Bulk apply failed.")}finally{tt(!1)}},disabled:et,children:et?"Applying…":"Apply to Matches"})]})]}),(0,s.jsxs)("div",{className:"dbvc-admin-app__entity-columns",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{children:"Raw Current"}),(0,s.jsx)("pre",{children:JSON.stringify(re,null,2)})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{children:"Raw Proposed (Bundle)"}),(0,s.jsx)("pre",{children:JSON.stringify(ce,null,2)})]})]})]}):(0,s.jsx)("p",{children:"Select an entity to view details."}))};function F({open:e,onClose:n,report:i,onMarkCanonical:a,actionKey:l,bulkMode:o,onBulkModeChange:r,confirmPhrase:c,confirmValue:d,onConfirmChange:u,onBulkCleanup:h,bulkBusy:m,bulkDisabled:v}){var b,f;return e?(0,s.jsxs)(t.Modal,{title:(0,s.jsxs)("span",{className:"dbvc-duplicates-modal__title",children:[`Duplicate entities (${null!==(b=i.count)&&void 0!==b?b:0})`,(0,s.jsx)("span",{className:"dbvc-duplicates-modal__lede",children:"Choose the filename format to keep and confirm the cleanup to delete the rest of the duplicate JSON files."})]}),onRequestClose:n,className:"dbvc-duplicates-modal",children:[(0,s.jsxs)("div",{className:"dbvc-duplicates-modal__bulk",children:[(0,s.jsxs)("label",{className:"dbvc-duplicates-modal__bulk-select",children:["Keep filenames as:",(0,s.jsx)("select",{value:o,onChange:e=>r&&r(e.target.value),children:[{value:"slug_id",label:"Slug + ID"},{value:"slug",label:"Slug"},{value:"id",label:"ID"}].map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,s.jsxs)("div",{className:"dbvc-duplicates-modal__bulk-inline",children:[(0,s.jsx)("input",{type:"text",value:d,placeholder:`Type ${c}`,onChange:e=>u&&u(e.target.value)}),(0,s.jsx)(t.Button,{variant:"primary",onClick:h,disabled:v,isBusy:m,children:m?"Cleaning…":"Bulk clean duplicates"})]})]}),0===(null!==(f=i.items)&&void 0!==f?f:[]).length?(0,s.jsx)("p",{children:"No duplicate manifest entries were detected for this proposal."}):i.items.map(e=>{var n,i;const o=null!==(n=e.entries)&&void 0!==n?n:[],r=o.reduce((e,t)=>{const s=t.post_modified?Date.parse(t.post_modified.replace(" ","T")):0;return Number.isFinite(s)&&s>e?s:e},0);return(0,s.jsxs)("div",{className:"dbvc-duplicate-group",children:[(0,s.jsxs)("div",{className:"dbvc-duplicate-group__header",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:$(e)}),(0,s.jsxs)("div",{className:"dbvc-duplicate-group__meta",children:[(0,s.jsxs)("span",{children:["UID: ",e.vf_object_uid]}),(0,s.jsxs)("span",{children:["Slug: ",S(e)]}),(0,s.jsxs)("span",{children:["Type: ",C(e)]})]})]}),(0,s.jsx)("div",{className:"dbvc-duplicate-group__badges",children:(0,s.jsxs)("span",{className:"dbvc-badge",children:[null!==(i=e.entries?.length)&&void 0!==i?i:0," files"]})})]}),(0,s.jsxs)("table",{className:"widefat",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Path"}),(0,s.jsx)("th",{children:"Hash"}),(0,s.jsx)("th",{children:"Content hash"}),(0,s.jsx)("th",{children:"Modified"}),(0,s.jsx)("th",{children:"Status"}),(0,s.jsx)("th",{children:"Size"}),(0,s.jsx)("th",{children:"Actions"})]})}),(0,s.jsx)("tbody",{children:o.map((n,i)=>{const o=`${e.vf_object_uid}::${i}::${n.path||"no-path"}`,c=n.post_modified?Date.parse(n.post_modified.replace(" ","T")):0,d=r&&Number.isFinite(c)&&c===r;return(0,s.jsxs)("tr",{className:d?"is-latest":"",children:[(0,s.jsx)("td",{className:"dbvc-text-break",children:n.path||"—"}),(0,s.jsx)("td",{className:"dbvc-text-break",children:n.hash||"—"}),(0,s.jsx)("td",{className:"dbvc-text-break",children:n.content_hash||"—"}),(0,s.jsx)("td",{children:n.post_modified?p(n.post_modified):"—"}),(0,s.jsx)("td",{children:n.post_status||"—"}),(0,s.jsx)("td",{children:"number"==typeof n.size?`${n.size} B`:"—"}),(0,s.jsx)("td",{children:(0,s.jsx)(t.Button,{variant:"secondary",onClick:()=>a&&a(e.vf_object_uid,n.path),disabled:l===o,children:l===o?"Marking…":"Keep this file"})})]},o)})})]})]},e.vf_object_uid)}),(0,s.jsx)("p",{className:"description",children:"Tip: Clean up duplicate JSON files in the sync folder before exporting new proposals to keep reviewers focused on a single entity."})]}):null}const L=()=>{var o,c,d,u,h,m,v,b,f,g,y,j,k,A,L,V,z,J,K,H,q,G,X,Z,Q,Y,ee,te,se,ne;const[ie,ae]=(0,e.useState)([]),[le,oe]=(0,e.useState)(null),[re,ce]=(0,e.useState)(null),[de,ue]=(0,e.useState)(null),[pe,he]=(0,e.useState)([]),[me,ve]=(0,e.useState)("needs_review"),[be,fe]=(0,e.useState)(""),[ge,_e]=(0,e.useState)(null),[xe,ye]=(0,e.useState)(null),[je,we]=(0,e.useState)(!1),[ke,Ce]=(0,e.useState)({}),[Ne,Se]=(0,e.useState)({}),[$e,De]=(0,e.useState)(null),[Re,Ae]=(0,e.useState)(!0),[Ie,Ee]=(0,e.useState)(!1),[Me,Be]=(0,e.useState)(!1),[Pe,Oe]=(0,e.useState)(!1),[Te,Ue]=(0,e.useState)(!1),[Fe,Le]=(0,e.useState)(null),[Ve,ze]=(0,e.useState)(null),[Je,Ke]=(0,e.useState)(null),[He,qe]=(0,e.useState)(null),[We,Ge]=(0,e.useState)(!1),[Xe,Ze]=(0,e.useState)(!1),[Qe,Ye]=(0,e.useState)(!1),[et,tt]=(0,e.useState)(""),[st,nt]=(0,e.useState)(null),[it,at]=(0,e.useState)(null),[lt,ot]=(0,e.useState)(!1),[rt,ct]=(0,e.useState)("full"),[dt,ut]=(0,e.useState)(!1),[pt,ht]=(0,e.useState)("conflicts"),[mt,vt]=(0,e.useState)([]),[bt,ft]=(0,e.useState)(!1),[gt,_t]=(0,e.useState)([]),[xt,yt]=(0,e.useState)([]),[jt,wt]=(0,e.useState)({}),[kt,Ct]=(0,e.useState)(null),[Nt,St]=(0,e.useState)(!1),[$t,Dt]=(0,e.useState)(!1),[Rt,At]=(0,e.useState)(!1),[It,Et]=(0,e.useState)(!1),[Mt,Bt]=(0,e.useState)(()=>{const e={};return M.forEach(t=>{e[t.id]=!1!==t.defaultVisible}),e}),[Pt,Ot]=(0,e.useState)({count:0,items:[]}),[Tt,Ut]=(0,e.useState)(!1),[Ft,Lt]=(0,e.useState)(null),[Vt,zt]=(0,e.useState)(!1),[Jt,Kt]=(0,e.useState)(""),[Ht,qt]=(0,e.useState)("slug_id"),[Wt,Gt]=(0,e.useState)(""),[Xt,Zt]=(0,e.useState)(!1),[Qt,Yt]=(0,e.useState)(!1),[es,ts]=(0,e.useState)(!1),[ss,ns]=(0,e.useState)(!1),[is,as]=(0,e.useState)(!1),[ls,os]=(0,e.useState)(()=>new Set),[rs,cs]=(0,e.useState)(!1),[ds,us]=(0,e.useState)([]),[ps,hs]=(0,e.useState)(!1),[ms,vs]=(0,e.useState)(null),[bs,fs]=(0,e.useState)(!1),[gs,_s]=(0,e.useState)(!1),[xs,ys]=(0,e.useState)("ignore"),[js,ws]=(0,e.useState)(""),[ks,Cs]=(0,e.useState)(""),[Ns,Ss]=(0,e.useState)(!1),[$s,Ds]=(0,e.useState)(!1),[Rs,As]=(0,e.useState)([]),[Is,Es]=(0,e.useState)(!1),Ms=(0,e.useRef)(null),Bs=(0,e.useRef)(null),Ps=(0,e.useRef)(null),Os="DELETE",Ts=(0,e.useMemo)(()=>M.filter(e=>Mt[e.id]),[Mt]),Us=(0,e.useCallback)(e=>{Bt(t=>{const s=M.find(t=>t.id===e);return s&&s.lockVisible?t:{...t,[e]:!t[e]}})},[]),Fs=(0,e.useCallback)(async(e,t={})=>{if(!e)return Ot({count:0,items:[]}),void Lt(null);const{signal:s}=t;Ut(!0),Lt(null);try{var n,a;const t=await i(`proposals/${encodeURIComponent(e)}/duplicates`,s?{signal:s}:void 0);Ot({count:null!==(n=t.count)&&void 0!==n?n:t.items?t.items.length:0,items:null!==(a=t.items)&&void 0!==a?a:[]})}catch(e){if("AbortError"===e.name)return;Lt(e?.message||"Failed to load duplicates."),Ot({count:0,items:[]})}finally{Ut(!1)}},[]),Ls=(0,e.useRef)(null);(0,e.useEffect)(()=>{Ls.current=ge},[ge]);const Vs=(0,e.useCallback)(async(e,t,s)=>{if(!e)return he([]),[];Be(!0),ze(null);try{var n;const a=t&&!["needs_review","needs_review_media","resolved","new_entities"].includes(t)||!t||"all"===t?"":`?status=${encodeURIComponent(t)}`,l=await i(`proposals/${encodeURIComponent(e)}/entities${a}`,{signal:s}),o=null!==(n=l.items)&&void 0!==n?n:[],r=E(o);return he(r),l.decision_summary&&ae(t=>t.map(t=>t.id===e?{...t,decisions:l.decision_summary}:t)),l.resolver_decisions&&ae(t=>t.map(t=>t.id===e?{...t,resolver_decisions:l.resolver_decisions}:t)),r}catch(e){return"AbortError"!==e.name&&ze(e.message),[]}finally{Be(!1)}},[]),zs="DBVC_MASK_UNDO",Js=(0,e.useCallback)(async(e,t)=>{if(!e)return vt([]),[];ft(!0);try{var s;const n=null!==(s=(await i(`proposals/${encodeURIComponent(e)}/entities`,t?{signal:t}:void 0)).items)&&void 0!==s?s:[],a=E(n);return vt(a),a}catch(e){return"AbortError"!==e.name&&vt([]),[]}finally{ft(!1)}},[]),Ks=(0,e.useRef)({}),Hs=(0,e.useCallback)(e=>Ks.current[e],[]),qs=(0,e.useCallback)((e,t)=>{e&&(Ks.current[e]=t)},[]),Ws=(0,e.useCallback)(e=>`DBVC_MASK_CACHE_${e}`,[]),Gs=(0,e.useCallback)(e=>{if(!e||"undefined"==typeof window||!window.sessionStorage)return null;const t=window.sessionStorage.getItem(Ws(e));if(!t)return null;try{const e=JSON.parse(t);return e&&Array.isArray(e.fields)?e.updatedAt&&Date.now()-e.updatedAt>3e5?null:e:null}catch(e){return null}},[Ws]),Xs=(0,e.useCallback)((e,t)=>{if(e&&"undefined"!=typeof window&&window.sessionStorage)try{window.sessionStorage.setItem(Ws(e),JSON.stringify({fields:t,updatedAt:Date.now()}))}catch(e){}},[Ws]),[Zs,Qs]=(0,e.useState)(0),Ys=(0,e.useCallback)(async(e,t)=>{if(!e)return us([]),Qs(0),void _s(!1);hs(!0),vs(null),Qs(0);const s=e=>{if(e)return"object"==typeof e&&"signal"in e?e:{signal:e}};qs(e,"loading");try{let n=1,a=[],l=!0,o=1,r=1;for(;l;){const c=await i(`proposals/${encodeURIComponent(e)}/masking?page=${n}`,s(t));Array.isArray(c?.fields)&&(a=a.concat(c.fields));const d=c?.chunk?.total_pages?parseInt(c.chunk.total_pages,10):1;r=d>0?d:1,o=n,c?.chunk?.has_more?n++:l=!1,Qs(Math.min(100,Math.round(o/r*100)))}us(a),_s(!rs&&a.length>0),Qs(100),Xs(e,a),qs(e,"success")}catch(t){if("AbortError"===t.name)return void qs(e,"failed");console.error("DBVC masking fetch failed:",t),vs(t?.message||"Failed to load masking candidates."),qs(e,"failed")}finally{hs(!1),setTimeout(()=>Qs(0),1500)}},[rs,Xs,qs]);(0,e.useEffect)(()=>{if(!le)return us([]),void Qs(0);const e=Gs(le);e&&Array.isArray(e.fields)?(us(e.fields),Qs(100),rs||_s(e.fields.length>0),Ks.current[le]=!0):(us([]),Qs(0),Ks.current[le]=!1)},[le,Gs,rs]);const[en,tn]=(0,e.useState)(null),[sn,nn]=(0,e.useState)(0),[an,ln]=(0,e.useState)(!1),on=(0,e.useCallback)(async()=>{const e=Array.isArray(ds)?ds:[];if(!le||!e.length)return vs("No masked fields are available to apply."),void _s(!1);if("override"===xs&&!js.trim())return void vs("Provide an override value to continue.");const t=[];for(let s=0;s<e.length;s+=50){const n=e.slice(s,s+50).map(e=>{const t={vf_object_uid:e.vf_object_uid,meta_path:e.meta_path,action:xs};return"auto_accept"===xs&&(t.suppress=!0),"override"===xs&&(t.override_value=js,ks&&(t.note=ks)),t});t.push(n)}fs(!0),nn(0),vs(null);try{const s=[];for(let e=0;e<t.length;e++){const n=t[e],i=await a(`proposals/${encodeURIComponent(le)}/masking/apply`,{items:n});s.push(i),nn(Math.min(99,Math.round((e+1)/t.length*100)))}nn(100);const n=[];s.forEach(e=>{Array.isArray(e?.entities)&&n.push(...e.entities)}),n.length&&he(e=>e.map(e=>{const t=n.find(t=>t.vf_object_uid===e.vf_object_uid);return t?{...e,diff_state:t.diff_state||e.diff_state,decision_summary:t.decision_summary||e.decision_summary,overall_status:t.overall_status||e.overall_status}:e})),ge&&n.forEach(e=>{e.vf_object_uid===ge&&ye(t=>t?{...t,diff_state:e.diff_state||t.diff_state,decision_summary:e.decision_summary||t.decision_summary,overall_status:e.overall_status||t.overall_status}:t)});try{const t={proposalId:le,items:e};window.sessionStorage&&window.sessionStorage.setItem(zs,JSON.stringify(t)),tn(t)}catch(e){}await Promise.all([Ys(le),Vs(le,me),Fs(le)]),_s(!1),_t(t=>[...t,{id:`${Date.now()}-mask`,severity:"success",title:"Masking applied",message:`Updated ${e.length} field${1===e.length?"":"s"}.`,timestamp:(new Date).toISOString()}])}catch(e){vs(e?.message||"Failed to apply masking rules.")}finally{fs(!1),setTimeout(()=>nn(0),1500)}},[le,ds,xs,ks,js]),rn=(0,e.useCallback)(async()=>{if(!en||!le)return;const e=Array.isArray(en.items)?en.items:[];if(e.length){fs(!0),vs(null);try{const t=e.map(e=>({vf_object_uid:e.vf_object_uid,meta_path:e.meta_path,action:"ignore"}));await a(`proposals/${encodeURIComponent(le)}/masking/apply`,{items:t}),window.sessionStorage&&window.sessionStorage.removeItem(zs),tn(null),await Promise.all([Ys(le),Vs(le,me),Fs(le)])}catch(e){vs(e?.message||"Failed to undo masking rules.")}finally{fs(!1)}}},[en,le]),cn=(0,e.useCallback)(async()=>{if(le){ln(!0),vs(null);try{const e=await a(`proposals/${encodeURIComponent(le)}/masking/revert`,{});window.sessionStorage&&window.sessionStorage.removeItem(zs),tn(null),await Promise.all([Ys(le),Vs(le,me),Fs(le)]),_t(t=>[...t,{id:`${Date.now()}-mask-revert`,severity:"info",title:"Masking decisions reverted",message:(e?.cleared?.decisions||0)>0?`Cleared ${e.cleared.decisions} masked decision${1===e.cleared.decisions?"":"s"}.`:"No masked decisions matched the current masking rules.",timestamp:(new Date).toISOString()}])}catch(e){vs(e?.message||"Failed to revert masking decisions.")}finally{ln(!1)}}},[le,Ys,Vs,me,Fs]),dn=(0,e.useCallback)(async(e={})=>{const{signal:t,focusProposalId:s}=e;Ae(!0),Le(null);try{var n;const e=null!==(n=(await i("proposals",t?{signal:t}:void 0)).items)&&void 0!==n?n:[];ae(e),oe(t=>{var n;return s&&e.some(e=>e.id===s)?s:t&&e.some(e=>e.id===t)?t:null!==(n=e[0]?.id)&&void 0!==n?n:null})}catch(e){if("AbortError"===e.name)return;Le(e.message)}finally{Ae(!1),Ee(!0)}},[]),un=(0,e.useCallback)(async e=>{if(!e)return;const t=ie.find(t=>t.id===e);if(t)if(e!==le){if(t.locked)_t(e=>[...e,{id:`${Date.now()}-proposal-delete-locked`,severity:"warning",title:"Proposal is locked",message:"Locked proposals cannot be deleted.",timestamp:(new Date).toISOString()}]);else if(window.confirm(`Delete proposal "${e}"? This cannot be undone.`)){ce(e);try{await l(`proposals/${encodeURIComponent(e)}`),await dn({focusProposalId:le&&le!==e?le:null}),_t(t=>[...t,{id:`${Date.now()}-proposal-delete-success`,severity:"info",title:"Proposal deleted",message:`Deleted ${e}.`,timestamp:(new Date).toISOString()}])}catch(t){_t(e=>[...e,{id:`${Date.now()}-proposal-delete-error`,severity:"error",title:"Delete failed",message:t?.message||"Unable to delete proposal.",timestamp:(new Date).toISOString()}])}finally{ce(null)}}}else _t(e=>[...e,{id:`${Date.now()}-proposal-delete-blocked`,severity:"warning",title:"Cannot delete current proposal",message:"Select another proposal before deleting this one.",timestamp:(new Date).toISOString()}])},[ie,le,dn,_t]),pn=(0,e.useCallback)(()=>{le&&Vs(le,me)},[le,me,Vs]),hn=(0,e.useCallback)(e=>{e.stopPropagation()},[]),mn=(0,e.useCallback)(e=>{e.preventDefault(),e.stopPropagation()},[]),vn=(0,e.useMemo)(()=>xe?.resolver?.attachments?.length?xe.resolver.attachments:de?.attachments||[],[de,xe]),bn=((0,e.useCallback)(()=>{le&&Fs(le)},[le,Fs]),(0,e.useCallback)(async(e,t)=>{if(le&&e&&t){Kt(`${e}::${t}`),Lt(null);try{await a(`proposals/${encodeURIComponent(le)}/duplicates/cleanup`,{vf_object_uid:e,keep_path:t}),await Fs(le),await Vs(le,me)}catch(e){Lt(e?.message||"Failed to mark canonical entry.")}finally{Kt("")}}},[le,Fs,Vs,me])),fn=(0,e.useCallback)(async()=>{if(le&&Pt.count&&Ht){Zt(!0),Lt(null);try{await a(`proposals/${encodeURIComponent(le)}/duplicates/cleanup`,{apply_all:!0,preferred_format:Ht,confirm_token:Wt.trim()}),Gt(""),await Fs(le),await Vs(le,me)}catch(e){Lt(e?.message||"Failed to clean duplicates.")}finally{Zt(!1)}}},[le,Pt.count,Ht,Wt,Fs,Vs,me]),gn=!Pt.count||Tt||!Ht||Wt.trim().toUpperCase()!==Os||Xt,[xn,yn]=(0,e.useState)(!1),jn=(0,e.useCallback)(e=>{os(t=>{const s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})},[]),wn=(0,e.useCallback)((e,t)=>{os(s=>{const n=new Set(s);return e.forEach(e=>{t?n.add(e):n.delete(e)}),n})},[]),kn=(0,e.useCallback)(()=>{os(new Set)},[]),Cn=(0,e.useCallback)(()=>{os(new Set(pe.map(e=>e.vf_object_uid)))},[pe]),Nn=(0,e.useMemo)(()=>pe.filter(e=>w(e)),[pe]),Sn=Nn.length>0,$n=(0,e.useCallback)(async()=>{if(le&&Sn){Yt(!0),Lt(null);try{await a(`proposals/${encodeURIComponent(le)}/entities/accept`,{scope:"new_only"}),await Vs(le,me),await Fs(le)}catch(e){Lt(e?.message||"Failed to accept new entities.")}finally{Yt(!1)}}},[le,Sn,Vs,me,Fs]),Dn=(0,e.useCallback)(async()=>{if(le&&0!==ls.size){ts(!0),De(null);try{await a(`proposals/${encodeURIComponent(le)}/entities/accept`,{scope:"selected",vf_object_uids:Array.from(ls)}),await Vs(le,me),kn()}catch(e){De(e?.message||"Failed to accept selected entities.")}finally{ts(!1)}}},[le,ls,Vs,me,kn]),Rn=(0,e.useCallback)(async()=>{if(le&&0!==ls.size){ns(!0),De(null);try{await a(`proposals/${encodeURIComponent(le)}/entities/unaccept`,{scope:"selected",vf_object_uids:Array.from(ls)}),await Vs(le,me),kn()}catch(e){De(e?.message||"Failed to unaccept selected entities.")}finally{ns(!1)}}},[le,ls,Vs,me,kn]),An=(0,e.useCallback)(async()=>{if(le&&0!==ls.size){as(!0),De(null);try{await a(`proposals/${encodeURIComponent(le)}/entities/unkeep`,{scope:"selected",vf_object_uids:Array.from(ls)}),await Vs(le,me),kn()}catch(e){De(e?.message||"Failed to unkeep selected entities.")}finally{as(!1)}}},[le,ls,Vs,me,kn]);(0,e.useEffect)(()=>{nt(null),at(null),Ge(!1),ot(!1),ct("full"),ut(!1),_t([])},[le]),(0,e.useEffect)(()=>{"partial"!==rt&&ut(!1)},[rt]),(0,e.useEffect)(()=>{if(0===gt.length)return;const e=setTimeout(()=>{_t(e=>e.slice(1))},6e3);return()=>clearTimeout(e)},[gt]),(0,e.useEffect)(()=>{const e=new AbortController;return dn({signal:e.signal}),()=>e.abort()},[dn]),(0,e.useEffect)(()=>{if("undefined"==typeof window||!window.sessionStorage)return;const e=window.sessionStorage.getItem(zs);if(e)try{const t=JSON.parse(e);t?.proposalId===le?tn(t):(window.sessionStorage.removeItem(zs),tn(null))}catch(e){window.sessionStorage.removeItem(zs),tn(null)}else tn(null)},[le]),(0,e.useEffect)(()=>{if(!Ns)return;const e=e=>{Ms.current&&Ms.current.contains(e.target)||Ss(!1)},t=e=>{"Escape"===e.key&&Ss(!1)};return document.addEventListener("mousedown",e),document.addEventListener("keyup",t),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keyup",t)}},[Ns]),(0,e.useEffect)(()=>{if(!rs)return;const e=e=>{Ps.current&&Ps.current.contains(e.target)||cs(!1)},t=e=>{"Escape"===e.key&&cs(!1)};return document.addEventListener("mousedown",e),document.addEventListener("keyup",t),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keyup",t)}},[rs]);const In=(0,e.useCallback)(async(e,t)=>{if(e){Oe(!0),Ke(null);try{const s=await i(`proposals/${encodeURIComponent(e)}/resolver`,{signal:t});ue(s)}catch(e){"AbortError"!==e.name&&Ke(e.message)}finally{Oe(!1)}}else ue(null)},[]);(0,e.useEffect)(()=>{if(!le)return _e(null),ye(null),void we(!1);const e=new AbortController;return Vs(le,me,e.signal).then(e=>{if(!e.length)return _e(null),void we(!1);const t=Ls.current;t&&e.some(e=>e.vf_object_uid===t)||(_e(null),we(!1))}),()=>e.abort()},[le,me,Vs]),(0,e.useEffect)(()=>{if(!le)return;const e=new AbortController;return In(le,e.signal),()=>e.abort()},[le,In]),(0,e.useEffect)(()=>{if(!le)return Ot({count:0,items:[]}),void Lt(null);const e=new AbortController;return Fs(le,{signal:e.signal}),()=>e.abort()},[le,Fs]),(0,e.useEffect)(()=>{if(!le||!ge)return ye(null),Ce({}),void Se({});const e=new AbortController;return(async()=>{Ue(!0),qe(null),De(null),Se({});try{var t;const s=await i(`proposals/${encodeURIComponent(le)}/entities/${encodeURIComponent(ge)}`,{signal:e.signal});ye(s),Ce(null!==(t=s.decisions)&&void 0!==t?t:{})}catch(e){"AbortError"!==e.name&&qe(e.message)}finally{Ue(!1)}})(),()=>e.abort()},[le,ge]),(0,e.useEffect)(()=>{if(!le||rs||ps||Me)return;if(Array.isArray(ds)&&ds.length)return;if(void 0!==Hs(le))return;const e=new AbortController;return Ys(le,{signal:e.signal}),()=>e.abort()},[le,rs,ps,ds,Me,Ys,Hs]),(0,e.useEffect)(()=>{if(!le||!rs)return;const e=new AbortController;return Ys(le,{signal:e.signal}),()=>e.abort()},[le,rs,Ys]),(0,e.useEffect)(()=>{rs||_s(ds.length>0)},[ds,rs]);const En=(0,e.useCallback)((e,t)=>{const s=Number(e),n=(e=[])=>e.map(e=>{if((void 0!==e.original_id?e.original_id:e.descriptor?.original_id)===s){if(t)return{...e,decision:t};const{decision:s,...n}=e;return n}return e});ue(e=>e?{...e,attachments:n(e.attachments||[])}:e),ye(e=>e?{...e,resolver:{...e.resolver||{},attachments:n(e.resolver?.attachments||[])}}:e),he(e=>e.map(e=>e.vf_object_uid===ge?{...e,resolver:{...e.resolver||{},attachments:n(e.resolver?.attachments||[])}}:e))},[ge]),Mn=(0,e.useMemo)(()=>{const e=new Set;return pe.forEach(t=>{const s=R(t);s&&e.add(s)}),Array.from(e).sort((e,t)=>I(D(e),D(t)))},[pe]),Bn=(0,e.useMemo)(()=>new Set(Rs),[Rs]),Pn=Rs.length+(Is?1:0),On=(0,e.useCallback)(e=>{As(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},[]),Tn=(0,e.useCallback)(()=>{As([]),Es(!1)},[]),Un=(0,e.useMemo)(()=>{let e=pe;if("with_decisions"===me&&(e=e.filter(e=>{var t;return(null!==(t=e.decision_summary?.total)&&void 0!==t?t:0)>0})),"uid_mismatch"===me&&(e=e.filter(e=>!!e.uid_mismatch)),be){const t=be.toLowerCase();e=e.filter(e=>[$(e),S(e),C(e),N(e),e.path,e.term_taxonomy,e.taxonomy].filter(Boolean).join(" ").toLowerCase().includes(t))}return Bn.size>0&&(e=e.filter(e=>Bn.has(R(e)))),Is&&(e=e.filter(e=>!!e.uid_mismatch)),e},[pe,be,me,Bn,Is]),Fn=(0,e.useMemo)(()=>pe.find(e=>e.vf_object_uid===ge),[pe,ge]);(0,e.useEffect)(()=>{os(e=>{const t=new Set,s=new Set(pe.map(e=>e.vf_object_uid));return e.forEach(e=>{s.has(e)&&t.add(e)}),t})},[pe]);const Ln=(0,e.useMemo)(()=>pe.filter(e=>"missing_local_hash"===e.diff_state?.reason),[pe]),Vn=(0,e.useMemo)(()=>ie.find(e=>e.id===le),[ie,le]),zn=(0,e.useMemo)(()=>{const e={proposed:{total:0,posts:0,terms:0},current:{total:0,posts:0,terms:0}};return mt.forEach(t=>{const s="term"===t.entity_type||"string"==typeof t.post_type&&t.post_type.startsWith("term:")||t.term_taxonomy||t.taxonomy?"terms":"posts";e.proposed.total++,e.proposed[s]+=1,!t.is_new_entity&&t.identity_match&&"none"!==t.identity_match&&(e.current.total++,e.current[s]+=1)}),e},[mt]),Jn=null!==(u=Vn?.media_items)&&void 0!==u?u:null!==(h=de?.metrics?.detected)&&void 0!==h?h:0,Kn=null!==(m=de?.metrics?.reused)&&void 0!==m?m:0,Hn=Un.length,qn=Array.isArray(ds)?ds.length:0,Wn=(0,e.useMemo)(()=>{if(!Array.isArray(ds))return 0;const e=new Set;return ds.forEach(t=>{t?.vf_object_uid&&e.add(t.vf_object_uid)}),e.size},[ds]),Gn=(0,e.useMemo)(()=>Array.isArray(ds)?ds.reduce((e,t)=>{const s=t?.vf_object_uid;return s?(e[s]||(e[s]=[]),e[s].push(t),e):e},{}):{},[ds]),Xn=(0,e.useMemo)(()=>{const e={needs_review:0,needs_review_media:0,new_entities:0,with_decisions:0,uid_mismatch:0};return pe.forEach(t=>{"needs_review"===t.overall_status&&e.needs_review++,t.media_needs_review&&e.needs_review_media++,t.is_new_entity&&e.new_entities++;const s=t.decision_summary||{};(null!=s.total?s.total:0)>0&&e.with_decisions++,t.uid_mismatch&&e.uid_mismatch++}),[{id:"needs_review",label:"Needs Review",count:e.needs_review,filter:"needs_review"},{id:"needs_review_media",label:"Unresolved meta",count:e.needs_review_media,filter:"needs_review_media"},{id:"new_entities",label:"New entities",count:e.new_entities,filter:"new_entities"},{id:"with_decisions",label:"Pending decisions",count:e.with_decisions,filter:"with_decisions"},{id:"uid_mismatch",label:"UID mismatch",count:e.uid_mismatch,filter:"uid_mismatch"}]},[pe]),Zn=(0,e.useMemo)(()=>[{label:"Keep & ignore current meta (uses mask config)",value:"ignore"},{label:"Auto-accept new meta & suppress future reviews",value:"auto_accept"},{label:"Override masked value",value:"override"}],[]),Qn=(0,e.useMemo)(()=>({apply:`Apply the configured masking rules to every entity in this proposal. Learn more: ${r("live-proposal-masking")}`,ignore:`Ignore this masked field so it no longer counts toward Needs Review. Learn more: ${r("ignore-masked-field")}`,auto:`Auto-accept the masked value and suppress it from future diffs. Learn more: ${r("auto-accept-and-suppress")}`,override:`Override the masked value with a sanitized replacement. Learn more: ${r("override-masked-value")}`,revert:`Clear masking decisions that were applied via this tool using the current masking rules. Learn more: ${r("revert-masked-decisions")}`}),[]);(0,e.useEffect)(()=>{if(!Un.length)return _e(null),void we(!1);ge&&!Un.some(e=>e.vf_object_uid===ge)&&(_e(null),we(!1))},[Un,ge]),(0,e.useEffect)(()=>{ht("conflicts")},[ge]),(0,e.useEffect)(()=>{if(!le)return vt([]);const e=new AbortController;return Js(le,e.signal),()=>{e.abort()}},[le,Js]);const Yn=(0,e.useCallback)(e=>{if(!e)return _e(null),void we(!1);_e(t=>t===e?t:e),we(!0)},[]),ei=(0,e.useCallback)(async e=>{if(le){Ze(!0);try{const t=await a(`proposals/${encodeURIComponent(le)}/status`,{status:e});ae(e=>e.map(e=>e.id===le?{...e,status:t.status}:e))}catch(e){at(e?.message||"Failed to update proposal status.")}finally{Ze(!1)}}},[le]),ti=(0,e.useCallback)(async()=>{if(le&&0!==Ln.length&&window.confirm(`Store import hashes for ${Ln.length} entit${1===Ln.length?"y":"ies"}?`)){tt("bulk"),Ye(!0),De(null);try{await a(`proposals/${encodeURIComponent(le)}/entities/hash-sync`,{vf_object_uids:Ln.map(e=>e.vf_object_uid)}),await Vs(le,me)}catch(e){De(e?.message||"Failed to store import hashes.")}finally{Ye(!1),tt("")}}},[le,Ln,Vs,me]),si=(0,e.useCallback)(async e=>{if(le&&e){tt(e),Ye(!0),De(null);try{var t;await a(`proposals/${encodeURIComponent(le)}/entities/${encodeURIComponent(e)}/hash-sync`,{}),await Vs(le,me);const s=await i(`proposals/${encodeURIComponent(le)}/entities/${encodeURIComponent(e)}`);ye(s),Ce(null!==(t=s.decisions)&&void 0!==t?t:{})}catch(e){De(e?.message||"Failed to store import hash.")}finally{Ye(!1),tt("")}}},[le,me,Vs]),ni=(0,e.useCallback)(()=>{we(!1)},[]),ii=(0,e.useCallback)(()=>{le&&(at(null),nt(null),ct("full"),ut(!1),ot(!0))},[le]),ai=(0,e.useCallback)(()=>{We||ot(!1)},[We]),li=(0,e.useCallback)(e=>{_t(t=>t.filter(t=>t.id!==e))},[]),oi=(0,e.useCallback)(async()=>{if(le){ot(!1),at(null),nt(null),Ge(!0);try{var e,t;const o=await a(`proposals/${encodeURIComponent(le)}/apply`,{mode:rt,ignore_missing_hash:dt});nt(o),o.decisions&&ae(e=>e.map(e=>e.id===le?{...e,decisions:o.decisions}:e)),o.resolver_decisions&&ae(e=>e.map(e=>e.id===le?{...e,resolver_decisions:o.resolver_decisions}:e)),o.status&&ae(e=>e.map(e=>e.id===le?{...e,status:o.status}:e));const r=null!==(e=o?.result?.imported)&&void 0!==e?e:0,c=null!==(t=o?.result?.skipped)&&void 0!==t?t:0,d=Array.isArray(o?.result?.errors)?o.result.errors:[],u=(new Date).toISOString(),p=Date.now(),h=[];var s,n,i,l;d.length>0&&h.push(d[0]),o.decisions_cleared&&o.auto_clear_enabled&&h.push("Reviewer decisions cleared."),o.ignore_missing_hash&&h.push("Hash check override enabled."),o.resolver_decisions&&h.push(`Resolver decisions — reuse: ${null!==(s=o.resolver_decisions.reuse)&&void 0!==s?s:0}, map: ${null!==(n=o.resolver_decisions.map)&&void 0!==n?n:0}, download: ${null!==(i=o.resolver_decisions.download)&&void 0!==i?i:0}, skip: ${null!==(l=o.resolver_decisions.skip)&&void 0!==l?l:0}`),"closed"===o.status&&h.push("Proposal marked closed."),_t(e=>[...e,{id:p,severity:d.length?"warning":"success",title:`Applied ${Vn?.title||le}`,message:`Imported ${r} · Skipped ${c}`,detail:h.join(" "),timestamp:u}]),yt(e=>{var t,s;return[{id:p,timestamp:u,proposalId:le,proposalTitle:Vn?.title||le,mode:null!==(t=o.mode)&&void 0!==t?t:rt,imported:r,skipped:c,errors:d,decisionsCleared:Boolean(o.decisions_cleared&&o.auto_clear_enabled),ignoreMissingHash:Boolean(o.ignore_missing_hash),resolverDecisions:null!==(s=o.resolver_decisions)&&void 0!==s?s:null},...e].slice(0,10)}),_e(null),we(!1),ye(null),Ce({}),Se({});const m=await Vs(le,me);m.length&&(_e(m[0].vf_object_uid),we(!0)),await In(le)}catch(e){const t=e?.message||"Apply request failed.";at(t);const s=(new Date).toISOString(),n=Date.now(),i=[t];dt&&i.push("Hash check override requested."),_t(e=>[...e,{id:n,severity:"warning",title:`Apply failed (${Vn?.title||le})`,message:t,detail:i.join(" "),timestamp:s}]),yt(e=>[{id:n,timestamp:s,proposalId:le,proposalTitle:Vn?.title||le,mode:rt,imported:0,skipped:0,errors:[t],decisionsCleared:!1,ignoreMissingHash:dt},...e].slice(0,10))}finally{Ge(!1)}}},[le,rt,Vs,me,In,Vn,dt]),ri=(0,e.useCallback)(async(e,t)=>{if(le&&ge){De(null),Se(t=>({...t,[e]:!0}));try{var s,n;const i=await a(`proposals/${encodeURIComponent(le)}/entities/${encodeURIComponent(ge)}/selections`,{path:e,action:t}),l=null!==(s=i.decisions)&&void 0!==s?s:{},o=null!==(n=i.summary)&&void 0!==n?n:null;Ce(l),ye(e=>{var t;return e?{...e,decisions:l,decision_summary:null!=o?o:e.decision_summary,new_entity_decision:null!==(t=l[_])&&void 0!==t?t:e.new_entity_decision}:e}),he(e=>e.map(e=>{var t;return e.vf_object_uid===ge?{...e,decision_summary:null!=o?o:e.decision_summary,new_entity_decision:null!==(t=l[_])&&void 0!==t?t:e.new_entity_decision}:e})),i.proposal_summary&&ae(e=>e.map(e=>e.id===le?{...e,decisions:i.proposal_summary}:e))}catch(e){De(e.message)}finally{Se(t=>{const s={...t};return delete s[e],s})}}},[le,ge]),ci=(0,e.useCallback)(async(e,t)=>{if(le){Ct(null),wt(t=>({...t,[e]:!0}));try{var s;const n=await a(`proposals/${encodeURIComponent(le)}/resolver/${encodeURIComponent(e)}`,t);return En(e,null!==(s=n.decision)&&void 0!==s?s:null),n}catch(e){throw Ct(e.message),e}finally{wt(t=>{const s={...t};return delete s[e],s})}}},[le,En]),di=(0,e.useCallback)(async(e,t)=>{await ci(e,t)},[ci]),ui=(0,e.useCallback)(async(e,t="proposal")=>{if(le){Ct(null),wt(t=>({...t,[e]:!0}));try{var s;const n=await l(`proposals/${encodeURIComponent(le)}/resolver/${encodeURIComponent(e)}?scope=${encodeURIComponent(t)}`);En(e,null!==(s=n.decision)&&void 0!==s?s:null)}catch(e){Ct(e.message)}finally{wt(t=>{const s={...t};return delete s[e],s})}}},[le,En]),pi=(0,e.useCallback)(async(e,t)=>{const s=e.reason||"";if(!s||!vn.length)return;const n=vn.filter(t=>t.original_id!==e.original_id&&(t.reason||"")===s);if(n.length){if(window.confirm(`Apply this ${t.action} decision to ${n.length} other conflict(s) with reason "${s}"?`))try{await Promise.all(n.map(e=>ci(e.original_id,t)))}catch(e){}}else window.alert("No similar conflicts found to apply this decision to.")},[vn,ci]),hi=(0,e.useCallback)(async()=>{if(le&&ge&&window.confirm("Clear all Accept/Keep choices for this entity?")){De(null),St(!0),Se({});try{var e,t;const s=await a(`proposals/${encodeURIComponent(le)}/entities/${encodeURIComponent(ge)}/selections`,{action:"clear_all"}),n=null!==(e=s.decisions)&&void 0!==e?e:{},i=null!==(t=s.summary)&&void 0!==t?t:null;Ce(n),ye(e=>e?{...e,decisions:n,decision_summary:null!=i?i:e.decision_summary}:e),he(e=>e.map(e=>e.vf_object_uid===ge?{...e,decision_summary:null!=i?i:e.decision_summary}:e)),s.proposal_summary&&ae(e=>e.map(e=>e.id===le?{...e,decisions:s.proposal_summary}:e))}catch(e){De(e.message)}finally{St(!1)}}},[le,ge]),mi=(0,e.useCallback)(async()=>{if(le&&ge){Dt(!0),De(null);try{var e,t;const s=null!==(e=(await a(`proposals/${encodeURIComponent(le)}/entities/${encodeURIComponent(ge)}/snapshot`,{})).snapshot)&&void 0!==e?e:null;s&&ye(e=>e?{...e,current:s,current_source:"snapshot"}:e);const n=await i(`proposals/${encodeURIComponent(le)}/entities/${encodeURIComponent(ge)}`);ye(n),Ce(null!==(t=n.decisions)&&void 0!==t?t:{}),he(e=>e.map(e=>{var t;return e.vf_object_uid===ge?{...e,decision_summary:null!==(t=n.decision_summary)&&void 0!==t?t:e.decision_summary}:e}))}catch(e){De(e.message)}finally{Dt(!1)}}},[le,ge]),vi=(0,e.useCallback)(async()=>{if(le){At(!0),De(null);try{var e,t;const n=await i(`proposals/${encodeURIComponent(le)}/entities?status=needs_review`),l=Array.isArray(n.items)?n.items:[],o=l.map(e=>e.vf_object_uid).filter(e=>"string"==typeof e&&e.length>0),r=o.length?{entity_ids:o}:{},c=await a(`proposals/${encodeURIComponent(le)}/snapshot`,r),d=null!==(e=c.captured)&&void 0!==e?e:0,u=null!==(t=c.targets)&&void 0!==t?t:o.length||l.length||0,p=(new Date).toISOString();if(_t(e=>[...e,{id:Date.now(),severity:"info",title:"Snapshots captured",message:`Captured ${d}/${u||d} snapshot(s) for proposal ${le}.`,timestamp:p}]),await Vs(le,me),await In(le),ge){var s;const e=await i(`proposals/${encodeURIComponent(le)}/entities/${encodeURIComponent(ge)}`);ye(e),Ce(null!==(s=e.decisions)&&void 0!==s?s:{})}}catch(e){De(e.message)}finally{At(!1)}}},[le,ge,me,Vs,In]),bi=(0,e.useCallback)(async()=>{if(window.confirm("This will delete all stored backups, snapshots, and reviewer decisions. Continue?")){Et(!0),De(null);try{await l("maintenance/clear-proposals"),await dn(),oe(null),he([]),ye(null),ue(null),Ce({}),Se({}),_t(e=>[...e,{id:Date.now(),severity:"info",title:"Backups cleared",message:"All proposal backups, snapshots, and decisions have been removed.",timestamp:(new Date).toISOString()}])}catch(e){De(e.message)}finally{Et(!1)}}},[dn]),fi=(0,e.useCallback)(async(e,t)=>{if(!le||!ge||!Array.isArray(t)||0===t.length)return;const s=t.filter(e=>"string"==typeof e&&e.length>0);if(!s.length)return;const n=e=>{var t,s;const n=null!==(t=e.decisions)&&void 0!==t?t:{},i=null!==(s=e.summary)&&void 0!==s?s:null;Ce(n),ye(e=>e?{...e,decisions:n,decision_summary:null!=i?i:e.decision_summary}:e),he(e=>e.map(e=>e.vf_object_uid===ge?{...e,decision_summary:null!=i?i:e.decision_summary}:e)),e.proposal_summary&&ae(t=>t.map(t=>t.id===le?{...t,decisions:e.proposal_summary}:t))};De(null),yn(!0),Se(e=>{const t={...e};return s.forEach(e=>{t[e]=!0}),t});try{try{const t=await a(`proposals/${encodeURIComponent(le)}/entities/${encodeURIComponent(ge)}/selections/bulk`,{action:e,paths:s});n(t),Se({})}catch(t){if(404!==t.status)throw t;await(async()=>{for(const t of s){const s=await a(`proposals/${encodeURIComponent(le)}/entities/${encodeURIComponent(ge)}/selections`,{path:t,action:e});n(s),Se(e=>{const s={...e};return delete s[t],s})}})()}}catch(e){De(e.message)}finally{yn(!1),Se({})}},[le,ge]),gi=null!==(u=Vn?.decisions)&&void 0!==u?u:null,_i=null!==(h=gi?.total)&&void 0!==h?h:0,xi=null!==(m=gi?.accepted)&&void 0!==m?m:0,yi=null!==(v=gi?.kept)&&void 0!==v?v:0,ji=null!==(b=gi?.accepted_new)&&void 0!==b?b:0,wi=null!==(f=gi?.entities_reviewed)&&void 0!==f?f:0,ki=null!==(g=Vn?.resolver_decisions)&&void 0!==g?g:null,Ci=null!==(y=ki?.reuse)&&void 0!==y?y:0,Ni=null!==(j=ki?.map)&&void 0!==j?j:0,Si=null!==(k=ki?.download)&&void 0!==k?k:0,$i=null!==(A=ki?.skip)&&void 0!==A?A:0,Di=null!==(L=null!==(V=de?.metrics?.unresolved)&&void 0!==V?V:Vn?.resolver?.metrics?.unresolved)&&void 0!==L?L:0,Ri=Array.isArray(st?.result?.errors)?st.result.errors:[],Ai=Ri.length?"notice notice-warning":"notice notice-success",Ii=null!==(z=st?.result?.imported)&&void 0!==z?z:0,Ei=null!==(J=st?.result?.skipped)&&void 0!==J?J:0,Mi=null!==(K=st?.result?.media_resolver?.metrics)&&void 0!==K?K:{},Bi=null!==(H=Mi?.unresolved)&&void 0!==H?H:0,Pi=null!==(q=st?.result?.media_reconcile)&&void 0!==q?q:null,Oi=(0,e.useCallback)(e=>{dn({focusProposalId:e});const t=(new Date).toISOString(),s=Date.now();_t(n=>[...n,{id:s,severity:"success",title:"Proposal uploaded",message:`Bundle registered as ${e}`,timestamp:t}])},[dn]),Ti=(0,e.useCallback)(e=>{const t=(new Date).toISOString(),s=Date.now();_t(n=>[...n,{id:s,severity:"error",title:"Upload failed",message:e,timestamp:t}])},[]),Ui=()=>{const e=(window.location.hash||"").replace(/^#/,"").split("?"),t=e[0]||"",s=e[1]||"",n="entity-editor"===DBVC_ADMIN_APP?.initialRoute?"entity-editor":"proposal-review";return{route:t?"entity-editor"===t?"entity-editor":"proposal-review":n,filePath:(()=>{if(!s)return"";const e=new URLSearchParams(s).get("file")||"";try{return decodeURIComponent(e)}catch(t){return e}})()}},[Fi,Li]=(0,e.useState)(Ui),Vi=Fi.route,zi=Fi.filePath,[Ji,Ki]=(0,e.useState)(null),[Hi,qi]=(0,e.useState)(!1),[Wi,Gi]=(0,e.useState)(""),[Xi,Zi]=(0,e.useState)(""),[Qi,Yi]=(0,e.useState)(!1),[ea,ta]=(0,e.useState)(!1),[sa,na]=(0,e.useState)(!1),[ia,aa]=(0,e.useState)(""),[la,oa]=(0,e.useState)(""),[ra,ca]=(0,e.useState)(""),[da,ua]=(0,e.useState)(null),[pa,ha]=(0,e.useState)(null),[ma,va]=(0,e.useState)(!1),[ba,fa]=(0,e.useState)(""),[ga,_a]=(0,e.useState)(""),[xa,ya]=(0,e.useState)(!1),[ja,wa]=(0,e.useState)([]),[ka,Ca]=(0,e.useState)(null),[Na,Sa]=(0,e.useState)(!1),[$a,Da]=(0,e.useState)(""),[Ra,Aa]=(0,e.useState)("all"),[Ia,Ea]=(0,e.useState)("all"),[Ma,Ba]=(0,e.useState)(""),[Pa,Oa]=(0,e.useState)({key:"mtime",direction:"desc"}),[Ta,Ua]=(0,e.useState)(1),Fa=(0,e.useCallback)(e=>{const t="entity-editor"===e?"entity-editor":"proposal-review",s=`#${t}`;Li({route:t,filePath:""}),window.location.hash!==s&&window.history.replaceState(null,"",s)},[]),La=(0,e.useCallback)(e=>{const t=`#entity-editor?file=${encodeURIComponent(e||"")}`;Li({route:"entity-editor",filePath:e||""}),window.location.hash!==t&&window.history.replaceState(null,"",t)},[]),Va=(0,e.useCallback)(()=>{Li({route:"entity-editor",filePath:""}),Ki(null),Zi(""),aa(""),oa(""),ca(""),ua(null),ha(null),"#entity-editor"!==window.location.hash&&window.history.replaceState(null,"","#entity-editor")},[]),za=(0,e.useCallback)(async(e,t=!1)=>{if(e){qi(!0),Gi(""),ha(null);try{const s=await i(`entity-editor/file?path=${encodeURIComponent(e)}${t?"&force_takeover=1":""}`);return Ki(s),Zi(s?.content||""),oa(""),aa(""),ca(s?.lock?.token||""),void ua(s?.lock||null)}catch(e){const t=e?.body?.data?.lock||null;Ki(null),Gi(e?.message||"Failed to load entity file"),ca(""),ua(null),ha(t)}finally{qi(!1)}}},[]),Ja=(0,e.useCallback)(async(e=!1)=>{if(zi){oa(""),aa(""),ha(null);try{JSON.parse(Xi||"{}")}catch(e){return void oa(e?.message||"Invalid JSON")}Yi(!0);try{const t=await a("entity-editor/file/save",{path:zi,content:Xi,lock_token:ra||"",force_takeover:!!e});Ki(e=>({...e,...t})),Zi(t?.content||Xi),aa(e?"Saved JSON to sync folder and took over lock.":"Saved JSON to sync folder."),ca(t?.lock?.token||ra),ua(t?.lock||da),wa([])}catch(e){const t=e?.body?.data?.lock||null;oa(e?.message||"Failed to save JSON"),ha(t)}finally{Yi(!1)}}},[zi,Xi,ra,da]),Ka=(0,e.useCallback)(async(e=!1)=>{if(zi){oa(""),aa(""),ha(null);try{JSON.parse(Xi||"{}")}catch(e){return void oa(e?.message||"Invalid JSON")}ta(!0);try{var t,s,n;const i=await a("entity-editor/file/import-partial",{path:zi,content:Xi,lock_token:ra||"",force_takeover:!!e}),l=i?.import_result?.counts||{};Ki(e=>({...e,...i})),Zi(i?.content||Xi),ca(i?.lock?.token||ra),ua(i?.lock||da),aa(`Saved + partial import complete (fields: ${null!==(t=l.core_fields_updated)&&void 0!==t?t:0}, meta: ${null!==(s=l.meta_keys_updated)&&void 0!==s?s:0}, tax: ${null!==(n=l.taxonomies_updated)&&void 0!==n?n:0}).`),wa([])}catch(e){const t=e?.body?.data?.lock||null;oa(e?.message||"Failed to run partial import"),ha(t)}finally{ta(!1)}}},[zi,Xi,ra,da]),Ha=(0,e.useCallback)(async(e=!1,t="")=>{if(!zi)return;oa(""),aa(""),ha(null);const s=(t||"").trim();if("REPLACE"===s){try{JSON.parse(Xi||"{}")}catch(e){return void oa(e?.message||"Invalid JSON")}na(!0);try{var n,i,l,o;const t=await a("entity-editor/file/import-replace",{path:zi,content:Xi,confirm_phrase:s,lock_token:ra||"",force_takeover:!!e}),r=t?.import_result?.counts||{},c=t?.import_result?.snapshot_path||"";Ki(e=>({...e,...t})),Zi(t?.content||Xi),ca(t?.lock?.token||ra),ua(t?.lock||da),aa(`Saved + full replace complete (fields: ${null!==(n=r.core_fields_updated)&&void 0!==n?n:0}, meta updated: ${null!==(i=r.meta_keys_updated)&&void 0!==i?i:0}, meta deleted: ${null!==(l=r.meta_keys_deleted)&&void 0!==l?l:0}, tax: ${null!==(o=r.taxonomies_updated)&&void 0!==o?o:0})${c?`; snapshot: ${c}`:""}.`),wa([])}catch(e){const t=e?.body?.data?.lock||null;oa(e?.message||"Failed to run full replace"),ha(t)}finally{na(!1)}}else oa('Full replace requires typing "REPLACE".')},[zi,Xi,ra,da]),qa=(0,e.useCallback)((e=!1)=>{ya(!!e),fa(""),_a(""),va(!0)},[]),Wa=(0,e.useCallback)(()=>{va(!1),fa(""),_a(""),ya(!1)},[]),Ga=(0,e.useCallback)(async()=>{"REPLACE"===(ba||"").trim()?(_a(""),va(!1),await Ha(xa,(ba||"").trim())):_a('Type "REPLACE" to continue.')},[ba,xa,Ha]),Xa=(0,e.useCallback)(()=>{zi&&za(zi,!0)},[zi,za]),Za=(0,e.useCallback)(async(e=!1)=>{Sa(!0),Da("");try{const t=e?await a("entity-editor/index/rebuild",{}):await i("entity-editor/index");wa(Array.isArray(t?.items)?t.items:[]),Ca(t?.stats||null)}catch(e){Da(e?.message||"Failed to load entity index")}finally{Sa(!1)}},[]);(0,e.useEffect)(()=>{const e=()=>Li(Ui());return window.addEventListener("hashchange",e),()=>window.removeEventListener("hashchange",e)},[]),(0,e.useEffect)(()=>{"entity-editor"===Vi&&0===ja.length&&!Na&&!$a&&Za(!1)},[Vi,ja.length,Na,$a,Za]),(0,e.useEffect)(()=>{if("entity-editor"!==Vi||!zi)return Ki(null),ca(""),ua(null),ha(null),void Gi("");za(zi,!1)},[Vi,zi,za]),(0,e.useEffect)(()=>{Ea("all"),Ua(1)},[Ra]);const Qa=(0,e.useMemo)(()=>{const e=new Set;return ja.forEach(t=>{"all"!==Ra&&t.entity_kind!==Ra||!t.subtype||e.add(t.subtype)}),Array.from(e).sort((e,t)=>e.localeCompare(t,void 0,{sensitivity:"base"}))},[ja,Ra]),Ya=(0,e.useMemo)(()=>{const e=Ma.trim().toLowerCase();return ja.filter(t=>("all"===Ra||t.entity_kind===Ra)&&(("all"===Ia||t.subtype===Ia)&&(!e||[t.title,t.slug,t.uid,t.relative_path,t.subtype,t.entity_kind].map(e=>(e||"").toString().toLowerCase()).some(t=>t.includes(e)))))},[ja,Ra,Ia,Ma]),el=(0,e.useMemo)(()=>{const e=[...Ya],t=(e,t)=>"mtime"===t?Number(e?.mtime||0):(e?.[t]||"").toString().toLowerCase();return e.sort((e,s)=>{const n=t(e,Pa.key),i=t(s,Pa.key);if(n===i)return 0;const a=n>i?1:-1;return"asc"===Pa.direction?a:-1*a}),e},[Ya,Pa]),tl=Math.max(1,Math.ceil(el.length/20)),sl=Math.min(Ta,tl),nl=(0,e.useMemo)(()=>{const e=20*(sl-1);return el.slice(e,e+20)},[el,sl,20]),il=e=>{Ua(1),Oa(t=>t.key===e?{key:e,direction:"asc"===t.direction?"desc":"asc"}:{key:e,direction:"asc"})};if(!Ie&&Re){const e=t?.Spinner?(0,s.jsx)(t.Spinner,{}):(0,s.jsx)("span",{style:{width:32,height:32,display:"inline-flex",alignItems:"center",justifyContent:"center",borderRadius:"50%",background:"var(--dbvc-color-surface-muted, #f6f7f7)",fontSize:20},children:"…"});return(0,s.jsx)("div",{className:"dbvc-admin-app dbvc-admin-app--initializing",children:(0,s.jsxs)("div",{className:"dbvc-admin-app__loading-panel",style:{minHeight:280,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:12,textAlign:"center",padding:"32px 16px"},children:[e,(0,s.jsx)("p",{style:{fontSize:18,margin:0},children:"Preparing proposals… please keep this tab open."}),(0,s.jsx)("small",{style:{color:"var(--dbvc-color-text-subtle, #8c8f94)",maxWidth:420,lineHeight:1.6},children:"We’re refreshing proposal data and synchronizing reviewer decisions. This can take a moment after updates."})]})})}return"entity-editor"===Vi?(0,s.jsxs)("div",{className:`dbvc-admin-app is-route-${Vi}`,onClick:hn,onMouseDown:hn,onSubmit:mn,children:[gt.length>0&&(0,s.jsx)("div",{className:"dbvc-toasts",children:gt.map(e=>(0,s.jsxs)("div",{className:`dbvc-toast dbvc-toast--${e.severity}`,children:[(0,s.jsxs)("div",{className:"dbvc-toast__content",children:[(0,s.jsx)("strong",{children:e.title}),(0,s.jsx)("span",{children:e.message}),e.detail&&(0,s.jsx)("small",{children:e.detail}),(0,s.jsx)("small",{className:"dbvc-toast__time",children:p(e.timestamp)})]}),(0,s.jsx)("button",{type:"button",className:"dbvc-toast__dismiss",onClick:()=>li(e.id),"aria-label":"Dismiss notification",children:"×"})]},e.id))}),(0,s.jsxs)("div",{className:"dbvc-admin-app__header",children:[(0,s.jsx)("h1",{children:"DBVC Entity Editor"}),(0,s.jsx)(t.Button,{variant:"secondary",onClick:()=>Za(!1),disabled:Na,children:Na?"Refreshing…":"Refresh index"}),(0,s.jsx)(t.Button,{variant:"tertiary",onClick:()=>Za(!0),disabled:Na,isBusy:Na,children:Na?"Rebuilding…":"Rebuild index"})]}),(0,s.jsxs)("nav",{className:"dbvc-admin-app__menu","aria-label":"DBVC admin sections",children:[(0,s.jsx)("button",{type:"button",className:"button"+("proposal-review"===Vi?" button-primary":""),onClick:()=>Fa("proposal-review"),children:"Proposal Review"}),(0,s.jsx)("button",{type:"button",className:"button"+("entity-editor"===Vi?" button-primary":""),onClick:()=>window.location.assign("admin.php?page=dbvc-entity-editor"),children:"Entity Editor"})]}),(0,s.jsxs)("section",{className:"dbvc-entity-editor-shell",children:[(0,s.jsx)("h2",{children:"Entity index"}),(0,s.jsxs)("p",{className:"description",children:["Showing ",el.length," indexed entities from sync (posts + terms only)."]}),$a&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsx)("p",{children:$a})}),(0,s.jsxs)("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap",marginBottom:"12px"},children:[(0,s.jsxs)("label",{children:["Kind ",(0,s.jsxs)("select",{value:Ra,onChange:e=>{Aa(e.target.value),Ua(1)},children:[(0,s.jsx)("option",{value:"all",children:"All"}),(0,s.jsx)("option",{value:"post",children:"Posts"}),(0,s.jsx)("option",{value:"term",children:"Terms"})]})]}),(0,s.jsxs)("label",{children:["Subtype ",(0,s.jsxs)("select",{value:Ia,onChange:e=>{Ea(e.target.value),Ua(1)},children:[(0,s.jsx)("option",{value:"all",children:"All"}),Qa.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]})]}),(0,s.jsxs)("label",{children:["Search ",(0,s.jsx)("input",{type:"search",value:Ma,onChange:e=>{Ba(e.target.value),Ua(1)},placeholder:"title, slug, uid, file"})]})]}),(0,s.jsx)("div",{className:"dbvc-entity-editor-shell__pane dbvc-entity-editor__table",children:(0,s.jsxs)("table",{className:"widefat striped",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:(0,s.jsxs)("button",{type:"button",className:"button button-link",onClick:()=>il("entity_kind"),children:["Kind","entity_kind"===Pa.key?"asc"===Pa.direction?" ↑":" ↓":""]})}),(0,s.jsx)("th",{children:"Matched WP"}),(0,s.jsx)("th",{children:(0,s.jsxs)("button",{type:"button",className:"button button-link",onClick:()=>il("subtype"),children:["Subtype","subtype"===Pa.key?"asc"===Pa.direction?" ↑":" ↓":""]})}),(0,s.jsx)("th",{children:(0,s.jsxs)("button",{type:"button",className:"button button-link",onClick:()=>il("title"),children:["Title","title"===Pa.key?"asc"===Pa.direction?" ↑":" ↓":""]})}),(0,s.jsx)("th",{children:(0,s.jsxs)("button",{type:"button",className:"button button-link",onClick:()=>il("slug"),children:["Slug","slug"===Pa.key?"asc"===Pa.direction?" ↑":" ↓":""]})}),(0,s.jsx)("th",{children:(0,s.jsxs)("button",{type:"button",className:"button button-link",onClick:()=>il("uid"),children:["UID","uid"===Pa.key?"asc"===Pa.direction?" ↑":" ↓":""]})}),(0,s.jsx)("th",{children:(0,s.jsxs)("button",{type:"button",className:"button button-link",onClick:()=>il("mtime"),children:["Modified","mtime"===Pa.key?"asc"===Pa.direction?" ↑":" ↓":""]})}),(0,s.jsx)("th",{children:(0,s.jsxs)("button",{type:"button",className:"button button-link",onClick:()=>il("relative_path"),children:["File","relative_path"===Pa.key?"asc"===Pa.direction?" ↑":" ↓":""]})}),(0,s.jsx)("th",{children:"Actions"})]})}),(0,s.jsx)("tbody",{children:nl.length?nl.map(e=>(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:e.entity_kind||"—"}),(0,s.jsx)("td",{children:e.matched_wp?.id?(0,s.jsxs)("a",{href:e.matched_wp?.edit_url||"#",children:[e.matched_wp?.kind||"wp"," #",e.matched_wp?.id]}):"—"}),(0,s.jsx)("td",{children:e.subtype||"—"}),(0,s.jsx)("td",{children:e.title||"—"}),(0,s.jsx)("td",{children:e.slug||"—"}),(0,s.jsx)("td",{children:e.uid||"—"}),(0,s.jsx)("td",{children:e.mtime_gmt?p(e.mtime_gmt):"—"}),(0,s.jsx)("td",{children:e.relative_path||"—"}),(0,s.jsx)("td",{children:(0,s.jsx)("button",{type:"button",className:"button button-small",onClick:()=>La(e.relative_path),children:"Edit JSON"})})]},e.relative_path)):(0,s.jsx)("tr",{children:(0,s.jsx)("td",{colSpan:9,children:Na?"Loading index…":"No matching entities found."})})})]})}),zi&&(0,s.jsxs)("div",{className:"dbvc-entity-editor-shell__pane dbvc-entity-editor__editor",style:{marginTop:"12px"},children:[(0,s.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,s.jsxs)("h3",{children:["Editing: ",zi]}),(0,s.jsx)("button",{type:"button",className:"button",onClick:Va,children:"Back to list"})]}),Hi&&(0,s.jsx)("p",{children:"Loading file…"}),Wi&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsx)("p",{children:Wi})}),pa&&(0,s.jsxs)("div",{className:"notice notice-warning",children:[(0,s.jsxs)("p",{children:["Current lock owner: ",pa?.user_display||"another user",pa?.expires_at?` (expires ${p(pa.expires_at)})`:""]}),(0,s.jsx)("button",{type:"button",className:"button",onClick:Xa,children:"Take over lock"})]}),Ji&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("p",{className:"description",children:["Kind: ",Ji.entity_kind||"—"," · Subtype: ",Ji.subtype||"—"," · UID: ",Ji.uid||"—"]}),da&&(0,s.jsxs)("p",{className:"description",children:["Editor lock: ",da?.user_display||"unknown",da?.expires_at?` · expires ${p(da.expires_at)}`:""]}),(0,s.jsx)("textarea",{style:{width:"100%",minHeight:"280px",fontFamily:"monospace"},value:Xi,onChange:e=>{Zi(e.target.value),aa(""),oa("")}}),la&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("p",{children:la}),pa&&(0,s.jsx)("button",{type:"button",className:"button",onClick:()=>Ja(!0),disabled:Qi||ea||sa,children:"Take over lock and save"}),pa&&(0,s.jsx)("button",{type:"button",className:"button",onClick:()=>qa(!0),disabled:Qi||ea||sa,children:"Take over lock and full replace"})]})}),ia&&(0,s.jsx)("div",{className:"notice notice-success",children:(0,s.jsx)("p",{children:ia})}),(0,s.jsx)(t.Button,{variant:"primary",onClick:Ja,disabled:Qi||ea||sa||!ra,isBusy:Qi,children:Qi?"Saving…":"Save JSON"}),(0,s.jsx)(t.Button,{variant:"secondary",onClick:Ka,disabled:ea||Qi||sa||!ra,isBusy:ea,children:ea?"Importing…":"Save + Partial Import"}),(0,s.jsx)(t.Button,{variant:"secondary",onClick:()=>qa(!1),disabled:sa||ea||Qi||!ra,isBusy:sa,children:sa?"Replacing…":"Save + Full Replace"})]})]}),(0,s.jsxs)("div",{style:{marginTop:"10px",display:"flex",gap:"8px",alignItems:"center"},children:[(0,s.jsx)("button",{type:"button",className:"button",disabled:sl<=1,onClick:()=>Ua(e=>Math.max(1,e-1)),children:"Previous"}),(0,s.jsxs)("span",{children:["Page ",sl," of ",tl]}),(0,s.jsx)("button",{type:"button",className:"button",disabled:sl>=tl,onClick:()=>Ua(e=>Math.min(tl,e+1)),children:"Next"}),ka&&(0,s.jsxs)("small",{children:[" · indexed: ",null!==(o=ka?.indexed_files)&&void 0!==o?o:0,", scanned: ",null!==(c=ka?.scanned_files)&&void 0!==c?c:0,", excluded: ",null!==(d=ka?.excluded_files)&&void 0!==d?d:0]})]}),ma&&(t?.Modal?(0,s.jsxs)(t.Modal,{title:"Confirm Full Replace",onRequestClose:Wa,children:[(0,s.jsx)("p",{children:"This operation is destructive. Meta keys not present in JSON will be deleted (except protected keys)."}),xa&&(0,s.jsx)("p",{children:"This action will also take over the editor lock."}),(0,s.jsxs)("p",{children:["Type ",(0,s.jsx)("code",{children:"REPLACE"})," to confirm."]}),(0,s.jsx)("input",{type:"text",value:ba,onChange:e=>{fa(e.target.value),_a("")},placeholder:"REPLACE",style:{width:"100%"}}),ga&&(0,s.jsx)("p",{style:{color:"#b32d2e"},children:ga}),(0,s.jsxs)("div",{style:{display:"flex",gap:"8px",justifyContent:"flex-end",marginTop:"12px"},children:[(0,s.jsx)(t.Button,{variant:"tertiary",onClick:Wa,children:"Cancel"}),(0,s.jsx)(t.Button,{variant:"primary",onClick:Ga,disabled:sa,isBusy:sa,children:"Confirm Replace"})]})]}):(0,s.jsxs)("div",{className:"notice notice-warning",children:[(0,s.jsx)("p",{children:'Typed confirmation needed: enter "REPLACE" then use Save + Full Replace.'}),(0,s.jsx)("button",{type:"button",className:"button",onClick:Wa,children:"Close"})]}))]})]}):!Ie&&Fe?(0,s.jsxs)("p",{className:"dbvc-admin-app-error",children:["Error loading proposals: ",u(Fe)]}):(0,s.jsxs)("div",{className:`dbvc-admin-app is-route-${Vi}`,onClick:hn,onMouseDown:hn,onSubmit:mn,children:[gt.length>0&&(0,s.jsx)("div",{className:"dbvc-toasts",children:gt.map(e=>(0,s.jsxs)("div",{className:`dbvc-toast dbvc-toast--${e.severity}`,children:[(0,s.jsxs)("div",{className:"dbvc-toast__content",children:[(0,s.jsx)("strong",{children:u(e.title)}),(0,s.jsx)("span",{children:u(e.message)}),e.detail&&(0,s.jsx)("small",{children:u(e.detail)}),(0,s.jsx)("small",{className:"dbvc-toast__time",children:p(e.timestamp)})]}),(0,s.jsx)("button",{type:"button",className:"dbvc-toast__dismiss",onClick:()=>li(e.id),"aria-label":"Dismiss notification",children:"×"})]},e.id))}),(0,s.jsxs)("div",{className:"dbvc-admin-app__header",children:[(0,s.jsx)("h1",{children:"DBVC Proposals"}),(0,s.jsx)(t.Button,{variant:"secondary",onClick:()=>dn(),disabled:Re&&Ie,children:Re&&Ie?"Refreshing…":"Refresh list"}),(0,s.jsx)(t.Button,{variant:"tertiary",onClick:bi,disabled:It,isBusy:It,children:It?"Clearing…":"Clear all backups"})]}),(0,s.jsxs)("nav",{className:"dbvc-admin-app__menu","aria-label":"DBVC admin sections",children:[(0,s.jsx)("button",{type:"button",className:"button"+("proposal-review"===Vi?" button-primary":""),onClick:()=>Fa("proposal-review"),children:"Proposal Review"}),(0,s.jsx)("button",{type:"button",className:"button"+("entity-editor"===Vi?" button-primary":""),onClick:()=>window.location.assign("admin.php?page=dbvc-entity-editor"),children:"Entity Editor"})]}),(0,s.jsx)(P,{onUploaded:Oi,onError:Ti}),Fe&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)("p",{children:["Failed to load proposals: ",u(Fe)]})}),(0,s.jsx)(B,{proposals:ie,selectedId:le,onSelect:oe,onDelete:un,deleteBusyId:re}),Vn&&(0,s.jsxs)("section",{className:"dbvc-admin-app__detail",children:[(0,s.jsx)("h2",{children:Vn.title}),(0,s.jsxs)("p",{className:"dbvc-admin-app__detail-meta",children:["Generated: ",p(Vn.generated_at)," · Files:"," ",null!==(G=Vn.files)&&void 0!==G?G:"—"," · Media: ",null!==(X=Vn.media_items)&&void 0!==X?X:"—"," · Status:"," ",(0,s.jsx)("strong",{children:"closed"===Vn.status?"Closed":"Open"})," ",(0,s.jsx)("span",{className:"dbvc-badge dbvc-badge--resolver",children:(0,s.jsx)("a",{href:"#dbvc-global-resolver",children:"Global rules enabled"})})]}),Je&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)("p",{children:["Resolver error: ",Je]})}),Pe?(0,s.jsx)("p",{children:"Loading resolver metrics…"}):(0,s.jsx)(O,{resolver:de}),(0,s.jsxs)("div",{className:"dbvc-admin-app__actions",children:[(0,s.jsx)("button",{type:"button",className:"button button-primary",onClick:ii,disabled:We||"closed"===Vn.status,title:"closed"===Vn.status?"Reopen this proposal before applying new changes.":void 0,children:We?"Applying…":"Close & Apply Proposal"}),"closed"===Vn.status?(0,s.jsxs)("div",{className:"dbvc-admin-app__status-note",children:[(0,s.jsx)("p",{children:"This proposal has been closed. Reopen it to continue reviewing this snapshot."}),(0,s.jsx)("button",{type:"button",className:"button",onClick:()=>ei("draft"),disabled:Xe,children:Xe?"Reopening…":"Reopen proposal"})]}):(0,s.jsx)("p",{className:"description",children:"Applying will close this proposal snapshot. Re-export on the source site for additional changes."}),_i>0&&(0,s.jsxs)("div",{className:"dbvc-decisions",children:[(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--accept",children:[xi," accept"]}),ji>0&&(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--new",children:[ji," new"]}),(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--keep",children:[yi," keep"]}),(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--reviewed",children:[wi," reviewed"]})]})]}),it&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)("p",{children:["Apply failed: ",u(it)]})}),st&&(0,s.jsxs)("div",{className:Ai,children:[(0,s.jsxs)("p",{children:['Applied proposal "',Vn?.title||le,'". Mode: ',null!==(Z=st.mode)&&void 0!==Z?Z:"full"," · Imported ",Ii," · Skipped"," ",Ei,st.decisions_cleared&&st.auto_clear_enabled?" · Reviewer decisions were cleared.":"",Bi>0&&` · ${Bi} resolver conflict(s) remain.`]}),Pi&&(0,s.jsxs)("p",{className:"dbvc-resolver-summary",children:["Media reconciliation — created: ",null!==(Q=Pi.created)&&void 0!==Q?Q:0,", unresolved: ",null!==(Y=Pi.unresolved)&&void 0!==Y?Y:0]}),st.resolver_decisions&&(0,s.jsxs)("p",{className:"dbvc-resolver-summary",children:["Resolver decisions applied — reuse: ",null!==(ee=st.resolver_decisions.reuse)&&void 0!==ee?ee:0,", map:"," ",null!==(te=st.resolver_decisions.map)&&void 0!==te?te:0,", download: ",null!==(se=st.resolver_decisions.download)&&void 0!==se?se:0,", skip:"," ",null!==(ne=st.resolver_decisions.skip)&&void 0!==ne?ne:0]}),Ri.length>0&&(0,s.jsx)("ul",{children:Ri.map((e,t)=>(0,s.jsx)("li",{children:u(e)},t))})]}),ki&&(0,s.jsx)("div",{className:"dbvc-resolver-summary",children:(0,s.jsxs)("span",{children:["Resolver decisions — reuse: ",Ci,", map: ",Ni,", download:"," ",Si,", skip: ",$i]})}),xt.length>0&&(0,s.jsxs)("div",{className:"dbvc-apply-history",children:[(0,s.jsx)("h3",{children:"Recent Apply Runs"}),(0,s.jsx)("ul",{children:xt.map(e=>{var t,n,i,a;return(0,s.jsxs)("li",{children:[(0,s.jsx)("strong",{children:p(e.timestamp)})," — Mode ",e.mode," · Imported ",e.imported," · Skipped ",e.skipped,e.errors.length?` · ${e.errors.length} error(s)`:"",e.decisionsCleared?" · Selections cleared":"",e.ignoreMissingHash?" · Hash override":"",e.resolverDecisions?` · Resolver decisions (reuse ${null!==(t=e.resolverDecisions.reuse)&&void 0!==t?t:0}, map ${null!==(n=e.resolverDecisions.map)&&void 0!==n?n:0}, download ${null!==(i=e.resolverDecisions.download)&&void 0!==i?i:0}, skip ${null!==(a=e.resolverDecisions.skip)&&void 0!==a?a:0})`:""]},e.id)})})]}),lt&&(0,s.jsxs)(t.Modal,{title:`Apply proposal "${Vn?.title||le}"`,onRequestClose:ai,isDismissible:!We,shouldCloseOnClickOutside:!We,children:[(0,s.jsxs)("div",{className:"dbvc-apply-modal__summary",children:[(0,s.jsx)("p",{children:"This will run the import pipeline for the selected proposal using the chosen mode."}),(0,s.jsx)("p",{className:"dbvc-apply-modal__warning",children:"Applying closes this proposal snapshot. To continue reviewing additional entities, export a new proposal after this step or reopen if necessary."}),_i>0?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("p",{children:"Reviewer selections captured:"}),(0,s.jsxs)("ul",{children:[(0,s.jsxs)("li",{children:[xi," field(s) marked Accept"]}),ji>0&&(0,s.jsxs)("li",{children:[ji," new entity approval(s)"]}),(0,s.jsxs)("li",{children:[yi," field(s) kept as-is"]}),(0,s.jsxs)("li",{children:[wi," entity row(s) touched"]})]}),(0,s.jsx)("p",{className:"description",children:"Only fields marked Accept will overwrite live data. Other fields remain unchanged."})]}):(0,s.jsx)("p",{className:"dbvc-apply-modal__warning",children:"No reviewer selections have been recorded. Applying now only imports entities with Accept/Keep selections or new entities you marked “Accept & import.” All other entities are skipped."})]}),(0,s.jsx)(t.RadioControl,{label:"Import mode",selected:rt,options:[{label:"Full import (copy entire proposal)",value:"full"},{label:"Partial import (skip unchanged items when hashes match)",value:"partial"}],onChange:e=>ct(e)}),(0,s.jsxs)("div",{className:"dbvc-apply-mode-help",children:[(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Full import (recommended):"})," Applies only the fields you accepted, records the close-out, and leaves untouched entities for the next export."]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Partial import (legacy):"})," Only needed for old proposals missing import hashes. Behavior otherwise matches full import."]})]}),"partial"===rt&&(0,s.jsx)(t.CheckboxControl,{label:"Ignore missing import hash validation",checked:dt,onChange:e=>ut(e),help:"Use only for legacy backups that predate import hash support. Recommended to resolve hash mismatches when possible."}),(0,s.jsx)("p",{className:"description",children:"Selections will be cleared automatically after a successful apply if the auto-clear setting is enabled in Configure → Import."}),(0,s.jsxs)("div",{className:"dbvc-apply-modal__footer",children:[(0,s.jsx)(t.Button,{variant:"secondary",onClick:ai,disabled:We,children:"Cancel"}),(0,s.jsx)(t.Button,{variant:"primary",onClick:oi,isBusy:We,disabled:We,children:"Close & Apply Proposal"})]})]}),(0,s.jsxs)("div",{className:"dbvc-entities-header",children:[(0,s.jsx)("h3",{children:"Entities"}),Tt&&(0,s.jsx)("span",{className:"dbvc-duplicates-loading",children:"Checking duplicates…"})]}),(0,s.jsxs)("div",{className:"dbvc-entity-summary",children:[(0,s.jsxs)("div",{className:"dbvc-entity-summary__block",children:[(0,s.jsx)("strong",{children:"Total Proposed Entities"}),(0,s.jsxs)("div",{className:"dbvc-entity-summary__counts",children:[(0,s.jsxs)("span",{children:["Total: ",zn.proposed.total]}),(0,s.jsxs)("span",{children:["Posts: ",zn.proposed.posts]}),(0,s.jsxs)("span",{children:["Terms: ",zn.proposed.terms]}),(0,s.jsxs)("span",{children:["Media: ",Jn]})]})]}),(0,s.jsxs)("div",{className:"dbvc-entity-summary__block",children:[(0,s.jsx)("strong",{children:"Total Current Entities"}),(0,s.jsxs)("div",{className:"dbvc-entity-summary__counts",children:[(0,s.jsxs)("span",{children:["Total: ",zn.current.total]}),(0,s.jsxs)("span",{children:["Posts: ",zn.current.posts]}),(0,s.jsxs)("span",{children:["Terms: ",zn.current.terms]}),(0,s.jsxs)("span",{children:["Media: ",Kn]})]})]}),(0,s.jsxs)("div",{className:"dbvc-entity-summary__block",children:[(0,s.jsx)("strong",{children:"Filtered Results"}),(0,s.jsxs)("div",{className:"dbvc-entity-summary__counts",children:[(0,s.jsxs)("span",{children:["Showing: ",Hn]}),bt&&(0,s.jsx)("span",{children:"Updating totals…"})]})]})]}),Ft&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)("p",{children:["Failed to load duplicate summary: ",Ft]})}),(0,s.jsxs)("div",{className:"dbvc-admin-app__filters",children:[(0,s.jsxs)("label",{children:["Show: ",(0,s.jsxs)("select",{value:me,onChange:e=>{ve(e.target.value)},children:[(0,s.jsx)("option",{value:"all",children:x.all}),(0,s.jsx)("option",{value:"needs_review",children:x.needs_review}),(0,s.jsx)("option",{value:"needs_review_media",children:x.needs_review_media}),(0,s.jsx)("option",{value:"resolved",children:x.resolved}),(0,s.jsx)("option",{value:"new_entities",children:x.new_entities}),(0,s.jsx)("option",{value:"with_decisions",children:x.with_decisions}),(0,s.jsx)("option",{value:"uid_mismatch",children:x.uid_mismatch})]})]}),(0,s.jsxs)("label",{children:[" Search: ",(0,s.jsx)("input",{type:"search",value:be,onChange:e=>{fe(e.target.value)},placeholder:"Title, type, path…"})]})]}),(0,s.jsxs)("div",{className:"dbvc-entity-badges-row",children:[(0,s.jsx)("div",{className:"dbvc-entity-status-badges",children:Xn.map(e=>(0,s.jsxs)("button",{type:"button",className:"dbvc-status-badge"+(me===e.filter?" is-active":""),disabled:0===e.count,"aria-pressed":me===e.filter,onClick:()=>ve(me===e.filter?"all":e.filter),children:[(0,s.jsx)("span",{children:e.label}),(0,s.jsx)("strong",{children:e.count})]},e.id))})]}),(0,s.jsx)("div",{className:"dbvc-entity-tools-row",children:[ls.size>0||pe.length>ls.size?(0,s.jsxs)("div",{className:"dbvc-selection-controls",children:[pe.length>ls.size?(0,s.jsxs)(t.Button,{variant:"secondary",className:"dbvc-selection-controls__button",onClick:Cn,disabled:0===pe.length,children:[(0,s.jsx)("span",{className:"dashicons dashicons-yes","aria-hidden":"true"}),(0,s.jsxs)("span",{children:["Select all (",pe.length,")"]})]}):null,ls.size>0?(0,s.jsxs)(t.Button,{variant:"secondary",className:"dbvc-selection-controls__button",onClick:kn,children:[(0,s.jsx)("span",{className:"dashicons dashicons-dismiss","aria-hidden":"true"}),(0,s.jsxs)("span",{children:["Clear selection (",ls.size,")"]})]}):null]}):null,(0,s.jsx)("div",{className:"dbvc-filter-toggle"+($s?" is-open":""),ref:Bs,onMouseLeave:()=>Ds(!1),children:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n,{content:"Filter entities by type or UID mismatch.",children:(0,s.jsxs)(t.Button,{variant:"secondary",className:"dbvc-filter-toggle__button",onClick:()=>Ds(e=>!e),"aria-haspopup":"true","aria-expanded":$s,"aria-controls":"dbvc-filter-toggle-menu",children:[(0,s.jsx)("span",{className:"dashicons dashicons-filter","aria-hidden":"true"}),(0,s.jsx)("span",{className:"dbvc-filter-toggle__button-label",children:"Filters"}),Pn>0&&(0,s.jsx)("span",{className:"dbvc-filter-toggle__count",children:Pn}),(0,s.jsx)("span",{className:"screen-reader-text",children:"Toggle filter menu"})]})}),$s&&(0,s.jsxs)("div",{id:"dbvc-filter-toggle-menu",className:"dbvc-filter-toggle__menu",role:"menu",children:[(0,s.jsxs)("div",{className:"dbvc-filter-toggle__group",children:[(0,s.jsx)("strong",{children:"Object type"}),Mn.length?(0,s.jsx)("div",{className:"dbvc-filter-toggle__options",children:Mn.map(e=>(0,s.jsxs)("label",{className:"dbvc-filter-toggle__option",children:[(0,s.jsx)("input",{type:"checkbox",checked:Rs.includes(e),onChange:()=>On(e)}),(0,s.jsx)("span",{children:e})]},e))}):(0,s.jsx)("span",{className:"dbvc-filter-toggle__empty",children:"No object types available."})]}),(0,s.jsxs)("div",{className:"dbvc-filter-toggle__group",children:[(0,s.jsx)("strong",{children:"vf_object_uid"}),(0,s.jsxs)("label",{className:"dbvc-filter-toggle__option",children:[(0,s.jsx)("input",{type:"checkbox",checked:Is,onChange:e=>Es(e.target.checked)}),(0,s.jsx)("span",{children:"Mismatch only"})]})]}),(0,s.jsx)("div",{className:"dbvc-filter-toggle__actions",children:(0,s.jsx)(t.Button,{variant:"secondary",onClick:Tn,disabled:0===Pn,children:"Clear filters"})})]})]})}),(0,s.jsx)("div",{className:"dbvc-column-toggle"+(Ns?" is-open":""),ref:Ms,onMouseEnter:()=>Ss(!0),onMouseLeave:()=>Ss(!1),children:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n,{content:"Choose which columns are visible in the All Entities table.",children:(0,s.jsxs)(t.Button,{variant:"secondary",className:"dbvc-column-toggle__button",onClick:()=>Ss(e=>!e),"aria-haspopup":"true","aria-expanded":Ns,"aria-controls":"dbvc-column-toggle-menu",children:[(0,s.jsx)("span",{className:"dashicons dashicons-screenoptions","aria-hidden":"true"}),(0,s.jsx)("span",{className:"dbvc-column-toggle__button-label",children:"Columns"}),(0,s.jsx)("span",{className:"screen-reader-text",children:"Toggle column visibility menu"})]})}),Ns&&(0,s.jsx)("div",{id:"dbvc-column-toggle-menu",className:"dbvc-column-toggle__menu",role:"menu",children:M.map(e=>(0,s.jsxs)("label",{className:"dbvc-column-toggle__option",children:[(0,s.jsx)("input",{type:"checkbox",checked:Mt[e.id],onChange:()=>Us(e.id),disabled:e.lockVisible}),(0,s.jsx)("span",{children:e.label})]},e.id))})]})}),Vn?(0,s.jsxs)("div",{className:`dbvc-actions-tray${rs?" is-open":""}${gs?" has-attention":""}`,ref:Ps,children:[(0,s.jsx)(n,{content:"Open Accept/Keep actions, snapshots, and masking tools.",children:(0,s.jsxs)(t.Button,{variant:"secondary",className:"dbvc-actions-tray__button",onClick:()=>cs(e=>{const t=!e;return t&&_s(!1),t}),"aria-expanded":rs,"aria-haspopup":"true",children:[(0,s.jsx)("span",{className:"dashicons dashicons-admin-tools","aria-hidden":"true"}),(0,s.jsx)("span",{children:"Actions & tools"}),(0,s.jsx)("span",{className:"screen-reader-text",children:"Toggle bulk actions tray"})]})}),rs&&(0,s.jsxs)("div",{className:"dbvc-actions-tray__panel",children:[(0,s.jsxs)("div",{className:"dbvc-actions-tray__section",children:[(0,s.jsxs)("div",{className:"dbvc-actions-tray__section-heading",children:[(0,s.jsx)("strong",{children:"Selected entities"}),(0,s.jsx)("p",{children:"Bulk Accept/Keep controls for the entities you checked in the table."})]}),(0,s.jsxs)("div",{className:"dbvc-actions-tray__items",children:[(0,s.jsxs)("div",{className:"dbvc-actions-tray__item",children:[(0,s.jsx)(t.Button,{className:"dbvc-new-entities-accept-button",variant:"primary",onClick:Dn,disabled:es||0===ls.size,isBusy:es,children:es?"Accepting selected…":ls.size>0?`Accept ${ls.size} selected`:"Accept selected"}),(0,s.jsx)("p",{children:ls.size>0?"Apply the proposal values to every selected entity.":"Select one or more entities to enable bulk Accept."})]}),(0,s.jsxs)("div",{className:"dbvc-actions-tray__item",children:[(0,s.jsx)(t.Button,{variant:"secondary",onClick:Rn,disabled:ss||0===ls.size,isBusy:ss,children:ss?"Unaccepting…":"Unaccept selected"}),(0,s.jsx)("p",{children:"Clear Accept decisions for every selected entity."})]}),(0,s.jsxs)("div",{className:"dbvc-actions-tray__item",children:[(0,s.jsx)(t.Button,{variant:"secondary",onClick:An,disabled:is||0===ls.size,isBusy:is,children:is?"Unkeeping…":"Unkeep selected"}),(0,s.jsx)("p",{children:"Remove Keep decisions so fields return to Needs Review."})]})]})]}),(0,s.jsxs)("div",{className:"dbvc-actions-tray__section",children:[(0,s.jsxs)("div",{className:"dbvc-actions-tray__section-heading",children:[(0,s.jsx)("strong",{children:"New entities"}),(0,s.jsx)("p",{children:"Decide what to do with content that doesn’t exist locally yet."})]}),(0,s.jsxs)("div",{className:"dbvc-actions-tray__items",children:[(0,s.jsxs)("div",{className:"dbvc-actions-tray__item",children:[(0,s.jsx)(t.Button,{className:"dbvc-new-entities-accept-button",variant:"primary",onClick:$n,disabled:Qt||!Sn,isBusy:Qt,children:Qt?"Accepting…":`Accept all new entities (${Nn.length})`}),(0,s.jsx)("p",{children:"Import every pending new post or term with one click."})]}),(0,s.jsxs)("div",{className:"dbvc-actions-tray__item",children:[(0,s.jsx)(t.Button,{className:"dbvc-new-entities-button",variant:"secondary",onClick:()=>{ve("new_entities"),fe("")},children:`Review ${Nn.length} new ${1===Nn.length?"entity":"entities"}`}),(0,s.jsx)("p",{children:"Open the New entities filter to inspect each diff."})]})]})]}),(0,s.jsxs)("div",{className:"dbvc-actions-tray__section",children:[(0,s.jsxs)("div",{className:"dbvc-actions-tray__section-heading",children:[(0,s.jsx)("strong",{children:"Snapshots & maintenance"}),(0,s.jsx)("p",{children:"Keep proposal data in sync before you apply decisions."})]}),(0,s.jsxs)("div",{className:"dbvc-actions-tray__items",children:[(0,s.jsxs)("div",{className:"dbvc-actions-tray__item",children:[(0,s.jsx)(t.Button,{variant:"secondary",onClick:pn,disabled:Me,isBusy:Me,children:Me?"Refreshing…":"Refresh entities"}),(0,s.jsx)("p",{children:"Reload entity rows, selections, and resolver stats."})]}),(0,s.jsxs)("div",{className:"dbvc-actions-tray__item",children:[(0,s.jsx)(t.Button,{variant:"secondary",onClick:vi,disabled:Rt,isBusy:Rt,children:Rt?"Capturing snapshots…":"Capture full snapshot"}),(0,s.jsx)("p",{children:Di>0?`Capture JSON snapshots for ${Di} unresolved entity ${1===Di?"diff":"diffs"}.`:"Capture fresh JSON snapshots for every entity."})]}),Ln.length>0&&(0,s.jsxs)("div",{className:"dbvc-actions-tray__item",children:[(0,s.jsx)(t.Button,{variant:"secondary",onClick:ti,disabled:Qe&&"bulk"===et,isBusy:Qe&&"bulk"===et,children:Qe&&"bulk"===et?"Storing hashes…":`Store hashes (${Ln.length})`}),(0,s.jsx)("p",{children:"Sync import hashes for entities missing their stored value."})]}),(0,s.jsxs)("div",{className:"dbvc-actions-tray__item",children:[(0,s.jsx)(t.Button,{variant:"primary",className:"dbvc-duplicates-button",onClick:()=>zt(!0),disabled:0===Pt.count,children:Pt.count>0?`Resolve ${Pt.count} duplicate${1===Pt.count?"":"s"}`:"No duplicates detected"}),(0,s.jsx)("p",{children:Pt.count>0?"Launch the duplicate modal to pick a canonical entity before continuing.":"All manifest entries look unique."})]})]})]}),(0,s.jsxs)("div",{className:"dbvc-actions-tray__section dbvc-actions-tray__section--masking",children:[(0,s.jsxs)("div",{className:"dbvc-tools-panel__section dbvc-tools-panel__section--masking",children:[(0,s.jsxs)("div",{className:"dbvc-tools-panel__section-heading",children:[(0,s.jsx)("strong",{children:"Meta masking"}),(ps||bs)&&(0,s.jsxs)("span",{className:"dbvc-mask-progress",children:[ps?Zs:sn,ps?"% loaded":"% applied"]}),(0,s.jsx)("a",{href:r("live-proposal-masking"),target:"_blank",rel:"noreferrer",children:"Masking guide ↗"}),en&&(0,s.jsx)(t.Button,{variant:"tertiary",onClick:rn,disabled:bs,children:bs?"Reverting…":"Undo last masking"})]}),ms&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)("p",{children:["Masking error: ",ms]})}),ps?(0,s.jsx)("p",{children:"Loading masking rules…"}):qn>0?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("p",{children:["Found ",qn," masked field",1===qn?"":"s"," across ",Wn," entit",1===Wn?"y":"ies",". Choose how to handle them."]}),t?.SelectControl?(0,s.jsx)(t.SelectControl,{label:"Bulk action",value:xs,options:Zn,onChange:e=>ys(e)}):(0,s.jsxs)("label",{children:["Bulk action",(0,s.jsxs)("select",{value:xs,onChange:e=>ys(e.target.value),children:Zn.map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.value))})]}),"override"===xs&&(0,s.jsxs)("div",{className:"dbvc-mask-field__override",children:[t?.TextareaControl?(0,s.jsx)(t.TextareaControl,{label:"Override value",value:js,onChange:e=>ws(e),rows:3}):(0,s.jsxs)("label",{children:["Override value",(0,s.jsx)("textarea",{value:js,onChange:e=>ws(e.target.value)})]}),t?.TextControl?(0,s.jsx)(t.TextControl,{label:"Note (optional)",value:ks,onChange:e=>Cs(e)}):(0,s.jsxs)("label",{children:["Note (optional)",(0,s.jsx)("input",{type:"text",value:ks,onChange:e=>Cs(e.target.value)})]})]}),(0,s.jsxs)("div",{className:"dbvc-mask-actions",children:[(0,s.jsx)(n,{content:Qn.apply,children:(0,s.jsx)(t.Button,{variant:"primary",onClick:on,disabled:bs||ps||!qn,isBusy:bs,children:bs?"Applying…":"Apply masking rules"})}),(0,s.jsx)(n,{content:Qn.revert,children:(0,s.jsx)(t.Button,{variant:"secondary",onClick:cn,disabled:an||bs||ps,isBusy:an,children:an?"Reverting…":"Revert masking decisions"})}),(0,s.jsx)(t.Button,{variant:"tertiary",onClick:()=>le&&Ys(le),disabled:ps,isBusy:ps,children:ps?"Refreshing…":"Refresh list"})]})]}):(0,s.jsxs)("p",{children:["No masked fields pending in this proposal. Learn more in the ",(0,s.jsx)("a",{href:r("live-proposal-masking"),target:"_blank",rel:"noreferrer",children:"masking reference"}),"."]})]})]})]})]}):null]}),Ve&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)("p",{children:["Failed to load entities: ",Ve]})}),(0,s.jsxs)("div",{className:"dbvc-entity-table-wrapper",children:[Pt.count>0&&(0,s.jsx)("button",{type:"button",className:"dbvc-duplicates-overlay",onClick:()=>zt(!0),title:"Resolve duplicate manifest entries before continuing.",children:"Duplicate manifest entries detected — resolve these first"}),(0,s.jsx)(T,{entities:Un,loading:Me,selectedEntityId:ge,onSelect:Yn,columns:Ts,selectedIds:ls,onToggleSelection:jn,onToggleSelectionAll:wn})]}),(0,s.jsx)(W,{}),(0,s.jsx)(U,{entityDetail:xe,resolverInfo:Fn?.resolver,resolverDecisionSummary:Vn?.resolver_decisions,decisions:ke,onDecisionChange:ri,onBulkDecision:fi,onResetDecisions:hi,onCaptureSnapshot:mi,onResolverDecision:di,onResolverDecisionReset:ui,onApplyResolverDecisionToSimilar:pi,savingPaths:Ne,bulkSaving:xn,resolverSaving:jt,resolverError:kt,decisionError:$e,loading:Te,error:He,filterMode:pt,onFilterModeChange:ht,isOpen:je,onClose:ni,resettingDecisions:Nt,snapshotCapturing:$t,onHashSync:si,hashSyncing:Qe,hashSyncTarget:et,maskFieldsByEntity:Gn}),(0,s.jsx)(F,{open:Vt,onClose:()=>zt(!1),onMarkCanonical:bn,actionKey:Jt,report:Pt,bulkMode:Ht,onBulkModeChange:qt,confirmPhrase:Os,confirmValue:Wt,onConfirmChange:Gt,onBulkCleanup:fn,bulkBusy:Xt,bulkDisabled:gn})]})]})};class V extends e.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){this.props.onError&&this.props.onError(e,t)}render(){return this.state.hasError?(0,s.jsxs)("div",{className:"dbvc-admin-app dbvc-admin-app--crashed",children:[(0,s.jsx)("h2",{children:"DBVC Proposals encountered an error"}),(0,s.jsxs)("div",{className:"notice notice-error",children:[(0,s.jsx)("p",{children:"The interface hit an unexpected error. You can reload this page to try again."}),(0,s.jsx)("p",{children:(0,s.jsx)("button",{type:"button",className:"button",onClick:()=>window.location.reload(),children:"Reload"})})]}),this.state.error&&(0,s.jsxs)("p",{className:"dbvc-admin-app__error-detail",children:["Error: ",h(this.state.error.message||this.state.error)]})]}):this.props.children}}const z=(e,t)=>{try{const s={message:e&&e.message?e.message:String(e),stack:e&&e.stack?e.stack:null,componentStack:t&&t.componentStack?t.componentStack:null,path:window.location&&window.location.href?window.location.href:null,context:"admin-app"};a("logs/client",s)}catch(e){}},J=()=>{const t=document.getElementById("dbvc-admin-app-root");if(!t)return;const n=e.createRoot?e.createRoot(t):null,i=(0,s.jsx)(V,{onError:z,children:(0,s.jsx)(L,{})});n?n.render(i):(0,e.render)(i,t)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",J):J();const K=({section:t,decisions:n,onDecisionChange:i,savingPaths:a})=>{const[l,o]=(0,e.useState)(!0);return(0,s.jsxs)("div",{className:"dbvc-admin-app__diff-section",id:`dbvc-diff-${t.key}`,children:[(0,s.jsxs)("button",{type:"button",className:"dbvc-admin-app__diff-toggle",onClick:()=>o(e=>!e),"aria-expanded":l,children:[(0,s.jsx)("h4",{children:t.label}),(0,s.jsx)("span",{children:l?"Collapse":"Expand"})]}),l?(0,s.jsxs)("table",{className:"widefat dbvc-admin-app__diff-table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{style:{width:"25%"},children:"Field"}),(0,s.jsx)("th",{children:"Current"}),(0,s.jsx)("th",{children:"Proposed"}),(0,s.jsx)("th",{style:{width:"20%"},children:"Decision"})]})}),(0,s.jsx)("tbody",{children:t.items.map(e=>{var t;const l=((e,t)=>{const s=m(e),n=m(t);if(s===n)return null;if(s.length>5e3||n.length>5e3)return null;const i=Math.min(s.length,n.length);let a=0;for(;a<i&&s[a]===n[a];)a++;let l=s.length-1,o=n.length-1;for(;l>=a&&o>=a&&s[l]===n[o];)l--,o--;return{old:{before:s.slice(0,a),diff:s.slice(a,l+1),after:s.slice(l+1)},new:{before:n.slice(0,a),diff:n.slice(a,o+1),after:n.slice(o+1)}}})(e.from,e.to),o=null!==(t=n?.[e.path])&&void 0!==t?t:"",r=!!a[e.path],d=!!e.is_equal,p=["dbvc-diff-row"];return(c(e.from)||c(e.to))&&((e,t,s)=>{const n=`${e||"unknown"}::${t||"unknown"}`;u.has(n)||(u.add(n),console.warn("DBVC: Promise detected in entity drawer values.",{entity_uid:e,path:t,value:s}))})(n?.item?.vf_object_uid||n?.vf_object_uid||"",e.path,c(e.from)?e.from:e.to),d?p.push("is-equal"):"accept"===o?p.push("is-accepted"):"keep"===o?p.push("is-kept"):p.push("is-unreviewed"),(0,s.jsxs)("tr",{className:p.join(" "),children:[(0,s.jsx)("td",{children:(0,s.jsxs)("div",{className:"dbvc-field-label",children:[h(e.label||e.path),e.path&&(0,s.jsx)("div",{className:"dbvc-field-label__key",children:h(e.path)})]})}),(0,s.jsx)("td",{children:l&&l.old.diff?v(l.old):h(e.from)}),(0,s.jsx)("td",{children:l&&l.new.diff?v(l.new):h(e.to)}),(0,s.jsxs)("td",{children:[d?(0,s.jsx)("em",{children:"No difference"}):(0,s.jsxs)("div",{className:"dbvc-decision-controls",children:[(0,s.jsxs)("div",{className:"dbvc-decision-options",children:[(0,s.jsxs)("label",{children:[(0,s.jsx)("input",{type:"radio",name:`decision-${e.path}`,value:"keep",checked:"keep"===o,disabled:r,onChange:()=>i&&i(e.path,"keep")}),"Keep"]}),(0,s.jsxs)("label",{children:[(0,s.jsx)("input",{type:"radio",name:`decision-${e.path}`,value:"accept",checked:"accept"===o,disabled:r,onChange:()=>i&&i(e.path,"accept")}),"Accept"]})]}),(0,s.jsx)("button",{type:"button",className:"button-link dbvc-decision-clear",onClick:()=>i&&i(e.path,"clear"),disabled:r||!o,children:"Clear decision"})]}),!d&&(0,s.jsxs)("div",{className:"dbvc-decision-state",children:[(0,s.jsx)("span",{className:"dbvc-decision-status",children:"accept"===o?"Accepted":"keep"===o?"Kept":"Not reviewed"}),r&&(0,s.jsx)("span",{className:"saving",children:"Saving…"})]})]})]},e.path)})})]}):(0,s.jsxs)("div",{className:"dbvc-admin-app__no-diff",children:["Collapsed (",t.items.length," changes)."]})]})},H=({src:e,label:t})=>(0,s.jsxs)("div",{className:"dbvc-resolver-inline-preview",children:[e?(0,s.jsx)("img",{src:e,alt:"",className:"dbvc-resolver-inline-preview__image",loading:"lazy"}):(0,s.jsx)("span",{className:"dbvc-resolver-inline-preview__placeholder",children:"—"}),(0,s.jsx)("span",{className:"dbvc-resolver-inline-preview__label",children:null!=t?t:"—"})]}),q=({attachment:t,saving:n,onSave:i,onClear:a,onApplyToSimilar:l})=>{var o,r;const c=t.original_id,[d,u]=(0,e.useState)(t.decision?.action||""),[p,h]=(0,e.useState)(t.decision?.target_id?String(t.decision.target_id):""),[m,v]=(0,e.useState)(t.decision?.note||""),[b,f]=(0,e.useState)("global"===t.decision?.scope);(0,e.useEffect)(()=>{u(t.decision?.action||""),h(t.decision?.target_id?String(t.decision.target_id):""),v(t.decision?.note||""),f("global"===t.decision?.scope)},[t.decision]);const g="reuse"===d||"map"===d,_=parseInt(p,10),x=d&&(!g||_>0);return(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:j(t.status||"unknown")}),(0,s.jsx)("td",{children:(0,s.jsx)(H,{src:t.preview?.proposed,label:c})}),(0,s.jsx)("td",{children:(0,s.jsx)(H,{src:t.preview?.local,label:null!==(o=t.target_id)&&void 0!==o?o:"—"})}),(0,s.jsx)("td",{children:null!==(r=t.reason)&&void 0!==r?r:"—"}),(0,s.jsx)("td",{children:(0,s.jsxs)("div",{className:"dbvc-resolver-controls dbvc-resolver-controls--decision",children:[(0,s.jsxs)("div",{className:"dbvc-resolver-control",children:[(0,s.jsx)("span",{className:"dbvc-resolver-control__label",children:"Decision"}),(0,s.jsxs)("select",{value:d,onChange:e=>u(e.target.value),children:[(0,s.jsx)("option",{value:"",children:"Select…"}),(0,s.jsx)("option",{value:"reuse",children:"Reuse existing"}),(0,s.jsx)("option",{value:"download",children:"Download new"}),(0,s.jsx)("option",{value:"map",children:"Map to attachment ID"}),(0,s.jsx)("option",{value:"skip",children:"Skip"})]})]}),g&&(0,s.jsxs)("div",{className:"dbvc-resolver-control",children:[(0,s.jsx)("span",{className:"dbvc-resolver-control__label",children:"Target attachment"}),(0,s.jsx)("input",{type:"number",min:"1",placeholder:"Attachment ID",value:p,onChange:e=>h(e.target.value)}),(0,s.jsx)("span",{className:"dbvc-field-hint",children:"Provide an attachment ID for reuse/map actions."})]}),(0,s.jsxs)("div",{className:"dbvc-resolver-control dbvc-resolver-control--note",children:[(0,s.jsx)("span",{className:"dbvc-resolver-control__label",children:"Reviewer note"}),(0,s.jsx)("textarea",{value:m,onChange:e=>v(e.target.value),placeholder:"Optional note",rows:2})]}),(0,s.jsxs)("label",{className:"dbvc-resolver-remember",children:[(0,s.jsxs)("span",{className:"dbvc-toggle",children:[(0,s.jsx)("input",{type:"checkbox",className:"dbvc-toggle__input",checked:b,onChange:e=>f(e.target.checked)}),(0,s.jsx)("span",{className:"dbvc-toggle__track","aria-hidden":"true"})]}),(0,s.jsx)("span",{className:"dbvc-toggle__label",children:"Remember for future proposals"})]})]})}),(0,s.jsxs)("td",{children:[(0,s.jsx)("button",{type:"button",className:"button button-primary",disabled:!x||n,onClick:()=>i&&i(c,{action:d,target_id:g?_:null,note:m,persist_global:b}),children:n?"Saving…":"Save"}),t.decision&&(0,s.jsx)("button",{type:"button",className:"button-link-delete",onClick:()=>a&&a(c,"global"===t.decision.scope?"global":"proposal"),disabled:n,children:"Clear"}),t.decision&&t.reason&&l&&(0,s.jsx)("button",{type:"button",className:"button-link",onClick:()=>{var e,s;return l(t,{action:t.decision?.action,target_id:null!==(e=t.decision?.target_id)&&void 0!==e?e:null,note:null!==(s=t.decision?.note)&&void 0!==s?s:"",persist_global:"global"===t.decision?.scope})},disabled:n,children:"Apply to similar"})]})]})},W=()=>{const[t,n]=(0,e.useState)([]),[o,r]=(0,e.useState)(!0),[c,d]=(0,e.useState)(null),[u,h]=(0,e.useState)(0),[m,v]=(0,e.useState)({}),[b,f]=(0,e.useState)(!1),[g,_]=(0,e.useState)(!1),[x,y]=(0,e.useState)(null),[j,w]=(0,e.useState)({original_id:"",action:"",target_id:"",note:""}),[k,C]=(0,e.useState)(""),[N,S]=(0,e.useState)(!1),[$,D]=(0,e.useState)(!0),[R,A]=(0,e.useState)(!1),[I,E]=(0,e.useState)({imported:0,errors:[]}),M=(0,e.useRef)(null),[B,P]=(0,e.useState)(""),O=(0,e.useRef)(""),T=(0,e.useMemo)(()=>{if(!B)return t;const e=B.toLowerCase();return t.filter(t=>[t.original_id,t.action,t.note,t.target_id,t.saved_at].filter(Boolean).map(e=>String(e).toLowerCase()).some(t=>t.includes(e)))},[B,t]),U=t.length>0,F=T.length>0,L=(Object.values(m).some(Boolean),!x&&j.original_id&&t.some(e=>String(e.original_id)===String(j.original_id))),V=("reuse"===j.action||"map"===j.action)&&j.target_id&&t.some(e=>String(e.original_id)!==String(j.original_id)&&e.target_id&&Number(e.target_id)===Number(j.target_id));(0,e.useEffect)(()=>{if(!O.current){const e=t.find(e=>e.target_id);e&&(O.current=String(e.target_id))}},[t]),(0,e.useEffect)(()=>{let e=!0;return(async()=>{r(!0),d(null);try{const s=await i("resolver-rules");var t;e&&n(null!==(t=s.rules)&&void 0!==t?t:[])}catch(t){e&&d(t.message)}finally{e&&r(!1)}})(),()=>{e=!1}},[u]);const z=(e=null)=>{var t,s,n;e?(y(e),w({original_id:String(null!==(t=e.original_id)&&void 0!==t?t:""),action:null!==(s=e.action)&&void 0!==s?s:"",target_id:e.target_id?String(e.target_id):"",note:null!==(n=e.note)&&void 0!==n?n:""})):(y(null),w({original_id:"",action:"",target_id:O.current||"",note:""})),C(""),_(!0)},J=()=>{_(!1),C(""),y(null)},K=(e,t)=>{w(s=>{const n={...s,[e]:t};return"action"===e&&("reuse"===t||"map"===t?!n.target_id&&O.current&&(n.target_id=O.current):n.target_id=""),n})};return(0,s.jsxs)("section",{className:"dbvc-resolver-rules",id:"dbvc-global-resolver",children:[(0,s.jsxs)("div",{className:"dbvc-resolver-rules__header",children:[(0,s.jsx)("h2",{children:"Global Resolver Rules"}),(0,s.jsx)("button",{type:"button",className:"button button-link",onClick:()=>D(e=>!e),children:$?"Show rules":"Hide rules"})]}),(0,s.jsx)("p",{className:"description",children:"Decisions saved with “remember for future proposals” appear here. They apply automatically whenever a matching original media ID is detected in any proposal."}),!$&&(0,s.jsxs)(s.Fragment,{children:[o&&(0,s.jsx)("p",{children:"Loading resolver rules…"}),c&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsx)("p",{children:c})}),!o&&!U&&(0,s.jsx)("p",{children:"No global rules saved yet."}),U&&(0,s.jsx)("div",{className:"dbvc-panel-search",children:(0,s.jsxs)("label",{children:["Search: ",(0,s.jsx)("input",{type:"search",value:B,onChange:e=>P(e.target.value),placeholder:"ID, action, note…"})]})}),!o&&U&&!F&&(0,s.jsxs)("p",{children:["No rules match “",B,"”."]}),!o&&F&&(0,s.jsxs)("table",{className:"widefat striped",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:(0,s.jsx)("input",{type:"checkbox",checked:b,onChange:()=>{const e=!b;if(f(e),e){const e={};t.forEach(t=>{e[t.original_id]=!0}),v(e)}else v({})}})}),(0,s.jsx)("th",{children:"Original ID"}),(0,s.jsx)("th",{children:"Action"}),(0,s.jsx)("th",{children:"Target"}),(0,s.jsx)("th",{children:"Note"}),(0,s.jsx)("th",{children:"Saved"}),(0,s.jsx)("th",{})]})}),(0,s.jsx)("tbody",{children:T.map(e=>{var t,n;return(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:(0,s.jsx)("input",{type:"checkbox",checked:!!m[e.original_id],onChange:()=>{return t=e.original_id,void v(e=>({...e,[t]:!e[t]}));var t}})}),(0,s.jsx)("td",{children:e.original_id}),(0,s.jsx)("td",{children:e.action}),(0,s.jsx)("td",{children:null!==(t=e.target_id)&&void 0!==t?t:"—"}),(0,s.jsx)("td",{children:null!==(n=e.note)&&void 0!==n?n:"—"}),(0,s.jsx)("td",{children:p(e.saved_at)}),(0,s.jsxs)("td",{className:"dbvc-resolver-rules__actions",children:[(0,s.jsx)("button",{type:"button",className:"button-link",onClick:()=>z(e),children:"Edit"}),(0,s.jsx)("button",{type:"button",className:"button-link-delete",onClick:()=>(async e=>{if(window.confirm(`Delete global rule for original ID ${e}?`))try{await l(`resolver-rules/${encodeURIComponent(e)}`),h(e=>e+1)}catch(e){window.alert(e.message)}})(e.original_id),children:"Delete"})]})]},e.original_id)})})]}),(0,s.jsxs)("div",{className:"dbvc-resolver-rules__bulk",children:[(0,s.jsx)("button",{type:"button",className:"button button-primary",onClick:()=>z(null),children:"Add Rule"}),(0,s.jsx)("button",{type:"button",className:"button",onClick:()=>{M.current&&M.current.click()},disabled:R,children:R?"Importing…":"Import CSV"}),(0,s.jsx)("button",{type:"button",className:"button button-secondary",onClick:async()=>{const e=Object.entries(m).filter(([,e])=>e).map(([e])=>e);if(e.length){if(window.confirm(`Delete ${e.length} selected rule(s)?`))try{await a("resolver-rules/bulk-delete",{original_ids:e}),v({}),f(!1),h(e=>e+1)}catch(e){window.alert(e.message)}}else window.alert("Select at least one rule to delete.")},disabled:!Object.values(m).some(Boolean),children:"Delete Selected"}),(0,s.jsx)("button",{type:"button",className:"button button-link",onClick:()=>{const e=["original_id,action,target_id,note,saved_at"].concat(t.map(e=>{var t;return[e.original_id,e.action,null!==(t=e.target_id)&&void 0!==t?t:"",(e.note||"").replace(/"/g,'""'),e.saved_at].join(",")})).join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(s),i=document.createElement("a");i.href=n,i.download="dbvc-resolver-rules.csv",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n)},children:"Export CSV"}),(0,s.jsx)("input",{ref:M,type:"file",accept:".csv,text/csv",style:{display:"none"},onChange:async e=>{const t=e.target.files&&e.target.files[0];t&&(await(async e=>{A(!0),E({imported:0,errors:[]});try{var t;const s=(e=>{const t=e.replace(/\r\n/g,"\n").split("\n").map(e=>e.trim()).filter(e=>e.length>0).map(e=>(e=>{const t=[];let s="",n=!1;for(let i=0;i<e.length;i++){const a=e[i];'"'===a?n&&'"'===e[i+1]?(s+='"',i++):n=!n:","!==a||n?s+=a:(t.push(s),s="")}return t.push(s),t})(e));if(!t.length)return[];let s=t[0].map(e=>e.trim().toLowerCase()),n=t.slice(1);s.includes("original_id")||(s=["original_id","action","target_id","note"],n=t);const i=new Set(["original_id","action","target_id","note"]),a=s.map((e,t)=>i.has(e)?e:`col_${t}`);return n.map(e=>{const t={};return a.forEach((s,n)=>{var i;t[s]=null!==(i=e[n])&&void 0!==i?i:""}),t}).map(e=>{const t=parseInt(e.original_id,10),s=parseInt(e.target_id,10);return{original_id:Number.isFinite(t)?t:null,action:(e.action||"").toLowerCase(),target_id:Number.isFinite(s)?s:null,note:e.note||""}}).filter(e=>e.original_id&&e.action)})(await e.text());if(!s.length)return void E({imported:0,errors:["The CSV file does not contain any valid rows."]});const n=await a("resolver-rules/import",{rules:s}),i=n.imported?n.imported.length:0;E({imported:i,errors:null!==(t=n.errors)&&void 0!==t?t:[]}),h(e=>e+1)}catch(e){E({imported:0,errors:[e?.message||"Import failed."]})}finally{A(!1)}})(t),e.target.value="")}})]}),g&&(0,s.jsxs)("form",{className:"dbvc-resolver-rule-form",onSubmit:async e=>{e.preventDefault(),C("");const t=parseInt(j.original_id,10);if(!Number.isFinite(t)||t<=0)return void C("Enter a valid original media ID.");if(!x&&L)return void C("A rule already exists for that original media ID. Choose Edit instead.");if(!j.action)return void C("Select an action for this rule.");const s="reuse"===j.action||"map"===j.action,n=parseInt(j.target_id,10);if(s&&(!Number.isFinite(n)||n<=0))C("Enter a target attachment ID for reuse/map actions.");else if(s&&V)C("This attachment ID is already mapped to another rule.");else{S(!0);try{await a("resolver-rules",{original_id:t,action:j.action,target_id:s?n:null,note:j.note}),h(e=>e+1),s&&Number.isFinite(n)&&n>0&&(O.current=String(n)),J()}catch(e){C(e?.message||"Failed to save rule.")}finally{S(!1)}}},children:[(0,s.jsx)("h3",{children:x?"Edit global rule":"Add global rule"}),(0,s.jsxs)("div",{className:"dbvc-resolver-controls",children:[(0,s.jsx)("input",{type:"number",min:"1",placeholder:"Original ID",value:j.original_id,onChange:e=>K("original_id",e.target.value),readOnly:!!x}),L&&(0,s.jsx)("span",{className:"dbvc-field-hint is-warning",children:"Rule already exists for this media ID."}),(0,s.jsxs)("select",{value:j.action,onChange:e=>K("action",e.target.value),children:[(0,s.jsx)("option",{value:"",children:"Select action…"}),(0,s.jsx)("option",{value:"reuse",children:"Reuse existing"}),(0,s.jsx)("option",{value:"download",children:"Download new"}),(0,s.jsx)("option",{value:"map",children:"Map to attachment ID"}),(0,s.jsx)("option",{value:"skip",children:"Skip"})]}),("reuse"===j.action||"map"===j.action)&&(0,s.jsx)("input",{type:"number",min:"1",placeholder:"Target attachment ID",value:j.target_id,onChange:e=>K("target_id",e.target.value)}),V&&(0,s.jsx)("span",{className:"dbvc-field-hint is-warning",children:"This attachment ID is already used by another rule."}),(0,s.jsx)("textarea",{value:j.note,onChange:e=>K("note",e.target.value),placeholder:"Optional note",rows:2})]}),k&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsx)("p",{children:k})}),(0,s.jsxs)("div",{className:"dbvc-resolver-rule-form__actions",children:[(0,s.jsx)("button",{type:"button",className:"button button-link",onClick:J,children:"Cancel"}),(0,s.jsx)("button",{type:"submit",className:"button button-primary",disabled:N,children:N?"Saving…":x?"Update Rule":"Save Rule"})]})]}),(I.imported>0||I.errors.length>0)&&(0,s.jsxs)("div",{className:"dbvc-resolver-import",children:[I.imported>0&&(0,s.jsx)("div",{className:"notice notice-success",children:(0,s.jsxs)("p",{children:[I.imported," rule(s) imported successfully."]})}),I.errors.length>0&&(0,s.jsxs)("div",{className:"notice notice-warning",children:[(0,s.jsx)("p",{children:"Import completed with warnings:"}),(0,s.jsx)("ul",{children:I.errors.map((e,t)=>(0,s.jsx)("li",{children:n(e)},t))})]})]})]})]})}}},s={};function n(e){var i=s[e];if(void 0!==i)return i.exports;var a=s[e]={exports:{}};return t[e](a,a.exports,n),a.exports}n.m=t,e=[],n.O=(t,s,i,a)=>{if(!s){var l=1/0;for(d=0;d<e.length;d++){for(var[s,i,a]=e[d],o=!0,r=0;r<s.length;r++)(!1&a||l>=a)&&Object.keys(n.O).every(e=>n.O[e](s[r]))?s.splice(r--,1):(o=!1,a<l&&(l=a));if(o){e.splice(d--,1);var c=i();void 0!==c&&(t=c)}}return t}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[s,i,a]},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={378:0,681:0};n.O.j=t=>0===e[t];var t=(t,s)=>{var i,a,[l,o,r]=s,c=0;if(l.some(t=>0!==e[t])){for(i in o)n.o(o,i)&&(n.m[i]=o[i]);if(r)var d=r(n)}for(t&&t(s);c<l.length;c++)a=l[c],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return n.O(d)},s=globalThis.webpackChunkdb_version_control_admin_app=globalThis.webpackChunkdb_version_control_admin_app||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var i=n.O(void 0,[681],()=>n(435));i=n.O(i)})()}},t={};function s(n){var i=t[n];if(void 0!==i)return i.exports;var a=t[n]={exports:{}};return e[n](a,a.exports,s),a.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";s(766)})()})()},976:(e,t,s)=>{"use strict";s(766)}},s={};function n(e){var i=s[e];if(void 0!==i)return i.exports;var a=s[e]={exports:{}};return t[e](a,a.exports,n),a.exports}n.m=t,e=[],n.O=(t,s,i,a)=>{if(!s){var l=1/0;for(d=0;d<e.length;d++){for(var[s,i,a]=e[d],o=!0,r=0;r<s.length;r++)(!1&a||l>=a)&&Object.keys(n.O).every(e=>n.O[e](s[r]))?s.splice(r--,1):(o=!1,a<l&&(l=a));if(o){e.splice(d--,1);var c=i();void 0!==c&&(t=c)}}return t}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[s,i,a]},n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={378:0,681:0};n.O.j=t=>0===e[t];var t=(t,s)=>{var i,a,[l,o,r]=s,c=0;if(l.some(t=>0!==e[t])){for(i in o)n.o(o,i)&&(n.m[i]=o[i]);if(r)var d=r(n)}for(t&&t(s);c<l.length;c++)a=l[c],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return n.O(d)},s=globalThis.webpackChunkdb_version_control_admin_app=globalThis.webpackChunkdb_version_control_admin_app||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var i=n.O(void 0,[681],()=>n(976));i=n.O(i)})();