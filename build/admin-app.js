(()=>{var e,t={766:()=>{(()=>{var e={766:()=>{(()=>{"use strict";var e,t={435:()=>{const e=window.wp.element,t=window.wp.components,s=window.ReactJSXRuntime,n=async(e,{signal:t}={})=>{const s=await window.fetch(`${DBVC_ADMIN_APP.root}${e}`,{headers:{"X-WP-Nonce":DBVC_ADMIN_APP.nonce},signal:t});if(!s.ok)throw new Error(`Request failed (${s.status})`);return s.json()},i=async(e,t)=>{const s=await window.fetch(`${DBVC_ADMIN_APP.root}${e}`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":DBVC_ADMIN_APP.nonce},body:JSON.stringify(t)});if(!s.ok){const t=await s.text();let n=t;try{n=JSON.parse(t)}catch(e){}const i=new Error(n&&n.message||t||`Request failed (${s.status})`);throw i.status=s.status,i.body=n,i}return s.json()},l=async e=>{const t=await window.fetch(`${DBVC_ADMIN_APP.root}${e}`,{method:"DELETE",headers:{"X-WP-Nonce":DBVC_ADMIN_APP.nonce}});if(!t.ok){const e=await t.text();throw new Error(e||`Request failed (${t.status})`)}return t.json()},a=DBVC_ADMIN_APP?.docs?.masking||(window.location&&window.location.origin?`${window.location.origin.replace(/\/$/,"")}/wp-content/plugins/db-version-control-main/docs/meta-masking.md`:"https://example.com/docs/meta-masking.md"),o=e=>e?`${a}#${e}`:a,r=e=>{if(!e)return"—";const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString()},c=e=>null==e?"—":"boolean"==typeof e?e?"true":"false":"number"==typeof e?e.toString():""===e?"(empty)":e,d=e=>{if(null==e)return"";if("string"==typeof e)return e;if("number"==typeof e||"boolean"==typeof e)return String(e);try{return JSON.stringify(e,null,2)}catch(t){return String(e)}},u=e=>e&&(e.diff||e.before||e.after)?(0,s.jsxs)(s.Fragment,{children:[e.before&&(0,s.jsx)("span",{children:e.before}),e.diff&&(0,s.jsx)("mark",{children:e.diff||"(empty)"}),e.after&&(0,s.jsx)("span",{children:e.after})]}):null,p=new Set(["post_title","post_name","post_status","post_type","post_excerpt","post_parent","post_author","post_date","post_date_gmt","post_modified","post_modified_gmt","post_password","post_mime_type","post_content_filtered","menu_order","comment_status","ping_status","guid","comment_count"]),h=new Set(["name","term_name","slug","term_slug","description","parent","parent_slug","taxonomy","term_taxonomy"]),m={meta:"Meta",tax:"Taxonomies",media:"Media References",content:"Content",post_fields:"Post Fields",term_fields:"Term Fields",title:"Title",status:"Status",post_type:"Post Type",post_excerpt:"Excerpt",other:"Other"},v="__dbvc_new_entity__",b={all:"All entities",needs_review:"Needs Review",needs_review_media:"Needs Review (Media)",resolved:"Resolved",reused:"Resolved",conflict:"Conflict",needs_download:"Needs Download",missing:"Missing",unknown:"Unknown",new_entities:"New entities",with_decisions:"With selections"},g=e=>{const t=b[e]||e;return(0,s.jsx)("span",{className:`dbvc-badge dbvc-badge--${e}`,children:t})},f=e=>Boolean(void 0!==e?.is_new_entity?e.is_new_entity:"missing_local_post"===e?.diff_state?.reason),_=e=>e?.entity_type?e.entity_type:"string"==typeof e?.post_type&&e.post_type.startsWith("term:")?"term":"post",x=e=>{if("term"===_(e)){const t=(e?.term_taxonomy||e?.post_type||"").replace(/^term:/,"");return t?`Term (${t})`:"Term"}return e?.post_type||"Post"},j=e=>"term"===_(e)?"Term":e?.post_status||"—",y=e=>"term"===_(e)?e?.term_slug||e?.slug||e?.post_name||"—":e?.post_name||"—",w=e=>{if("term"===_(e)){const t=e?.name||e?.term_name||e?.post_title||"",s=e?.term_taxonomy||e?.taxonomy||"",n=e?.term_slug||e?.slug||e?.post_name||"";if(t)return t;if(s&&n)return`${s}/${n}`;if(n)return n}return e?.post_title||e?.vf_object_uid||"Entity detail"},k=[{id:"title",label:"Title",defaultVisible:!0,lockVisible:!0,renderCell:e=>w(e)},{id:"post_name",label:"Slug",defaultVisible:!0,renderCell:e=>(0,s.jsx)("span",{className:"dbvc-text-break",children:y(e)})},{id:"post_type",label:"Type",defaultVisible:!0,renderCell:e=>x(e)},{id:"post_status",label:"Status",defaultVisible:!0,renderCell:e=>j(e)},{id:"post_modified",label:"Last modified",defaultVisible:!0,renderCell:e=>e.post_modified?r(e.post_modified):"—"},{id:"content_hash",label:"Content hash",defaultVisible:!1,renderCell:e=>{var t;return(0,s.jsx)("span",{className:"dbvc-text-break",children:null!==(t=e.content_hash)&&void 0!==t?t:"—"})}},{id:"diff",label:"Diff",defaultVisible:!0,renderCell:(e,t)=>(0,s.jsxs)(s.Fragment,{children:[g(t.diffState.needs_review?"needs_review":"resolved"),t.hashMissing&&(0,s.jsx)("span",{className:"dbvc-badge dbvc-badge--missing",style:{marginLeft:"0.25rem"},children:"Hash missing"}),t.entityHasSelections&&(0,s.jsx)("span",{className:"dbvc-badge dbvc-badge--pending",style:{marginLeft:"0.25rem"},children:"Pending"})]})},{id:"media_refs",label:"Media refs",defaultVisible:!0,renderCell:e=>{var t,s;return(null!==(t=e.media_refs?.meta?.length)&&void 0!==t?t:0)+(null!==(s=e.media_refs?.content?.length)&&void 0!==s?s:0)}},{id:"resolver",label:"Resolver",defaultVisible:!0,renderCell:(e,t)=>{const n=t.isNewEntity,i=t.newDecision||"",l=_(e);let a="term"===l?"New term":"New post";return"accept_new"===i?a="term"===l?"New term accepted":"New post accepted":"decline_new"===i&&(a="term"===l?"New term declined":"New post declined"),(0,s.jsxs)("div",{className:"dbvc-resolver-cell",children:[g(t.mediaStatus),n&&(0,s.jsx)("span",{className:"dbvc-badge dbvc-badge--new"+("decline_new"===i?" is-declined":""),style:{marginLeft:"0.25rem"},children:a})]})}},{id:"unresolved_media",label:"Unresolved media",defaultVisible:!0,renderCell:(e,t)=>{var s;return null!==(s=t.summary.unresolved)&&void 0!==s?s:0}},{id:"meta_diff_count",label:"Unresolved meta",defaultVisible:!0,renderCell:e=>{var t;return null!==(t=e.meta_diff_count)&&void 0!==t?t:0}},{id:"conflicts",label:"Conflicts",defaultVisible:!0,renderCell:(e,t)=>{var s;return null!==(s=t.summary.conflicts)&&void 0!==s?s:0}},{id:"decisions",label:"Decisions",defaultVisible:!0,renderCell:(e,t)=>t.entityHasSelections?(0,s.jsxs)("div",{className:"dbvc-decisions",children:[t.entityAccepted>0&&(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--accept",children:[t.entityAccepted," accept"]}),t.entityNewAccepted>0&&(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--new",children:[t.entityNewAccepted," new"]}),t.entityKept>0&&(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--keep",children:[t.entityKept," keep"]})]}):"—"}],C=({proposals:e,selectedId:t,onSelect:n})=>e.length?(0,s.jsxs)("table",{className:"widefat fixed striped dbvc-proposal-table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Proposal"}),(0,s.jsx)("th",{children:"Generated"}),(0,s.jsx)("th",{children:"Files"}),(0,s.jsx)("th",{children:"Media"}),(0,s.jsx)("th",{children:"Status"}),(0,s.jsx)("th",{children:"Decisions"}),(0,s.jsx)("th",{children:"Resolver reused"}),(0,s.jsx)("th",{children:"Resolver unresolved"})]})}),(0,s.jsx)("tbody",{children:e.map(e=>{var i,l,a,o,c,d,u,p,h,m,v;const b=null!==(i=e.resolver?.metrics)&&void 0!==i?i:{},g=e.id===t,f=null!==(l=e.decisions)&&void 0!==l?l:{},_=null!==(a=f.accepted)&&void 0!==a?a:0,x=null!==(o=f.kept)&&void 0!==o?o:0,j=null!==(c=f.entities_reviewed)&&void 0!==c?c:0,y=(null!==(d=f.total)&&void 0!==d?d:0)>0,w="closed"===e.status?"Closed":"Open";return(0,s.jsxs)("tr",{className:`${g?"is-active":""} ${"closed"===e.status?"is-archived":""}`,onClick:()=>n(e.id),style:{cursor:"pointer"},children:[(0,s.jsx)("td",{children:e.title}),(0,s.jsx)("td",{children:r(e.generated_at)}),(0,s.jsx)("td",{children:null!==(u=e.files)&&void 0!==u?u:"—"}),(0,s.jsx)("td",{children:null!==(p=e.media_items)&&void 0!==p?p:"—"}),(0,s.jsx)("td",{children:(0,s.jsx)("span",{className:`dbvc-status-badge dbvc-status-badge--${null!==(h=e.status)&&void 0!==h?h:"draft"}`,children:w})}),(0,s.jsx)("td",{children:y?(0,s.jsxs)("div",{className:"dbvc-decisions",children:[(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--accept",children:[_," accept"]}),(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--keep",children:[x," keep"]}),j>0&&(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--reviewed",children:[j," reviewed"]})]}):"—"}),(0,s.jsx)("td",{children:null!==(m=b.reused)&&void 0!==m?m:"—"}),(0,s.jsx)("td",{children:null!==(v=b.unresolved)&&void 0!==v?v:"—"})]},e.id)})})]}):(0,s.jsx)("p",{children:"No proposals found. Generate an export to get started."}),N=({onUploaded:n,onError:i})=>{const[l,a]=(0,e.useState)(!1),[o,r]=(0,e.useState)(!1),[c,d]=(0,e.useState)(""),[u,p]=(0,e.useState)(""),[h,m]=(0,e.useState)(!1),v=(0,e.useRef)(null),b=(0,e.useCallback)(async e=>{const t=e&&e[0];if(!t)return;const s=new window.FormData;s.append("file",t),s.append("overwrite",h?"1":"0"),r(!0),d(""),p("");try{const e=await(async(e,t)=>{const s=await window.fetch(`${DBVC_ADMIN_APP.root}proposals/upload`,{method:"POST",headers:{"X-WP-Nonce":DBVC_ADMIN_APP.nonce},body:t});if(!s.ok){const e=await s.text();throw new Error(e||`Request failed (${s.status})`)}return s.json()})(0,s);d(`Uploaded ${t.name}`),"function"==typeof n&&n(e.proposal_id,e)}catch(e){const t=e?.message||"Upload failed.";p(t),"function"==typeof i&&i(t)}finally{r(!1),v.current&&(v.current.value="")}},[h,n,i]);return(0,s.jsxs)("div",{className:"dbvc-proposal-uploader",children:[(0,s.jsx)("div",{className:`dbvc-proposal-uploader__dropzone${l?" is-dragging":""}${o?" is-uploading":""}`,onDragOver:e=>{e.preventDefault(),a(!0)},onDragLeave:e=>{e.currentTarget.contains(e.relatedTarget)||a(!1)},onDrop:e=>{e.preventDefault(),a(!1),b(e.dataTransfer?.files)},children:(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:"Upload proposal bundle"}),(0,s.jsx)("p",{children:"Drop a DBVC ZIP export here or select a file to register it."}),(0,s.jsx)(t.Button,{variant:"secondary",onClick:()=>v.current?.click(),disabled:o,children:o?"Uploading…":"Select ZIP"}),(0,s.jsx)("input",{ref:v,type:"file",accept:".zip",style:{display:"none"},onChange:e=>b(e.target.files)}),(0,s.jsx)(t.CheckboxControl,{label:"Replace existing proposal when IDs match",help:"Enable if this upload should refresh an existing proposal folder instead of creating a new one.",checked:h,onChange:e=>m(e),disabled:o})]})}),c&&(0,s.jsx)("p",{className:"dbvc-proposal-uploader__status",children:c}),u&&(0,s.jsx)("p",{className:"dbvc-proposal-uploader__error",role:"alert",children:u})]})},S=({resolver:e})=>{var t,n,i,l;if(!e)return(0,s.jsx)("p",{children:"Resolver metrics unavailable."});const{metrics:a={},conflicts:o=[]}=e;return(0,s.jsxs)("div",{className:"dbvc-admin-app__resolver",children:[(0,s.jsx)("h3",{children:"Resolver Summary"}),(0,s.jsxs)("ul",{children:[(0,s.jsxs)("li",{children:["Detected: ",null!==(t=a.detected)&&void 0!==t?t:0]}),(0,s.jsxs)("li",{children:["Reused: ",null!==(n=a.reused)&&void 0!==n?n:0]}),(0,s.jsxs)("li",{children:["Downloaded: ",null!==(i=a.downloaded)&&void 0!==i?i:0]}),(0,s.jsxs)("li",{children:["Unresolved: ",null!==(l=a.unresolved)&&void 0!==l?l:0]}),(0,s.jsxs)("li",{children:["Conflicts: ",o.length]})]}),o.length>0&&(0,s.jsx)("div",{className:"notice notice-warning",children:(0,s.jsxs)("p",{children:["The resolver reported ",o.length," conflict(s). Review before applying."]})})]})},$=({entities:t,loading:n,selectedEntityId:i,onSelect:l,columns:a,selectedIds:o=new Set,onToggleSelection:r,onToggleSelectionAll:c})=>{if(n)return(0,s.jsx)("p",{children:"Loading entities…"});if(!t.length)return(0,s.jsx)("p",{children:"No entities found for this proposal."});const d=a&&a.length?a:k,u="function"==typeof r,p=o instanceof Set?o:new Set(o),h=t.map(e=>e.vf_object_uid),m=u&&t.length>0&&t.every(e=>p.has(e.vf_object_uid)),v=u&&!m&&t.some(e=>p.has(e.vf_object_uid)),b=(0,e.useRef)(null);return(0,e.useEffect)(()=>{u&&b.current&&(b.current.indeterminate=v)},[u,v]),(0,s.jsx)("div",{className:"dbvc-entity-table",children:(0,s.jsxs)("table",{className:"widefat striped",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[u&&(0,s.jsx)("th",{className:"dbvc-entity-select",children:(0,s.jsx)("input",{type:"checkbox",ref:b,checked:m,onChange:e=>c?.(h,e.target.checked)})}),d.map(e=>(0,s.jsx)("th",{children:e.label},e.id))]})}),(0,s.jsx)("tbody",{children:t.map(e=>{var t,n,a,o,c,h,m,v;const b=e.vf_object_uid===i,g=u&&p.has(e.vf_object_uid),_=null!==(t=e.resolver?.summary)&&void 0!==t?t:{},x=null!==(n=e.diff_state)&&void 0!==n?n:{},j=e.media_needs_review?"needs_review":null!==(a=e.resolver?.status)&&void 0!==a?a:"resolved",y=e.overall_status||(x.needs_review?"needs_review":"resolved"),w="missing_local_hash"===x.reason,k=null!==(o=e.decision_summary)&&void 0!==o?o:{},C=null!==(c=k.accepted)&&void 0!==c?c:0,N=null!==(h=k.kept)&&void 0!==h?h:0,S=null!==(m=k.accepted_new)&&void 0!==m?m:0,$=(null!==(v=k.total)&&void 0!==v?v:0)>0,D=f(e),R=e.new_entity_decision||"",I=e.identity_match||"",A=[`resolver-${y}`,b?"is-active":"",g?"is-selected":""].filter(Boolean).join(" "),E=t=>{t.preventDefault(),t.stopPropagation(),l(e.vf_object_uid)},M={summary:_,diffState:x,mediaStatus:j,hashMissing:w,decisionSummary:k,entityHasSelections:$,entityAccepted:C,entityNewAccepted:S,entityKept:N,isNewEntity:D,newDecision:R,identityMatch:I};return(0,s.jsxs)("tr",{className:A,onClick:E,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||E(e)},style:{cursor:"pointer"},role:"button",tabIndex:0,children:[u&&(0,s.jsx)("td",{className:"dbvc-entity-select",children:(0,s.jsx)("input",{type:"checkbox",checked:g,onChange:t=>{t.stopPropagation(),r?.(e.vf_object_uid)},onClick:e=>e.stopPropagation()})}),d.map(t=>{var n;return(0,s.jsx)("td",{children:t.renderCell?t.renderCell(e,M):null!==(n=e[t.id])&&void 0!==n?n:"—"},t.id)})]},e.vf_object_uid)})})]})})},D=({entityDetail:n,resolverInfo:i,resolverDecisionSummary:l=null,decisions:a={},onDecisionChange:o,onBulkDecision:r,onResetDecisions:c,onCaptureSnapshot:d,onResolverDecision:u,onResolverDecisionReset:b,onApplyResolverDecisionToSimilar:g,savingPaths:j={},bulkSaving:k=!1,resolverSaving:C={},resolverError:N=null,decisionError:S,loading:$,error:D,onClose:R,filterMode:I,onFilterModeChange:A,isOpen:M=!0,resettingDecisions:O=!1,snapshotCapturing:U=!1,onHashSync:T,hashSyncing:P=!1,hashSyncTarget:F=""})=>{var V,L,H,K,z,J,q,W,G,X,Z,Q,Y,ee,te;const se=(0,e.useMemo)(()=>n?.item?.vf_object_uid?`dbvc-entity-detail-${n.item.vf_object_uid}`:n?.vf_object_uid?`dbvc-entity-detail-${n.vf_object_uid}`:"dbvc-entity-detail",[n]),ne=(0,e.useRef)(null),ie=(0,e.useRef)(null);(0,e.useEffect)(()=>{if(!R||!M)return;ie.current=document.activeElement instanceof HTMLElement?document.activeElement:null;const e=ne.current;e&&e.focus();const t=e=>{"Escape"===e.key&&(e.preventDefault(),R())};return document.addEventListener("keydown",t),()=>{document.removeEventListener("keydown",t),ie.current&&"function"==typeof ie.current.focus&&ie.current.focus()}},[M,R,se]);const{item:le,current:ae,proposed:oe={},diff:re}=null!=n?n:{},ce=null!==(V=n?.decision_summary)&&void 0!==V?V:{},de=null!==(L=null!==(H=n?.diff_state)&&void 0!==H?H:le?.diff_state)&&void 0!==L?L:null,ue=((e,t)=>{if(!t)return"";if("term"===_(e)){const s=e?.term_taxonomy||e?.taxonomy||"";return s?`term.php?taxonomy=${s}&tag_ID=${t}`:`term.php?tag_ID=${t}`}return`post.php?post=${t}&action=edit`})(le,null!==(K=de?.local_post_id)&&void 0!==K?K:null),pe=w(le),he=y(le),me=(e=>"term"===_(e)?"Term slug:":"Slug:")(le),ve=_(le),be=le?.term_taxonomy||le?.taxonomy||"",ge=(x(le),"missing_local_hash"===de?.reason),fe=f(null!=n?n:{diff_state:de}),_e=null!==(z=null!==(J=a?.[v])&&void 0!==J?J:n?.new_entity_decision)&&void 0!==z?z:"",xe=Boolean(j?.[v]),je=null!==(q=ce.total)&&void 0!==q?q:0,ye=je>0?`${null!==(W=ce.accepted)&&void 0!==W?W:0} accepted · ${null!==(G=ce.kept)&&void 0!==G?G:0} kept`:"No selections captured yet.",we=null!==(X=re?.changes)&&void 0!==X?X:[],ke=(0,e.useMemo)(()=>we,[we,I]),Ce=(0,e.useMemo)(()=>(e=>{const t={};return e.forEach(e=>{const[s]=e.path.split("."),n=(p.has(s)?"post_fields":h.has(s)?"term_fields":s)||"other";t[n]||(t[n]=[]),t[n].push(e)}),Object.entries(t).map(([e,t])=>({key:e,label:m[e]||e,items:t}))})(ke),[ke]),Ne=null!==(Z=i?.attachments)&&void 0!==Z?Z:[],[Se,$e]=(0,e.useState)(""),De=(0,e.useMemo)(()=>{if(!Se)return Ne;const e=Se.toLowerCase();return Ne.filter(t=>{const s=t.descriptor||{};return[t.original_id,t.reason,t.status,t.decision?.note,s.asset_uid,s.bundle_path,s.path].filter(Boolean).join(" ").toLowerCase().includes(e)})},[Ne,Se]),Re="conflicts"===I,Ie=we.length,Ae=(0,e.useMemo)(()=>we.filter(e=>{var t;return"accept"!==(null!==(t=a?.[e.path])&&void 0!==t?t:"")}).length,[we,a]),Ee=ke.length,[Me,Be]=(0,e.useState)(!1),[Oe,Ue]=(0,e.useState)(""),[Te,Pe]=(0,e.useState)("reason"),[Fe,Ve]=(0,e.useState)(""),[Le,He]=(0,e.useState)(""),[Ke,ze]=(0,e.useState)(""),[Je,qe]=(0,e.useState)(""),[We,Ge]=(0,e.useState)(!1),[Xe,Ze]=(0,e.useState)(!1),[Qe,Ye]=(0,e.useState)("");(0,e.useEffect)(()=>{Me||Ue(Ce[0]?.key||"")},[Ce,Me]);const et=(0,e.useMemo)(()=>Me||!Oe?Ce:Ce.filter(e=>e.key===Oe),[Ce,Me,Oe]),tt=(0,e.useMemo)(()=>{if(Me)return ke;const e=Ce.find(e=>e.key===Oe);return e?e.items:[]},[Me,ke,Ce,Oe]),st=(0,e.useMemo)(()=>tt.map(e=>e.path).filter(Boolean),[tt]),nt=(0,e.useMemo)(()=>{const e=new Set,t=new Set,s=new Set;return Ne.forEach(n=>{n.reason&&e.add(n.reason);const i=n.descriptor||{};i.asset_uid&&t.add(i.asset_uid);const l=i.bundle_path||i.path||"";l&&s.add(l)}),{reason:Array.from(e),asset_uid:Array.from(t),bundle_path:Array.from(s)}},[Ne]);(0,e.useEffect)(()=>{const e=nt[Te]||[];e.length?e.includes(Fe)||Ve(e[0]||""):Ve("")},[Te,Fe,nt]);const it="term"===ve&&be?`${be}/${he}`:he,lt=le?.term_parent_slug||le?.parent_slug||oe?.parent_slug||ae?.term_parent_slug||ae?.parent_slug||"",at=le?.term_parent||le?.parent||oe?.parent||ae?.term_parent||ae?.parent||0,ot="term"!==ve?null:lt||(le?.term_parent_uid||oe?.parent_uid||ae?.term_parent_uid||"")||(at?`ID ${at}`:"—"),rt="term"===ve&&be?`${pe} · ${be}`:pe,ct=(0,e.useMemo)(()=>!Fe&&(nt[Te]||[]).length?[]:Ne.filter(e=>{const t=e.descriptor||{};switch(Te){case"asset_uid":return(t.asset_uid||"")===Fe;case"bundle_path":return(t.bundle_path||t.path||"")===Fe;default:return(e.reason||"")===Fe}}),[Ne,Te,Fe,nt]),dt=ct.length,ut="reuse"===Le||"map"===Le;return R&&!M?null:(e=>{const t=(0,s.jsx)("div",{className:"dbvc-admin-app__entity-detail",children:e});return R?(0,s.jsxs)("div",{className:"dbvc-entity-detail-modal",role:"presentation",children:[(0,s.jsx)("div",{className:"dbvc-entity-detail-modal__overlay",onClick:R,"aria-hidden":"true"}),(0,s.jsx)("div",{className:"dbvc-entity-detail-modal__panel",role:"dialog","aria-modal":"true","aria-labelledby":se,children:t})]}):t})($?(0,s.jsx)("p",{children:"Loading entity detail…"}):D?(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)("p",{children:["Failed to load entity detail: ",D]})}):n?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"dbvc-entity-toolbar",children:[(0,s.jsxs)("div",{className:"dbvc-entity-toolbar__meta",children:[(0,s.jsx)("div",{className:"dbvc-entity-toolbar__title",id:se,children:ue?(0,s.jsx)("a",{href:ue,target:"_blank",rel:"noreferrer",children:rt}):rt}),(0,s.jsxs)("div",{className:"dbvc-entity-toolbar__sub",children:[(0,s.jsxs)("span",{children:[me," ",ue&&"—"!==it?(0,s.jsx)("a",{href:ue,target:"_blank",rel:"noreferrer",children:it}):it]}),"term"===ve&&(0,s.jsxs)("span",{children:["Taxonomy: ",be||"—"]}),"term"===ve&&(0,s.jsxs)("span",{children:["Parent: ",ot||"—"]}),(0,s.jsxs)("span",{children:["File: ",le?.path||"—"]})]})]}),R&&(0,s.jsx)("button",{type:"button",className:"dbvc-entity-detail__close",onClick:R,"aria-label":"Close entity detail",ref:R?ne:void 0,children:"Close"}),(0,s.jsxs)("div",{className:"dbvc-diff-filter",children:[(0,s.jsx)("span",{children:"View:"}),(0,s.jsx)("button",{type:"button",className:Re?"is-active":"",onClick:()=>A&&A("conflicts"),children:"Conflicts & Resolver"}),(0,s.jsx)("button",{type:"button",className:Re?"":"is-active",onClick:()=>A&&A("full"),children:"Full Overview"})]}),(0,s.jsx)("p",{className:"dbvc-entity-toolbar__count",children:Re?`${Ae} field(s) awaiting review · ${Ie} total`:`${Ee} field(s) shown.`}),ge&&T&&(0,s.jsxs)("div",{className:"notice notice-warning",children:[(0,s.jsx)("p",{children:"This entity is missing its stored import hash. Sync it to prevent repeated reviews."}),(0,s.jsx)("button",{type:"button",className:"button button-secondary",onClick:()=>T(n?.vf_object_uid),disabled:P&&F===n?.vf_object_uid,children:P&&F===n?.vf_object_uid?"Storing hash…":"Store import hash"})]}),(()=>{const e=[];return st.length>0&&(e.push({key:"accept_all",content:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{type:"button",className:"button button-secondary",onClick:()=>{r&&window.confirm(`Accept ${st.length} field(s)?`)&&r("accept",st)},disabled:k,children:k?"Accepting…":"Accept All Visible"}),(0,s.jsx)("p",{className:"description",children:"Applies the bundle values to every field currently listed."})]})}),e.push({key:"keep_all",content:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{type:"button",className:"button",onClick:()=>{r&&window.confirm(`Keep current values for ${st.length} field(s)?`)&&r("keep",st)},disabled:k,children:k?"Keeping…":"Keep All Visible"}),(0,s.jsx)("p",{className:"description",children:"Locks in the live values for each visible field without importing."})]})})),"function"==typeof d&&e.push({key:"snapshot",content:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{type:"button",className:"button dbvc-button-inverted",onClick:d,disabled:U||!d,children:U?"Capturing snapshot…":"Capture current snapshot"}),(0,s.jsx)("p",{className:"description",children:`Refreshes the “current” baseline from the live ${"term"===ve?"term":"post"} before you compare.`})]})}),"function"==typeof c&&je>0&&e.push({key:"clear_decisions",content:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{type:"button",className:"button",onClick:c,disabled:O,children:O?"Clearing…":"Clear all decisions"}),(0,s.jsx)("p",{className:"description",children:"Removes every Accept/Keep choice so you can re-evaluate this entity."})]})}),e.length?(0,s.jsx)("div",{className:"dbvc-entity-action-grid",children:e.map(e=>(0,s.jsx)("div",{className:"dbvc-entity-action",children:e.content},e.key))}):null})(),(0,s.jsxs)("p",{className:"dbvc-decision-summary",children:["Selections: ",ye]})]}),fe&&(0,s.jsxs)("div",{className:"dbvc-new-entity-card",children:[(0,s.jsxs)("div",{className:"dbvc-new-entity-card__header",children:[(0,s.jsx)("span",{className:"dbvc-badge dbvc-badge--new",children:"term"===_(le)?"New term":"New post"}),(0,s.jsx)("span",{className:"dbvc-new-entity-card__status",children:"accept_new"===_e?"Accepted for import":"decline_new"===_e?"Declined — will be skipped":"Pending reviewer decision"})]}),(0,s.jsxs)("p",{children:["This proposal would create a new ","term"===_(le)?x(le):le?.post_type||"post"," on this site. No UID, original ID, or slug match was detected locally, so choose whether to import it."]}),(0,s.jsxs)("div",{className:"dbvc-new-entity-actions",children:[(0,s.jsx)(t.Button,{variant:"accept_new"===_e?"primary":"secondary",onClick:()=>o&&o(v,"accept_new"),disabled:xe,isBusy:xe&&"accept_new"===_e,children:"Accept & import"}),(0,s.jsx)(t.Button,{variant:"decline_new"===_e?"primary":"secondary",onClick:()=>o&&o(v,"decline_new"),disabled:xe,isBusy:xe&&"decline_new"===_e,children:"term"===_(le)?"Decline new term":"Decline new post"}),(0,s.jsx)(t.Button,{variant:"tertiary",onClick:()=>o&&o(v,"clear"),disabled:xe||!_e,children:"Clear choice"})]})]}),S&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsx)("p",{children:S})}),Ce.length>0&&(0,s.jsxs)("div",{className:"dbvc-section-nav",children:[(0,s.jsx)("span",{children:Me?"Sections:":"Jump to:"}),Ce.map(e=>(0,s.jsx)("button",{type:"button",className:Me||Oe!==e.key?"":"is-active",onClick:()=>{if(Me){const t=document.getElementById(`dbvc-diff-${e.key}`);t&&t.scrollIntoView({behavior:"smooth",block:"start"})}else Ue(e.key)},children:e.label},e.key)),(0,s.jsx)("button",{type:"button",className:Me?"is-active":"",onClick:()=>Be(e=>!e),children:Me?"Focus Section":"Show All"})]}),et.length>0?et.map(e=>(0,s.jsx)(E,{section:e,decisions:a,onDecisionChange:o,savingPaths:j},e.key)):(0,s.jsx)("p",{children:Re&&Ie>0?"No resolver or media conflicts detected for this entity. Switch to Full Overview to inspect all differences.":"No differences detected."}),Ne.length>0&&(0,s.jsxs)("div",{className:"dbvc-admin-app__resolver-attachments",children:[(0,s.jsx)("h4",{children:"Media Resolver"}),(0,s.jsx)("div",{className:"dbvc-panel-search",children:(0,s.jsxs)("label",{children:["Search:  ",(0,s.jsx)("input",{type:"search",value:Se,onChange:e=>$e(e.target.value),placeholder:"Reason, asset UID, note…"})]})}),l&&(0,s.jsxs)("p",{className:"dbvc-resolver-summary",children:["Saved decisions — reuse: ",null!==(Q=l.reuse)&&void 0!==Q?Q:0,", map: ",null!==(Y=l.map)&&void 0!==Y?Y:0,", download:"," ",null!==(ee=l.download)&&void 0!==ee?ee:0,", skip: ",null!==(te=l.skip)&&void 0!==te?te:0]}),N&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsx)("p",{children:N})}),De.length>0?(0,s.jsxs)("table",{className:"widefat",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Status"}),(0,s.jsx)("th",{children:"Original ID"}),(0,s.jsx)("th",{children:"Target"}),(0,s.jsx)("th",{children:"Reason"}),(0,s.jsx)("th",{children:"Decision"}),(0,s.jsx)("th",{style:{width:"160px"},children:"Actions"})]})}),(0,s.jsx)("tbody",{children:De.map(e=>(0,s.jsx)(B,{attachment:e,saving:!!C[e.original_id],onSave:u,onClear:b,onApplyToSimilar:g},e.original_id))})]}):(0,s.jsx)("p",{children:"No resolver conflicts match your search."}),(0,s.jsxs)("div",{className:"dbvc-resolver-bulk",children:[(0,s.jsx)("h5",{children:"Bulk Apply Resolver Decision"}),(0,s.jsx)("p",{className:"description",children:"Match a subset of conflicts and apply a single decision without editing rows individually."}),(0,s.jsxs)("div",{className:"dbvc-resolver-bulk__filters",children:[(0,s.jsxs)("label",{children:["Match by",(0,s.jsxs)("select",{value:Te,onChange:e=>Pe(e.target.value),children:[(0,s.jsx)("option",{value:"reason",children:"Reason"}),(0,s.jsx)("option",{value:"asset_uid",children:"Asset UID"}),(0,s.jsx)("option",{value:"bundle_path",children:"Manifest Path"})]})]}),(0,s.jsxs)("label",{children:["Value",(0,s.jsxs)("select",{value:Fe,onChange:e=>Ve(e.target.value),disabled:0===(nt[Te]||[]).length,children:[0===(nt[Te]||[]).length&&(0,s.jsx)("option",{value:"",children:"No values detected"}),(nt[Te]||[]).map(e=>(0,s.jsx)("option",{value:e,children:e||"— Not provided —"},e||"blank"))]})]}),(0,s.jsxs)("span",{className:"dbvc-resolver-bulk__count",children:["Matches: ",dt]})]}),(0,s.jsxs)("div",{className:"dbvc-resolver-controls dbvc-resolver-bulk__controls",children:[(0,s.jsxs)("select",{value:Le,onChange:e=>He(e.target.value),children:[(0,s.jsx)("option",{value:"",children:"Select action…"}),(0,s.jsx)("option",{value:"reuse",children:"Reuse existing"}),(0,s.jsx)("option",{value:"download",children:"Download new"}),(0,s.jsx)("option",{value:"map",children:"Map to attachment ID"}),(0,s.jsx)("option",{value:"skip",children:"Skip"})]}),ut&&(0,s.jsx)("input",{type:"number",min:"1",placeholder:"Attachment ID",value:Ke,onChange:e=>ze(e.target.value)}),(0,s.jsx)("textarea",{value:Je,onChange:e=>qe(e.target.value),placeholder:"Optional note",rows:2}),(0,s.jsxs)("label",{children:[(0,s.jsx)("input",{type:"checkbox",checked:We,onChange:e=>Ge(e.target.checked)})," ","Remember as global rule"]})]}),Qe&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsx)("p",{children:Qe})}),(0,s.jsx)("button",{type:"button",className:"button button-secondary",onClick:async()=>{if(!Le)return void Ye("Select an action to apply.");if(ut&&!Ke)return void Ye("Enter a target attachment ID for this action.");if(!dt)return void Ye("No matching conflicts were found for the selected filter.");if(!u)return;if(!window.confirm(`Apply this decision to ${dt} conflict(s) matched by ${"reason"===Te?"reason":"asset_uid"===Te?"asset UID":"manifest path"}?`))return;Ze(!0),Ye("");const e={action:Le,target_id:ut?Number(Ke):null,note:Je,persist_global:We};try{for(const t of ct)t.original_id&&await u(t.original_id,e);qe(""),ze("")}catch(e){Ye(e?.message||"Bulk apply failed.")}finally{Ze(!1)}},disabled:Xe,children:Xe?"Applying…":"Apply to Matches"})]})]}),(0,s.jsxs)("div",{className:"dbvc-admin-app__entity-columns",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{children:"Raw Current"}),(0,s.jsx)("pre",{children:JSON.stringify(ae,null,2)})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{children:"Raw Proposed (Bundle)"}),(0,s.jsx)("pre",{children:JSON.stringify(oe,null,2)})]})]})]}):(0,s.jsx)("p",{children:"Select an entity to view details."}))};function R({open:e,onClose:n,report:i,onMarkCanonical:l,actionKey:a,bulkMode:o,onBulkModeChange:c,confirmPhrase:d,confirmValue:u,onConfirmChange:p,onBulkCleanup:h,bulkBusy:m,bulkDisabled:v}){var b,g;return e?(0,s.jsxs)(t.Modal,{title:(0,s.jsxs)("span",{className:"dbvc-duplicates-modal__title",children:[`Duplicate entities (${null!==(b=i.count)&&void 0!==b?b:0})`,(0,s.jsx)("span",{className:"dbvc-duplicates-modal__lede",children:"Choose the filename format to keep and confirm the cleanup to delete the rest of the duplicate JSON files."})]}),onRequestClose:n,className:"dbvc-duplicates-modal",children:[(0,s.jsxs)("div",{className:"dbvc-duplicates-modal__bulk",children:[(0,s.jsxs)("label",{className:"dbvc-duplicates-modal__bulk-select",children:["Keep filenames as:",(0,s.jsx)("select",{value:o,onChange:e=>c&&c(e.target.value),children:[{value:"slug_id",label:"Slug + ID"},{value:"slug",label:"Slug"},{value:"id",label:"ID"}].map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,s.jsxs)("div",{className:"dbvc-duplicates-modal__bulk-inline",children:[(0,s.jsx)("input",{type:"text",value:u,placeholder:`Type ${d}`,onChange:e=>p&&p(e.target.value)}),(0,s.jsx)(t.Button,{variant:"primary",onClick:h,disabled:v,isBusy:m,children:m?"Cleaning…":"Bulk clean duplicates"})]})]}),0===(null!==(g=i.items)&&void 0!==g?g:[]).length?(0,s.jsx)("p",{children:"No duplicate manifest entries were detected for this proposal."}):i.items.map(e=>{var n,i;const o=null!==(n=e.entries)&&void 0!==n?n:[],c=o.reduce((e,t)=>{const s=t.post_modified?Date.parse(t.post_modified.replace(" ","T")):0;return Number.isFinite(s)&&s>e?s:e},0);return(0,s.jsxs)("div",{className:"dbvc-duplicate-group",children:[(0,s.jsxs)("div",{className:"dbvc-duplicate-group__header",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:w(e)}),(0,s.jsxs)("div",{className:"dbvc-duplicate-group__meta",children:[(0,s.jsxs)("span",{children:["UID: ",e.vf_object_uid]}),(0,s.jsxs)("span",{children:["Slug: ",y(e)]}),(0,s.jsxs)("span",{children:["Type: ",x(e)]})]})]}),(0,s.jsx)("div",{className:"dbvc-duplicate-group__badges",children:(0,s.jsxs)("span",{className:"dbvc-badge",children:[null!==(i=e.entries?.length)&&void 0!==i?i:0," files"]})})]}),(0,s.jsxs)("table",{className:"widefat",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Path"}),(0,s.jsx)("th",{children:"Hash"}),(0,s.jsx)("th",{children:"Content hash"}),(0,s.jsx)("th",{children:"Modified"}),(0,s.jsx)("th",{children:"Status"}),(0,s.jsx)("th",{children:"Size"}),(0,s.jsx)("th",{children:"Actions"})]})}),(0,s.jsx)("tbody",{children:o.map((n,i)=>{const o=`${e.vf_object_uid}::${i}::${n.path||"no-path"}`,d=n.post_modified?Date.parse(n.post_modified.replace(" ","T")):0,u=c&&Number.isFinite(d)&&d===c;return(0,s.jsxs)("tr",{className:u?"is-latest":"",children:[(0,s.jsx)("td",{className:"dbvc-text-break",children:n.path||"—"}),(0,s.jsx)("td",{className:"dbvc-text-break",children:n.hash||"—"}),(0,s.jsx)("td",{className:"dbvc-text-break",children:n.content_hash||"—"}),(0,s.jsx)("td",{children:n.post_modified?r(n.post_modified):"—"}),(0,s.jsx)("td",{children:n.post_status||"—"}),(0,s.jsx)("td",{children:"number"==typeof n.size?`${n.size} B`:"—"}),(0,s.jsx)("td",{children:(0,s.jsx)(t.Button,{variant:"secondary",onClick:()=>l&&l(e.vf_object_uid,n.path),disabled:a===o,children:a===o?"Marking…":"Keep this file"})})]},o)})})]})]},e.vf_object_uid)}),(0,s.jsx)("p",{className:"description",children:"Tip: Clean up duplicate JSON files in the sync folder before exporting new proposals to keep reviewers focused on a single entity."})]}):null}const I=()=>{var a,c,d,u,p,h,m,g,_,I,A,E,M,B,U,T,P,F,V,L,H,K,z,J,q,W,G;const[X,Z]=(0,e.useState)([]),[Q,Y]=(0,e.useState)(null),[ee,te]=(0,e.useState)(null),[se,ne]=(0,e.useState)([]),[ie,le]=(0,e.useState)("needs_review"),[ae,oe]=(0,e.useState)(""),[re,ce]=(0,e.useState)(null),[de,ue]=(0,e.useState)(null),[pe,he]=(0,e.useState)(!1),[me,ve]=(0,e.useState)({}),[be,ge]=(0,e.useState)({}),[fe,_e]=(0,e.useState)(null),[xe,je]=(0,e.useState)(!0),[ye,we]=(0,e.useState)(!1),[ke,Ce]=(0,e.useState)(!1),[Ne,Se]=(0,e.useState)(!1),[$e,De]=(0,e.useState)(!1),[Re,Ie]=(0,e.useState)(null),[Ae,Ee]=(0,e.useState)(null),[Me,Be]=(0,e.useState)(null),[Oe,Ue]=(0,e.useState)(null),[Te,Pe]=(0,e.useState)(!1),[Fe,Ve]=(0,e.useState)(!1),[Le,He]=(0,e.useState)(!1),[Ke,ze]=(0,e.useState)(""),[Je,qe]=(0,e.useState)(null),[We,Ge]=(0,e.useState)(null),[Xe,Ze]=(0,e.useState)(!1),[Qe,Ye]=(0,e.useState)("full"),[et,tt]=(0,e.useState)(!1),[st,nt]=(0,e.useState)("conflicts"),[it,lt]=(0,e.useState)([]),[at,ot]=(0,e.useState)([]),[rt,ct]=(0,e.useState)({}),[dt,ut]=(0,e.useState)(null),[pt,ht]=(0,e.useState)(!1),[mt,vt]=(0,e.useState)(!1),[bt,gt]=(0,e.useState)(!1),[ft,_t]=(0,e.useState)(!1),[xt,jt]=(0,e.useState)(()=>{const e={};return k.forEach(t=>{e[t.id]=!1!==t.defaultVisible}),e}),[yt,wt]=(0,e.useState)({count:0,items:[]}),[kt,Ct]=(0,e.useState)(!1),[Nt,St]=(0,e.useState)(null),[$t,Dt]=(0,e.useState)(!1),[Rt,It]=(0,e.useState)(""),[At,Et]=(0,e.useState)("slug_id"),[Mt,Bt]=(0,e.useState)(""),[Ot,Ut]=(0,e.useState)(!1),[Tt,Pt]=(0,e.useState)(!1),[Ft,Vt]=(0,e.useState)(!1),[Lt,Ht]=(0,e.useState)(!1),[Kt,zt]=(0,e.useState)(()=>new Set),[Jt,qt]=(0,e.useState)(!1),[Wt,Gt]=(0,e.useState)([]),[Xt,Zt]=(0,e.useState)(!1),[Qt,Yt]=(0,e.useState)(null),[es,ts]=(0,e.useState)(!1),[ss,ns]=(0,e.useState)(!1),[is,ls]=(0,e.useState)("ignore"),[as,os]=(0,e.useState)(""),[rs,cs]=(0,e.useState)(""),ds="DELETE",us=(0,e.useMemo)(()=>k.filter(e=>xt[e.id]),[xt]),ps=(0,e.useCallback)(e=>{jt(t=>{const s=k.find(t=>t.id===e);return s&&s.lockVisible?t:{...t,[e]:!t[e]}})},[]),hs=(0,e.useCallback)(async(e,t={})=>{if(!e)return wt({count:0,items:[]}),void St(null);const{signal:s}=t;Ct(!0),St(null);try{var i,l;const t=await n(`proposals/${encodeURIComponent(e)}/duplicates`,s?{signal:s}:void 0);wt({count:null!==(i=t.count)&&void 0!==i?i:t.items?t.items.length:0,items:null!==(l=t.items)&&void 0!==l?l:[]})}catch(e){if("AbortError"===e.name)return;St(e?.message||"Failed to load duplicates."),wt({count:0,items:[]})}finally{Ct(!1)}},[]),ms=(0,e.useRef)(null);(0,e.useEffect)(()=>{ms.current=re},[re]);const vs="DBVC_MASK_UNDO",[bs,gs]=(0,e.useState)(0),fs=(0,e.useCallback)(async(e,t)=>{if(!e)return Gt([]),gs(0),void ns(!1);Zt(!0),Yt(null),gs(0);try{let s=1,i=[],l=!0,a=1,o=1;for(;l;){const r=await n(`proposals/${encodeURIComponent(e)}/masking?page=${s}`,t?{signal:t}:void 0);Array.isArray(r?.fields)&&(i=i.concat(r.fields));const c=r?.chunk?.total_pages?parseInt(r.chunk.total_pages,10):1;o=c>0?c:1,a=s,r?.chunk?.has_more?s++:l=!1,gs(Math.min(100,Math.round(a/o*100)))}Gt(i),ns(!Jt&&i.length>0),gs(100)}catch(e){if("AbortError"===e.name)return;console.error("DBVC masking fetch failed:",e),Yt(e?.message||"Failed to load masking candidates.")}finally{Zt(!1),setTimeout(()=>gs(0),1500)}},[Jt]),_s=(0,e.useCallback)(()=>{qt(e=>{const t=!e;return t||ns(!1),t})},[]),[xs,js]=(0,e.useState)(null),[ys,ws]=(0,e.useState)(0),ks=(0,e.useCallback)(async()=>{const s=Array.isArray(Wt)?Wt:[];if(!Q||!s.length)return Yt("No masked meta fields are available to apply."),void ns(!1);if("override"===is&&!as.trim())return void Yt("Provide an override value to continue.");const n=[];for(let e=0;e<s.length;e+=50){const t=s.slice(e,e+50).map(e=>{const t={vf_object_uid:e.vf_object_uid,meta_path:e.meta_path,action:is};return"auto_accept"===is&&(t.suppress=!0),"override"===is&&(t.override_value=as,rs&&(t.note=rs)),t});n.push(t)}ts(!0),ws(0),Yt(null);try{for(let e=0;e<n.length;e++){const t=n[e];await i(`proposals/${encodeURIComponent(Q)}/masking/apply`,{items:t}),ws(Math.min(99,Math.round((e+1)/n.length*100)))}ws(100),Array.isArray(t?.entities)&&ne(e=>e.map(e=>{const s=t.entities.find(t=>t.vf_object_uid===e.vf_object_uid);return s?{...e,diff_state:s.diff_state||e.diff_state,decision_summary:s.decision_summary||e.decision_summary,overall_status:s.overall_status||e.overall_status}:e})),t?.entities&&re&&t.entities.forEach(e=>{e.vf_object_uid===re&&ue(t=>t?{...t,diff_state:e.diff_state||t.diff_state,decision_summary:e.decision_summary||t.decision_summary,overall_status:e.overall_status||t.overall_status}:t)});try{const t={proposalId:Q,items:e};window.sessionStorage&&window.sessionStorage.setItem(vs,JSON.stringify(t)),js(t)}catch(e){}await Promise.all([fs(Q),Ss(Q,ie),hs(Q)]),ns(!1),lt(t=>[...t,{id:`${Date.now()}-mask`,severity:"success",title:"Meta masking applied",message:`Updated ${e.length} field${1===e.length?"":"s"}.`,timestamp:(new Date).toISOString()}])}catch(e){Yt(e?.message||"Failed to apply masking rules.")}finally{ts(!1),setTimeout(()=>ws(0),1500)}},[Q,Wt,is,rs,as]),Cs=(0,e.useCallback)(async()=>{if(!xs||!Q)return;const e=Array.isArray(xs.items)?xs.items:[];if(e.length){ts(!0),Yt(null);try{const t=e.map(e=>({vf_object_uid:e.vf_object_uid,meta_path:e.meta_path,action:"ignore"}));await i(`proposals/${encodeURIComponent(Q)}/masking/apply`,{items:t}),window.sessionStorage&&window.sessionStorage.removeItem(vs),js(null),await Promise.all([fs(Q),Ss(Q,ie),hs(Q)])}catch(e){Yt(e?.message||"Failed to undo masking rules.")}finally{ts(!1)}}},[xs,Q]),Ns=(0,e.useCallback)(async(e={})=>{const{signal:t,focusProposalId:s}=e;je(!0),Ie(null);try{var i;const e=null!==(i=(await n("proposals",t?{signal:t}:void 0)).items)&&void 0!==i?i:[];Z(e),Y(t=>{var n;return s&&e.some(e=>e.id===s)?s:t&&e.some(e=>e.id===t)?t:null!==(n=e[0]?.id)&&void 0!==n?n:null})}catch(e){if("AbortError"===e.name)return;Ie(e.message)}finally{je(!1),we(!0)}},[]),Ss=(0,e.useCallback)(async(e,t,s)=>{if(!e)return ne([]),[];Ce(!0),Ee(null);try{var i;const l=t&&!["needs_review","needs_review_media","resolved","new_entities"].includes(t)||!t||"all"===t?"":`?status=${encodeURIComponent(t)}`,a=await n(`proposals/${encodeURIComponent(e)}/entities${l}`,{signal:s}),o=null!==(i=a.items)&&void 0!==i?i:[];return ne(o),a.decision_summary&&Z(t=>t.map(t=>t.id===e?{...t,decisions:a.decision_summary}:t)),a.resolver_decisions&&Z(t=>t.map(t=>t.id===e?{...t,resolver_decisions:a.resolver_decisions}:t)),o}catch(e){return"AbortError"!==e.name&&Ee(e.message),[]}finally{Ce(!1)}},[]),$s=(0,e.useCallback)(()=>{Q&&Ss(Q,ie)},[Q,ie,Ss]),Ds=(0,e.useCallback)(e=>{e.stopPropagation()},[]),Rs=(0,e.useCallback)(e=>{e.preventDefault(),e.stopPropagation()},[]),Is=(0,e.useMemo)(()=>de?.resolver?.attachments?.length?de.resolver.attachments:ee?.attachments||[],[ee,de]),As=((0,e.useCallback)(()=>{Q&&hs(Q)},[Q,hs]),(0,e.useCallback)(async(e,t)=>{if(Q&&e&&t){It(`${e}::${t}`),St(null);try{await i(`proposals/${encodeURIComponent(Q)}/duplicates/cleanup`,{vf_object_uid:e,keep_path:t}),await hs(Q),await Ss(Q,ie)}catch(e){St(e?.message||"Failed to mark canonical entry.")}finally{It("")}}},[Q,hs,Ss,ie])),Es=(0,e.useCallback)(async()=>{if(Q&&yt.count&&At){Ut(!0),St(null);try{await i(`proposals/${encodeURIComponent(Q)}/duplicates/cleanup`,{apply_all:!0,preferred_format:At,confirm_token:Mt.trim()}),Bt(""),await hs(Q),await Ss(Q,ie)}catch(e){St(e?.message||"Failed to clean duplicates.")}finally{Ut(!1)}}},[Q,yt.count,At,Mt,hs,Ss,ie]),Ms=!yt.count||kt||!At||Mt.trim().toUpperCase()!==ds||Ot,[Bs,Os]=(0,e.useState)(!1),Us=(0,e.useCallback)(e=>{zt(t=>{const s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})},[]),Ts=(0,e.useCallback)((e,t)=>{zt(s=>{const n=new Set(s);return e.forEach(e=>{t?n.add(e):n.delete(e)}),n})},[]),Ps=(0,e.useCallback)(()=>{zt(new Set)},[]),Fs=(0,e.useCallback)(()=>{zt(new Set(se.map(e=>e.vf_object_uid)))},[se]),Vs=(0,e.useMemo)(()=>se.filter(e=>f(e)),[se]),Ls=Vs.length>0,Hs=(0,e.useCallback)(async()=>{if(Q&&Ls){Pt(!0),St(null);try{await i(`proposals/${encodeURIComponent(Q)}/entities/accept`,{scope:"new_only"}),await Ss(Q,ie),await hs(Q)}catch(e){St(e?.message||"Failed to accept new entities.")}finally{Pt(!1)}}},[Q,Ls,Ss,ie,hs]),Ks=(0,e.useCallback)(async()=>{if(Q&&0!==Kt.size){Vt(!0),_e(null);try{await i(`proposals/${encodeURIComponent(Q)}/entities/accept`,{scope:"selected",vf_object_uids:Array.from(Kt)}),await Ss(Q,ie),Ps()}catch(e){_e(e?.message||"Failed to accept selected entities.")}finally{Vt(!1)}}},[Q,Kt,Ss,ie,Ps]),zs=(0,e.useCallback)(async()=>{if(Q&&0!==Kt.size){Ht(!0),_e(null);try{await i(`proposals/${encodeURIComponent(Q)}/entities/unaccept`,{scope:"selected",vf_object_uids:Array.from(Kt)}),await Ss(Q,ie),Ps()}catch(e){_e(e?.message||"Failed to unaccept selected entities.")}finally{Ht(!1)}}},[Q,Kt,Ss,ie,Ps]);(0,e.useEffect)(()=>{qe(null),Ge(null),Pe(!1),Ze(!1),Ye("full"),tt(!1),lt([])},[Q]),(0,e.useEffect)(()=>{"partial"!==Qe&&tt(!1)},[Qe]),(0,e.useEffect)(()=>{if(0===it.length)return;const e=setTimeout(()=>{lt(e=>e.slice(1))},6e3);return()=>clearTimeout(e)},[it]),(0,e.useEffect)(()=>{const e=new AbortController;return Ns({signal:e.signal}),()=>e.abort()},[Ns]),(0,e.useEffect)(()=>{if("undefined"==typeof window||!window.sessionStorage)return;const e=window.sessionStorage.getItem(vs);if(e)try{const t=JSON.parse(e);t?.proposalId===Q?js(t):(window.sessionStorage.removeItem(vs),js(null))}catch(e){window.sessionStorage.removeItem(vs),js(null)}else js(null)},[Q]);const Js=(0,e.useCallback)(async(e,t)=>{if(e){Se(!0),Be(null);try{const s=await n(`proposals/${encodeURIComponent(e)}/resolver`,{signal:t});te(s)}catch(e){"AbortError"!==e.name&&Be(e.message)}finally{Se(!1)}}else te(null)},[]);(0,e.useEffect)(()=>{if(!Q)return ce(null),ue(null),void he(!1);const e=new AbortController;return Ss(Q,ie,e.signal).then(e=>{if(!e.length)return ce(null),void he(!1);const t=ms.current;t&&e.some(e=>e.vf_object_uid===t)||(ce(null),he(!1))}),()=>e.abort()},[Q,ie,Ss]),(0,e.useEffect)(()=>{if(!Q)return;const e=new AbortController;return Js(Q,e.signal),()=>e.abort()},[Q,Js]),(0,e.useEffect)(()=>{if(!Q)return wt({count:0,items:[]}),void St(null);const e=new AbortController;return hs(Q,{signal:e.signal}),()=>e.abort()},[Q,hs]),(0,e.useEffect)(()=>{if(!Q||!re)return ue(null),ve({}),void ge({});const e=new AbortController;return(async()=>{De(!0),Ue(null),_e(null),ge({});try{var t;const s=await n(`proposals/${encodeURIComponent(Q)}/entities/${encodeURIComponent(re)}`,{signal:e.signal});ue(s),ve(null!==(t=s.decisions)&&void 0!==t?t:{})}catch(e){"AbortError"!==e.name&&Ue(e.message)}finally{De(!1)}})(),()=>e.abort()},[Q,re]),(0,e.useEffect)(()=>{if(!Q||!Jt)return;const e=new AbortController;return fs(Q,e.signal),()=>e.abort()},[Q,Jt,fs]),(0,e.useEffect)(()=>{Jt||ns(Wt.length>0)},[Wt,Jt]);const qs=(0,e.useCallback)((e,t)=>{const s=Number(e),n=(e=[])=>e.map(e=>{if((void 0!==e.original_id?e.original_id:e.descriptor?.original_id)===s){if(t)return{...e,decision:t};const{decision:s,...n}=e;return n}return e});te(e=>e?{...e,attachments:n(e.attachments||[])}:e),ue(e=>e?{...e,resolver:{...e.resolver||{},attachments:n(e.resolver?.attachments||[])}}:e),ne(e=>e.map(e=>e.vf_object_uid===re?{...e,resolver:{...e.resolver||{},attachments:n(e.resolver?.attachments||[])}}:e))},[re]),Ws=(0,e.useMemo)(()=>{let e=se;if("with_decisions"===ie&&(e=e.filter(e=>{var t;return(null!==(t=e.decision_summary?.total)&&void 0!==t?t:0)>0})),!ae)return e;const t=ae.toLowerCase();return e.filter(e=>[w(e),y(e),x(e),j(e),e.path,e.term_taxonomy,e.taxonomy].filter(Boolean).join(" ").toLowerCase().includes(t))},[se,ae,ie]),Gs=(0,e.useMemo)(()=>se.find(e=>e.vf_object_uid===re),[se,re]);(0,e.useEffect)(()=>{zt(e=>{const t=new Set,s=new Set(se.map(e=>e.vf_object_uid));return e.forEach(e=>{s.has(e)&&t.add(e)}),t})},[se]);const Xs=(0,e.useMemo)(()=>se.filter(e=>"missing_local_hash"===e.diff_state?.reason),[se]),Zs=(0,e.useMemo)(()=>X.find(e=>e.id===Q),[X,Q]),Qs=Array.isArray(Wt)?Wt.length:0,Ys=(0,e.useMemo)(()=>{if(!Array.isArray(Wt))return 0;const e=new Set;return Wt.forEach(t=>{t?.vf_object_uid&&e.add(t.vf_object_uid)}),e.size},[Wt]),en=(0,e.useMemo)(()=>{const e={needs_review:0,needs_review_media:0,new_entities:0,with_decisions:0};return se.forEach(t=>{"needs_review"===t.overall_status&&e.needs_review++,t.media_needs_review&&e.needs_review_media++,t.is_new_entity&&e.new_entities++;const s=t.decision_summary||{};(null!=s.total?s.total:0)>0&&e.with_decisions++}),[{id:"needs_review",label:"Needs Review",count:e.needs_review,filter:"needs_review"},{id:"needs_review_media",label:"Unresolved meta",count:e.needs_review_media,filter:"needs_review_media"},{id:"new_entities",label:"New entities",count:e.new_entities,filter:"new_entities"},{id:"with_decisions",label:"Pending decisions",count:e.with_decisions,filter:"with_decisions"}]},[se]),tn=(0,e.useMemo)(()=>[{label:"Ignore & hide",value:"ignore"},{label:"Auto-accept & suppress",value:"auto_accept"},{label:"Override masked value",value:"override"}],[]),sn=(0,e.useMemo)(()=>({apply:`Apply the configured masking rules to every entity in this proposal. Learn more: ${o("live-proposal-masking")}`,ignore:`Ignore this masked field so it no longer counts toward Needs Review. Learn more: ${o("ignore-masked-field")}`,auto:`Auto-accept the masked value and suppress it from future diffs. Learn more: ${o("auto-accept-and-suppress")}`,override:`Override the masked value with a sanitized replacement. Learn more: ${o("override-masked-value")}`}),[]);(0,e.useEffect)(()=>{if(!Ws.length)return ce(null),void he(!1);re&&!Ws.some(e=>e.vf_object_uid===re)&&(ce(null),he(!1))},[Ws,re]),(0,e.useEffect)(()=>{nt("conflicts")},[re]);const nn=(0,e.useCallback)(e=>{if(!e)return ce(null),void he(!1);ce(t=>t===e?t:e),he(!0)},[]),ln=(0,e.useCallback)(async e=>{if(Q){Ve(!0);try{const t=await i(`proposals/${encodeURIComponent(Q)}/status`,{status:e});Z(e=>e.map(e=>e.id===Q?{...e,status:t.status}:e))}catch(e){Ge(e?.message||"Failed to update proposal status.")}finally{Ve(!1)}}},[Q]),an=(0,e.useCallback)(async()=>{if(Q&&0!==Xs.length&&window.confirm(`Store import hashes for ${Xs.length} entit${1===Xs.length?"y":"ies"}?`)){ze("bulk"),He(!0),_e(null);try{await i(`proposals/${encodeURIComponent(Q)}/entities/hash-sync`,{vf_object_uids:Xs.map(e=>e.vf_object_uid)}),await Ss(Q,ie)}catch(e){_e(e?.message||"Failed to store import hashes.")}finally{He(!1),ze("")}}},[Q,Xs,Ss,ie]),on=(0,e.useCallback)(async e=>{if(Q&&e){ze(e),He(!0),_e(null);try{var t;await i(`proposals/${encodeURIComponent(Q)}/entities/${encodeURIComponent(e)}/hash-sync`,{}),await Ss(Q,ie);const s=await n(`proposals/${encodeURIComponent(Q)}/entities/${encodeURIComponent(e)}`);ue(s),ve(null!==(t=s.decisions)&&void 0!==t?t:{})}catch(e){_e(e?.message||"Failed to store import hash.")}finally{He(!1),ze("")}}},[Q,ie,Ss]),rn=(0,e.useCallback)(()=>{he(!1)},[]),cn=(0,e.useCallback)(()=>{Q&&(Ge(null),qe(null),Ye("full"),tt(!1),Ze(!0))},[Q]),dn=(0,e.useCallback)(()=>{Te||Ze(!1)},[Te]),un=(0,e.useCallback)(e=>{lt(t=>t.filter(t=>t.id!==e))},[]),pn=(0,e.useCallback)(async()=>{if(Q){Ze(!1),Ge(null),qe(null),Pe(!0);try{var e,t;const o=await i(`proposals/${encodeURIComponent(Q)}/apply`,{mode:Qe,ignore_missing_hash:et});qe(o),o.decisions&&Z(e=>e.map(e=>e.id===Q?{...e,decisions:o.decisions}:e)),o.resolver_decisions&&Z(e=>e.map(e=>e.id===Q?{...e,resolver_decisions:o.resolver_decisions}:e)),o.status&&Z(e=>e.map(e=>e.id===Q?{...e,status:o.status}:e));const r=null!==(e=o?.result?.imported)&&void 0!==e?e:0,c=null!==(t=o?.result?.skipped)&&void 0!==t?t:0,d=Array.isArray(o?.result?.errors)?o.result.errors:[],u=(new Date).toISOString(),p=Date.now(),h=[];var s,n,l,a;d.length>0&&h.push(d[0]),o.decisions_cleared&&o.auto_clear_enabled&&h.push("Reviewer decisions cleared."),o.ignore_missing_hash&&h.push("Hash check override enabled."),o.resolver_decisions&&h.push(`Resolver decisions — reuse: ${null!==(s=o.resolver_decisions.reuse)&&void 0!==s?s:0}, map: ${null!==(n=o.resolver_decisions.map)&&void 0!==n?n:0}, download: ${null!==(l=o.resolver_decisions.download)&&void 0!==l?l:0}, skip: ${null!==(a=o.resolver_decisions.skip)&&void 0!==a?a:0}`),"closed"===o.status&&h.push("Proposal marked closed."),lt(e=>[...e,{id:p,severity:d.length?"warning":"success",title:`Applied ${Zs?.title||Q}`,message:`Imported ${r} · Skipped ${c}`,detail:h.join(" "),timestamp:u}]),ot(e=>{var t,s;return[{id:p,timestamp:u,proposalId:Q,proposalTitle:Zs?.title||Q,mode:null!==(t=o.mode)&&void 0!==t?t:Qe,imported:r,skipped:c,errors:d,decisionsCleared:Boolean(o.decisions_cleared&&o.auto_clear_enabled),ignoreMissingHash:Boolean(o.ignore_missing_hash),resolverDecisions:null!==(s=o.resolver_decisions)&&void 0!==s?s:null},...e].slice(0,10)}),ce(null),he(!1),ue(null),ve({}),ge({});const m=await Ss(Q,ie);m.length&&(ce(m[0].vf_object_uid),he(!0)),await Js(Q)}catch(e){const t=e?.message||"Apply request failed.";Ge(t);const s=(new Date).toISOString(),n=Date.now(),i=[t];et&&i.push("Hash check override requested."),lt(e=>[...e,{id:n,severity:"warning",title:`Apply failed (${Zs?.title||Q})`,message:t,detail:i.join(" "),timestamp:s}]),ot(e=>[{id:n,timestamp:s,proposalId:Q,proposalTitle:Zs?.title||Q,mode:Qe,imported:0,skipped:0,errors:[t],decisionsCleared:!1,ignoreMissingHash:et},...e].slice(0,10))}finally{Pe(!1)}}},[Q,Qe,Ss,ie,Js,Zs,et]),hn=(0,e.useCallback)(async(e,t)=>{if(Q&&re){_e(null),ge(t=>({...t,[e]:!0}));try{var s,n;const l=await i(`proposals/${encodeURIComponent(Q)}/entities/${encodeURIComponent(re)}/selections`,{path:e,action:t}),a=null!==(s=l.decisions)&&void 0!==s?s:{},o=null!==(n=l.summary)&&void 0!==n?n:null;ve(a),ue(e=>{var t;return e?{...e,decisions:a,decision_summary:null!=o?o:e.decision_summary,new_entity_decision:null!==(t=a[v])&&void 0!==t?t:e.new_entity_decision}:e}),ne(e=>e.map(e=>{var t;return e.vf_object_uid===re?{...e,decision_summary:null!=o?o:e.decision_summary,new_entity_decision:null!==(t=a[v])&&void 0!==t?t:e.new_entity_decision}:e})),l.proposal_summary&&Z(e=>e.map(e=>e.id===Q?{...e,decisions:l.proposal_summary}:e))}catch(e){_e(e.message)}finally{ge(t=>{const s={...t};return delete s[e],s})}}},[Q,re]),mn=(0,e.useCallback)(async(e,t)=>{if(Q){ut(null),ct(t=>({...t,[e]:!0}));try{var s;const n=await i(`proposals/${encodeURIComponent(Q)}/resolver/${encodeURIComponent(e)}`,t);return qs(e,null!==(s=n.decision)&&void 0!==s?s:null),n}catch(e){throw ut(e.message),e}finally{ct(t=>{const s={...t};return delete s[e],s})}}},[Q,qs]),vn=(0,e.useCallback)(async(e,t)=>{await mn(e,t)},[mn]),bn=(0,e.useCallback)(async(e,t="proposal")=>{if(Q){ut(null),ct(t=>({...t,[e]:!0}));try{var s;const n=await l(`proposals/${encodeURIComponent(Q)}/resolver/${encodeURIComponent(e)}?scope=${encodeURIComponent(t)}`);qs(e,null!==(s=n.decision)&&void 0!==s?s:null)}catch(e){ut(e.message)}finally{ct(t=>{const s={...t};return delete s[e],s})}}},[Q,qs]),gn=(0,e.useCallback)(async(e,t)=>{const s=e.reason||"";if(!s||!Is.length)return;const n=Is.filter(t=>t.original_id!==e.original_id&&(t.reason||"")===s);if(n.length){if(window.confirm(`Apply this ${t.action} decision to ${n.length} other conflict(s) with reason "${s}"?`))try{await Promise.all(n.map(e=>mn(e.original_id,t)))}catch(e){}}else window.alert("No similar conflicts found to apply this decision to.")},[Is,mn]),fn=(0,e.useCallback)(async()=>{if(Q&&re&&window.confirm("Clear all Accept/Keep choices for this entity?")){_e(null),ht(!0),ge({});try{var e,t;const s=await i(`proposals/${encodeURIComponent(Q)}/entities/${encodeURIComponent(re)}/selections`,{action:"clear_all"}),n=null!==(e=s.decisions)&&void 0!==e?e:{},l=null!==(t=s.summary)&&void 0!==t?t:null;ve(n),ue(e=>e?{...e,decisions:n,decision_summary:null!=l?l:e.decision_summary}:e),ne(e=>e.map(e=>e.vf_object_uid===re?{...e,decision_summary:null!=l?l:e.decision_summary}:e)),s.proposal_summary&&Z(e=>e.map(e=>e.id===Q?{...e,decisions:s.proposal_summary}:e))}catch(e){_e(e.message)}finally{ht(!1)}}},[Q,re]),xn=(0,e.useCallback)(async()=>{if(Q&&re){vt(!0),_e(null);try{var e,t;const s=null!==(e=(await i(`proposals/${encodeURIComponent(Q)}/entities/${encodeURIComponent(re)}/snapshot`,{})).snapshot)&&void 0!==e?e:null;s&&ue(e=>e?{...e,current:s,current_source:"snapshot"}:e);const l=await n(`proposals/${encodeURIComponent(Q)}/entities/${encodeURIComponent(re)}`);ue(l),ve(null!==(t=l.decisions)&&void 0!==t?t:{}),ne(e=>e.map(e=>{var t;return e.vf_object_uid===re?{...e,decision_summary:null!==(t=l.decision_summary)&&void 0!==t?t:e.decision_summary}:e}))}catch(e){_e(e.message)}finally{vt(!1)}}},[Q,re]),jn=(0,e.useCallback)(async()=>{if(Q){gt(!0),_e(null);try{var e,t;const l=await n(`proposals/${encodeURIComponent(Q)}/entities?status=needs_review`),a=Array.isArray(l.items)?l.items:[],o=a.map(e=>e.vf_object_uid).filter(e=>"string"==typeof e&&e.length>0),r=o.length?{entity_ids:o}:{},c=await i(`proposals/${encodeURIComponent(Q)}/snapshot`,r),d=null!==(e=c.captured)&&void 0!==e?e:0,u=null!==(t=c.targets)&&void 0!==t?t:o.length||a.length||0,p=(new Date).toISOString();if(lt(e=>[...e,{id:Date.now(),severity:"info",title:"Snapshots captured",message:`Captured ${d}/${u||d} snapshot(s) for proposal ${Q}.`,timestamp:p}]),await Ss(Q,ie),await Js(Q),re){var s;const e=await n(`proposals/${encodeURIComponent(Q)}/entities/${encodeURIComponent(re)}`);ue(e),ve(null!==(s=e.decisions)&&void 0!==s?s:{})}}catch(e){_e(e.message)}finally{gt(!1)}}},[Q,re,ie,Ss,Js]),yn=(0,e.useCallback)(async()=>{if(window.confirm("This will delete all stored backups, snapshots, and reviewer decisions. Continue?")){_t(!0),_e(null);try{await l("maintenance/clear-proposals"),await Ns(),Y(null),ne([]),ue(null),te(null),ve({}),ge({}),lt(e=>[...e,{id:Date.now(),severity:"info",title:"Backups cleared",message:"All proposal backups, snapshots, and decisions have been removed.",timestamp:(new Date).toISOString()}])}catch(e){_e(e.message)}finally{_t(!1)}}},[Ns]),wn=(0,e.useCallback)(async(e,t)=>{if(!Q||!re||!Array.isArray(t)||0===t.length)return;const s=t.filter(e=>"string"==typeof e&&e.length>0);if(!s.length)return;const n=e=>{var t,s;const n=null!==(t=e.decisions)&&void 0!==t?t:{},i=null!==(s=e.summary)&&void 0!==s?s:null;ve(n),ue(e=>e?{...e,decisions:n,decision_summary:null!=i?i:e.decision_summary}:e),ne(e=>e.map(e=>e.vf_object_uid===re?{...e,decision_summary:null!=i?i:e.decision_summary}:e)),e.proposal_summary&&Z(t=>t.map(t=>t.id===Q?{...t,decisions:e.proposal_summary}:t))};_e(null),Os(!0),ge(e=>{const t={...e};return s.forEach(e=>{t[e]=!0}),t});try{try{const t=await i(`proposals/${encodeURIComponent(Q)}/entities/${encodeURIComponent(re)}/selections/bulk`,{action:e,paths:s});n(t),ge({})}catch(t){if(404!==t.status)throw t;await(async()=>{for(const t of s){const s=await i(`proposals/${encodeURIComponent(Q)}/entities/${encodeURIComponent(re)}/selections`,{path:t,action:e});n(s),ge(e=>{const s={...e};return delete s[t],s})}})()}}catch(e){_e(e.message)}finally{Os(!1),ge({})}},[Q,re]),kn=null!==(a=Zs?.decisions)&&void 0!==a?a:null,Cn=null!==(c=kn?.total)&&void 0!==c?c:0,Nn=null!==(d=kn?.accepted)&&void 0!==d?d:0,Sn=null!==(u=kn?.kept)&&void 0!==u?u:0,$n=null!==(p=kn?.accepted_new)&&void 0!==p?p:0,Dn=null!==(h=kn?.entities_reviewed)&&void 0!==h?h:0,Rn=null!==(m=Zs?.resolver_decisions)&&void 0!==m?m:null,In=null!==(g=Rn?.reuse)&&void 0!==g?g:0,An=null!==(_=Rn?.map)&&void 0!==_?_:0,En=null!==(I=Rn?.download)&&void 0!==I?I:0,Mn=null!==(A=Rn?.skip)&&void 0!==A?A:0,Bn=null!==(E=null!==(M=ee?.metrics?.unresolved)&&void 0!==M?M:Zs?.resolver?.metrics?.unresolved)&&void 0!==E?E:0,On=Array.isArray(Je?.result?.errors)?Je.result.errors:[],Un=On.length?"notice notice-warning":"notice notice-success",Tn=null!==(B=Je?.result?.imported)&&void 0!==B?B:0,Pn=null!==(U=Je?.result?.skipped)&&void 0!==U?U:0,Fn=null!==(T=Je?.result?.media_resolver?.metrics)&&void 0!==T?T:{},Vn=null!==(P=Fn?.unresolved)&&void 0!==P?P:0,Ln=null!==(F=Je?.result?.media_reconcile)&&void 0!==F?F:null,Hn=(0,e.useCallback)(e=>{Ns({focusProposalId:e});const t=(new Date).toISOString(),s=Date.now();lt(n=>[...n,{id:s,severity:"success",title:"Proposal uploaded",message:`Bundle registered as ${e}`,timestamp:t}])},[Ns]),Kn=(0,e.useCallback)(e=>{const t=(new Date).toISOString(),s=Date.now();lt(n=>[...n,{id:s,severity:"error",title:"Upload failed",message:e,timestamp:t}])},[]);return!ye&&xe?(0,s.jsx)("p",{children:"Loading proposals…"}):!ye&&Re?(0,s.jsxs)("p",{className:"dbvc-admin-app-error",children:["Error loading proposals: ",Re]}):(0,s.jsxs)("div",{className:"dbvc-admin-app",onClick:Ds,onMouseDown:Ds,onSubmit:Rs,children:[it.length>0&&(0,s.jsx)("div",{className:"dbvc-toasts",children:it.map(e=>(0,s.jsxs)("div",{className:`dbvc-toast dbvc-toast--${e.severity}`,children:[(0,s.jsxs)("div",{className:"dbvc-toast__content",children:[(0,s.jsx)("strong",{children:e.title}),(0,s.jsx)("span",{children:e.message}),e.detail&&(0,s.jsx)("small",{children:e.detail}),(0,s.jsx)("small",{className:"dbvc-toast__time",children:r(e.timestamp)})]}),(0,s.jsx)("button",{type:"button",className:"dbvc-toast__dismiss",onClick:()=>un(e.id),"aria-label":"Dismiss notification",children:"×"})]},e.id))}),(0,s.jsxs)("div",{className:"dbvc-admin-app__header",children:[(0,s.jsx)("h1",{children:"DBVC Proposals"}),(0,s.jsx)(t.Button,{variant:"secondary",onClick:()=>Ns(),disabled:xe&&ye,children:xe&&ye?"Refreshing…":"Refresh list"}),(0,s.jsx)(t.Button,{variant:"tertiary",onClick:yn,disabled:ft,isBusy:ft,children:ft?"Clearing…":"Clear all backups"})]}),(0,s.jsx)(N,{onUploaded:Hn,onError:Kn}),Re&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)("p",{children:["Failed to load proposals: ",Re]})}),(0,s.jsx)(C,{proposals:X,selectedId:Q,onSelect:Y}),Zs&&(0,s.jsxs)("section",{className:"dbvc-admin-app__detail",children:[(0,s.jsx)("h2",{children:Zs.title}),(0,s.jsxs)("p",{className:"dbvc-admin-app__detail-meta",children:["Generated: ",r(Zs.generated_at)," · Files:"," ",null!==(V=Zs.files)&&void 0!==V?V:"—"," · Media: ",null!==(L=Zs.media_items)&&void 0!==L?L:"—"," · Status:"," ",(0,s.jsx)("strong",{children:"closed"===Zs.status?"Closed":"Open"})," ",(0,s.jsx)("span",{className:"dbvc-badge dbvc-badge--resolver",children:(0,s.jsx)("a",{href:"#dbvc-global-resolver",children:"Global rules enabled"})})]}),Me&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)("p",{children:["Resolver error: ",Me]})}),Ne?(0,s.jsx)("p",{children:"Loading resolver metrics…"}):(0,s.jsx)(S,{resolver:ee}),(0,s.jsxs)("div",{className:"dbvc-admin-app__actions",children:[(0,s.jsx)("button",{type:"button",className:"button button-primary",onClick:cn,disabled:Te||"closed"===Zs.status,title:"closed"===Zs.status?"Reopen this proposal before applying new changes.":void 0,children:Te?"Applying…":"Close & Apply Proposal"}),"closed"===Zs.status?(0,s.jsxs)("div",{className:"dbvc-admin-app__status-note",children:[(0,s.jsx)("p",{children:"This proposal has been closed. Reopen it to continue reviewing this snapshot."}),(0,s.jsx)("button",{type:"button",className:"button",onClick:()=>ln("draft"),disabled:Fe,children:Fe?"Reopening…":"Reopen proposal"})]}):(0,s.jsx)("p",{className:"description",children:"Applying will close this proposal snapshot. Re-export on the source site for additional changes."}),Cn>0&&(0,s.jsxs)("div",{className:"dbvc-decisions",children:[(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--accept",children:[Nn," accept"]}),$n>0&&(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--new",children:[$n," new"]}),(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--keep",children:[Sn," keep"]}),(0,s.jsxs)("span",{className:"dbvc-badge dbvc-badge--reviewed",children:[Dn," reviewed"]})]})]}),We&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)("p",{children:["Apply failed: ",We]})}),Je&&(0,s.jsxs)("div",{className:Un,children:[(0,s.jsxs)("p",{children:['Applied proposal "',Zs?.title||Q,'". Mode: ',null!==(H=Je.mode)&&void 0!==H?H:"full"," · Imported ",Tn," · Skipped"," ",Pn,Je.decisions_cleared&&Je.auto_clear_enabled?" · Reviewer decisions were cleared.":"",Vn>0&&` · ${Vn} resolver conflict(s) remain.`]}),Ln&&(0,s.jsxs)("p",{className:"dbvc-resolver-summary",children:["Media reconciliation — created: ",null!==(K=Ln.created)&&void 0!==K?K:0,", unresolved: ",null!==(z=Ln.unresolved)&&void 0!==z?z:0]}),Je.resolver_decisions&&(0,s.jsxs)("p",{className:"dbvc-resolver-summary",children:["Resolver decisions applied — reuse: ",null!==(J=Je.resolver_decisions.reuse)&&void 0!==J?J:0,", map:"," ",null!==(q=Je.resolver_decisions.map)&&void 0!==q?q:0,", download: ",null!==(W=Je.resolver_decisions.download)&&void 0!==W?W:0,", skip:"," ",null!==(G=Je.resolver_decisions.skip)&&void 0!==G?G:0]}),On.length>0&&(0,s.jsx)("ul",{children:On.map((e,t)=>(0,s.jsx)("li",{children:e},t))})]}),Rn&&(0,s.jsx)("div",{className:"dbvc-resolver-summary",children:(0,s.jsxs)("span",{children:["Resolver decisions — reuse: ",In,", map: ",An,", download:"," ",En,", skip: ",Mn]})}),at.length>0&&(0,s.jsxs)("div",{className:"dbvc-apply-history",children:[(0,s.jsx)("h3",{children:"Recent Apply Runs"}),(0,s.jsx)("ul",{children:at.map(e=>{var t,n,i,l;return(0,s.jsxs)("li",{children:[(0,s.jsx)("strong",{children:r(e.timestamp)})," — Mode ",e.mode," · Imported ",e.imported," · Skipped ",e.skipped,e.errors.length?` · ${e.errors.length} error(s)`:"",e.decisionsCleared?" · Selections cleared":"",e.ignoreMissingHash?" · Hash override":"",e.resolverDecisions?` · Resolver decisions (reuse ${null!==(t=e.resolverDecisions.reuse)&&void 0!==t?t:0}, map ${null!==(n=e.resolverDecisions.map)&&void 0!==n?n:0}, download ${null!==(i=e.resolverDecisions.download)&&void 0!==i?i:0}, skip ${null!==(l=e.resolverDecisions.skip)&&void 0!==l?l:0})`:""]},e.id)})})]}),Xe&&(0,s.jsxs)(t.Modal,{title:`Apply proposal "${Zs?.title||Q}"`,onRequestClose:dn,isDismissible:!Te,shouldCloseOnClickOutside:!Te,children:[(0,s.jsxs)("div",{className:"dbvc-apply-modal__summary",children:[(0,s.jsx)("p",{children:"This will run the import pipeline for the selected proposal using the chosen mode."}),(0,s.jsx)("p",{className:"dbvc-apply-modal__warning",children:"Applying closes this proposal snapshot. To continue reviewing additional entities, export a new proposal after this step or reopen if necessary."}),Cn>0?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("p",{children:"Reviewer selections captured:"}),(0,s.jsxs)("ul",{children:[(0,s.jsxs)("li",{children:[Nn," field(s) marked Accept"]}),$n>0&&(0,s.jsxs)("li",{children:[$n," new entity approval(s)"]}),(0,s.jsxs)("li",{children:[Sn," field(s) kept as-is"]}),(0,s.jsxs)("li",{children:[Dn," entity row(s) touched"]})]}),(0,s.jsx)("p",{className:"description",children:"Only fields marked Accept will overwrite live data. Other fields remain unchanged."})]}):(0,s.jsx)("p",{className:"dbvc-apply-modal__warning",children:"No reviewer selections have been recorded. Applying now only imports entities with Accept/Keep selections or new entities you marked “Accept & import.” All other entities are skipped."})]}),(0,s.jsx)(t.RadioControl,{label:"Import mode",selected:Qe,options:[{label:"Full import (copy entire proposal)",value:"full"},{label:"Partial import (skip unchanged items when hashes match)",value:"partial"}],onChange:e=>Ye(e)}),(0,s.jsxs)("div",{className:"dbvc-apply-mode-help",children:[(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Full import (recommended):"})," Applies only the fields you accepted, records the close-out, and leaves untouched entities for the next export."]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Partial import (legacy):"})," Only needed for old proposals missing import hashes. Behavior otherwise matches full import."]})]}),"partial"===Qe&&(0,s.jsx)(t.CheckboxControl,{label:"Ignore missing import hash validation",checked:et,onChange:e=>tt(e),help:"Use only for legacy backups that predate import hash support. Recommended to resolve hash mismatches when possible."}),(0,s.jsx)("p",{className:"description",children:"Selections will be cleared automatically after a successful apply if the auto-clear setting is enabled in Configure → Import."}),(0,s.jsxs)("div",{className:"dbvc-apply-modal__footer",children:[(0,s.jsx)(t.Button,{variant:"secondary",onClick:dn,disabled:Te,children:"Cancel"}),(0,s.jsx)(t.Button,{variant:"primary",onClick:pn,isBusy:Te,disabled:Te,children:"Close & Apply Proposal"})]})]}),(0,s.jsxs)("div",{className:"dbvc-entities-header",children:[(0,s.jsx)("h3",{children:"Entities"}),kt&&(0,s.jsx)("span",{className:"dbvc-duplicates-loading",children:"Checking duplicates…"})]}),Nt&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)("p",{children:["Failed to load duplicate summary: ",Nt]})}),(0,s.jsxs)("div",{className:"dbvc-admin-app__filters",children:[(0,s.jsxs)("label",{children:["Show: ",(0,s.jsxs)("select",{value:ie,onChange:e=>{le(e.target.value)},children:[(0,s.jsx)("option",{value:"all",children:b.all}),(0,s.jsx)("option",{value:"needs_review",children:b.needs_review}),(0,s.jsx)("option",{value:"needs_review_media",children:b.needs_review_media}),(0,s.jsx)("option",{value:"resolved",children:b.resolved}),(0,s.jsx)("option",{value:"new_entities",children:b.new_entities}),(0,s.jsx)("option",{value:"with_decisions",children:b.with_decisions})]})]}),(0,s.jsxs)("label",{children:[" Search: ",(0,s.jsx)("input",{type:"search",value:ae,onChange:e=>{oe(e.target.value)},placeholder:"Title, type, path…"})]})]}),(0,s.jsxs)("div",{className:"dbvc-entity-badges-row",children:[(0,s.jsx)("div",{className:"dbvc-entity-status-badges",children:en.map(e=>(0,s.jsxs)("button",{type:"button",className:"dbvc-status-badge"+(ie===e.filter?" is-active":""),disabled:0===e.count,"aria-pressed":ie===e.filter,onClick:()=>le(ie===e.filter?"all":e.filter),children:[(0,s.jsx)("span",{children:e.label}),(0,s.jsx)("strong",{children:e.count})]},e.id))}),(0,s.jsx)("div",{className:`dbvc-tools-toggle${Jt?" is-open":""}${ss?" has-attention":""}`,children:t?.Tooltip?(0,s.jsx)(t.Tooltip,{text:`Open resolver summary, hashing helpers, and masking controls. Learn more: ${o("live-proposal-masking")}`,children:(0,s.jsx)("button",{type:"button",className:"button button-secondary",onClick:_s,"aria-expanded":Jt,children:Jt?"Hide tools":"Tools"})}):(0,s.jsx)("button",{type:"button",className:"button button-secondary",onClick:_s,"aria-expanded":Jt,children:Jt?"Hide tools":"Tools"})})]}),Jt&&(0,s.jsxs)("div",{className:"dbvc-tools-panel"+(ss?" has-attention":""),children:[(0,s.jsxs)("div",{className:"dbvc-tools-panel__section dbvc-tools-panel__section--masking",children:[(0,s.jsxs)("div",{className:"dbvc-tools-panel__section-heading",children:[(0,s.jsx)("strong",{children:"Meta masking"}),(Xt||es)&&(0,s.jsxs)("span",{className:"dbvc-mask-progress",children:[Xt?bs:ys,Xt?"% loaded":"% applied"]}),(0,s.jsx)("a",{href:o("live-proposal-masking"),target:"_blank",rel:"noreferrer",children:"Masking guide ↗"}),xs&&(0,s.jsx)(t.Button,{variant:"tertiary",onClick:Cs,disabled:es,children:es?"Reverting…":"Undo last masking"})]}),Qt&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)("p",{children:["Masking error: ",Qt]})}),Xt?(0,s.jsx)("p",{children:"Loading masking rules…"}):Array.isArray(Wt)&&Wt.length?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("p",{children:`Found ${Qs} masked field${1===Qs?"":"s"} across ${Ys} entit${1===Ys?"y":"ies"} in this proposal. Choose how you want to handle them.`}),t?.SelectControl?(0,s.jsx)(t.SelectControl,{label:"Action",value:is,options:tn,onChange:e=>ls(e)}):(0,s.jsxs)("label",{children:["Action",(0,s.jsxs)("select",{value:is,onChange:e=>ls(e.target.value),children:tn.map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.value))})]}),"override"===is&&(0,s.jsxs)("div",{className:"dbvc-mask-field__override",children:[t?.TextareaControl?(0,s.jsx)(t.TextareaControl,{label:"Override value",value:as,onChange:e=>os(e),rows:3}):(0,s.jsxs)("label",{children:["Override value",(0,s.jsx)("textarea",{value:as,onChange:e=>os(e.target.value)})]}),t?.TextControl?(0,s.jsx)(t.TextControl,{label:"Note (optional)",value:rs,onChange:e=>cs(e)}):(0,s.jsxs)("label",{children:["Note (optional)",(0,s.jsx)("input",{type:"text",value:rs,onChange:e=>cs(e.target.value)})]})]})]}):(0,s.jsxs)("p",{children:["No masked meta pending in this proposal. Learn more in the ",(0,s.jsx)("a",{href:o("live-proposal-masking"),target:"_blank",rel:"noreferrer",children:"masking reference"}),"."]}),(0,s.jsxs)("div",{className:"dbvc-mask-actions",children:[t?.Tooltip?(0,s.jsx)(t.Tooltip,{text:sn.apply,children:(0,s.jsx)(t.Button,{variant:"primary",onClick:ks,disabled:es||Xt||!Qs,isBusy:es,children:es?"Applying…":"Apply masking rules"})}):(0,s.jsx)(t.Button,{variant:"primary",onClick:ks,disabled:es||Xt||!Qs,isBusy:es,children:es?"Applying…":"Apply masking rules"}),(0,s.jsx)(t.Button,{variant:"tertiary",onClick:()=>Q&&fs(Q),disabled:Xt,isBusy:Xt,children:Xt?"Refreshing…":"Refresh list"})]})]})]}),Zs&&(0,s.jsxs)("div",{className:"dbvc-entity-actions",children:[Kt.size>0&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.Button,{className:"dbvc-new-entities-accept-button",variant:"primary",onClick:Ks,disabled:Ft,isBusy:Ft,children:Ft?"Accepting selected…":`Accept ${Kt.size} selected`}),(0,s.jsx)(t.Button,{variant:"secondary",onClick:zs,disabled:Lt,isBusy:Lt,children:Lt?"Unaccepting…":"Unaccept selected"})]}),Ls&&(0,s.jsx)(t.Button,{className:"dbvc-new-entities-accept-button",variant:"primary",onClick:Hs,disabled:Tt,isBusy:Tt,children:Tt?"Accepting…":`Accept all new entities (${Vs.length})`}),Ls&&(0,s.jsxs)(t.Button,{className:"dbvc-new-entities-button",variant:"secondary",onClick:()=>{le("new_entities"),oe("")},children:["Review ",Vs.length," new entity",1===Vs.length?"":"ies"]}),(0,s.jsx)(t.Button,{variant:"secondary",onClick:$s,disabled:ke,isBusy:ke,children:ke?"Refreshing…":"Refresh Entities"}),Kt.size>0&&(0,s.jsx)(t.Button,{variant:"tertiary",onClick:Ps,children:"Clear selection"}),0===Kt.size&&se.length>0&&(0,s.jsxs)(t.Button,{variant:"tertiary",onClick:Fs,children:["Select all (",se.length,")"]}),yt.count>0&&(0,s.jsxs)(t.Button,{variant:"primary",className:"dbvc-duplicates-button",onClick:()=>Dt(!0),children:["Resolve ",yt.count," duplicate",1===yt.count?"":"s"]}),(0,s.jsx)(t.Button,{variant:"secondary",onClick:jn,disabled:bt,isBusy:bt,children:bt?"Capturing snapshots…":"Capture Full Snapshot"}),Xs.length>0&&(0,s.jsx)(t.Button,{variant:"secondary",onClick:an,disabled:Le&&"bulk"===Ke,isBusy:Le&&"bulk"===Ke,children:Le&&"bulk"===Ke?"Storing hashes…":`Store hashes for ${Xs.length} entity hash${1===Xs.length?"":"es"}`}),(0,s.jsxs)("p",{className:"description",children:["Captures current-state JSON for ",Bn>0?`${Bn} unresolved`:"all"," entity(ies) so the diff shows live vs. proposed."]}),Xs.length>0&&(0,s.jsx)("p",{className:"description",children:"Some entities are missing their stored import hash. Sync them to prevent repeat reviews across environments."})]}),(0,s.jsxs)("div",{className:"dbvc-column-toggle",children:[(0,s.jsx)("span",{children:"Columns:"}),k.map(e=>(0,s.jsxs)("label",{children:[(0,s.jsx)("input",{type:"checkbox",checked:xt[e.id],onChange:()=>ps(e.id),disabled:e.lockVisible}),e.label]},e.id))]}),Ae&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsxs)("p",{children:["Failed to load entities: ",Ae]})}),(0,s.jsxs)("div",{className:"dbvc-entity-table-wrapper",children:[yt.count>0&&(0,s.jsx)("button",{type:"button",className:"dbvc-duplicates-overlay",onClick:()=>Dt(!0),title:"Resolve duplicate manifest entries before continuing.",children:"Duplicate manifest entries detected — resolve these first"}),(0,s.jsx)($,{entities:Ws,loading:ke,selectedEntityId:re,onSelect:nn,columns:us,selectedIds:Kt,onToggleSelection:Us,onToggleSelectionAll:Ts})]}),(0,s.jsx)(O,{}),(0,s.jsx)(D,{entityDetail:de,resolverInfo:Gs?.resolver,resolverDecisionSummary:Zs?.resolver_decisions,decisions:me,onDecisionChange:hn,onBulkDecision:wn,onResetDecisions:fn,onCaptureSnapshot:xn,onResolverDecision:vn,onResolverDecisionReset:bn,onApplyResolverDecisionToSimilar:gn,savingPaths:be,bulkSaving:Bs,resolverSaving:rt,resolverError:dt,decisionError:fe,loading:$e,error:Oe,filterMode:st,onFilterModeChange:nt,isOpen:pe,onClose:rn,resettingDecisions:pt,snapshotCapturing:mt,onHashSync:on,hashSyncing:Le,hashSyncTarget:Ke}),(0,s.jsx)(R,{open:$t,onClose:()=>Dt(!1),onMarkCanonical:As,actionKey:Rt,report:yt,bulkMode:At,onBulkModeChange:Et,confirmPhrase:ds,confirmValue:Mt,onConfirmChange:Bt,onBulkCleanup:Es,bulkBusy:Ot,bulkDisabled:Ms})]})]})},A=()=>{const t=document.getElementById("dbvc-admin-app-root");if(!t)return;const n=e.createRoot?e.createRoot(t):null;n?n.render((0,s.jsx)(I,{})):(0,e.render)((0,s.jsx)(I,{}),t)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",A):A();const E=({section:t,decisions:n,onDecisionChange:i,savingPaths:l})=>{const[a,o]=(0,e.useState)(!0);return(0,s.jsxs)("div",{className:"dbvc-admin-app__diff-section",id:`dbvc-diff-${t.key}`,children:[(0,s.jsxs)("button",{type:"button",className:"dbvc-admin-app__diff-toggle",onClick:()=>o(e=>!e),"aria-expanded":a,children:[(0,s.jsx)("h4",{children:t.label}),(0,s.jsx)("span",{children:a?"Collapse":"Expand"})]}),a?(0,s.jsxs)("table",{className:"widefat dbvc-admin-app__diff-table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{style:{width:"25%"},children:"Field"}),(0,s.jsx)("th",{children:"Current"}),(0,s.jsx)("th",{children:"Proposed"}),(0,s.jsx)("th",{style:{width:"20%"},children:"Decision"})]})}),(0,s.jsx)("tbody",{children:t.items.map(e=>{var t;const a=((e,t)=>{const s=d(e),n=d(t);if(s===n)return null;if(s.length>5e3||n.length>5e3)return null;const i=Math.min(s.length,n.length);let l=0;for(;l<i&&s[l]===n[l];)l++;let a=s.length-1,o=n.length-1;for(;a>=l&&o>=l&&s[a]===n[o];)a--,o--;return{old:{before:s.slice(0,l),diff:s.slice(l,a+1),after:s.slice(a+1)},new:{before:n.slice(0,l),diff:n.slice(l,o+1),after:n.slice(o+1)}}})(e.from,e.to),o=null!==(t=n?.[e.path])&&void 0!==t?t:"",r=!!l[e.path],p=["dbvc-diff-row"];return"accept"===o?p.push("is-accepted"):"keep"===o?p.push("is-kept"):p.push("is-unreviewed"),(0,s.jsxs)("tr",{className:p.join(" "),children:[(0,s.jsx)("td",{children:(0,s.jsxs)("div",{className:"dbvc-field-label",children:[e.label||e.path,e.path&&(0,s.jsx)("div",{className:"dbvc-field-label__key",children:e.path})]})}),(0,s.jsx)("td",{children:a&&a.old.diff?u(a.old):c(e.from)}),(0,s.jsx)("td",{children:a&&a.new.diff?u(a.new):c(e.to)}),(0,s.jsxs)("td",{children:[(0,s.jsxs)("div",{className:"dbvc-decision-controls",children:[(0,s.jsxs)("div",{className:"dbvc-decision-options",children:[(0,s.jsxs)("label",{children:[(0,s.jsx)("input",{type:"radio",name:`decision-${e.path}`,value:"keep",checked:"keep"===o,disabled:r,onChange:()=>i&&i(e.path,"keep")}),"Keep"]}),(0,s.jsxs)("label",{children:[(0,s.jsx)("input",{type:"radio",name:`decision-${e.path}`,value:"accept",checked:"accept"===o,disabled:r,onChange:()=>i&&i(e.path,"accept")}),"Accept"]})]}),(0,s.jsx)("button",{type:"button",className:"button-link dbvc-decision-clear",onClick:()=>i&&i(e.path,"clear"),disabled:r||!o,children:"Clear decision"})]}),(0,s.jsxs)("div",{className:"dbvc-decision-state",children:[(0,s.jsx)("span",{className:"dbvc-decision-status",children:"accept"===o?"Accepted":"keep"===o?"Kept":"Not reviewed"}),r&&(0,s.jsx)("span",{className:"saving",children:"Saving…"})]})]})]},e.path)})})]}):(0,s.jsxs)("div",{className:"dbvc-admin-app__no-diff",children:["Collapsed (",t.items.length," changes)."]})]})},M=({src:e,label:t})=>(0,s.jsxs)("div",{className:"dbvc-resolver-inline-preview",children:[e?(0,s.jsx)("img",{src:e,alt:"",className:"dbvc-resolver-inline-preview__image",loading:"lazy"}):(0,s.jsx)("span",{className:"dbvc-resolver-inline-preview__placeholder",children:"—"}),(0,s.jsx)("span",{className:"dbvc-resolver-inline-preview__label",children:null!=t?t:"—"})]}),B=({attachment:t,saving:n,onSave:i,onClear:l,onApplyToSimilar:a})=>{var o,r;const c=t.original_id,[d,u]=(0,e.useState)(t.decision?.action||""),[p,h]=(0,e.useState)(t.decision?.target_id?String(t.decision.target_id):""),[m,v]=(0,e.useState)(t.decision?.note||""),[b,f]=(0,e.useState)("global"===t.decision?.scope);(0,e.useEffect)(()=>{u(t.decision?.action||""),h(t.decision?.target_id?String(t.decision.target_id):""),v(t.decision?.note||""),f("global"===t.decision?.scope)},[t.decision]);const _="reuse"===d||"map"===d,x=parseInt(p,10),j=d&&(!_||x>0);return(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:g(t.status||"unknown")}),(0,s.jsx)("td",{children:(0,s.jsx)(M,{src:t.preview?.proposed,label:c})}),(0,s.jsx)("td",{children:(0,s.jsx)(M,{src:t.preview?.local,label:null!==(o=t.target_id)&&void 0!==o?o:"—"})}),(0,s.jsx)("td",{children:null!==(r=t.reason)&&void 0!==r?r:"—"}),(0,s.jsx)("td",{children:(0,s.jsxs)("div",{className:"dbvc-resolver-controls",children:[(0,s.jsxs)("select",{value:d,onChange:e=>u(e.target.value),children:[(0,s.jsx)("option",{value:"",children:"Select…"}),(0,s.jsx)("option",{value:"reuse",children:"Reuse existing"}),(0,s.jsx)("option",{value:"download",children:"Download new"}),(0,s.jsx)("option",{value:"map",children:"Map to attachment ID"}),(0,s.jsx)("option",{value:"skip",children:"Skip"})]}),_&&(0,s.jsx)("input",{type:"number",min:"1",placeholder:"Attachment ID",value:p,onChange:e=>h(e.target.value)}),(0,s.jsx)("textarea",{value:m,onChange:e=>v(e.target.value),placeholder:"Optional note",rows:2}),(0,s.jsxs)("label",{children:[(0,s.jsx)("input",{type:"checkbox",checked:b,onChange:e=>f(e.target.checked)})," ","Remember for future proposals"]})]})}),(0,s.jsxs)("td",{children:[(0,s.jsx)("button",{type:"button",className:"button button-primary",disabled:!j||n,onClick:()=>i&&i(c,{action:d,target_id:_?x:null,note:m,persist_global:b}),children:n?"Saving…":"Save"}),t.decision&&(0,s.jsx)("button",{type:"button",className:"button-link-delete",onClick:()=>l&&l(c,"global"===t.decision.scope?"global":"proposal"),disabled:n,children:"Clear"}),t.decision&&t.reason&&a&&(0,s.jsx)("button",{type:"button",className:"button-link",onClick:()=>{var e,s;return a(t,{action:t.decision?.action,target_id:null!==(e=t.decision?.target_id)&&void 0!==e?e:null,note:null!==(s=t.decision?.note)&&void 0!==s?s:"",persist_global:"global"===t.decision?.scope})},disabled:n,children:"Apply to similar"})]})]})},O=()=>{const[t,a]=(0,e.useState)([]),[o,c]=(0,e.useState)(!0),[d,u]=(0,e.useState)(null),[p,h]=(0,e.useState)(0),[m,v]=(0,e.useState)({}),[b,g]=(0,e.useState)(!1),[f,_]=(0,e.useState)(!1),[x,j]=(0,e.useState)(null),[y,w]=(0,e.useState)({original_id:"",action:"",target_id:"",note:""}),[k,C]=(0,e.useState)(""),[N,S]=(0,e.useState)(!1),[$,D]=(0,e.useState)(!0),[R,I]=(0,e.useState)(!1),[A,E]=(0,e.useState)({imported:0,errors:[]}),M=(0,e.useRef)(null),[B,O]=(0,e.useState)(""),U=(0,e.useRef)(""),T=(0,e.useMemo)(()=>{if(!B)return t;const e=B.toLowerCase();return t.filter(t=>[t.original_id,t.action,t.note,t.target_id,t.saved_at].filter(Boolean).map(e=>String(e).toLowerCase()).some(t=>t.includes(e)))},[B,t]),P=t.length>0,F=T.length>0,V=(Object.values(m).some(Boolean),!x&&y.original_id&&t.some(e=>String(e.original_id)===String(y.original_id))),L=("reuse"===y.action||"map"===y.action)&&y.target_id&&t.some(e=>String(e.original_id)!==String(y.original_id)&&e.target_id&&Number(e.target_id)===Number(y.target_id));(0,e.useEffect)(()=>{if(!U.current){const e=t.find(e=>e.target_id);e&&(U.current=String(e.target_id))}},[t]),(0,e.useEffect)(()=>{let e=!0;return(async()=>{c(!0),u(null);try{const s=await n("resolver-rules");var t;e&&a(null!==(t=s.rules)&&void 0!==t?t:[])}catch(t){e&&u(t.message)}finally{e&&c(!1)}})(),()=>{e=!1}},[p]);const H=(e=null)=>{var t,s,n;e?(j(e),w({original_id:String(null!==(t=e.original_id)&&void 0!==t?t:""),action:null!==(s=e.action)&&void 0!==s?s:"",target_id:e.target_id?String(e.target_id):"",note:null!==(n=e.note)&&void 0!==n?n:""})):(j(null),w({original_id:"",action:"",target_id:U.current||"",note:""})),C(""),_(!0)},K=()=>{_(!1),C(""),j(null)},z=(e,t)=>{w(s=>{const n={...s,[e]:t};return"action"===e&&("reuse"===t||"map"===t?!n.target_id&&U.current&&(n.target_id=U.current):n.target_id=""),n})};return(0,s.jsxs)("section",{className:"dbvc-resolver-rules",id:"dbvc-global-resolver",children:[(0,s.jsxs)("div",{className:"dbvc-resolver-rules__header",children:[(0,s.jsx)("h2",{children:"Global Resolver Rules"}),(0,s.jsx)("button",{type:"button",className:"button button-link",onClick:()=>D(e=>!e),children:$?"Show rules":"Hide rules"})]}),(0,s.jsx)("p",{className:"description",children:"Decisions saved with “remember for future proposals” appear here. They apply automatically whenever a matching original media ID is detected in any proposal."}),!$&&(0,s.jsxs)(s.Fragment,{children:[o&&(0,s.jsx)("p",{children:"Loading resolver rules…"}),d&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsx)("p",{children:d})}),!o&&!P&&(0,s.jsx)("p",{children:"No global rules saved yet."}),P&&(0,s.jsx)("div",{className:"dbvc-panel-search",children:(0,s.jsxs)("label",{children:["Search: ",(0,s.jsx)("input",{type:"search",value:B,onChange:e=>O(e.target.value),placeholder:"ID, action, note…"})]})}),!o&&P&&!F&&(0,s.jsxs)("p",{children:["No rules match “",B,"”."]}),!o&&F&&(0,s.jsxs)("table",{className:"widefat striped",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:(0,s.jsx)("input",{type:"checkbox",checked:b,onChange:()=>{const e=!b;if(g(e),e){const e={};t.forEach(t=>{e[t.original_id]=!0}),v(e)}else v({})}})}),(0,s.jsx)("th",{children:"Original ID"}),(0,s.jsx)("th",{children:"Action"}),(0,s.jsx)("th",{children:"Target"}),(0,s.jsx)("th",{children:"Note"}),(0,s.jsx)("th",{children:"Saved"}),(0,s.jsx)("th",{})]})}),(0,s.jsx)("tbody",{children:T.map(e=>{var t,n;return(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:(0,s.jsx)("input",{type:"checkbox",checked:!!m[e.original_id],onChange:()=>{return t=e.original_id,void v(e=>({...e,[t]:!e[t]}));var t}})}),(0,s.jsx)("td",{children:e.original_id}),(0,s.jsx)("td",{children:e.action}),(0,s.jsx)("td",{children:null!==(t=e.target_id)&&void 0!==t?t:"—"}),(0,s.jsx)("td",{children:null!==(n=e.note)&&void 0!==n?n:"—"}),(0,s.jsx)("td",{children:r(e.saved_at)}),(0,s.jsxs)("td",{className:"dbvc-resolver-rules__actions",children:[(0,s.jsx)("button",{type:"button",className:"button-link",onClick:()=>H(e),children:"Edit"}),(0,s.jsx)("button",{type:"button",className:"button-link-delete",onClick:()=>(async e=>{if(window.confirm(`Delete global rule for original ID ${e}?`))try{await l(`resolver-rules/${encodeURIComponent(e)}`),h(e=>e+1)}catch(e){window.alert(e.message)}})(e.original_id),children:"Delete"})]})]},e.original_id)})})]}),(0,s.jsxs)("div",{className:"dbvc-resolver-rules__bulk",children:[(0,s.jsx)("button",{type:"button",className:"button button-primary",onClick:()=>H(null),children:"Add Rule"}),(0,s.jsx)("button",{type:"button",className:"button",onClick:()=>{M.current&&M.current.click()},disabled:R,children:R?"Importing…":"Import CSV"}),(0,s.jsx)("button",{type:"button",className:"button button-secondary",onClick:async()=>{const e=Object.entries(m).filter(([,e])=>e).map(([e])=>e);if(e.length){if(window.confirm(`Delete ${e.length} selected rule(s)?`))try{await i("resolver-rules/bulk-delete",{original_ids:e}),v({}),g(!1),h(e=>e+1)}catch(e){window.alert(e.message)}}else window.alert("Select at least one rule to delete.")},disabled:!Object.values(m).some(Boolean),children:"Delete Selected"}),(0,s.jsx)("button",{type:"button",className:"button button-link",onClick:()=>{const e=["original_id,action,target_id,note,saved_at"].concat(t.map(e=>{var t;return[e.original_id,e.action,null!==(t=e.target_id)&&void 0!==t?t:"",(e.note||"").replace(/"/g,'""'),e.saved_at].join(",")})).join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(s),i=document.createElement("a");i.href=n,i.download="dbvc-resolver-rules.csv",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n)},children:"Export CSV"}),(0,s.jsx)("input",{ref:M,type:"file",accept:".csv,text/csv",style:{display:"none"},onChange:async e=>{const t=e.target.files&&e.target.files[0];t&&(await(async e=>{I(!0),E({imported:0,errors:[]});try{var t;const s=(e=>{const t=e.replace(/\r\n/g,"\n").split("\n").map(e=>e.trim()).filter(e=>e.length>0).map(e=>(e=>{const t=[];let s="",n=!1;for(let i=0;i<e.length;i++){const l=e[i];'"'===l?n&&'"'===e[i+1]?(s+='"',i++):n=!n:","!==l||n?s+=l:(t.push(s),s="")}return t.push(s),t})(e));if(!t.length)return[];let s=t[0].map(e=>e.trim().toLowerCase()),n=t.slice(1);s.includes("original_id")||(s=["original_id","action","target_id","note"],n=t);const i=new Set(["original_id","action","target_id","note"]),l=s.map((e,t)=>i.has(e)?e:`col_${t}`);return n.map(e=>{const t={};return l.forEach((s,n)=>{var i;t[s]=null!==(i=e[n])&&void 0!==i?i:""}),t}).map(e=>{const t=parseInt(e.original_id,10),s=parseInt(e.target_id,10);return{original_id:Number.isFinite(t)?t:null,action:(e.action||"").toLowerCase(),target_id:Number.isFinite(s)?s:null,note:e.note||""}}).filter(e=>e.original_id&&e.action)})(await e.text());if(!s.length)return void E({imported:0,errors:["The CSV file does not contain any valid rows."]});const n=await i("resolver-rules/import",{rules:s}),l=n.imported?n.imported.length:0;E({imported:l,errors:null!==(t=n.errors)&&void 0!==t?t:[]}),h(e=>e+1)}catch(e){E({imported:0,errors:[e?.message||"Import failed."]})}finally{I(!1)}})(t),e.target.value="")}})]}),f&&(0,s.jsxs)("form",{className:"dbvc-resolver-rule-form",onSubmit:async e=>{e.preventDefault(),C("");const t=parseInt(y.original_id,10);if(!Number.isFinite(t)||t<=0)return void C("Enter a valid original media ID.");if(!x&&V)return void C("A rule already exists for that original media ID. Choose Edit instead.");if(!y.action)return void C("Select an action for this rule.");const s="reuse"===y.action||"map"===y.action,n=parseInt(y.target_id,10);if(s&&(!Number.isFinite(n)||n<=0))C("Enter a target attachment ID for reuse/map actions.");else if(s&&L)C("This attachment ID is already mapped to another rule.");else{S(!0);try{await i("resolver-rules",{original_id:t,action:y.action,target_id:s?n:null,note:y.note}),h(e=>e+1),s&&Number.isFinite(n)&&n>0&&(U.current=String(n)),K()}catch(e){C(e?.message||"Failed to save rule.")}finally{S(!1)}}},children:[(0,s.jsx)("h3",{children:x?"Edit global rule":"Add global rule"}),(0,s.jsxs)("div",{className:"dbvc-resolver-controls",children:[(0,s.jsx)("input",{type:"number",min:"1",placeholder:"Original ID",value:y.original_id,onChange:e=>z("original_id",e.target.value),readOnly:!!x}),V&&(0,s.jsx)("span",{className:"dbvc-field-hint is-warning",children:"Rule already exists for this media ID."}),(0,s.jsxs)("select",{value:y.action,onChange:e=>z("action",e.target.value),children:[(0,s.jsx)("option",{value:"",children:"Select action…"}),(0,s.jsx)("option",{value:"reuse",children:"Reuse existing"}),(0,s.jsx)("option",{value:"download",children:"Download new"}),(0,s.jsx)("option",{value:"map",children:"Map to attachment ID"}),(0,s.jsx)("option",{value:"skip",children:"Skip"})]}),("reuse"===y.action||"map"===y.action)&&(0,s.jsx)("input",{type:"number",min:"1",placeholder:"Target attachment ID",value:y.target_id,onChange:e=>z("target_id",e.target.value)}),L&&(0,s.jsx)("span",{className:"dbvc-field-hint is-warning",children:"This attachment ID is already used by another rule."}),(0,s.jsx)("textarea",{value:y.note,onChange:e=>z("note",e.target.value),placeholder:"Optional note",rows:2})]}),k&&(0,s.jsx)("div",{className:"notice notice-error",children:(0,s.jsx)("p",{children:k})}),(0,s.jsxs)("div",{className:"dbvc-resolver-rule-form__actions",children:[(0,s.jsx)("button",{type:"button",className:"button button-link",onClick:K,children:"Cancel"}),(0,s.jsx)("button",{type:"submit",className:"button button-primary",disabled:N,children:N?"Saving…":x?"Update Rule":"Save Rule"})]})]}),(A.imported>0||A.errors.length>0)&&(0,s.jsxs)("div",{className:"dbvc-resolver-import",children:[A.imported>0&&(0,s.jsx)("div",{className:"notice notice-success",children:(0,s.jsxs)("p",{children:[A.imported," rule(s) imported successfully."]})}),A.errors.length>0&&(0,s.jsxs)("div",{className:"notice notice-warning",children:[(0,s.jsx)("p",{children:"Import completed with warnings:"}),(0,s.jsx)("ul",{children:A.errors.map((e,t)=>(0,s.jsx)("li",{children:e},t))})]})]})]})]})}}},s={};function n(e){var i=s[e];if(void 0!==i)return i.exports;var l=s[e]={exports:{}};return t[e](l,l.exports,n),l.exports}n.m=t,e=[],n.O=(t,s,i,l)=>{if(!s){var a=1/0;for(d=0;d<e.length;d++){for(var[s,i,l]=e[d],o=!0,r=0;r<s.length;r++)(!1&l||a>=l)&&Object.keys(n.O).every(e=>n.O[e](s[r]))?s.splice(r--,1):(o=!1,l<a&&(a=l));if(o){e.splice(d--,1);var c=i();void 0!==c&&(t=c)}}return t}l=l||0;for(var d=e.length;d>0&&e[d-1][2]>l;d--)e[d]=e[d-1];e[d]=[s,i,l]},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={378:0,681:0};n.O.j=t=>0===e[t];var t=(t,s)=>{var i,l,[a,o,r]=s,c=0;if(a.some(t=>0!==e[t])){for(i in o)n.o(o,i)&&(n.m[i]=o[i]);if(r)var d=r(n)}for(t&&t(s);c<a.length;c++)l=a[c],n.o(e,l)&&e[l]&&e[l][0](),e[l]=0;return n.O(d)},s=globalThis.webpackChunkdb_version_control_admin_app=globalThis.webpackChunkdb_version_control_admin_app||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var i=n.O(void 0,[681],()=>n(435));i=n.O(i)})()}},t={};function s(n){var i=t[n];if(void 0!==i)return i.exports;var l=t[n]={exports:{}};return e[n](l,l.exports,s),l.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";s(766)})()})()},976:(e,t,s)=>{"use strict";s(766)}},s={};function n(e){var i=s[e];if(void 0!==i)return i.exports;var l=s[e]={exports:{}};return t[e](l,l.exports,n),l.exports}n.m=t,e=[],n.O=(t,s,i,l)=>{if(!s){var a=1/0;for(d=0;d<e.length;d++){for(var[s,i,l]=e[d],o=!0,r=0;r<s.length;r++)(!1&l||a>=l)&&Object.keys(n.O).every(e=>n.O[e](s[r]))?s.splice(r--,1):(o=!1,l<a&&(a=l));if(o){e.splice(d--,1);var c=i();void 0!==c&&(t=c)}}return t}l=l||0;for(var d=e.length;d>0&&e[d-1][2]>l;d--)e[d]=e[d-1];e[d]=[s,i,l]},n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={378:0,681:0};n.O.j=t=>0===e[t];var t=(t,s)=>{var i,l,[a,o,r]=s,c=0;if(a.some(t=>0!==e[t])){for(i in o)n.o(o,i)&&(n.m[i]=o[i]);if(r)var d=r(n)}for(t&&t(s);c<a.length;c++)l=a[c],n.o(e,l)&&e[l]&&e[l][0](),e[l]=0;return n.O(d)},s=globalThis.webpackChunkdb_version_control_admin_app=globalThis.webpackChunkdb_version_control_admin_app||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var i=n.O(void 0,[681],()=>n(976));i=n.O(i)})();