(()=>{"use strict";var e,s={435:()=>{const e=window.wp.element,s=window.wp.components,t=window.ReactJSXRuntime,n=async(e,{signal:s}={})=>{const t=await window.fetch(`${DBVC_ADMIN_APP.root}${e}`,{headers:{"X-WP-Nonce":DBVC_ADMIN_APP.nonce},signal:s});if(!t.ok)throw new Error(`Request failed (${t.status})`);return t.json()},i=async(e,s)=>{const t=await window.fetch(`${DBVC_ADMIN_APP.root}${e}`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":DBVC_ADMIN_APP.nonce},body:JSON.stringify(s)});if(!t.ok){const e=await t.text();let s=e;try{s=JSON.parse(e)}catch(e){}const n=new Error(s&&s.message||e||`Request failed (${t.status})`);throw n.status=t.status,n.body=s,n}return t.json()},l=async e=>{const s=await window.fetch(`${DBVC_ADMIN_APP.root}${e}`,{method:"DELETE",headers:{"X-WP-Nonce":DBVC_ADMIN_APP.nonce}});if(!s.ok){const e=await s.text();throw new Error(e||`Request failed (${s.status})`)}return s.json()},a=e=>{if(!e)return"—";const s=new Date(e);return Number.isNaN(s.getTime())?e:s.toLocaleString()},r=e=>null==e?"—":"boolean"==typeof e?e?"true":"false":"number"==typeof e?e.toString():""===e?"(empty)":e,o=e=>{if(null==e)return"";if("string"==typeof e)return e;if("number"==typeof e||"boolean"==typeof e)return String(e);try{return JSON.stringify(e,null,2)}catch(s){return String(e)}},c=e=>e&&(e.diff||e.before||e.after)?(0,t.jsxs)(t.Fragment,{children:[e.before&&(0,t.jsx)("span",{children:e.before}),e.diff&&(0,t.jsx)("mark",{children:e.diff||"(empty)"}),e.after&&(0,t.jsx)("span",{children:e.after})]}):null,d={meta:"Meta",tax:"Taxonomies",media:"Media References",content:"Content",title:"Title",status:"Status",post_type:"Post Type",post_excerpt:"Excerpt",other:"Other"},u={all:"All entities",needs_review:"Needs Review",resolved:"Resolved",reused:"Resolved",conflict:"Conflict",needs_download:"Needs Download",missing:"Missing",unknown:"Unknown"},p=e=>{const s=u[e]||e;return(0,t.jsx)("span",{className:`dbvc-badge dbvc-badge--${e}`,children:s})},h=({proposals:e,selectedId:s,onSelect:n})=>e.length?(0,t.jsxs)("table",{className:"widefat fixed striped",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:"Proposal"}),(0,t.jsx)("th",{children:"Generated"}),(0,t.jsx)("th",{children:"Files"}),(0,t.jsx)("th",{children:"Media"}),(0,t.jsx)("th",{children:"Decisions"}),(0,t.jsx)("th",{children:"Resolver reused"}),(0,t.jsx)("th",{children:"Resolver unresolved"})]})}),(0,t.jsx)("tbody",{children:e.map(e=>{var i,l,r,o,c,d,u,p,h,v;const m=null!==(i=e.resolver?.metrics)&&void 0!==i?i:{},g=e.id===s,b=null!==(l=e.decisions)&&void 0!==l?l:{},x=null!==(r=b.accepted)&&void 0!==r?r:0,j=null!==(o=b.kept)&&void 0!==o?o:0,f=null!==(c=b.entities_reviewed)&&void 0!==c?c:0,y=(null!==(d=b.total)&&void 0!==d?d:0)>0;return(0,t.jsxs)("tr",{className:g?"is-active":void 0,onClick:()=>n(e.id),style:{cursor:"pointer"},children:[(0,t.jsx)("td",{children:e.title}),(0,t.jsx)("td",{children:a(e.generated_at)}),(0,t.jsx)("td",{children:null!==(u=e.files)&&void 0!==u?u:"—"}),(0,t.jsx)("td",{children:null!==(p=e.media_items)&&void 0!==p?p:"—"}),(0,t.jsx)("td",{children:y?(0,t.jsxs)("div",{className:"dbvc-decisions",children:[(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--accept",children:[x," accept"]}),(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--keep",children:[j," keep"]}),f>0&&(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--reviewed",children:[f," reviewed"]})]}):"—"}),(0,t.jsx)("td",{children:null!==(h=m.reused)&&void 0!==h?h:"—"}),(0,t.jsx)("td",{children:null!==(v=m.unresolved)&&void 0!==v?v:"—"})]},e.id)})})]}):(0,t.jsx)("p",{children:"No proposals found. Generate an export to get started."}),v=({onUploaded:n,onError:i})=>{const[l,a]=(0,e.useState)(!1),[r,o]=(0,e.useState)(!1),[c,d]=(0,e.useState)(""),[u,p]=(0,e.useState)(""),[h,v]=(0,e.useState)(!1),m=(0,e.useRef)(null),g=(0,e.useCallback)(async e=>{const s=e&&e[0];if(!s)return;const t=new window.FormData;t.append("file",s),t.append("overwrite",h?"1":"0"),o(!0),d(""),p("");try{const e=await(async(e,s)=>{const t=await window.fetch(`${DBVC_ADMIN_APP.root}proposals/upload`,{method:"POST",headers:{"X-WP-Nonce":DBVC_ADMIN_APP.nonce},body:s});if(!t.ok){const e=await t.text();throw new Error(e||`Request failed (${t.status})`)}return t.json()})(0,t);d(`Uploaded ${s.name}`),"function"==typeof n&&n(e.proposal_id,e)}catch(e){const s=e?.message||"Upload failed.";p(s),"function"==typeof i&&i(s)}finally{o(!1),m.current&&(m.current.value="")}},[h,n,i]);return(0,t.jsxs)("div",{className:"dbvc-proposal-uploader",children:[(0,t.jsx)("div",{className:`dbvc-proposal-uploader__dropzone${l?" is-dragging":""}${r?" is-uploading":""}`,onDragOver:e=>{e.preventDefault(),a(!0)},onDragLeave:e=>{e.currentTarget.contains(e.relatedTarget)||a(!1)},onDrop:e=>{e.preventDefault(),a(!1),g(e.dataTransfer?.files)},children:(0,t.jsxs)("div",{children:[(0,t.jsx)("strong",{children:"Upload proposal bundle"}),(0,t.jsx)("p",{children:"Drop a DBVC ZIP export here or select a file to register it."}),(0,t.jsx)(s.Button,{variant:"secondary",onClick:()=>m.current?.click(),disabled:r,children:r?"Uploading…":"Select ZIP"}),(0,t.jsx)("input",{ref:m,type:"file",accept:".zip",style:{display:"none"},onChange:e=>g(e.target.files)}),(0,t.jsx)(s.CheckboxControl,{label:"Replace existing proposal when IDs match",help:"Enable if this upload should refresh an existing proposal folder instead of creating a new one.",checked:h,onChange:e=>v(e),disabled:r})]})}),c&&(0,t.jsx)("p",{className:"dbvc-proposal-uploader__status",children:c}),u&&(0,t.jsx)("p",{className:"dbvc-proposal-uploader__error",role:"alert",children:u})]})},m=({resolver:e})=>{var s,n,i,l;if(!e)return(0,t.jsx)("p",{children:"Resolver metrics unavailable."});const{metrics:a={},conflicts:r=[]}=e;return(0,t.jsxs)("div",{className:"dbvc-admin-app__resolver",children:[(0,t.jsx)("h3",{children:"Resolver Summary"}),(0,t.jsxs)("ul",{children:[(0,t.jsxs)("li",{children:["Detected: ",null!==(s=a.detected)&&void 0!==s?s:0]}),(0,t.jsxs)("li",{children:["Reused: ",null!==(n=a.reused)&&void 0!==n?n:0]}),(0,t.jsxs)("li",{children:["Downloaded: ",null!==(i=a.downloaded)&&void 0!==i?i:0]}),(0,t.jsxs)("li",{children:["Unresolved: ",null!==(l=a.unresolved)&&void 0!==l?l:0]}),(0,t.jsxs)("li",{children:["Conflicts: ",r.length]})]}),r.length>0&&(0,t.jsx)("div",{className:"notice notice-warning",children:(0,t.jsxs)("p",{children:["The resolver reported ",r.length," conflict(s). Review before applying."]})})]})},g=({entities:s,loading:n,selectedEntityId:i,onSelect:l})=>{if(n)return(0,t.jsx)("p",{children:"Loading entities…"});if(!s.length)return(0,t.jsx)("p",{children:"No entities found for this proposal."});const a=s.length>200,r=(0,e.useRef)(null),[o,c]=(0,e.useState)(0),[d,u]=(0,e.useState)(0);(0,e.useEffect)(()=>{if(!a)return c(0),void u(0);const e=r.current;if(!e)return;const s=()=>{c(e.clientHeight||0)};s();let t=null;return"undefined"!=typeof ResizeObserver?(t=new ResizeObserver(s),t.observe(e)):window.addEventListener("resize",s),()=>{t?t.disconnect():window.removeEventListener("resize",s)}},[a]);const h=s.length,v=52*h,m=a&&o?Math.ceil(o/52)+5:h,g=a?Math.max(0,Math.floor(d/52)-5):0,b=a?Math.min(h,g+m):h,x=a?s.slice(g,b):s,j=a?52*g:0,f=a?Math.max(0,v-j-52*x.length):0,y=a?e=>{u(e.currentTarget.scrollTop)}:void 0;return(0,t.jsx)("div",{className:"dbvc-entity-table"+(a?" is-virtualized":""),ref:r,onScroll:y,children:(0,t.jsxs)("table",{className:"widefat striped",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:"Title"}),(0,t.jsx)("th",{children:"Type"}),(0,t.jsx)("th",{children:"Status"}),(0,t.jsx)("th",{children:"Content hash"}),(0,t.jsx)("th",{children:"Media refs"}),(0,t.jsx)("th",{children:"Resolver"}),(0,t.jsx)("th",{children:"Unresolved"}),(0,t.jsx)("th",{children:"Conflicts"}),(0,t.jsx)("th",{children:"Decisions"})]})}),(0,t.jsxs)("tbody",{children:[a&&j>0&&(0,t.jsx)("tr",{className:"dbvc-entity-spacer","aria-hidden":"true",style:{height:`${j}px`},children:(0,t.jsx)("td",{colSpan:9})}),x.map(e=>{var s,n,a,r,o,c,d,u,h,v,m;const g=e.vf_object_uid===i,b=null!==(s=e.resolver?.summary)&&void 0!==s?s:{},x=null!==(n=e.resolver?.status)&&void 0!==n?n:"unknown",j=null!==(a=e.decision_summary)&&void 0!==a?a:{},f=null!==(r=j.accepted)&&void 0!==r?r:0,y=null!==(o=j.kept)&&void 0!==o?o:0,_=(null!==(c=j.total)&&void 0!==c?c:0)>0,w=[`resolver-${x}`,g?"is-active":""].filter(Boolean).join(" "),C=s=>{s.preventDefault(),s.stopPropagation(),l(e.vf_object_uid)};return(0,t.jsxs)("tr",{className:w,onClick:C,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||C(e)},style:{cursor:"pointer"},role:"button",tabIndex:0,children:[(0,t.jsx)("td",{children:e.post_title||e.vf_object_uid}),(0,t.jsx)("td",{children:e.post_type}),(0,t.jsx)("td",{children:e.post_status||"—"}),(0,t.jsx)("td",{style:{wordBreak:"break-all"},children:null!==(d=e.content_hash)&&void 0!==d?d:"—"}),(0,t.jsx)("td",{children:(null!==(u=e.media_refs?.meta?.length)&&void 0!==u?u:0)+(null!==(h=e.media_refs?.content?.length)&&void 0!==h?h:0)}),(0,t.jsx)("td",{children:p(x)}),(0,t.jsx)("td",{children:null!==(v=b.unresolved)&&void 0!==v?v:0}),(0,t.jsx)("td",{children:null!==(m=b.conflicts)&&void 0!==m?m:0}),(0,t.jsx)("td",{children:_?(0,t.jsxs)("div",{className:"dbvc-decisions",children:[f>0&&(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--accept",children:[f," accept"]}),y>0&&(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--keep",children:[y," keep"]})]}):"—"})]},e.vf_object_uid)}),a&&f>0&&(0,t.jsx)("tr",{className:"dbvc-entity-spacer","aria-hidden":"true",style:{height:`${f}px`},children:(0,t.jsx)("td",{colSpan:9})})]})]})})},b=({entityDetail:n,resolverInfo:i,resolverDecisionSummary:l=null,decisions:a={},onDecisionChange:r,onBulkDecision:o,onResetDecisions:c,onCaptureSnapshot:u,onResolverDecision:p,onResolverDecisionReset:h,onApplyResolverDecisionToSimilar:v,savingPaths:m={},bulkSaving:g=!1,resolverSaving:b={},resolverError:x=null,decisionError:j,loading:_,error:w,onClose:C,filterMode:N,onFilterModeChange:k,isOpen:S=!0,resettingDecisions:D=!1,snapshotCapturing:R=!1})=>{var I,$,A,E,M,O,P,U,B,T;const L=(0,e.useMemo)(()=>n?.item?.vf_object_uid?`dbvc-entity-detail-${n.item.vf_object_uid}`:n?.vf_object_uid?`dbvc-entity-detail-${n.vf_object_uid}`:"dbvc-entity-detail",[n]),F=(0,e.useRef)(null),V=(0,e.useRef)(null);(0,e.useEffect)(()=>{if(!C||!S)return;V.current=document.activeElement instanceof HTMLElement?document.activeElement:null;const e=F.current;e&&e.focus();const s=e=>{"Escape"===e.key&&(e.preventDefault(),C())};return document.addEventListener("keydown",s),()=>{document.removeEventListener("keydown",s),V.current&&"function"==typeof V.current.focus&&V.current.focus()}},[S,C,L]);const{item:z,current:H,proposed:J={},diff:q}=null!=n?n:{},K=null!==(I=n?.decision_summary)&&void 0!==I?I:{},X=null!==($=K.total)&&void 0!==$?$:0,G=X>0?`${null!==(A=K.accepted)&&void 0!==A?A:0} accepted · ${null!==(E=K.kept)&&void 0!==E?E:0} kept`:"No selections captured yet.",W=null!==(M=q?.changes)&&void 0!==M?M:[],Z=(0,e.useMemo)(()=>"conflicts"!==N?W:W.filter(e=>{var s;const t=e.path||"";return"accept"!==(null!==(s=a?.[t])&&void 0!==s?s:"keep")}),[W,N,a]),Q=(0,e.useMemo)(()=>(e=>{const s={};return e.forEach(e=>{const[t]=e.path.split("."),n=t||"other";s[n]||(s[n]=[]),s[n].push(e)}),Object.entries(s).map(([e,s])=>({key:e,label:d[e]||e,items:s}))})(Z),[Z]),Y=null!==(O=i?.attachments)&&void 0!==O?O:[],[ee,se]=(0,e.useState)(""),te=(0,e.useMemo)(()=>{if(!ee)return Y;const e=ee.toLowerCase();return Y.filter(s=>{const t=s.descriptor||{};return[s.original_id,s.reason,s.status,s.decision?.note,t.asset_uid,t.bundle_path,t.path].filter(Boolean).join(" ").toLowerCase().includes(e)})},[Y,ee]),ne="conflicts"===N,ie=Z.length,le=W.length,[ae,re]=(0,e.useState)(!1),[oe,ce]=(0,e.useState)(""),[de,ue]=(0,e.useState)("reason"),[pe,he]=(0,e.useState)(""),[ve,me]=(0,e.useState)(""),[ge,be]=(0,e.useState)(""),[xe,je]=(0,e.useState)(""),[fe,ye]=(0,e.useState)(!1),[_e,we]=(0,e.useState)(!1),[Ce,Ne]=(0,e.useState)("");(0,e.useEffect)(()=>{ae||ce(Q[0]?.key||"")},[Q,ae]);const ke=(0,e.useMemo)(()=>ae||!oe?Q:Q.filter(e=>e.key===oe),[Q,ae,oe]),Se=(0,e.useMemo)(()=>{if(ae)return Z;const e=Q.find(e=>e.key===oe);return e?e.items:[]},[ae,Z,Q,oe]),De=(0,e.useMemo)(()=>Se.map(e=>e.path).filter(Boolean),[Se]),Re=(0,e.useMemo)(()=>{const e=new Set,s=new Set,t=new Set;return Y.forEach(n=>{n.reason&&e.add(n.reason);const i=n.descriptor||{};i.asset_uid&&s.add(i.asset_uid);const l=i.bundle_path||i.path||"";l&&t.add(l)}),{reason:Array.from(e),asset_uid:Array.from(s),bundle_path:Array.from(t)}},[Y]);(0,e.useEffect)(()=>{const e=Re[de]||[];e.length?e.includes(pe)||he(e[0]||""):he("")},[de,pe,Re]);const Ie=(0,e.useMemo)(()=>!pe&&(Re[de]||[]).length?[]:Y.filter(e=>{const s=e.descriptor||{};switch(de){case"asset_uid":return(s.asset_uid||"")===pe;case"bundle_path":return(s.bundle_path||s.path||"")===pe;default:return(e.reason||"")===pe}}),[Y,de,pe,Re]),$e=Ie.length,Ae="reuse"===ve||"map"===ve;return C&&!S?null:(e=>{const s=(0,t.jsxs)("div",{className:"dbvc-entity-detail__header",children:[(0,t.jsx)("h3",{id:L,children:z?.post_title||"Entity detail"}),z&&(0,t.jsxs)("div",{className:"dbvc-entity-detail__meta",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("strong",{children:"Slug:"})," ",z.post_name||"—"]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("strong",{children:"File:"})," ",z.path||"—"]})]}),C&&(0,t.jsx)("button",{type:"button",className:"dbvc-entity-detail__close",onClick:C,"aria-label":"Close entity detail",ref:C?F:void 0,children:"Close"})]}),n=(0,t.jsxs)("div",{className:"dbvc-admin-app__entity-detail",children:[s,e]});return C?(0,t.jsxs)("div",{className:"dbvc-entity-detail-modal",role:"presentation",children:[(0,t.jsx)("div",{className:"dbvc-entity-detail-modal__overlay",onClick:C,"aria-hidden":"true"}),(0,t.jsx)("div",{className:"dbvc-entity-detail-modal__panel",role:"dialog","aria-modal":"true","aria-labelledby":L,children:n})]}):n})(_?(0,t.jsx)("p",{children:"Loading entity detail…"}):w?(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsxs)("p",{children:["Failed to load entity detail: ",w]})}):n?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"dbvc-entity-toolbar",children:[(0,t.jsxs)("div",{className:"dbvc-entity-toolbar__meta",children:[(0,t.jsx)("div",{className:"dbvc-entity-toolbar__title",children:z?.post_title||"Entity detail"}),(0,t.jsxs)("div",{className:"dbvc-entity-toolbar__sub",children:[(0,t.jsxs)("span",{children:["Slug: ",z?.post_name||"—"]}),(0,t.jsxs)("span",{children:["File: ",z?.path||"—"]})]})]}),(0,t.jsxs)("div",{className:"dbvc-diff-filter",children:[(0,t.jsx)("span",{children:"View:"}),(0,t.jsx)("button",{type:"button",className:ne?"is-active":"",onClick:()=>k&&k("conflicts"),children:"Conflicts & Resolver"}),(0,t.jsx)("button",{type:"button",className:ne?"":"is-active",onClick:()=>k&&k("full"),children:"Full Overview"})]}),(0,t.jsxs)("p",{className:"dbvc-entity-toolbar__count",children:[ie," field(s) shown",ne?` (from ${le} total changes)`:"","."]}),De.length>0&&(0,t.jsxs)("div",{className:"dbvc-bulk-actions",children:[(0,t.jsx)("button",{type:"button",className:"button button-secondary",onClick:()=>{o&&window.confirm(`Accept ${De.length} field(s)?`)&&o("accept",De)},disabled:g,children:g?"Accepting…":"Accept All Visible"}),(0,t.jsx)("button",{type:"button",className:"button",onClick:()=>{o&&window.confirm(`Keep current values for ${De.length} field(s)?`)&&o("keep",De)},disabled:g,children:g?"Keeping…":"Keep All Visible"})]}),(0,t.jsxs)("p",{className:"dbvc-decision-summary",children:["Selections: ",G]})]}),(0,t.jsxs)("div",{className:"dbvc-entity-detail__actions",children:[(0,t.jsx)(s.Button,{variant:"secondary",onClick:u,isBusy:R,disabled:R||!u,children:R?"Capturing snapshot…":"Capture current snapshot"}),(0,t.jsx)("p",{className:"description",children:"Creates a fresh “current” snapshot from the live site for this entity."})]}),j&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsx)("p",{children:j})}),"function"==typeof c&&X>0&&(0,t.jsxs)("div",{className:"dbvc-entity-detail__actions",children:[(0,t.jsx)(s.Button,{variant:"tertiary",onClick:c,isBusy:D,disabled:D,children:D?"Clearing…":"Clear all decisions"}),(0,t.jsx)("p",{className:"description",children:"Removes every Accept/Keep choice for this entity."})]}),Q.length>0&&(0,t.jsxs)("div",{className:"dbvc-section-nav",children:[(0,t.jsx)("span",{children:ae?"Sections:":"Jump to:"}),Q.map(e=>(0,t.jsx)("button",{type:"button",className:ae||oe!==e.key?"":"is-active",onClick:()=>{if(ae){const s=document.getElementById(`dbvc-diff-${e.key}`);s&&s.scrollIntoView({behavior:"smooth",block:"start"})}else ce(e.key)},children:e.label},e.key)),(0,t.jsx)("button",{type:"button",className:ae?"is-active":"",onClick:()=>re(e=>!e),children:ae?"Focus Section":"Show All"})]}),ke.length>0?ke.map(e=>(0,t.jsx)(f,{section:e,decisions:a,onDecisionChange:r,savingPaths:m},e.key)):(0,t.jsx)("p",{children:ne&&le>0?"No resolver or media conflicts detected for this entity. Switch to Full Overview to inspect all differences.":"No differences detected."}),Y.length>0&&(0,t.jsxs)("div",{className:"dbvc-admin-app__resolver-attachments",children:[(0,t.jsx)("h4",{children:"Media Resolver"}),(0,t.jsx)("div",{className:"dbvc-panel-search",children:(0,t.jsxs)("label",{children:["Search:  ",(0,t.jsx)("input",{type:"search",value:ee,onChange:e=>se(e.target.value),placeholder:"Reason, asset UID, note…"})]})}),l&&(0,t.jsxs)("p",{className:"dbvc-resolver-summary",children:["Saved decisions — reuse: ",null!==(P=l.reuse)&&void 0!==P?P:0,", map: ",null!==(U=l.map)&&void 0!==U?U:0,", download:"," ",null!==(B=l.download)&&void 0!==B?B:0,", skip: ",null!==(T=l.skip)&&void 0!==T?T:0]}),x&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsx)("p",{children:x})}),te.length>0?(0,t.jsxs)("table",{className:"widefat",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:"Original ID"}),(0,t.jsx)("th",{children:"Status"}),(0,t.jsx)("th",{children:"Preview"}),(0,t.jsx)("th",{children:"Target"}),(0,t.jsx)("th",{children:"Reason"}),(0,t.jsx)("th",{children:"Decision"}),(0,t.jsx)("th",{style:{width:"160px"},children:"Actions"})]})}),(0,t.jsx)("tbody",{children:te.map(e=>(0,t.jsx)(y,{attachment:e,saving:!!b[e.original_id],onSave:p,onClear:h,onApplyToSimilar:v},e.original_id))})]}):(0,t.jsx)("p",{children:"No resolver conflicts match your search."}),(0,t.jsxs)("div",{className:"dbvc-resolver-bulk",children:[(0,t.jsx)("h5",{children:"Bulk Apply Resolver Decision"}),(0,t.jsx)("p",{className:"description",children:"Match a subset of conflicts and apply a single decision without editing rows individually."}),(0,t.jsxs)("div",{className:"dbvc-resolver-bulk__filters",children:[(0,t.jsxs)("label",{children:["Match by",(0,t.jsxs)("select",{value:de,onChange:e=>ue(e.target.value),children:[(0,t.jsx)("option",{value:"reason",children:"Reason"}),(0,t.jsx)("option",{value:"asset_uid",children:"Asset UID"}),(0,t.jsx)("option",{value:"bundle_path",children:"Manifest Path"})]})]}),(0,t.jsxs)("label",{children:["Value",(0,t.jsxs)("select",{value:pe,onChange:e=>he(e.target.value),disabled:0===(Re[de]||[]).length,children:[0===(Re[de]||[]).length&&(0,t.jsx)("option",{value:"",children:"No values detected"}),(Re[de]||[]).map(e=>(0,t.jsx)("option",{value:e,children:e||"— Not provided —"},e||"blank"))]})]}),(0,t.jsxs)("span",{className:"dbvc-resolver-bulk__count",children:["Matches: ",$e]})]}),(0,t.jsxs)("div",{className:"dbvc-resolver-controls dbvc-resolver-bulk__controls",children:[(0,t.jsxs)("select",{value:ve,onChange:e=>me(e.target.value),children:[(0,t.jsx)("option",{value:"",children:"Select action…"}),(0,t.jsx)("option",{value:"reuse",children:"Reuse existing"}),(0,t.jsx)("option",{value:"download",children:"Download new"}),(0,t.jsx)("option",{value:"map",children:"Map to attachment ID"}),(0,t.jsx)("option",{value:"skip",children:"Skip"})]}),Ae&&(0,t.jsx)("input",{type:"number",min:"1",placeholder:"Attachment ID",value:ge,onChange:e=>be(e.target.value)}),(0,t.jsx)("textarea",{value:xe,onChange:e=>je(e.target.value),placeholder:"Optional note",rows:2}),(0,t.jsxs)("label",{children:[(0,t.jsx)("input",{type:"checkbox",checked:fe,onChange:e=>ye(e.target.checked)})," ","Remember as global rule"]})]}),Ce&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsx)("p",{children:Ce})}),(0,t.jsx)("button",{type:"button",className:"button button-secondary",onClick:async()=>{if(!ve)return void Ne("Select an action to apply.");if(Ae&&!ge)return void Ne("Enter a target attachment ID for this action.");if(!$e)return void Ne("No matching conflicts were found for the selected filter.");if(!p)return;if(!window.confirm(`Apply this decision to ${$e} conflict(s) matched by ${"reason"===de?"reason":"asset_uid"===de?"asset UID":"manifest path"}?`))return;we(!0),Ne("");const e={action:ve,target_id:Ae?Number(ge):null,note:xe,persist_global:fe};try{for(const s of Ie)s.original_id&&await p(s.original_id,e);je(""),be("")}catch(e){Ne(e?.message||"Bulk apply failed.")}finally{we(!1)}},disabled:_e,children:_e?"Applying…":"Apply to Matches"})]})]}),(0,t.jsxs)("div",{className:"dbvc-admin-app__entity-columns",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h4",{children:"Raw Current"}),(0,t.jsx)("pre",{children:JSON.stringify(H,null,2)})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h4",{children:"Raw Proposed (Bundle)"}),(0,t.jsx)("pre",{children:JSON.stringify(J,null,2)})]})]})]}):(0,t.jsx)("p",{children:"Select an entity to view details."}))},x=()=>{var r,o,c,d,p,x,j,f,y,w,C,N,k,S,D,R,I,$,A,E,M,O,P;const[U,B]=(0,e.useState)([]),[T,L]=(0,e.useState)(null),[F,V]=(0,e.useState)(null),[z,H]=(0,e.useState)([]),[J,q]=(0,e.useState)("needs_review"),[K,X]=(0,e.useState)(""),[G,W]=(0,e.useState)(null),[Z,Q]=(0,e.useState)(null),[Y,ee]=(0,e.useState)(!1),[se,te]=(0,e.useState)({}),[ne,ie]=(0,e.useState)({}),[le,ae]=(0,e.useState)(null),[re,oe]=(0,e.useState)(!0),[ce,de]=(0,e.useState)(!1),[ue,pe]=(0,e.useState)(!1),[he,ve]=(0,e.useState)(!1),[me,ge]=(0,e.useState)(!1),[be,xe]=(0,e.useState)(null),[je,fe]=(0,e.useState)(null),[ye,_e]=(0,e.useState)(null),[we,Ce]=(0,e.useState)(null),[Ne,ke]=(0,e.useState)(!1),[Se,De]=(0,e.useState)(null),[Re,Ie]=(0,e.useState)(null),[$e,Ae]=(0,e.useState)(!1),[Ee,Me]=(0,e.useState)("full"),[Oe,Pe]=(0,e.useState)(!1),[Ue,Be]=(0,e.useState)("conflicts"),[Te,Le]=(0,e.useState)([]),[Fe,Ve]=(0,e.useState)([]),[ze,He]=(0,e.useState)({}),[Je,qe]=(0,e.useState)(null),[Ke,Xe]=(0,e.useState)(!1),[Ge,We]=(0,e.useState)(!1),[Ze,Qe]=(0,e.useState)(!1),[Ye,es]=(0,e.useState)(!1),ss=(0,e.useCallback)(async(e={})=>{const{signal:s,focusProposalId:t}=e;oe(!0),xe(null);try{var i;const e=null!==(i=(await n("proposals",s?{signal:s}:void 0)).items)&&void 0!==i?i:[];B(e),L(s=>{var n;return t&&e.some(e=>e.id===t)?t:s&&e.some(e=>e.id===s)?s:null!==(n=e[0]?.id)&&void 0!==n?n:null})}catch(e){if("AbortError"===e.name)return;xe(e.message)}finally{oe(!1),de(!0)}},[]),ts=(0,e.useCallback)(e=>{e.stopPropagation()},[]),ns=(0,e.useCallback)(e=>{e.preventDefault(),e.stopPropagation()},[]),is=(0,e.useMemo)(()=>Z?.resolver?.attachments?.length?Z.resolver.attachments:F?.attachments||[],[F,Z]),[ls,as]=(0,e.useState)(!1);(0,e.useEffect)(()=>{De(null),Ie(null),ke(!1),Ae(!1),Me("full"),Pe(!1),Le([])},[T]),(0,e.useEffect)(()=>{"partial"!==Ee&&Pe(!1)},[Ee]),(0,e.useEffect)(()=>{if(0===Te.length)return;const e=setTimeout(()=>{Le(e=>e.slice(1))},6e3);return()=>clearTimeout(e)},[Te]),(0,e.useEffect)(()=>{const e=new AbortController;return ss({signal:e.signal}),()=>e.abort()},[ss]);const rs=(0,e.useCallback)(async(e,s,t)=>{if(!e)return H([]),[];pe(!0),fe(null);try{var i;const l=s&&"all"!==s?`?status=${encodeURIComponent(s)}`:"",a=await n(`proposals/${encodeURIComponent(e)}/entities${l}`,{signal:t}),r=null!==(i=a.items)&&void 0!==i?i:[];return H(r),a.decision_summary&&B(s=>s.map(s=>s.id===e?{...s,decisions:a.decision_summary}:s)),a.resolver_decisions&&B(s=>s.map(s=>s.id===e?{...s,resolver_decisions:a.resolver_decisions}:s)),r}catch(e){return"AbortError"!==e.name&&fe(e.message),[]}finally{pe(!1)}},[]),os=(0,e.useCallback)(async(e,s)=>{if(e){ve(!0),_e(null);try{const t=await n(`proposals/${encodeURIComponent(e)}/resolver`,{signal:s});V(t)}catch(e){"AbortError"!==e.name&&_e(e.message)}finally{ve(!1)}}else V(null)},[]);(0,e.useEffect)(()=>{if(!T)return;const e=new AbortController;return W(null),Q(null),rs(T,J,e.signal).then(e=>{e.length?(W(e[0].vf_object_uid),ee(!0)):(W(null),ee(!1))}),()=>e.abort()},[T,J,rs]),(0,e.useEffect)(()=>{if(!T)return;const e=new AbortController;return os(T,e.signal),()=>e.abort()},[T,os]),(0,e.useEffect)(()=>{if(!T||!G)return Q(null),te({}),void ie({});const e=new AbortController;return(async()=>{ge(!0),Ce(null),ae(null),ie({});try{var s;const t=await n(`proposals/${encodeURIComponent(T)}/entities/${encodeURIComponent(G)}`,{signal:e.signal});Q(t),te(null!==(s=t.decisions)&&void 0!==s?s:{})}catch(e){"AbortError"!==e.name&&Ce(e.message)}finally{ge(!1)}})(),()=>e.abort()},[T,G]);const cs=(0,e.useCallback)((e,s)=>{const t=Number(e),n=(e=[])=>e.map(e=>{if((void 0!==e.original_id?e.original_id:e.descriptor?.original_id)===t){if(s)return{...e,decision:s};const{decision:t,...n}=e;return n}return e});V(e=>e?{...e,attachments:n(e.attachments||[])}:e),Q(e=>e?{...e,resolver:{...e.resolver||{},attachments:n(e.resolver?.attachments||[])}}:e),H(e=>e.map(e=>e.vf_object_uid===G?{...e,resolver:{...e.resolver||{},attachments:n(e.resolver?.attachments||[])}}:e))},[G]),ds=(0,e.useMemo)(()=>{if(!K)return z;const e=K.toLowerCase();return z.filter(s=>[s.post_title,s.post_type,s.post_status,s.path].filter(Boolean).join(" ").toLowerCase().includes(e))},[z,K]),us=(0,e.useMemo)(()=>z.find(e=>e.vf_object_uid===G),[z,G]),ps=(0,e.useMemo)(()=>U.find(e=>e.id===T),[U,T]);(0,e.useEffect)(()=>{if(!ds.length)return W(null),void ee(!1);ds.find(e=>e.vf_object_uid===G)||(W(ds[0].vf_object_uid),ee(!0))},[ds,G]),(0,e.useEffect)(()=>{z.length&&!G&&(W(z[0].vf_object_uid),ee(!0))},[z,G]),(0,e.useEffect)(()=>{Be("conflicts")},[G]);const hs=(0,e.useCallback)(e=>{if(!e)return W(null),void ee(!1);W(s=>s===e?s:e),ee(!0)},[]),vs=(0,e.useCallback)(()=>{ee(!1)},[]),ms=(0,e.useCallback)(()=>{T&&(Ie(null),De(null),Me("full"),Pe(!1),Ae(!0))},[T]),gs=(0,e.useCallback)(()=>{Ne||Ae(!1)},[Ne]),bs=(0,e.useCallback)(e=>{Le(s=>s.filter(s=>s.id!==e))},[]),xs=(0,e.useCallback)(async()=>{if(T){Ae(!1),Ie(null),De(null),ke(!0);try{var e,s;const r=await i(`proposals/${encodeURIComponent(T)}/apply`,{mode:Ee,ignore_missing_hash:Oe});De(r),r.decisions&&B(e=>e.map(e=>e.id===T?{...e,decisions:r.decisions}:e)),r.resolver_decisions&&B(e=>e.map(e=>e.id===T?{...e,resolver_decisions:r.resolver_decisions}:e));const o=null!==(e=r?.result?.imported)&&void 0!==e?e:0,c=null!==(s=r?.result?.skipped)&&void 0!==s?s:0,d=Array.isArray(r?.result?.errors)?r.result.errors:[],u=(new Date).toISOString(),p=Date.now(),h=[];var t,n,l,a;d.length>0&&h.push(d[0]),r.decisions_cleared&&r.auto_clear_enabled&&h.push("Reviewer decisions cleared."),r.ignore_missing_hash&&h.push("Hash check override enabled."),r.resolver_decisions&&h.push(`Resolver decisions — reuse: ${null!==(t=r.resolver_decisions.reuse)&&void 0!==t?t:0}, map: ${null!==(n=r.resolver_decisions.map)&&void 0!==n?n:0}, download: ${null!==(l=r.resolver_decisions.download)&&void 0!==l?l:0}, skip: ${null!==(a=r.resolver_decisions.skip)&&void 0!==a?a:0}`),Le(e=>[...e,{id:p,severity:d.length?"warning":"success",title:`Applied ${ps?.title||T}`,message:`Imported ${o} · Skipped ${c}`,detail:h.join(" "),timestamp:u}]),Ve(e=>{var s,t;return[{id:p,timestamp:u,proposalId:T,proposalTitle:ps?.title||T,mode:null!==(s=r.mode)&&void 0!==s?s:Ee,imported:o,skipped:c,errors:d,decisionsCleared:Boolean(r.decisions_cleared&&r.auto_clear_enabled),ignoreMissingHash:Boolean(r.ignore_missing_hash),resolverDecisions:null!==(t=r.resolver_decisions)&&void 0!==t?t:null},...e].slice(0,10)}),W(null),ee(!1),Q(null),te({}),ie({});const v=await rs(T,J);v.length&&(W(v[0].vf_object_uid),ee(!0)),await os(T)}catch(e){const s=e?.message||"Apply request failed.";Ie(s);const t=(new Date).toISOString(),n=Date.now(),i=[s];Oe&&i.push("Hash check override requested."),Le(e=>[...e,{id:n,severity:"warning",title:`Apply failed (${ps?.title||T})`,message:s,detail:i.join(" "),timestamp:t}]),Ve(e=>[{id:n,timestamp:t,proposalId:T,proposalTitle:ps?.title||T,mode:Ee,imported:0,skipped:0,errors:[s],decisionsCleared:!1,ignoreMissingHash:Oe},...e].slice(0,10))}finally{ke(!1)}}},[T,Ee,rs,J,os,ps,Oe]),js=(0,e.useCallback)(async(e,s)=>{if(T&&G){ae(null),ie(s=>({...s,[e]:!0}));try{var t,n;const l=await i(`proposals/${encodeURIComponent(T)}/entities/${encodeURIComponent(G)}/selections`,{path:e,action:s}),a=null!==(t=l.decisions)&&void 0!==t?t:{},r=null!==(n=l.summary)&&void 0!==n?n:null;te(a),Q(e=>e?{...e,decisions:a,decision_summary:null!=r?r:e.decision_summary}:e),H(e=>e.map(e=>e.vf_object_uid===G?{...e,decision_summary:null!=r?r:e.decision_summary}:e)),l.proposal_summary&&B(e=>e.map(e=>e.id===T?{...e,decisions:l.proposal_summary}:e))}catch(e){ae(e.message)}finally{ie(s=>{const t={...s};return delete t[e],t})}}},[T,G]),fs=(0,e.useCallback)(async(e,s)=>{if(T){qe(null),He(s=>({...s,[e]:!0}));try{var t;const n=await i(`proposals/${encodeURIComponent(T)}/resolver/${encodeURIComponent(e)}`,s);return cs(e,null!==(t=n.decision)&&void 0!==t?t:null),n}catch(e){throw qe(e.message),e}finally{He(s=>{const t={...s};return delete t[e],t})}}},[T,cs]),ys=(0,e.useCallback)(async(e,s)=>{await fs(e,s)},[fs]),_s=(0,e.useCallback)(async(e,s="proposal")=>{if(T){qe(null),He(s=>({...s,[e]:!0}));try{var t;const n=await l(`proposals/${encodeURIComponent(T)}/resolver/${encodeURIComponent(e)}?scope=${encodeURIComponent(s)}`);cs(e,null!==(t=n.decision)&&void 0!==t?t:null)}catch(e){qe(e.message)}finally{He(s=>{const t={...s};return delete t[e],t})}}},[T,cs]),ws=(0,e.useCallback)(async(e,s)=>{const t=e.reason||"";if(!t||!is.length)return;const n=is.filter(s=>s.original_id!==e.original_id&&(s.reason||"")===t);if(n.length){if(window.confirm(`Apply this ${s.action} decision to ${n.length} other conflict(s) with reason "${t}"?`))try{await Promise.all(n.map(e=>fs(e.original_id,s)))}catch(e){}}else window.alert("No similar conflicts found to apply this decision to.")},[is,fs]),Cs=(0,e.useCallback)(async()=>{if(T&&G&&window.confirm("Clear all Accept/Keep choices for this entity?")){ae(null),Xe(!0),ie({});try{var e,s;const t=await i(`proposals/${encodeURIComponent(T)}/entities/${encodeURIComponent(G)}/selections`,{action:"clear_all"}),n=null!==(e=t.decisions)&&void 0!==e?e:{},l=null!==(s=t.summary)&&void 0!==s?s:null;te(n),Q(e=>e?{...e,decisions:n,decision_summary:null!=l?l:e.decision_summary}:e),H(e=>e.map(e=>e.vf_object_uid===G?{...e,decision_summary:null!=l?l:e.decision_summary}:e)),t.proposal_summary&&B(e=>e.map(e=>e.id===T?{...e,decisions:t.proposal_summary}:e))}catch(e){ae(e.message)}finally{Xe(!1)}}},[T,G]),Ns=(0,e.useCallback)(async()=>{if(T&&G){We(!0),ae(null);try{var e,s;const t=null!==(e=(await i(`proposals/${encodeURIComponent(T)}/entities/${encodeURIComponent(G)}/snapshot`,{})).snapshot)&&void 0!==e?e:null;t&&Q(e=>e?{...e,current:t,current_source:"snapshot"}:e);const l=await n(`proposals/${encodeURIComponent(T)}/entities/${encodeURIComponent(G)}`);Q(l),te(null!==(s=l.decisions)&&void 0!==s?s:{}),H(e=>e.map(e=>{var s;return e.vf_object_uid===G?{...e,decision_summary:null!==(s=l.decision_summary)&&void 0!==s?s:e.decision_summary}:e}))}catch(e){ae(e.message)}finally{We(!1)}}},[T,G]),ks=(0,e.useCallback)(async()=>{if(T){Qe(!0),ae(null);try{var e,s;const l=await n(`proposals/${encodeURIComponent(T)}/entities?status=needs_review`),a=Array.isArray(l.items)?l.items:[],r=a.map(e=>parseInt(e.vf_object_uid,10)).filter(e=>Number.isFinite(e)&&e>0),o=r.length?{entity_ids:r}:{},c=await i(`proposals/${encodeURIComponent(T)}/snapshot`,o),d=null!==(e=c.captured)&&void 0!==e?e:0,u=null!==(s=c.targets)&&void 0!==s?s:r.length||a.length||0,p=(new Date).toISOString();if(Le(e=>[...e,{id:Date.now(),severity:"info",title:"Snapshots captured",message:`Captured ${d}/${u||d} snapshot(s) for proposal ${T}.`,timestamp:p}]),await rs(T,J),await os(T),G){var t;const e=await n(`proposals/${encodeURIComponent(T)}/entities/${encodeURIComponent(G)}`);Q(e),te(null!==(t=e.decisions)&&void 0!==t?t:{})}}catch(e){ae(e.message)}finally{Qe(!1)}}},[T,G,J,rs,os]),Ss=(0,e.useCallback)(async()=>{if(window.confirm("This will delete all stored backups, snapshots, and reviewer decisions. Continue?")){es(!0),ae(null);try{await l("maintenance/clear-proposals"),await ss(),L(null),H([]),Q(null),V(null),te({}),ie({}),Le(e=>[...e,{id:Date.now(),severity:"info",title:"Backups cleared",message:"All proposal backups, snapshots, and decisions have been removed.",timestamp:(new Date).toISOString()}])}catch(e){ae(e.message)}finally{es(!1)}}},[ss]),Ds=(0,e.useCallback)(async(e,s)=>{if(!T||!G||!Array.isArray(s)||0===s.length)return;const t=s.filter(e=>"string"==typeof e&&e.length>0);if(!t.length)return;const n=e=>{var s,t;const n=null!==(s=e.decisions)&&void 0!==s?s:{},i=null!==(t=e.summary)&&void 0!==t?t:null;te(n),Q(e=>e?{...e,decisions:n,decision_summary:null!=i?i:e.decision_summary}:e),H(e=>e.map(e=>e.vf_object_uid===G?{...e,decision_summary:null!=i?i:e.decision_summary}:e)),e.proposal_summary&&B(s=>s.map(s=>s.id===T?{...s,decisions:e.proposal_summary}:s))};ae(null),as(!0),ie(e=>{const s={...e};return t.forEach(e=>{s[e]=!0}),s});try{try{const s=await i(`proposals/${encodeURIComponent(T)}/entities/${encodeURIComponent(G)}/selections/bulk`,{action:e,paths:t});n(s),ie({})}catch(s){if(404!==s.status)throw s;await(async()=>{for(const s of t){const t=await i(`proposals/${encodeURIComponent(T)}/entities/${encodeURIComponent(G)}/selections`,{path:s,action:e});n(t),ie(e=>{const t={...e};return delete t[s],t})}})()}}catch(e){ae(e.message)}finally{as(!1),ie({})}},[T,G]),Rs=null!==(r=ps?.decisions)&&void 0!==r?r:null,Is=null!==(o=Rs?.total)&&void 0!==o?o:0,$s=null!==(c=Rs?.accepted)&&void 0!==c?c:0,As=null!==(d=Rs?.kept)&&void 0!==d?d:0,Es=null!==(p=Rs?.entities_reviewed)&&void 0!==p?p:0,Ms=null!==(x=ps?.resolver_decisions)&&void 0!==x?x:null,Os=null!==(j=Ms?.reuse)&&void 0!==j?j:0,Ps=null!==(f=Ms?.map)&&void 0!==f?f:0,Us=null!==(y=Ms?.download)&&void 0!==y?y:0,Bs=null!==(w=Ms?.skip)&&void 0!==w?w:0,Ts=null!==(C=null!==(N=F?.metrics?.unresolved)&&void 0!==N?N:ps?.resolver?.metrics?.unresolved)&&void 0!==C?C:0,Ls=Array.isArray(Se?.result?.errors)?Se.result.errors:[],Fs=Ls.length?"notice notice-warning":"notice notice-success",Vs=null!==(k=Se?.result?.imported)&&void 0!==k?k:0,zs=null!==(S=Se?.result?.skipped)&&void 0!==S?S:0,Hs=null!==(D=Se?.result?.media_resolver?.metrics)&&void 0!==D?D:{},Js=null!==(R=Hs?.unresolved)&&void 0!==R?R:0,qs=(0,e.useCallback)(e=>{ss({focusProposalId:e});const s=(new Date).toISOString(),t=Date.now();Le(n=>[...n,{id:t,severity:"success",title:"Proposal uploaded",message:`Bundle registered as ${e}`,timestamp:s}])},[ss]),Ks=(0,e.useCallback)(e=>{const s=(new Date).toISOString(),t=Date.now();Le(n=>[...n,{id:t,severity:"error",title:"Upload failed",message:e,timestamp:s}])},[]);return!ce&&re?(0,t.jsx)("p",{children:"Loading proposals…"}):!ce&&be?(0,t.jsxs)("p",{className:"dbvc-admin-app-error",children:["Error loading proposals: ",be]}):(0,t.jsxs)("div",{className:"dbvc-admin-app",onClick:ts,onMouseDown:ts,onSubmit:ns,children:[Te.length>0&&(0,t.jsx)("div",{className:"dbvc-toasts",children:Te.map(e=>(0,t.jsxs)("div",{className:`dbvc-toast dbvc-toast--${e.severity}`,children:[(0,t.jsxs)("div",{className:"dbvc-toast__content",children:[(0,t.jsx)("strong",{children:e.title}),(0,t.jsx)("span",{children:e.message}),e.detail&&(0,t.jsx)("small",{children:e.detail}),(0,t.jsx)("small",{className:"dbvc-toast__time",children:a(e.timestamp)})]}),(0,t.jsx)("button",{type:"button",className:"dbvc-toast__dismiss",onClick:()=>bs(e.id),"aria-label":"Dismiss notification",children:"×"})]},e.id))}),(0,t.jsxs)("div",{className:"dbvc-admin-app__header",children:[(0,t.jsx)("h1",{children:"DBVC Proposals"}),(0,t.jsx)(s.Button,{variant:"secondary",onClick:()=>ss(),disabled:re&&ce,children:re&&ce?"Refreshing…":"Refresh list"}),(0,t.jsx)(s.Button,{variant:"tertiary",onClick:Ss,disabled:Ye,isBusy:Ye,children:Ye?"Clearing…":"Clear all backups"})]}),(0,t.jsx)(v,{onUploaded:qs,onError:Ks}),be&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsxs)("p",{children:["Failed to load proposals: ",be]})}),(0,t.jsx)(h,{proposals:U,selectedId:T,onSelect:L}),(0,t.jsx)(_,{}),ps&&(0,t.jsxs)("section",{className:"dbvc-admin-app__detail",children:[(0,t.jsx)("h2",{children:ps.title}),(0,t.jsxs)("p",{children:["Generated: ",a(ps.generated_at)," · Files:"," ",null!==(I=ps.files)&&void 0!==I?I:"—"," · Media: ",null!==($=ps.media_items)&&void 0!==$?$:"—"]}),ye&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsxs)("p",{children:["Resolver error: ",ye]})}),he?(0,t.jsx)("p",{children:"Loading resolver metrics…"}):(0,t.jsx)(m,{resolver:F}),(0,t.jsxs)("div",{className:"dbvc-admin-app__actions",children:[(0,t.jsx)("button",{type:"button",className:"button button-primary",onClick:ms,disabled:Ne,children:Ne?"Applying…":"Apply Proposal"}),Is>0&&(0,t.jsxs)("div",{className:"dbvc-decisions",children:[(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--accept",children:[$s," accept"]}),(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--keep",children:[As," keep"]}),(0,t.jsxs)("span",{className:"dbvc-badge dbvc-badge--reviewed",children:[Es," reviewed"]})]})]}),Re&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsxs)("p",{children:["Apply failed: ",Re]})}),Se&&(0,t.jsxs)("div",{className:Fs,children:[(0,t.jsxs)("p",{children:['Applied proposal "',ps?.title||T,'". Mode: ',null!==(A=Se.mode)&&void 0!==A?A:"full"," · Imported ",Vs," · Skipped"," ",zs,Se.decisions_cleared&&Se.auto_clear_enabled?" · Reviewer decisions were cleared.":"",Js>0&&` · ${Js} resolver conflict(s) remain.`]}),Se.resolver_decisions&&(0,t.jsxs)("p",{className:"dbvc-resolver-summary",children:["Resolver decisions applied — reuse: ",null!==(E=Se.resolver_decisions.reuse)&&void 0!==E?E:0,", map:"," ",null!==(M=Se.resolver_decisions.map)&&void 0!==M?M:0,", download: ",null!==(O=Se.resolver_decisions.download)&&void 0!==O?O:0,", skip:"," ",null!==(P=Se.resolver_decisions.skip)&&void 0!==P?P:0]}),Ls.length>0&&(0,t.jsx)("ul",{children:Ls.map((e,s)=>(0,t.jsx)("li",{children:e},s))})]}),Ms&&(0,t.jsx)("div",{className:"dbvc-resolver-summary",children:(0,t.jsxs)("span",{children:["Resolver decisions — reuse: ",Os,", map: ",Ps,", download:"," ",Us,", skip: ",Bs]})}),Fe.length>0&&(0,t.jsxs)("div",{className:"dbvc-apply-history",children:[(0,t.jsx)("h3",{children:"Recent Apply Runs"}),(0,t.jsx)("ul",{children:Fe.map(e=>{var s,n,i,l;return(0,t.jsxs)("li",{children:[(0,t.jsx)("strong",{children:a(e.timestamp)})," — Mode ",e.mode," · Imported ",e.imported," · Skipped ",e.skipped,e.errors.length?` · ${e.errors.length} error(s)`:"",e.decisionsCleared?" · Selections cleared":"",e.ignoreMissingHash?" · Hash override":"",e.resolverDecisions?` · Resolver decisions (reuse ${null!==(s=e.resolverDecisions.reuse)&&void 0!==s?s:0}, map ${null!==(n=e.resolverDecisions.map)&&void 0!==n?n:0}, download ${null!==(i=e.resolverDecisions.download)&&void 0!==i?i:0}, skip ${null!==(l=e.resolverDecisions.skip)&&void 0!==l?l:0})`:""]},e.id)})})]}),$e&&(0,t.jsxs)(s.Modal,{title:`Apply proposal "${ps?.title||T}"`,onRequestClose:gs,isDismissible:!Ne,shouldCloseOnClickOutside:!Ne,children:[(0,t.jsxs)("div",{className:"dbvc-apply-modal__summary",children:[(0,t.jsx)("p",{children:"This will run the import pipeline for the selected proposal using the chosen mode."}),Is>0?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("p",{children:"Reviewer selections captured:"}),(0,t.jsxs)("ul",{children:[(0,t.jsxs)("li",{children:[$s," field(s) marked Accept"]}),(0,t.jsxs)("li",{children:[As," field(s) kept as-is"]}),(0,t.jsxs)("li",{children:[Es," entity row(s) touched"]})]}),(0,t.jsx)("p",{className:"description",children:"Only fields marked Accept will overwrite live data. Other fields remain unchanged."})]}):(0,t.jsx)("p",{className:"dbvc-apply-modal__warning",children:"No reviewer selections have been recorded. Applying will use the manifest values unchanged."})]}),(0,t.jsx)(s.RadioControl,{label:"Import mode",selected:Ee,options:[{label:"Full import (copy entire proposal)",value:"full"},{label:"Partial import (skip unchanged items when hashes match)",value:"partial"}],onChange:e=>Me(e)}),"partial"===Ee&&(0,t.jsx)(s.CheckboxControl,{label:"Ignore missing import hash validation",checked:Oe,onChange:e=>Pe(e),help:"Use only for legacy backups that predate import hash support. Recommended to resolve hash mismatches when possible."}),(0,t.jsx)("p",{className:"description",children:"Selections will be cleared automatically after a successful apply if the auto-clear setting is enabled in Configure → Import."}),(0,t.jsxs)("div",{className:"dbvc-apply-modal__footer",children:[(0,t.jsx)(s.Button,{variant:"secondary",onClick:gs,disabled:Ne,children:"Cancel"}),(0,t.jsx)(s.Button,{variant:"primary",onClick:xs,isBusy:Ne,disabled:Ne,children:"Apply Proposal"})]})]}),(0,t.jsx)("h3",{children:"Entities"}),(0,t.jsxs)("div",{className:"dbvc-admin-app__filters",children:[(0,t.jsxs)("label",{children:["Show: ",(0,t.jsxs)("select",{value:J,onChange:e=>{q(e.target.value)},children:[(0,t.jsx)("option",{value:"all",children:u.all}),(0,t.jsx)("option",{value:"needs_review",children:u.needs_review}),(0,t.jsx)("option",{value:"resolved",children:u.resolved})]})]}),(0,t.jsxs)("label",{children:[" Search: ",(0,t.jsx)("input",{type:"search",value:K,onChange:e=>{X(e.target.value)},placeholder:"Title, type, path…"})]})]}),ps&&(0,t.jsxs)("div",{className:"dbvc-entity-actions",children:[(0,t.jsx)(s.Button,{variant:"secondary",onClick:ks,disabled:Ze,isBusy:Ze,children:Ze?"Capturing snapshots…":"Capture Full Snapshot"}),(0,t.jsxs)("p",{className:"description",children:["Captures current-state JSON for ",Ts>0?`${Ts} unresolved`:"all"," entity(ies) so the diff shows live vs. proposed."]})]}),je&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsxs)("p",{children:["Failed to load entities: ",je]})}),(0,t.jsx)(g,{entities:ds,loading:ue,selectedEntityId:G,onSelect:hs}),(0,t.jsx)(b,{entityDetail:Z,resolverInfo:us?.resolver,resolverDecisionSummary:ps?.resolver_decisions,decisions:se,onDecisionChange:js,onBulkDecision:Ds,onResetDecisions:Cs,onCaptureSnapshot:Ns,onResolverDecision:ys,onResolverDecisionReset:_s,onApplyResolverDecisionToSimilar:ws,savingPaths:ne,bulkSaving:ls,resolverSaving:ze,resolverError:Je,decisionError:le,loading:me,error:we,filterMode:Ue,onFilterModeChange:Be,isOpen:Y,onClose:vs,resettingDecisions:Ke,snapshotCapturing:Ge})]})]})},j=()=>{const s=document.getElementById("dbvc-admin-app-root");s&&(0,e.render)((0,t.jsx)(x,{}),s)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",j):j();const f=({section:n,decisions:i,onDecisionChange:l,savingPaths:a})=>{const[d,u]=(0,e.useState)(!0);return(0,t.jsxs)("div",{className:"dbvc-admin-app__diff-section",id:`dbvc-diff-${n.key}`,children:[(0,t.jsxs)("button",{type:"button",className:"dbvc-admin-app__diff-toggle",onClick:()=>u(e=>!e),"aria-expanded":d,children:[(0,t.jsx)("h4",{children:n.label}),(0,t.jsx)("span",{children:d?"Collapse":"Expand"})]}),d?(0,t.jsxs)("table",{className:"widefat dbvc-admin-app__diff-table",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{style:{width:"25%"},children:"Field"}),(0,t.jsx)("th",{children:"Current"}),(0,t.jsx)("th",{children:"Proposed"}),(0,t.jsx)("th",{style:{width:"20%"},children:"Decision"})]})}),(0,t.jsx)("tbody",{children:n.items.map(e=>{var n;const d=((e,s)=>{const t=o(e),n=o(s);if(t===n)return null;if(t.length>5e3||n.length>5e3)return null;const i=Math.min(t.length,n.length);let l=0;for(;l<i&&t[l]===n[l];)l++;let a=t.length-1,r=n.length-1;for(;a>=l&&r>=l&&t[a]===n[r];)a--,r--;return{old:{before:t.slice(0,l),diff:t.slice(l,a+1),after:t.slice(a+1)},new:{before:n.slice(0,l),diff:n.slice(l,r+1),after:n.slice(r+1)}}})(e.from,e.to),u=null!==(n=i?.[e.path])&&void 0!==n?n:"",p=!!a[e.path];return(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{children:(0,t.jsxs)("div",{className:"dbvc-field-label",children:[e.label||e.path,e.path&&(0,t.jsx)("div",{className:"dbvc-field-label__key",children:e.path})]})}),(0,t.jsx)("td",{children:d&&d.old.diff?c(d.old):r(e.from)}),(0,t.jsx)("td",{children:d&&d.new.diff?c(d.new):r(e.to)}),(0,t.jsx)("td",{children:(0,t.jsxs)("div",{className:"dbvc-decision-controls",children:[(0,t.jsxs)("label",{children:[(0,t.jsx)("input",{type:"radio",name:`decision-${e.path}`,value:"keep",checked:"keep"===u,disabled:p,onChange:()=>l&&l(e.path,"keep")}),"Keep"]}),(0,t.jsxs)("label",{children:[(0,t.jsx)("input",{type:"radio",name:`decision-${e.path}`,value:"accept",checked:"accept"===u,disabled:p,onChange:()=>l&&l(e.path,"accept")}),"Accept"]}),(0,t.jsx)(s.Button,{variant:"link",className:"dbvc-decision-clear",onClick:()=>l&&l(e.path,"clear"),disabled:p||!u,children:"Clear decision"}),!u&&(0,t.jsx)("span",{className:"dbvc-decision-status",children:"Not reviewed"}),p&&(0,t.jsx)("span",{className:"saving",children:"Saving…"})]})})]},e.path)})})]}):(0,t.jsxs)("div",{className:"dbvc-admin-app__no-diff",children:["Collapsed (",n.items.length," changes)."]})]})},y=({attachment:s,saving:n,onSave:i,onClear:l,onApplyToSimilar:a})=>{var r,o;const c=s.original_id,[d,u]=(0,e.useState)(s.decision?.action||""),[h,v]=(0,e.useState)(s.decision?.target_id?String(s.decision.target_id):""),[m,g]=(0,e.useState)(s.decision?.note||""),[b,x]=(0,e.useState)("global"===s.decision?.scope);(0,e.useEffect)(()=>{u(s.decision?.action||""),v(s.decision?.target_id?String(s.decision.target_id):""),g(s.decision?.note||""),x("global"===s.decision?.scope)},[s.decision]);const j="reuse"===d||"map"===d,f=parseInt(h,10),y=d&&(!j||f>0);return(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{children:c}),(0,t.jsx)("td",{children:p(s.status||"unknown")}),(0,t.jsx)("td",{children:(0,t.jsxs)("div",{className:"dbvc-resolver-preview",children:[(0,t.jsxs)("div",{className:"dbvc-resolver-preview__item",children:[(0,t.jsx)("span",{className:"dbvc-resolver-preview__label",children:"Proposed"}),s.preview?.proposed?(0,t.jsx)("img",{src:s.preview.proposed,alt:"",className:"dbvc-resolver-preview__image",loading:"lazy"}):(0,t.jsx)("span",{className:"dbvc-resolver-preview__placeholder",children:"—"})]}),(0,t.jsxs)("div",{className:"dbvc-resolver-preview__item",children:[(0,t.jsx)("span",{className:"dbvc-resolver-preview__label",children:"Current"}),s.preview?.local?(0,t.jsx)("img",{src:s.preview.local,alt:"",className:"dbvc-resolver-preview__image",loading:"lazy"}):(0,t.jsx)("span",{className:"dbvc-resolver-preview__placeholder",children:"—"})]})]})}),(0,t.jsx)("td",{children:null!==(r=s.target_id)&&void 0!==r?r:"—"}),(0,t.jsx)("td",{children:null!==(o=s.reason)&&void 0!==o?o:"—"}),(0,t.jsx)("td",{children:(0,t.jsxs)("div",{className:"dbvc-resolver-controls",children:[(0,t.jsxs)("select",{value:d,onChange:e=>u(e.target.value),children:[(0,t.jsx)("option",{value:"",children:"Select…"}),(0,t.jsx)("option",{value:"reuse",children:"Reuse existing"}),(0,t.jsx)("option",{value:"download",children:"Download new"}),(0,t.jsx)("option",{value:"map",children:"Map to attachment ID"}),(0,t.jsx)("option",{value:"skip",children:"Skip"})]}),j&&(0,t.jsx)("input",{type:"number",min:"1",placeholder:"Attachment ID",value:h,onChange:e=>v(e.target.value)}),(0,t.jsx)("textarea",{value:m,onChange:e=>g(e.target.value),placeholder:"Optional note",rows:2}),(0,t.jsxs)("label",{children:[(0,t.jsx)("input",{type:"checkbox",checked:b,onChange:e=>x(e.target.checked)})," ","Remember for future proposals"]})]})}),(0,t.jsxs)("td",{children:[(0,t.jsx)("button",{type:"button",className:"button button-primary",disabled:!y||n,onClick:()=>i&&i(c,{action:d,target_id:j?f:null,note:m,persist_global:b}),children:n?"Saving…":"Save"}),s.decision&&(0,t.jsx)("button",{type:"button",className:"button-link-delete",onClick:()=>l&&l(c,"global"===s.decision.scope?"global":"proposal"),disabled:n,children:"Clear"}),s.decision&&s.reason&&a&&(0,t.jsx)("button",{type:"button",className:"button-link",onClick:()=>{var e,t;return a(s,{action:s.decision?.action,target_id:null!==(e=s.decision?.target_id)&&void 0!==e?e:null,note:null!==(t=s.decision?.note)&&void 0!==t?t:"",persist_global:"global"===s.decision?.scope})},disabled:n,children:"Apply to similar"})]})]})},_=()=>{const[s,r]=(0,e.useState)([]),[o,c]=(0,e.useState)(!0),[d,u]=(0,e.useState)(null),[p,h]=(0,e.useState)(0),[v,m]=(0,e.useState)({}),[g,b]=(0,e.useState)(!1),[x,j]=(0,e.useState)(!1),[f,y]=(0,e.useState)(null),[_,w]=(0,e.useState)({original_id:"",action:"",target_id:"",note:""}),[C,N]=(0,e.useState)(""),[k,S]=(0,e.useState)(!1),[D,R]=(0,e.useState)(!1),[I,$]=(0,e.useState)({imported:0,errors:[]}),A=(0,e.useRef)(null),[E,M]=(0,e.useState)(""),O=(0,e.useRef)(""),P=(0,e.useMemo)(()=>{if(!E)return s;const e=E.toLowerCase();return s.filter(s=>[s.original_id,s.action,s.note,s.target_id,s.saved_at].filter(Boolean).map(e=>String(e).toLowerCase()).some(s=>s.includes(e)))},[E,s]),U=s.length>0,B=P.length>0,T=(Object.values(v).some(Boolean),!f&&_.original_id&&s.some(e=>String(e.original_id)===String(_.original_id))),L=("reuse"===_.action||"map"===_.action)&&_.target_id&&s.some(e=>String(e.original_id)!==String(_.original_id)&&e.target_id&&Number(e.target_id)===Number(_.target_id));(0,e.useEffect)(()=>{if(!O.current){const e=s.find(e=>e.target_id);e&&(O.current=String(e.target_id))}},[s]),(0,e.useEffect)(()=>{let e=!0;return(async()=>{c(!0),u(null);try{const t=await n("resolver-rules");var s;e&&r(null!==(s=t.rules)&&void 0!==s?s:[])}catch(s){e&&u(s.message)}finally{e&&c(!1)}})(),()=>{e=!1}},[p]);const F=(e=null)=>{var s,t,n;e?(y(e),w({original_id:String(null!==(s=e.original_id)&&void 0!==s?s:""),action:null!==(t=e.action)&&void 0!==t?t:"",target_id:e.target_id?String(e.target_id):"",note:null!==(n=e.note)&&void 0!==n?n:""})):(y(null),w({original_id:"",action:"",target_id:O.current||"",note:""})),N(""),j(!0)},V=()=>{j(!1),N(""),y(null)},z=(e,s)=>{w(t=>{const n={...t,[e]:s};return"action"===e&&("reuse"===s||"map"===s?!n.target_id&&O.current&&(n.target_id=O.current):n.target_id=""),n})};return(0,t.jsxs)("section",{className:"dbvc-resolver-rules",children:[(0,t.jsx)("h2",{children:"Global Resolver Rules"}),(0,t.jsx)("p",{className:"description",children:"Decisions saved with “remember for future proposals” appear here. They apply automatically whenever a matching original media ID is detected in any proposal."}),o&&(0,t.jsx)("p",{children:"Loading resolver rules…"}),d&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsx)("p",{children:d})}),!o&&!U&&(0,t.jsx)("p",{children:"No global rules saved yet."}),U&&(0,t.jsx)("div",{className:"dbvc-panel-search",children:(0,t.jsxs)("label",{children:["Search: ",(0,t.jsx)("input",{type:"search",value:E,onChange:e=>M(e.target.value),placeholder:"ID, action, note…"})]})}),!o&&U&&!B&&(0,t.jsxs)("p",{children:["No rules match “",E,"”."]}),!o&&B&&(0,t.jsxs)("table",{className:"widefat striped",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:(0,t.jsx)("input",{type:"checkbox",checked:g,onChange:()=>{const e=!g;if(b(e),e){const e={};s.forEach(s=>{e[s.original_id]=!0}),m(e)}else m({})}})}),(0,t.jsx)("th",{children:"Original ID"}),(0,t.jsx)("th",{children:"Action"}),(0,t.jsx)("th",{children:"Target"}),(0,t.jsx)("th",{children:"Note"}),(0,t.jsx)("th",{children:"Saved"}),(0,t.jsx)("th",{})]})}),(0,t.jsx)("tbody",{children:P.map(e=>{var s,n;return(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{children:(0,t.jsx)("input",{type:"checkbox",checked:!!v[e.original_id],onChange:()=>{return s=e.original_id,void m(e=>({...e,[s]:!e[s]}));var s}})}),(0,t.jsx)("td",{children:e.original_id}),(0,t.jsx)("td",{children:e.action}),(0,t.jsx)("td",{children:null!==(s=e.target_id)&&void 0!==s?s:"—"}),(0,t.jsx)("td",{children:null!==(n=e.note)&&void 0!==n?n:"—"}),(0,t.jsx)("td",{children:a(e.saved_at)}),(0,t.jsxs)("td",{className:"dbvc-resolver-rules__actions",children:[(0,t.jsx)("button",{type:"button",className:"button-link",onClick:()=>F(e),children:"Edit"}),(0,t.jsx)("button",{type:"button",className:"button-link-delete",onClick:()=>(async e=>{if(window.confirm(`Delete global rule for original ID ${e}?`))try{await l(`resolver-rules/${encodeURIComponent(e)}`),h(e=>e+1)}catch(e){window.alert(e.message)}})(e.original_id),children:"Delete"})]})]},e.original_id)})})]}),(0,t.jsxs)("div",{className:"dbvc-resolver-rules__bulk",children:[(0,t.jsx)("button",{type:"button",className:"button button-primary",onClick:()=>F(null),children:"Add Rule"}),(0,t.jsx)("button",{type:"button",className:"button",onClick:()=>{A.current&&A.current.click()},disabled:D,children:D?"Importing…":"Import CSV"}),(0,t.jsx)("button",{type:"button",className:"button button-secondary",onClick:async()=>{const e=Object.entries(v).filter(([,e])=>e).map(([e])=>e);if(e.length){if(window.confirm(`Delete ${e.length} selected rule(s)?`))try{await i("resolver-rules/bulk-delete",{original_ids:e}),m({}),b(!1),h(e=>e+1)}catch(e){window.alert(e.message)}}else window.alert("Select at least one rule to delete.")},disabled:!Object.values(v).some(Boolean),children:"Delete Selected"}),(0,t.jsx)("button",{type:"button",className:"button button-link",onClick:()=>{const e=["original_id,action,target_id,note,saved_at"].concat(s.map(e=>{var s;return[e.original_id,e.action,null!==(s=e.target_id)&&void 0!==s?s:"",(e.note||"").replace(/\"/g,'""'),e.saved_at].join(",")})).join("\n"),t=new Blob([e],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download="dbvc-resolver-rules.csv",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n)},children:"Export CSV"}),(0,t.jsx)("input",{ref:A,type:"file",accept:".csv,text/csv",style:{display:"none"},onChange:async e=>{const s=e.target.files&&e.target.files[0];s&&(await(async e=>{R(!0),$({imported:0,errors:[]});try{var s;const t=(e=>{const s=e.replace(/\r\n/g,"\n").split("\n").map(e=>e.trim()).filter(e=>e.length>0).map(e=>(e=>{const s=[];let t="",n=!1;for(let i=0;i<e.length;i++){const l=e[i];'"'===l?n&&'"'===e[i+1]?(t+='"',i++):n=!n:","!==l||n?t+=l:(s.push(t),t="")}return s.push(t),s})(e));if(!s.length)return[];let t=s[0].map(e=>e.trim().toLowerCase()),n=s.slice(1);t.includes("original_id")||(t=["original_id","action","target_id","note"],n=s);const i=new Set(["original_id","action","target_id","note"]),l=t.map((e,s)=>i.has(e)?e:`col_${s}`);return n.map(e=>{const s={};return l.forEach((t,n)=>{var i;s[t]=null!==(i=e[n])&&void 0!==i?i:""}),s}).map(e=>{const s=parseInt(e.original_id,10),t=parseInt(e.target_id,10);return{original_id:Number.isFinite(s)?s:null,action:(e.action||"").toLowerCase(),target_id:Number.isFinite(t)?t:null,note:e.note||""}}).filter(e=>e.original_id&&e.action)})(await e.text());if(!t.length)return void $({imported:0,errors:["The CSV file does not contain any valid rows."]});const n=await i("resolver-rules/import",{rules:t}),l=n.imported?n.imported.length:0;$({imported:l,errors:null!==(s=n.errors)&&void 0!==s?s:[]}),h(e=>e+1)}catch(e){$({imported:0,errors:[e?.message||"Import failed."]})}finally{R(!1)}})(s),e.target.value="")}})]}),x&&(0,t.jsxs)("form",{className:"dbvc-resolver-rule-form",onSubmit:async e=>{e.preventDefault(),N("");const s=parseInt(_.original_id,10);if(!Number.isFinite(s)||s<=0)return void N("Enter a valid original media ID.");if(!f&&T)return void N("A rule already exists for that original media ID. Choose Edit instead.");if(!_.action)return void N("Select an action for this rule.");const t="reuse"===_.action||"map"===_.action,n=parseInt(_.target_id,10);if(t&&(!Number.isFinite(n)||n<=0))N("Enter a target attachment ID for reuse/map actions.");else if(t&&L)N("This attachment ID is already mapped to another rule.");else{S(!0);try{await i("resolver-rules",{original_id:s,action:_.action,target_id:t?n:null,note:_.note}),h(e=>e+1),t&&Number.isFinite(n)&&n>0&&(O.current=String(n)),V()}catch(e){N(e?.message||"Failed to save rule.")}finally{S(!1)}}},children:[(0,t.jsx)("h3",{children:f?"Edit global rule":"Add global rule"}),(0,t.jsxs)("div",{className:"dbvc-resolver-controls",children:[(0,t.jsx)("input",{type:"number",min:"1",placeholder:"Original ID",value:_.original_id,onChange:e=>z("original_id",e.target.value),readOnly:!!f}),T&&(0,t.jsx)("span",{className:"dbvc-field-hint is-warning",children:"Rule already exists for this media ID."}),(0,t.jsxs)("select",{value:_.action,onChange:e=>z("action",e.target.value),children:[(0,t.jsx)("option",{value:"",children:"Select action…"}),(0,t.jsx)("option",{value:"reuse",children:"Reuse existing"}),(0,t.jsx)("option",{value:"download",children:"Download new"}),(0,t.jsx)("option",{value:"map",children:"Map to attachment ID"}),(0,t.jsx)("option",{value:"skip",children:"Skip"})]}),("reuse"===_.action||"map"===_.action)&&(0,t.jsx)("input",{type:"number",min:"1",placeholder:"Target attachment ID",value:_.target_id,onChange:e=>z("target_id",e.target.value)}),L&&(0,t.jsx)("span",{className:"dbvc-field-hint is-warning",children:"This attachment ID is already used by another rule."}),(0,t.jsx)("textarea",{value:_.note,onChange:e=>z("note",e.target.value),placeholder:"Optional note",rows:2})]}),C&&(0,t.jsx)("div",{className:"notice notice-error",children:(0,t.jsx)("p",{children:C})}),(0,t.jsxs)("div",{className:"dbvc-resolver-rule-form__actions",children:[(0,t.jsx)("button",{type:"button",className:"button button-link",onClick:V,children:"Cancel"}),(0,t.jsx)("button",{type:"submit",className:"button button-primary",disabled:k,children:k?"Saving…":f?"Update Rule":"Save Rule"})]})]}),(I.imported>0||I.errors.length>0)&&(0,t.jsxs)("div",{className:"dbvc-resolver-import",children:[I.imported>0&&(0,t.jsx)("div",{className:"notice notice-success",children:(0,t.jsxs)("p",{children:[I.imported," rule(s) imported successfully."]})}),I.errors.length>0&&(0,t.jsxs)("div",{className:"notice notice-warning",children:[(0,t.jsx)("p",{children:"Import completed with warnings:"}),(0,t.jsx)("ul",{children:I.errors.map((e,s)=>(0,t.jsx)("li",{children:e},s))})]})]})]})}}},t={};function n(e){var i=t[e];if(void 0!==i)return i.exports;var l=t[e]={exports:{}};return s[e](l,l.exports,n),l.exports}n.m=s,e=[],n.O=(s,t,i,l)=>{if(!t){var a=1/0;for(d=0;d<e.length;d++){for(var[t,i,l]=e[d],r=!0,o=0;o<t.length;o++)(!1&l||a>=l)&&Object.keys(n.O).every(e=>n.O[e](t[o]))?t.splice(o--,1):(r=!1,l<a&&(a=l));if(r){e.splice(d--,1);var c=i();void 0!==c&&(s=c)}}return s}l=l||0;for(var d=e.length;d>0&&e[d-1][2]>l;d--)e[d]=e[d-1];e[d]=[t,i,l]},n.o=(e,s)=>Object.prototype.hasOwnProperty.call(e,s),(()=>{var e={378:0,681:0};n.O.j=s=>0===e[s];var s=(s,t)=>{var i,l,[a,r,o]=t,c=0;if(a.some(s=>0!==e[s])){for(i in r)n.o(r,i)&&(n.m[i]=r[i]);if(o)var d=o(n)}for(s&&s(t);c<a.length;c++)l=a[c],n.o(e,l)&&e[l]&&e[l][0](),e[l]=0;return n.O(d)},t=globalThis.webpackChunkdb_version_control_admin_app=globalThis.webpackChunkdb_version_control_admin_app||[];t.forEach(s.bind(null,0)),t.push=s.bind(null,t.push.bind(t))})();var i=n.O(void 0,[681],()=>n(435));i=n.O(i)})();